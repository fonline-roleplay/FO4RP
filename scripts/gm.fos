#ifndef __GM_MODULE__
#define __GM_MODULE__

#include "_utils.fos"
#include "gm_h.fos"
#include "npc_names_holder_h.fos"
#include "local_population_h.fos"
#include "globalmap_group_h.fos"
#include "entire_h.fos"
#include "npc_planes_h.fos"
#include "Fractions.fosh"
#include "effects_h.fos"
#include "critter_status_h.fos"
#include "speed_h.fos"
#include "heal_h.fos"
#include "banhammer_h.fos"
#include "playlist_h.fos"
#include "time_h.fos"
#include "weather_h.fos"
#include "radio_h.fos"
#include "radiation_h.fos"
#include "furniture_h.fos"
#include "gasses_h.fos"
#include "_npc_pids.fos"

import  void GM_brokeItem( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 ) from "gm_commands";

import uint CountMapPlayers( Map@ map ) from "manager";

import void ShowInputBoxScreen( Critter& cr, string funcName, uint16 textLength, uint8 flags ) from "main";

import void SetWorkbench( Critter& cr, int p0, int p1, int p2 )  from "item";
import void SetSecurityDoor( Critter& cr, int p0, int p1, int p2 )  from "item";

import void unsafe_log_2(Critter& cr, int locX, int locY, int type, string@ message, int[] @ p4 ) from "general_unsafe"; 
import void unsafe_sleep( Critter& player, int isBack, int isRemote, int param2, string@ param3, int[] @ param4 ) from "general_unsafe";

import void PlayMusic(Map& map, string& musicName, uint pos, uint repeat) from "media";

import void StoreMenu( Critter& cr ) from "store";

import void ShowTeleports( Critter& cr ) from "teleports";

import NpcNamesHolder@ getNpcNamesHolder() from "npc_names_holder";

import void GM_MobInit( Critter& npc ) from "mob";
import void GM_GuardsInit( Critter& npc ) from "ai_guards";

import string@ GetName(uint id) from "factions";
import array<string@> GetList() from "factions";
import void SetFractionRelation( Fraction @fraction, string key, string relation_name ) from "factions";
import void DeleteFraction(uint id) from "factions";

void unsafe_resetCharacter( Critter& player, int targetId, int param1, int param2, string@ param3, int[] @ vals )
{
	if( isGM( player ) )
	{
		Result result = resetCharacter( GetCritter( targetId ) );
		player.Say( SAY_NETMSG, result.toString( "Reset", "didn't changed anything", "affects character" ) );
	}
}

Result resetCharacter( Critter@ cr )
{
	if( !valid( cr ) )
	{
		return Failure( "critter not found" );
	}
	
	int[] before = statsToList( cr );
	setSkillsBase( cr );
	int[] after = statsToList( cr );
	
	return compareListINT( after, before );
}

class Result
{
	bool value;
	bool failed() { return !value; }
	bool succeed() { return value; }
	
	string description;
	
	Result( bool _value, string _description )
	{
		value = _value;
		description = _description;
	}

	Result( bool _value )
	{
		value = _value;
		description = _value ? "true" : "false";
	}
	
	string toString( string info, string _succeed = "succeed", string _failed = "failed" )
	{
		string line = info + " " + ( succeed() ? "|0xFFFF00 " + _succeed : "|0xFF0000 " + _failed );
		if( failed() )
		{
			line += "|0xAAAAAA " + " ( " + description + " )";
		}		
		return line + "|0x00FF00 " + ".";
	}
}

class Success : Result
{
	Success( string _description )
	{
		value = true;
		description = _description;
	}	
}

class Failure : Result
{
	Failure( string _description )
	{
		value = false;
		description = _description;
	}	
}

Result compareListINT( int[] a, int[] b )
{
	if( a.length() != b.length() )
	{
		return Failure( "a.length(" + a.length() + ") != b.length( " + b.length() + ")" );
	}
	
	for( uint i = 0, l = a.length(); i < l; i++ )
	{
		if( a[i] != b[i] )
		{
			return Failure( "a[" + i + "](" + a[i] + ") != b[" + i + "](" + b[i] + ")" );
		}
	}
	
	return Success( "a[] equals b[]" );
}

int[] statsToList( Critter& cr )
{
	int[] result;
	
	result.insertLast( cr.ParamBase[ SK_SMALL_GUNS ] );
	result.insertLast( cr.ParamBase[ SK_MEDIUM_GUNS ] );
	result.insertLast( cr.ParamBase[ SK_BIG_GUNS] );
	result.insertLast( cr.ParamBase[ SK_UNARMED ] );
	result.insertLast( cr.ParamBase[ SK_MELEE_WEAPONS ] );
	result.insertLast( cr.ParamBase[ SK_THROWING ] );
	result.insertLast( cr.ParamBase[ SK_FIRST_AID ] );
	result.insertLast( cr.ParamBase[ SK_DOCTOR ] );
	result.insertLast( cr.ParamBase[ SK_SNEAK ] );
	result.insertLast( cr.ParamBase[ SK_LOCKPICK ] );
	result.insertLast( cr.ParamBase[ SK_STEAL ] );
	result.insertLast( cr.ParamBase[ SK_TRAPS ] );
	result.insertLast( cr.ParamBase[ SK_SCIENCE ] );
	result.insertLast( cr.ParamBase[ SK_REPAIR ] );
	result.insertLast( cr.ParamBase[ SK_SPEECH ] );
	result.insertLast( cr.ParamBase[ SK_BARTER ] );
	result.insertLast( cr.ParamBase[ SK_GAMBLING ] );
	result.insertLast( cr.ParamBase[ SK_OUTDOORSMAN ] );
	result.insertLast( cr.ParamBase[ SK_MINING ] );
	result.insertLast( cr.ParamBase[ SK_CHOPPING ] );
	result.insertLast( cr.ParamBase[ SK_SCAVENGING ] );
	result.insertLast( cr.ParamBase[ SK_HUNTING ] );
	result.insertLast( cr.ParamBase[ SK_FISHING ] );
	result.insertLast( cr.ParamBase[ SK_FARMING ] );
	result.insertLast( cr.ParamBase[ SK_COOKING ] );
	result.insertLast( cr.ParamBase[ SK_SEX ] );
	
	return result;
}

void setSkillsBase( Critter& cr )
{
	int S = cr.ParamBase[ ST_STRENGTH ];
	int P = cr.ParamBase[ ST_PERCEPTION ];
	int E = cr.ParamBase[ ST_ENDURANCE ];
	int C = cr.ParamBase[ ST_CHARISMA ];
	int I = cr.ParamBase[ ST_INTELLECT ];
	int A = cr.ParamBase[ ST_AGILITY ];
	int L = cr.ParamBase[ ST_LUCK ];
	
	cr.ParamBase[ SK_SMALL_GUNS ] 		= 40 +  6 * A;
	cr.ParamBase[ SK_MEDIUM_GUNS ] 		= 20 +  3 * A;
	cr.ParamBase[ SK_BIG_GUNS ] 	= 20 +  3 * A;
	cr.ParamBase[ SK_UNARMED ] 			= 40 +  4 * A + 4 * S;
	cr.ParamBase[ SK_MELEE_WEAPONS ] 	= 20 +  4 * A + 4 * S;
	cr.ParamBase[ SK_THROWING ] 		= 20 +  6 * A;
	cr.ParamBase[ SK_FIRST_AID ] 		= 20 +  5 * P + 5 * I;
	cr.ParamBase[ SK_DOCTOR ] 			= 20 +  4 * P + 4 * I;
	cr.ParamBase[ SK_SNEAK ] 			=  0;//20 +  5 * A;
	cr.ParamBase[ SK_LOCKPICK ] 		= 10 +  4 * P + 4 * A;
	cr.ParamBase[ SK_STEAL ] 			=  0 + 10 * A;
	cr.ParamBase[ SK_TRAPS ] 			= 10 +  4 * P + 4 * A;
	cr.ParamBase[ SK_SCIENCE ] 			= 20 +  8 * I;
	cr.ParamBase[ SK_REPAIR ] 			= 20 +  6 * I;
	cr.ParamBase[ SK_SPEECH ] 			=  0;//40 +  6 * C;
	cr.ParamBase[ SK_BARTER ] 			= 40 +  8 * C;
	cr.ParamBase[ SK_GAMBLING ] 		=  0;//20 +  8 * L;
	cr.ParamBase[ SK_OUTDOORSMAN ] 		= 40 +  5 * E + 5 * I;
	cr.ParamBase[ SK_MINING ] 			=  0 +  5 * S + 4 * A + 3 * P + 2 * I;
	cr.ParamBase[ SK_CHOPPING ] 		=  0 +  5 * S + 4 * A + 3 * P + 2 * I;
	cr.ParamBase[ SK_SCAVENGING ] 		=  0 +  6 * L + 5 * I + 4 * P + 3 * A + 2 * S;
	cr.ParamBase[ SK_HUNTING ] 			=  0 +  5 * A + 4 * I + 3 * P + 2 * S;
	cr.ParamBase[ SK_FISHING ] 			=  0 +  6 * L + 5 * P + 4 * A + 3 * I + 2 * S;
	cr.ParamBase[ SK_FARMING ] 			=  0 +  5 * I + 4 * P + 3 * S + 2 * A;
	cr.ParamBase[ SK_COOKING ] 			=  0 +  5 * I + 4 * P + 3 * A;
	cr.ParamBase[ SK_SEX ] 				=  0 +  5 * S + 4 * A + 3 * I;
	
	cr.ParamBase[ cr.ParamBase[ TAG_SKILL1 ] ] += 50;
	cr.ParamBase[ cr.ParamBase[ TAG_SKILL2 ] ] += 40;
	cr.ParamBase[ cr.ParamBase[ TAG_SKILL3 ] ] += 30;

	if( cr.ParamBase[ TRAIT_SURE_FOOTED ] != 0 )
	{
		cr.ParamBase[ SK_FIRST_AID ]		+= 25;
		cr.ParamBase[ SK_DOCTOR ]			+= 25;
		cr.ParamBase[ SK_BARTER ]			+= 25;
		cr.ParamBase[ SK_SMALL_GUNS ] 		-= 20;
		cr.ParamBase[ SK_MEDIUM_GUNS ]			-= 20;
		cr.ParamBase[ SK_BIG_GUNS ]	-= 20;
		cr.ParamBase[ SK_UNARMED ]			-= 20;
		cr.ParamBase[ SK_MELEE_WEAPONS ]	-= 20;
		cr.ParamBase[ SK_THROWING ]			-= 20;
	}
	
	if( cr.ParamBase[ TRAIT_SKILLED ] != 0 )
	{
		for( uint i = SK_SMALL_GUNS; i <= SK_OUTDOORSMAN; i++ )
		{
			if( cr.ParamBase[ i ] != 0 )
			{
				cr.ParamBase[ i ] += 10;
			}
		}
	}
	
	cr.ParamBase[ ST_LEVEL ] = 1;
	cr.ParamBase[ ST_EXPERIENCE ] = 0;
	cr.ParamBase[ ST_UNSPENT_SKILL_POINTS ] = 0;

	cr.Say( SAY_NETMSG, "Your stats has been reset." );
}

//~run gm abortOldGMs 0 0 0
void abortOldGMs( Critter& cr, int, int, int )
{
	GameVar@ autoOffOldGMs = GetGlobalVar( GVAR_autoOffOldGMs );		
	autoOffOldGMs.opAssign( CLAMP( 1 - autoOffOldGMs.GetValue(), 0, 1 ) );
	cr.Say( SAY_NETMSG, "Pocket GM mode discard on login is: " + ( autoOffOldGMs.GetValue() == 0 ? "dis" : "en" ) + "abled." );
}

//~run gm gmlist action 0 0
void gmlist( Critter& cr, int action, int p1, int p2 )
{
	string result = "GM list:";
	Critter@[] crs;
	Critter@ GM = null;
	uint count = GetAllPlayers( crs );
	uint n = 1;
	for( uint i = 0; i < count; i++ )
	{
		@ GM = crs[i];
		if( !valid( GM ) )
		{
			continue;
		}
		if( GM.StatBase[ ST_ACCESS_LEVEL ] > 0 )
		{
			result += "\n" + ( n++ ) + ") #" + GM.Id + " " + GetPlayerName( GM.Id );
			switch( action )
			{
				case( 0 ): //enlist
					result += " has " + GM.StatBase[ ST_ACCESS_LEVEL ] + " and is " + ( isPocketGM( GM.Id ) ? "" : "not" ) + " pocket GM. [" + GM.GetAccess() + "]";
					break;
				case( 1 ): //reset
					result += " lost access, and is " + ( isPocketGM( GM.Id ) ? "" : "not" ) + " pocket GM. [" + GM.GetAccess() + "]";
					GM.StatBase[ ST_ACCESS_LEVEL ] = 0;
					break;
				default:
					break;
			}
		}
	}
	cr.Say( SAY_NETMSG, result );
}

//~run gm LoadGMs 0 0 0
void LoadGMs( Critter& cr, int p0, int p1, int p2 )
{
	reloadGMs(cr);
}

void unsafe_GM_getItemsByPid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		GM_getItemsByPid( player, param0, param1, param2, param3, param4 );
	}
}

void GM_getItemsByPid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    getItemsByPid( player, param0, param1, param2 );
}

void getItemsByPid( Critter& player, int pid, int param1, int param2 )
{
    Item@[] items;
    uint count = GetAllItems( pid,  items );
    player.Say( SAY_NETMSG, "Count: " + count );

    Item@ item = null;

    for( uint i = 0; i < count; i++ )
    {
        @item = items[ i ];
        if( !valid( item ) )
            continue;
        switch( item.Accessory )
        {
        case ACCESSORY_HEX:
        {
            Map@ map = GetMap( item.MapId );
            if( !valid( map ) )
            {
                player.Say( SAY_NETMSG, "#" + item.Id + ": map " + item.MapId + " not valid" );
                continue;
            }
            player.Say( SAY_NETMSG, "#" + item.Id + ": map " + map.Id + " (" + item.HexX + ", " + item.HexY + ")" );
        }
        break;
        case ACCESSORY_CRITTER:
        {
            Critter@ cr = GetCritter( item.CritId );
            if( !valid( cr ) )
            {
                player.Say( SAY_NETMSG, "#" + item.Id + ": crit " + item.CritId + " not valid" );
                continue;
            }
            Map@ map = cr.GetMap();
            if( valid( map ) )
            {
                player.Say( SAY_NETMSG, "#" + item.Id + ": crit " + cr.Id + " (map " + map.Id + ": " + cr.HexX + ", " + cr.HexY + ")" );
            }
            else
            {
                player.Say( SAY_NETMSG, "#" + item.Id + ": crit " + cr.Id + " (global)" );
            }
        }
        break;
        case ACCESSORY_CONTAINER:
        {
            Map@ map = GetMap( item.MapId );
            if( !valid( map ) )
            {
                player.Say( SAY_NETMSG, "#" + item.Id + ": map " + item.MapId + " not valid" );
                continue;
            }

            Item@ cont = map.GetItem( item.ContainerId );
            if( !valid( cont ) )
                continue;

            player.Say( SAY_NETMSG, "#" + item.Id + ": map " + map.Id + " (cont " + cont.Id + ": " + cont.HexX + ", " + cont.HexY + ")" );
        }
        break;
        }
    }

	items.resize(0);
}

void delItemsByPid( Critter& player, int pid, int param1, int param2 )
{
    Item@[] items;
    uint count = GetAllItems( pid,  items );

    DeleteItems( items );
	items.resize(0);

    player.Say( SAY_NETMSG, "Deleted " + count + " items." );
}

class Replic
{
    uint   Author;
    uint   Speaker;
    uint8  SayType;
    string Buffer;
    Replic()
    {
        Author = 0;
        Speaker = 0;
        SayType = 0;
        Buffer = "";
    }
}

Replic[] replics;

void unsafe_GM_voice( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		GM_voice( player, param0, param1, param2, param3, param4 );
	}
}

void GM_voice( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    player.ParamBase[ ST_VAR1 ] = param0;
    player.ParamBase[ ST_VAR2 ] = param1;
    ShowInputBoxScreen( player, "gm@unsafe_answer_GM_voice#text", 0, INPUTBOX_CLOSE_ON_ENTER );
}

void unsafe_answer_GM_voice( Critter& player, int skill, int p1, int p2, string@ message, int[] @ p4 )
{
    if( message.length() != 0 )
    {
        Map@ map = player.GetMap();
		int x = player.ParamBase[ ST_VAR1 ];
		int y = player.ParamBase[ ST_VAR2 ];
        map.SetText( x, y, COLOR_GRAY, message );
		SayLog( player, crInfo( player ) + " :" + message + ":" );
		GM_voice( player,  player.ParamBase[ ST_VAR1 ], player.ParamBase[ ST_VAR2 ], 0, null, null );
    }
}

void unsafe_GM_say( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		Say( player, param0, param1, param2 );
	}
}

void GM_say( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Say( player, param0, param1, param2 );
}

void Say( Critter& player, int param0, int param1, int param2 )
{
    if( param0 < 1 )
    {
        return;
    }

    Critter@ cr = GetCritter( uint( param0 ) );

    if( !valid( cr ) )
    {
        player.Say( SAY_NETMSG, "Can't find critter by Id." );
        return;
    }

    if( param1 < 1 || param1 > 11 )
    {
        player.Say( SAY_NETMSG, "Wrong SayType." );
        return;
    }

    player.ParamBase[ ST_VAR1 ] = cr.Id;
    player.ParamBase[ ST_VAR2 ] = param1;
	
	string[] description = { "Text:", "Say:", "SAY_NORM_ON_HEAD", "Shout:", "SAY_SHOUT_ON_HEAD", "Emote:", "SAY_EMOTE_ON_HEAD", "Whisper:", "SAY_WHISP_ON_HEAD", "SAY_NARATIVE", "SAY_RADIO", "Inform:", "Text:" };
	ShowInputBoxScreen( player, "gm@unsafe_answer_GM_say#" + description[CLAMP( uint( param1 ), 0, description.length() - 1 )], 0, INPUTBOX_CLOSE_ON_ENTER );
}

void unsafe_answer_GM_say( Critter& player, int skill, int p1, int p2, string@ message, int[] @ p4 )
{
	int saytype = player.ParamBase[ ST_VAR2 ];

    if( message.length() != 0 )
    {
        Critter@ cr = GetCritter( player.ParamBase[ ST_VAR1 ] );
		if( !valid( cr ) )
		{
			player.Say( SAY_NETMSG, "Target not found!" );
			return;
		}
		
        cr.Say( saytype, ( saytype == SAY_NETMSG ? "|0xFFFF00 " : "" ) + message );
			
		string name;
		
		if(cr.IsPlayer())
		{
			name = GetPlayerName(cr.Id);
		}
		else
		{
			int dialogId = cr.Param[ST_DIALOG_ID] != 0 ? cr.Param[ST_DIALOG_ID] : cr.GetProtoId();
			name = "NPC " + getNpcNamesHolder().getNpcName(dialogId);
		}

		if( saytype == SAY_NETMSG )
		{
			player.Say( SAY_NETMSG, "|0x979998 @" + name + ": " + message );
			SayLog( cr, crInfo( player ) + " @ " + crInfo( cr ) + " < " + message + " >" );
		}
		else
		{
			SayLog( cr, saytype, message, "{ " + crInfo( player ) + " } " );
		}
		
        unsafe_OutMessage( cr, saytype, 0, 0, message, null );
		
		Say( player, player.ParamBase[ ST_VAR1 ], saytype, 0 );
    }
}

void answer_gm_say( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() < 2 || answerS.length() > 64 )
    {
        player.Say( SAY_NETMSG, "Wrong text length." );
        delAuthor( player.Id );
        return;
    }

    uint    len = replics.length();
    Replic@ rep = null;

    for( uint i = 0; i < len; i++ )
    {
        if( replics[ i ].Author != player.Id )
            continue;
        @rep = replics[ i ];
        break;
    }
    if( rep is null )
    {
        player.Say( SAY_NETMSG, "Can't find replic." );
        delAuthor( player.Id );
        return;
    }

    Critter@ cr = GetCritter( rep.Speaker );

    if( cr is null )
    {
        player.Say( SAY_NETMSG, "Can't find critter." );
        delAuthor( player.Id );
        return;
    }

    rep.Buffer += answerS;

    if( answerS[ answerS.length() - 1 ] == '+' )
    {
        rep.Buffer.resize( rep.Buffer.length() - 1 );

        player.ShowScreen( SCREEN_SAY, 0, "answer_gm_say" );
        player.Say( SAY_SAY_TITLE, "Say..." );

        return;
    }

    cr.Say( rep.SayType, rep.Buffer );
    player.Say( SAY_NETMSG, "Ok." );
    delAuthor( player.Id );
}

void delAuthor( uint id )
{
    uint len = replics.length();

    for( uint i = 0; i < len; i++ )
    {
        if( replics[ i ].Author != id )
            continue;
        replics.removeAt( i );
        break;
    }
}

void PlayersHP( Critter& player, int param0, int param1, int param2 )
{
    Critter@[] crs;
    GetAllPlayers( crs );

    for( uint i = 0; i < crs.length(); i++ )
    {
        Critter@ cr = crs[ i ];
        if( cr is null )
            continue;
        player.Say( SAY_NETMSG, "Id: " + cr.Id + " BaseMaxHP: " + cr.StatBase[ ST_MAX_LIFE ] + " MaxHP: " + cr.Stat[ ST_MAX_LIFE ] );
    }
}

void dec15hp( Critter& player, int param0, int param1, int param2 )
{
    if( param0 != 0 )
    {
        Critter@ cr = GetCritter( param0 );
        if( !(cr is null) )
        {
            if( cr.StatBase[ ST_MAX_LIFE ] > 15 )
                cr.StatBase[ ST_MAX_LIFE ] -= 15;
            else
                cr.StatBase[ ST_MAX_LIFE ] = 0;
        }
        return;
    }


    Critter@[] crs;
    GetAllPlayers( crs );

    for( uint i = 0; i < crs.length(); i++ )
    {
        Critter@ cr = crs[ i ];
        if( (cr is null) || cr.StatBase[ ST_MAX_LIFE ] != 15 )
            continue;
        cr.StatBase[ ST_MAX_LIFE ] = 0;
        player.Say( SAY_NETMSG, "Id: " + cr.Id + "  base MaxHP reset to 0." );
    }
}

void dec75hp( Critter& player, int param0, int param1, int param2 )
{
    Critter@[] crs;
    GetAllPlayers( crs );

    for( uint i = 0; i < crs.length(); i++ )
    {
        Critter@ cr = crs[ i ];
        if( (cr is null) || cr.StatBase[ ST_MAX_LIFE ] != 75 )
            continue;
        cr.StatBase[ ST_MAX_LIFE ] = 0;
        player.Say( SAY_NETMSG, "Id: " + cr.Id + "  base MaxHP reset to 0." );
    }
}


void sleep( Critter& player, int param0, int param1, int param2 )
{
    Critter@ cr = null;
    if( param0 > 0 )
    {
        @cr = GetCritter( param0 );
        if( cr is null )
            return;
    }
    else
        @cr = player;

    if( cr.IsKnockout() )
    {
        cr.ParamBase[ ST_CURRENT_AP ] = 0;
        if( cr.Param[ ST_CURRENT_HP ] > 0 )
            cr.ToLife();
    }
    else
        cr.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( param1 == 0 ), 9999, cr.HexX, cr.HexY );
}

uint last_s2a_author = 0;

void unsafe_say2all( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
		_say2all( player, param0, param1, param2, param3, param4 );
}

void _say2all( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@[] crs;
    GetAllPlayers( crs );

    string str = "|0xFFFF0000 ### |0xFFBB33CC " + param3 + " |0xFFFF0000 ### ";

    int   acc = player.GetAccess();

    for( uint i = 0, j = crs.length(); i < j; i++ )
    {
        if( crs[ i ] is null )
            continue;

        if( crs[ i ].GetAccess() >= acc )
            crs[ i ].Say( SAY_NETMSG, "|0xFFFF0000 <|0xFFFFFF00 " + GetPlayerName( player.Id ) + "|0xFFFF0000 >" + str );
        else
            crs[ i ].Say( SAY_NETMSG, str );
    }

    last_s2a_author = player.Id;
}

void unsafe_ans( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@ cr = GetCritter( last_s2a_author );
    if( cr is null )
        return;

    cr.Say( SAY_NETMSG, "s2a-answer |0xFFFF0000 <|0xFFFFFF00 " + GetPlayerName( player.Id ) + "(" + player.Id + ")|0xFFFF0000 > |0xFFBB33CC " + param3 );
}

void unsafe_help( Critter& player, int param0, int param1, int param2, string@ msg, int[] @ param4 )
{
    Critter@[] crs;
    GetAllPlayers( crs );

    string str = "help |0xFFFF0000 <|0xFFFFFF00 " + GetPlayerName( player.Id ) + "(" + player.Id + ")|0xFFFF0000 > |0xFFBB33CC " + msg;

    for( uint i = 0, j = crs.length(); i < j; i++ )
    {
        if( crs[ i ] is null or !isGM( crs[ i ] ) )
            continue;
        crs[ i ].Say( SAY_NETMSG, str );
    }

	SayPrepare( player, crInfo( player ), msg, " <$> " );
}

class Poll
{
    uint   Id;
    uint   InitiatorId;
    string Question;
    uint8  AnsNum;
    string[] Answers;
    uint16[] Votes;

    Poll()
    {
        Id = 0;
        InitiatorId = 0;
        AnsNum = 0;
    }

    Poll@ Set( uint id, uint initiatorId, string& question )
    {
        Id = id;
        InitiatorId = initiatorId;
        Question = question;
        return this;
    }
    Poll@ Add( string& answer )
    {
        AnsNum++;
        Answers.insertLast( answer );
        Votes.insertLast( 0 );
        return this;
    }
    void Vote( uint num )
    {
        if( num >= AnsNum )
            return;
        Votes[ num ] += 1;
    }
}

Poll@[] polls;
uint poll_lastId = 0;

void unsafe_poll( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		_poll( player, param0, param1, param2, param3, param4 );
	}
}

void _poll( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( param3 is null || param3.length() < 10 )
        return;

    string@[] @ parts = splitEx( param3, "@" );

    if( parts is null || parts.length() < 2 || parts.length() > 6 || parts[ 0 ] is null || parts[ 1 ] is null )
        return;

    Poll@ poll = Poll().Set( poll_lastId++, player.Id, parts[ 0 ] );

    for( uint i = 1, j = parts.length(); i < j; i++ )
    {
        if( parts[ i ] is null )
            continue;
        poll.Add( parts[ i ] );
    }
    polls.insertLast( @poll );

    Critter@[] crs;
    GetAllPlayers( crs );

    string str = "|0xFFFF0000 # |0xFFBB33CC Poll started. |0xFFFF0000 #";

    for( uint i = 0, j = crs.length(); i < j; i++ )
    {
        if( crs[ i ] is null )
            continue;

        crs[ i ].Say( SAY_NETMSG, str );
        crs[ i ].ParamBase[ ST_VAR3 ] = poll.Id;
        crs[ i ].ShowScreen( SCREEN_DIALOGBOX, poll.AnsNum, "answer_poll" );
        crs[ i ].Say( SAY_DIALOGBOX_TEXT, poll.Question );
        for( uint k = 0; k < poll.AnsNum; k++ )
        {
            crs[ i ].Say( SAY_DIALOGBOX_BUTTON( k ), poll.Answers[ k ] );
        }
    }

    player.Say( SAY_NETMSG, "Poll Id: " + poll.Id );
}

Poll@ GetPoll( uint8 num )
{
    Poll@ poll = null;
    for( uint i = 0; i < polls.length(); i++ )
    {
        if( polls[ i ] is null or polls[ i ].Id != num )
            continue;
        @poll = polls[ i ];
    }
    return poll;
}

void answer_poll( Critter& cr, uint answerI, string& answerS )
{
    uint  id = cr.Param[ ST_VAR3 ];
    Poll@ poll = GetPoll( uint8( id ) );
    if( poll is null or poll.AnsNum <= answerI )
        return;

    poll.Votes[ answerI ] += 1;

    Critter@ gm = GetCritter( poll.InitiatorId );

    if( @gm != null )
    {
        gm.Say( SAY_NETMSG, "Player " + GetPlayerName( cr.Id ) + "(" + cr.Id + ") chose variant " + answerI );
    }
    cr.ParamBase[ ST_VAR3 ] = -1;
}

void poll_check( Critter& player, int param0, int param1, int param2 )
{
    Poll@ poll = GetPoll( uint8( param0 ) );
    if( poll is null )
    {
        player.Say( SAY_NETMSG, "Poll not found." );
        return;
    }

    player.Say( SAY_NETMSG, "Poll #" + param0 + ": " + poll.Question );
    for( uint i = 0; i < poll.AnsNum; i++ )
    {
        player.Say( SAY_NETMSG, i + ") " + poll.Answers[ i ] + " - " + poll.Votes[ i ] );
    }
}

void poll_end( Critter& player, int param0, int hide, int param2 )
{
    Poll@ poll = GetPoll( uint8( param0 ) );
    if( poll is null )
    {
        player.Say( SAY_NETMSG, "Poll not found." );
        return;
    }

    Critter@[] crs;

    if( hide > 0 )
    {
        crs.resize( 1 );
        @crs[ 0 ] = player;
    }
    else
        GetAllPlayers( crs );

    string str = "Poll #" + param0 + ": \"" + poll.Question + "\" Ended.";
    string[] str0( poll.AnsNum );

    for( uint i = 0; i < poll.AnsNum; i++ )
    {
        str0[ i ] = i + ") " + poll.Answers[ i ] + " - " + poll.Votes[ i ];
    }

    for( uint j = 0, k = crs.length(); j < k; j++ )
    {
        if( crs[ j ] is null )
            continue;

        crs[ j ].Say( SAY_NETMSG, str );
        for( uint i = 0; i < poll.AnsNum; i++ )
        {
            crs[ j ].Say( SAY_NETMSG, str0[ i ] );
        }
    }

    @polls[ poll.Id ] = null;
}

void unsafe_private( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
		_private( player, param0, param1, param2, param3, param4 );
}

void _private( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( param0 < 1 )
        return;
    Critter@ cr = GetCritter( param0 );
    if( cr is null or cr.IsNpc() )
    {
        player.Say( SAY_NETMSG, "Player not found." );
        return;
    }

    string str = "|0xFFFF0000 <|0xFFFFFF00 " + ( ( cr.GetAccess() > ACCESS_TESTER ) ? GetPlayerName( player.Id ) : ( ( player.GetAccess() == ACCESS_ADMIN ) ? "admin" : "gm" ) ) + "|0xFFFF0000 > |0xFFCC33AA " + param3;

    cr.Say( SAY_NETMSG, str );
    player.Say( SAY_NETMSG, "Sent." );
	SayLog( cr, crInfo( player ) + " $ " + crInfo( cr ) + ": " + param3 );
}

void unsafe_GM_name( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
		GM_name( player, param0, param1, param2, param3, param4 );
}

void GM_name( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( param0 < 1 )
        return;
    player.Say( SAY_NETMSG, "Id: " + param0 + " Login: " + GetPlayerName( param0 ) );
}

void name( Critter& cr, int crId, int num, int val )
{
    if( crId < 1 )
        return;
    cr.Say( SAY_NETMSG, "Id: " + crId + " Login: " + GetPlayerName( crId ) );
}

void unsafe_GM_showVal( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
		GM_showVal( player, param0, param1, param2, param3, param4 );
}

void GM_showVal( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    showVal( player, param0, param1, param2 );
}

void showVal( Critter& cr, int itemId, int num, int val )
{
    if( itemId < 1 )
        return;

    Item@ item = GetItem( itemId );
    if( item is null )
        return;

    cr.Say( SAY_NETMSG, "ItemId: " + item.Id );
    cr.Say( SAY_NETMSG, "Val0: " + item.Val0 );
    cr.Say( SAY_NETMSG, "Val1: " + item.Val1 );
    cr.Say( SAY_NETMSG, "Val2: " + item.Val2 );
    cr.Say( SAY_NETMSG, "Val3: " + item.Val3 );
    cr.Say( SAY_NETMSG, "Val4: " + item.Val4 );
    cr.Say( SAY_NETMSG, "Val5: " + item.Val5 );
    cr.Say( SAY_NETMSG, "Val6: " + item.Val6 );
    cr.Say( SAY_NETMSG, "Val7: " + item.Val7 );
    cr.Say( SAY_NETMSG, "Val8: " + item.Val8 );
    cr.Say( SAY_NETMSG, "Val9: " + item.Val9 );
}

void give( Critter& player, int crId, int itemId, int p2 )
{
    Critter@ cr = GetCritter( uint( crId ) );
    if( cr is null )
        return;

    Item@ item = GetItem( itemId );
    if( item is null )
        return;

    uint count = 1;
    if( item.IsStackable() )
    {
        count = item.GetCount();
        if( p2 > 0 && p2 < int( count ) )
            count = p2;
    }
    MoveItem( item, count, cr );
}

void unsafe_gmlex( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
		_gmlex( player, param0, param1, param2, param3, param4 );
}

void _gmlex( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( param0 < 1 )
        return;
    Critter@ cr = GetCritter( param0 );
    if( cr is null or cr.IsNpc() )
    {
        player.Say( SAY_NETMSG, "Player not found." );
        return;
    }

    cr.SetLexems( param3 );
    player.Say( SAY_NETMSG, "Lex asigned." );
}

void unsafe_gmitemlex( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
		_gmitemlex( player, param0, param1, param2, param3, param4 );
}

void _gmitemlex( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( param0 < 1 )
        return;
    Item@ item = GetItem( param0 );
    if( !valid( item ) )
    {
        player.Say( SAY_NETMSG, "Player not found." );
        return;
    }

    item.SetLexems( param3 );
    player.Say( SAY_NETMSG, "Lex asigned." );
}

string[] LightStatusMaker( int storage, string[] list )
{
	string[] result;
	for( uint i = 0, l = list.length(); i < l; i++ )
	{
		result.insertLast( ( FLAG( storage, int( pow( 2, i ) ) ) ? "+" : "-" ) + " " + list[ i ] );
	}
	return result;
}

void unsafe_sinf( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	player.RunClientScript( "client_main@_sinf", isGM( player ) ? player.Param[ CR_SINF_MODE ] : 0, 0, 0, null, null );
}

//MAIN GM MENU CTRL+G
void unsafe_GM_PANNEL_SELF( Critter& cr, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( !isGM( cr ) )
	{
		return;
	}
	StartMenuGMMain( cr );
}

void StartMenuGMMain( Critter& gm )
{
    Map@ map = gm.GetMap();
    if( map is null )
	{
		ShowTeleports( gm );
        return;
    }
	
    iMenuHandler@ handler = MenuGMMain( map );
    iDialogBox@ menu = OpenMenu( gm, "Main GM Menu", handler );
}

class MenuGMMain: CenteredMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMain( Map& map )
	{
        map_id = map.Id;
		level = 0;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );

		if( menu.ButtonMsg( STR_GM_MENU_TELEPORTS ) )
		{
			ShowTeleports( gm );
			return false;
		}		
		
		if( menu.ButtonMsg( STR_GM_MENU_STORAGE ) )
		{
			StoreMenu( gm );
			return false;
		}	
		
		if( menu.ButtonMsg( STR_GM_MENU_MAP_SPAWNERS ) )
		{
			MenuGMSpawners@ menu_spawners = MenuGMSpawners( map );
			menu_spawners.level = level + 1;
			return menu.OpenChild( "Level " + menu_spawners.level, menu_spawners );
		}	
		
		if( menu.ButtonMsg( STR_GM_MENU_GM_VISION ) )
		{
			int vision = gm.ParamBase[ QST_VISION ];
			bool wasOn = vision != 0;
			gm.ParamBase[ QST_VISION ] = ( wasOn ? 0 : 200 );
			gm.Say( SAY_NETMSG, "Vision: " + "|0xFFFF00 " + ( wasOn ? "dis" : "en" ) + "abled." );
			return true;
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_GM_VISION_MODES ) )
		{
			MenuGMSinf@ menu_sinf = MenuGMSinf( map );
			menu_sinf.level = level + 1;
			return menu.OpenChild( "Level " + menu_sinf.level, menu_sinf );
		}
		
		if( __GlobalRain == 0 )
		{
			if( menu.ButtonSayMsg( STR_GM_MENU_RAIN_SIMULATION, STR_GM_MENU_HEADER_INPUT_TIME ) )
			{
				string rainDuration = menu.GetSayValue();
				int val = 0;
				StrToInt( rainDuration, val );
				if( val <= 0 )
				{ 
					gm.Say( SAY_NETMSG, "|0xFFFF00 Value must be more than 0 !!!");
					return true;
				}
				
				uint initial_time = 1;
				uint[] values = { val, initial_time };
				CreateTimeEvent( AFTER( REAL_SECOND( 0 ) ), "weather@e_GlobalRainSimulation", values, true );
				__GlobalRain = 1;
				gm.Say( SAY_NETMSG, "You have set " + "|0xFFFF00 world rain" + "|0x3CF800  for: " + "|0xFFFF00 " + val + "|0x3CF800  minutes.");
				return true;
			}
			
			//if( menu.ButtonSay( "World rain", "Input strength from 0 to 255" ) )
			if( menu.ButtonSayMsg( STR_GM_MENU_WORLD_RAIN, STR_GM_MENU_HEADER_INPUT_STRENGTH ) )
			{
				string rainStr = menu.GetSayValue();
				int val = 0;
				StrToInt( rainStr, val );
				val = CLAMP( val, 0, 255 );
				Map@[] maps;
				for( int i = 0, iend = GetAllMaps( 0, maps ); i < iend; i++ )
				{   
					uint16 pid = maps[ i ].GetProtoId();
					if( GetMapLevelByPid( pid ) == 0 )
					{
						Map@ rmap = maps[i];
						rmap.SetRain( val );
						RainSound( rmap, val );
						applyWatering( rmap );
					}
				}
				gm.Say( SAY_NETMSG, "You have set " + "|0xFFFF00 world rain" + "|0x3CF800  wuth strengh of: " + "|0xFFFF00 " + val + "|0x3CF800 .");
				return true;
			}

			if( menu.ButtonSayMsg( STR_GM_MENU_MAP_RAIN, STR_GM_MENU_HEADER_INPUT_STRENGTH ) )
			{
				string rainStr = menu.GetSayValue();
				int val = 0;
				StrToInt( rainStr, val );
				val = CLAMP( val, 0, 255 );
				map.SetRain( val );
				RainSound( map, val );
				applyWatering( map );
				gm.Say( SAY_NETMSG, "You have set " + "|0xFFFF00 map rain" + "|0x3CF800  wuth strengh of: " + "|0xFFFF00 " + val + "|0x3CF800 .");
				return true;
			}
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_MUSIC ) )
		{
			MenuGMMusic@ menu_music = MenuGMMusic( map );
			menu_music.level = level + 1;
			return menu.OpenChild( "Level " + menu_music.level, menu_music );
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_TIME ) )
		{
			MenuGMTime@ menu_time = MenuGMTime( map );
			menu_time.level = level + 1;
			return menu.OpenChild( "Level " + menu_time.level, menu_time );
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_FACTIONS ) )
		{
			show_faction_list( gm );
			return false;
		}
		
		return true;
    }

    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_MAIN;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }

}

//LVAR AND SPAWN SETTING FOR LOCAL MAP
class MenuGMSpawners: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMSpawners( Map& map )
	{
        map_id = map.Id;
		level = 1;
   }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );

		if( menu.ButtonMsg( STR_GM_MENU_REFRESH_MOBS ) )
		{
			AddCritter( map );
			return true;
		}		
		
		if( menu.ButtonSayMsg( STR_GM_MENU_SET_ALL_TO, STR_GM_MENU_SET_MOB_COUNT ) )
		{
			string amount = menu.GetSayValue();	
			uint len = mob_names + beast_names;
			int val = 0;
			StrToInt( amount, val );
			for( uint i = 0; i < len; i++ )
			{
				GetLocalVar( MAP_MOB_SPAWNER + i, map.Id ).opAssign( val );
			}
			gm.Say( SAY_NETMSG, "You have set: " + "|0xFFFF00 all spawners" +"|0x3CF800  to " + "|0xFFFF00 " + val + " |0x3CF800 mobs.");
			return true;
		}	
		
		if( menu.ButtonMsg( STR_GM_MENU_ANIMAL_SPAWNERS ) )
		{
			MenuGMSpawnersMob@ menu_spawners_mob = MenuGMSpawnersMob( map );
			menu_spawners_mob.level = level + 1;
			return menu.OpenChild( "Level " + menu_spawners_mob.level, menu_spawners_mob );
		}	
		
		if( menu.ButtonMsg( STR_GM_MENU_MONSTER_SPAWNERS ) )
		{
			MenuGMSpawnersBeast@ menu_spawners_beast = MenuGMSpawnersBeast( map );
			menu_spawners_beast.level = level + 1;
			return menu.OpenChild( "Level " + menu_spawners_beast.level, menu_spawners_beast );
		}	
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			level = 0;
			return false;
		}	
		
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_MAP_SPAWNERS_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }

}

//MOB LVAR SETTING FOR LOCAL MAP
class MenuGMSpawnersMob: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMSpawnersMob( Map& map )
	{
        map_id = map.Id;
		level = 2;
   }

	bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
		Map@ map = GetMap( map_id );

		uint len = mob_names; //from local_population_h
		for( uint i = 0; i < len; i++ )
		{
			string mob = STR_INSERT_TEXT_LINE( STR_GM_SPAWNMENU_MOB_START + i );
			string spawners = map.CountEntire( MAP_MOB_SPAWNER + i );
			string spawns = GetLocalVar( MAP_MOB_SPAWNER + i, map.Id ).GetValue();
			string info = "$spawners" + spawners + "$mobSpawns" + spawns 
						+ "$nameMob" + mob;
			if( menu.ButtonSayMsg( STR_GM_MENU_MAP_SPAWNERS_MOB, info, STR_GM_MENU_MAP_SET_NUMBER_MOBS_PER ) )
			{
				string amount = menu.GetSayValue();	
				int val = 0;
				StrToInt( amount, val );
				GetLocalVar( MAP_MOB_SPAWNER + i, map.Id ).opAssign( val );
				gm.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GM_SPAWNMENU_SPAWN_SET_MUL, "$mob" + mob + "$val" + val );
			}
		}
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_MAP_SPAWNERS_MOB_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }	
}

//BEAST LVAR SETTING FOR LOCAL MAP
class MenuGMSpawnersBeast: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMSpawnersBeast( Map& map )
	{
        map_id = map.Id;
		level = 2;
   }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );

		uint len = beast_names; //from local_population_h
		for( uint i = 0; i < len; i++ )
		{
			string mob = STR_INSERT_TEXT_LINE( STR_GM_SPAWNMENU_MONSTER_START + i );
			string spawners = map.CountEntire( MAP_MOB_SPAWNER + 17 + i );
			string spawns = GetLocalVar( MAP_MOB_SPAWNER + 17 + i, map.Id ).GetValue();
			// string info = "[" + spawners + "x" + spawns + "]" + mob;
			string info = "$spawners" + spawners + "$mobSpawns" + spawns 
						+ "$nameMob" + mob;
			if( menu.ButtonSayMsg( STR_GM_MENU_MAP_SPAWNERS_MOB, info, STR_GM_MENU_MAP_SET_NUMBER_MOBS ) )
			{
				string amount = menu.GetSayValue();	
				int val = 0;
				StrToInt( amount, val );
				GetLocalVar( MAP_MOB_SPAWNER + 17 + i, map.Id ).opAssign( val );
				gm.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GM_SPAWNMENU_SPAWN_SET_MUL, "$mob" + mob + "$val" + val );
				return true;
			}
		}

		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}	
		
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_MAP_SPAWNERS_MOB_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }	
}

int[] sinf_menu_list =
{
	STR_GM_MENU_PLAYER_LOGINS		, 	// SINF_LOGINS			( 0x00000001 )
	STR_GM_MENU_ID_IN_DESC			, 	// SINF_ID_CRITS		( 0x00000002 )
	STR_GM_MENU_ID_OVER_HEAD		, 	// SINF_ID_HEADS		( 0x00000004 )
	STR_GM_MENU_ID_IN_CHAT			, 	// SINF_ID_CHAT			( 0x00000008 )
	STR_GM_MENU_ID_ITEMS_IN_CHAT	, 	// SINF_ID_ITEMS		( 0x00000010 )
	STR_GM_MENU_HEX_COORDINATES		, 	// SINF_COORDS			( 0x00000020 )
	STR_GM_MENU_RADIATION_MARKERS	, 	// SINF_RAD_SIGN		( 0x00000040 )
	STR_GM_MENU_CURSOR_SPRITES		, 	// SINF_SPRITES			( 0x00000080 )
	STR_GM_MENU_HEAR_RADIOS			, 	// SINF_RADIO			( 0x00000100 )
	STR_GM_MENU_HEAR_WHISPER		,	// SINF_WHISPER			( 0x00000200 )
	STR_GM_MENU_INFO_DESC			, 	// SINF_DESC_INFO		( 0x00000400 )
	STR_GM_MENU_GAS_MARKERS			,	// SINF_GAS_SIGN		( 0x00000800 )
	STR_GM_MENU_LIGHT_MARKERS		, 	// SINF_LIGHT_SIGN		( 0x00001000 )
	STR_GM_MENU_MOB_HP_PERCENT		, 	// SINF_MOB_HP_PERCENT 	( 0x00002000 )
 	STR_GM_MENU_MOB_LIST			, 	// SINF_MOB_LIST       	( 0x00004000 )
};

class MenuGMSinf: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMSinf( Map& map )
	{
        map_id = map.Id;
		level = 1;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		uint len = sinf_menu_list.length() - 1;

		for( uint i = 0; i < len; i++ )
		{
			uint mask = 1 << i;
			bool status = FLAG( gm.ParamBase[ CR_SINF_MODE ], mask );
			string info = "$gmInfo" + STR_INSERT_TEXT_LINE( sinf_menu_list[i] ) 
						+ "$status" + STR_INSERT_TEXT_LINE( status ? STR_YES : STR_NO );
			if( menu.ButtonMsg(STR_GM_MENU_GMINFO_PATTERN_STR, info ) )
			{
				gm.ParamBase[ CR_SINF_MODE ] = gm.ParamBase[ CR_SINF_MODE ] ^ mask;
				int Smode = gm.Param[ CR_SINF_MODE ];
				gm.RunClientScript( "client_main@_sinf", Smode, 0, 0, null, null );
				return true;
			}
		}

		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}	
		
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GMINFO_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }	
	
}

//LVAR MUSIC CATEGORY SELECTION
class MenuGMMusic: CenteredMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusic( Map& map )
	{
        map_id = map.Id;
		level = 1;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		if( valid( map ) )
		{
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_DISABLE_SOUNDS) )
			{
				Critter@[] players;
				map.GetCritters( 0, FIND_ALL | FIND_ONLY_PLAYERS, players );
				for( uint i = 0; i < players.length(); i ++ )
				{
					Critter@ player = players[i];
					if( valid( player ) && !player.IsNpc() )
					{
						player.RunClientScript( "fofmod@__StopAll", 0, 0, 0, null, null );
					}
				}
			}

			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_ACTION ) )
			{
				MenuGMMusicAction@ menu_music_action = MenuGMMusicAction( map );
				menu_music_action.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_action.level, menu_music_action );
			}
			
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_SUSPENCE ) )
			{
				MenuGMMusicSuspence@ menu_music_suspence = MenuGMMusicSuspence( map );
				menu_music_suspence.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_suspence.level, menu_music_suspence );
			}
			
			if( menu.ButtonMsg(STR_GM_MENU_MUSIC_CRINGE ) )
			{
				MenuGMMusicCringe@ menu_music_Cringe = MenuGMMusicCringe( map );
				menu_music_Cringe.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_Cringe.level, menu_music_Cringe );
			}
			
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_SFX ) )
			{
				MenuGMMusicSFX@ menu_music_SFX = MenuGMMusicSFX( map );
				menu_music_SFX.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_SFX.level, menu_music_SFX );
			}
			
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_TUNES ) )
			{
				MenuGMMusicJukebox@ menu_music_jukebox = MenuGMMusicJukebox( map );
				menu_music_jukebox.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_jukebox.level, menu_music_jukebox );
			}
			
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_FONLINE ) )
			{ 
				MenuGMMusicFonline@ menu_music_fonline = MenuGMMusicFonline( map );
				menu_music_fonline.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_fonline.level, menu_music_fonline );
			}
			
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_NNM ) )
			{
				MenuGMMusicNNM@ menu_music_NNM = MenuGMMusicNNM( map );
				menu_music_NNM.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_NNM.level, menu_music_NNM );
			}
			
			if( menu.ButtonMsg( STR_GM_MENU_MUSIC_OTHER ) )
			{
				MenuGMMusicOther@ menu_music_Other = MenuGMMusicOther( map );
				menu_music_Other.level = level + 1;
				return menu.OpenChild( "Level " + menu_music_Other.level, menu_music_Other );
			}
		}
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}	
		
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
	
}

class MenuGMMusicFonline: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicFonline( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < FonlineMusic.length(); i ++ )
		{
			string music = FonlineMusic[i];
			if( menu.Button( music ) )
			{
				string path = "sound/music/"+music;
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, path );
				return false;
			}
		}
		return true;
    }

	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }

}

class MenuGMMusicAction: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicAction( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < ActionMusic.length(); i ++ )
		{
			string music = ActionMusic[i];
			if( menu.Button( music ) )
			{
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, music );
				return false;
			}
		}
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
	
}

class MenuGMMusicSuspence: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicSuspence( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < SuspenceMusic.length(); i ++ )
		{
			string music = SuspenceMusic[i];
			if( menu.Button( music ) )
			{
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, music );
				return false;
			}
		}
		
		return true;
    }
	
   int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

class MenuGMMusicNNM: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicNNM( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < NNMplaylist.length(); i ++ )
		{
			string music = NNMplaylist[i];
			if( menu.Button( music ) )
			{
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, music );
				return false;
			}
		}
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

class MenuGMMusicOther: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicOther( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < OtherMusic.length(); i ++ )
		{
			string music = OtherMusic[i];
			if( menu.Button( music ) )
			{
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, music );
				return false;
			}
		}
		return true;
    }
	
    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

class MenuGMMusicCringe: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicCringe( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < CringeMusic.length(); i ++ )
		{
			string music = CringeMusic[i];
			if( menu.Button( music ) )
			{
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, music );
				return false;
			}
		}
		return true;
    }
	
    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

class MenuGMMusicSFX: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicSFX( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < GMSFX.length(); i ++ )
		{
			string music = GMSFX[i];
			if( menu.Button( music ) )
			{
				string path = "sound/sfx/" + music;
				PlayMapMusic( map, path );
				return true;
			}
		}
		return true;
    }
	
    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

class MenuGMMusicJukebox: DefaultMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMMusicJukebox( Map& map )
	{
        map_id = map.Id;
		level = 2;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		for( uint i = 0; i < JukeboxMusic.length(); i ++ )
		{
			string music = JukeboxMusic[i];
			if( menu.Button( music ) )
			{
				PlayMusic( map, "DUMMY", 0, 0 );
				PlayMapMusic( map, music );
				return false;
			}
		}
		return true;
    }
	
    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_GENERAL_MUSIC_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

void PlayMapMusic( Map& map, string@ path )
{
	Critter@[] players;
    map.GetCritters( 0, FIND_ALL | FIND_ONLY_PLAYERS, players );
	for( uint i = 0; i < players.length(); i ++ )
	{
		Critter@ player = players[i];
		if( valid( player ) && !player.IsNpc() )
		{
			int timeStamp = GetTick();
			player.RunClientScript( "fofmod@__PlayMapMusic", map.Id, timeStamp, 0, path, null );
		}
	}
}

class MenuGMTime: CenteredMenuHandler
{
    uint map_id;
	uint level;
	
    MenuGMTime( Map& map )
	{
        map_id = map.Id;
		level = 1;
	}

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
		Map@ map = GetMap( map_id );
       	if( menu.ButtonSayMsg( STR_GM_MENU_LOCAL_YEAR_LOCAL, STR_GM_MENU_YEAR_INPUT_FORMAT ) )
		{
			string input = menu.GetSayValue();
			if( input !is null && input.length() == 4 )
			{
				int year = 0;
				if( !StrToInt( input, year ) )
				{
					gm.Say( SAY_NETMSG, "|0xFFFF00 The input does not match the requirements: YYYY" );
					return true;
				}
				GameVar@ DELTA_YEARS = GetLocalVar( LMVAR_DELTA_YEARS, map.Id );

				int year2 = GetGlobalYear();

				int new_delta = year - year2;

				DELTA_YEARS.opAssign( new_delta );	

				Location@ loc = map.GetLocation();
				Map@[] maps;
				loc.GetMaps(maps);
				for( uint i = 0; i < maps.length(); i++ )
				{
					DELTA_YEARS = GetLocalVar( LMVAR_DELTA_YEARS, maps[i].Id );
					DELTA_YEARS.opAssign( new_delta );
				}
				gm.Say( SAY_NETMSG, "New L-Year delta: |0xFFFF00 " + new_delta + "|0x3CF800  years.\nChanged for all |0xFFFF00 " + maps.length() + "|0x3CF800  locations of the Area." );
				return true;
			}
			gm.Say( SAY_NETMSG, "|0xFFFF00The input does not match the requirements: YYYY" );
			return true;
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_LOCAL_YEAR_RESET ) )
		{
			GameVar@ DELTA_YEARS = GetLocalVar( LMVAR_DELTA_YEARS, map.Id );
			DELTA_YEARS.opAssign( 0 );
			gm.Say( SAY_NETMSG, "|0xFFFF00 Local year modifier reset!" );
			return true;
		}
				
		if( menu.ButtonSayMsg( STR_GM_MENU_LOCAL_YEAR_GLOBAL, STR_GM_MENU_YEAR_INPUT_FORMAT ) )
		{
			string input = menu.GetSayValue();
			if( input !is null && input.length() == 4 )
			{
				int year = 0;
				if( !StrToInt( input, year ) )
				{
					gm.Say( SAY_NETMSG, "|0xFFFF00 The input does not match the requirements: YYYY" );
					return true;
				}
				int year2 = GetRealYear();

				__YearShift = year - year2;
				GameVar@ DELTA_YEARS = GetLocalVar( LMVAR_DELTA_YEARS, map.Id );
				DELTA_YEARS.opAssign( 0 );
				gm.Say( SAY_NETMSG, "New G-Year delta: |0xFFFF00 " + __YearShift + "|0x3CF800  years.\nChanged for every location of the world! L-Year reset!!!" );
				return true;
			}
			gm.Say( SAY_NETMSG, "|0xFFFF00 The input does not match the requirements: YYYY" );
			return true;
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_GLOBAL_YEAR_RESET ) )
		{
			__YearShift = 0;
			gm.Say( SAY_NETMSG, "|0xFFFF00 Global and Local year modifier reset!" );
			return true;
		}
		
		bool AdditiveMode = map.GetData( MAP_CURRENT_MODE ) == MAP_CURRENT_MODE_ADDITIVE;
		
		if( menu.ButtonSayMsg( STR_GM_MENU_MAP_TIME_SET ) )
		{
			setTime( map, strToInt( checkNull( menu.GetSayValue(), "0" ) ), AdditiveMode );
			return true;
		}

		if( menu.ButtonMsg( STR_GM_MENU_MAP_TIME_MODE, STR_CHECK_FLAG( "mode", !AdditiveMode ) ) )
		{
			setTime( map, map.GetData( MAP_CURRENT_TIME ), !AdditiveMode );
			return true;
		}
		
		if( menu.ButtonMsg( STR_GM_MENU_MAP_TIME_RESET ) )
		{
			setTime( map, 0, true );
			return true;
		}

		string realDay = "$state" + STR_INSERT_TEXT_LINE( __AllowRealDayTime == 0 ? STR_YES : STR_NO );
		if( menu.ButtonMsg( STR_GM_MENU_REAL_DAY_STATE, realDay ) )
		{
			if( __AllowRealDayTime == 0 )
			{
				__AllowRealDayTime = 1;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Day colour matches physical server time." );
			}
			else
			{
				__AllowRealDayTime = 0;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Day colour matches server time modifier." );
			}
			return true;
		}
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_MENU_REAL_TIME_DESCRIPTION;
	}	
	
    string@ Description( Critter& gm )
	{
		Map@ map = GetMap( map_id );
		uint16 year = 0, month = 0, day = 0, hour = 0, minute = 0, var = 0;
		GetTime( year, month, day, var, hour, minute, var, var ); var = 0;
		
		uint16 _hour = hour, _minute = minute;
		int fullMinute = getMapFullMinute( map, day, _hour, _minute );		
		bool AdditiveMode = map.GetData( MAP_CURRENT_MODE ) == MAP_CURRENT_MODE_ADDITIVE;		
		
		string info = "$time" + STR_INSERT_TEXT_LINE( STR_GM_MENU_MAP_TIME_INFO )
						+ "$global" + DeltaTime_HM( hour * 60 + minute )
						+ "$map" + DeltaTime_HM( fullMinute )
						+ "$delta" + ( AdditiveMode ? DeltaTime_HM( map.GetData( MAP_CURRENT_TIME ) ) : STR_INSERT_TEXT_LINE( STR_GM_MENU_MAP_TIME_STATIC ) ) 
					+ "$timeMul" + __TimeMultiplier
					+ "$yearNow" + year
					+ "$month" + month
					+ "$day" + day
					+ "$yearGlobal" + GetGlobalYear()
					+ "$yearShift" + __YearShift
					+ "$yearLocal" + GetLocalYear( map )
					+ "$yearMod" + GetLocationTimeDeltaYears( map )
				;

		return info;
    }
}

funcdef void funcdef_answer( Critter& , uint , string&  );
dictionary Memmory;

void Back( Critter& critter )
{
	funcdef_answer@ func = null;
	uint answerI = 0;
	string answerS = "";
	
	uint temp = 0;
	Memmory.get( "back_" + critter.Id, temp );

	temp--;
	
	Memmory.get( "back_" + temp + "_" + critter.Id, @func );
	Memmory.get( "back_answerI_" + temp + "_" + critter.Id, answerI );
	Memmory.get( "back_answerS_" + temp + "_" + critter.Id, answerS );
	
	temp--;
	Memmory.set( "back_" + critter.Id, temp );	
	
	if( valid( func ) )
	{
		func( critter, answerI, answerS );
	}
}

void BackParse( Critter& critter, funcdef_answer@ func, uint answerI, string answerS )
{
	uint temp = 0;
	
	Memmory.get( "back_" + critter.Id, temp );
	
	temp++;
	
	Memmory.set( "back_" + temp + "_" + critter.Id, @func );
	Memmory.set( "back_answerI_" + temp + "_" + critter.Id, answerI );
	Memmory.set( "back_answerS_" + temp + "_" + critter.Id, answerS );
	Memmory.set( "back_" + critter.Id, temp );
}

Fraction@ GetMemmoryFraction( Critter& critter )
{
	string faction_name;
	Memmory.get( "faction_" + critter.Id, faction_name );
	return GetFraction( faction_name );
}

string GetFactionNameByIndex( uint index )
{
	return GetList()[index];
}

#define SHOW_FRACTIONS_LIST_COUNT	7

void show_faction_list( Critter& player )
{
	array<string> data = { "gm@answer_GM_PANNEL_FACTION_LIST", "Choose a faction" };
	array<string@> list = GetList();
	
	uint start = CLAMP( uint( player.ParamBase[ CR_VAL0 ] ), 0, list.length / SHOW_FRACTIONS_LIST_COUNT ) * SHOW_FRACTIONS_LIST_COUNT;
	
	for( uint i = 0; i < SHOW_FRACTIONS_LIST_COUNT; i++ )
		data.insertLast( start + i < list.length() ? list[start + i] : "" );
	
	data.insertLast( "Create faction" );
	data.insertLast( ">>>" );
	data.insertLast( "<<<" );
	data.insertLast( "Return" );
	
	DIALOG_MENU( player, data );
}

void answer_GM_PANNEL_FACTION_CREATE( Critter& player, uint answerI, string& answerS )
{
	CreateFraction( answerS );
	Back( player );
}

void answer_GM_PANNEL_FACTION_LIST( Critter& player, uint answerI, string& answerS )
{
	array<string@> list = GetList();
	
	if( answerI == SHOW_FRACTIONS_LIST_COUNT )
	{
		player.ShowScreen( SCREEN_SAY, 0, "answer_GM_PANNEL_FACTION_CREATE" );
		player.Say( SAY_SAY_TITLE, "Input Faction Name" );
		return;
	}
	
	if( answerI == SHOW_FRACTIONS_LIST_COUNT + 1 )
	{
		int step = player.ParamBase[ CR_VAL0 ] + 1;
		if( step > int( list.length() / SHOW_FRACTIONS_LIST_COUNT ) )
			step = 0;		

		player.ParamBase[ CR_VAL0 ] = step;
		
		show_faction_list( player );
		return;
	}
	if( answerI == SHOW_FRACTIONS_LIST_COUNT + 2 )
	{
		int step = player.ParamBase[ CR_VAL0 ] - 1;
		if( step < 0 )
			step = list.length() / SHOW_FRACTIONS_LIST_COUNT;		

		player.ParamBase[ CR_VAL0 ] = step;
		
		show_faction_list( player );
		return;
	}
	
	else if( answerI == SHOW_FRACTIONS_LIST_COUNT + 3 )
	{
		StartMenuGMMain( player );
		return;
	}

	uint index = player.ParamBase[ CR_VAL0 ] * SHOW_FRACTIONS_LIST_COUNT + answerI;
	if( index >= list.length() )
	{
		show_faction_list( player );
		return;
	}
	
	player.ParamBase[ CR_VAL1 ] = player.ParamBase[ CR_VAL0 ];
	Memmory.set( "faction_" + player.Id, GetFactionNameByIndex( index ) );
	array<string> data = { "gm@answer_GM_PANNEL_FACTION", "Faction '" + GetFactionNameByIndex( index ) + "'", "Relationships", "Default Relationship", "Add Player", "Delete", "Return" };
	BackParse( player, @answer_GM_PANNEL_FACTION_LIST, answerI, answerS );
	DIALOG_MENU( player, data );
}

void answer_GM_PANNEL_FACTION( Critter& player, uint answerI, string& answerS )
{
	switch( answerI )
	{
		case 0:
			show_faction_list2( player );				
			BackParse( player, @answer_GM_PANNEL_FACTION, answerI, answerS );
			break;
		case 1:
		{
			Fraction@ faction = GetMemmoryFraction(player);

			string faction_name = "error";
			Memmory.get( "faction_" + player.Id, faction_name );

			if( faction is null )
			{
				player.Say( SAY_NETMSG, "Error, faction: " + faction_name + " not found" );
				return;
			}
			IRelations@ rel = faction.GetRelation( "RelationDefault" );
			if( rel is null )
			{
				player.Say( SAY_NETMSG, "Error, default relations not found" );
				return;
			}
			string current = faction.GetRelation( "RelationDefault" ).Name;
			array<string> data = { "gm@answer_GM_PANNEL_FACTION_SET_RELATIONS", "Standard relation to all:\n\t'" + faction_name + "' == " + colorize_relations( current ), "war","dislike", "neutral", "like","ally", "RETURN" };
			BackParse( player, @answer_GM_PANNEL_FACTION, answerI, answerS );
			Memmory.set( "faction_" + player.Id + "_relkey", "RelationDefault" );
			DIALOG_MENU( player, data );
			break;
		}
		case 2:
			player.ShowScreen( SCREEN_SAY, 0, "answer_GM_PANNEL_FACTION_RELATIONS_PLAYER" );
			player.Say( SAY_SAY_TITLE, "Input login or player Id" );
			break;
		case 3:
			player.ShowScreen( SCREEN_SAY, 0, "answer_GM_DELETE_FACTION" );
			player.Say( SAY_SAY_TITLE, "Repeat name:" );
			break;
		case 4:
			Back( player );
			break;
		default:
			player.Say( SAY_NETMSG, "Error, answer " + answerI + " not found" );
			break;
	}
}

void answer_GM_DELETE_FACTION( Critter& player, uint answerI, string& answerS )
{
	Fraction@ faction = GetMemmoryFraction(player);
	if( faction !is null )
	{
		if( answerS != faction.Name )
			player.Say( SAY_NETMSG, "Error, wrong faction name" );
		else DeleteFraction( faction.Id );
	}
	else player.Say( SAY_NETMSG, "Error, faction not found" );
	
	Back( player );
}

void show_faction_list2( Critter& player )
{
	Fraction@ faction = GetMemmoryFraction(player);
	if( faction is null )
	{
		string faction_name = "error";
		Memmory.get( "faction_" + player.Id, faction_name );
		player.Say( SAY_NETMSG, "Error, faction: " + faction_name + " not found" );
		return;
	}

	array<string> data = {"gm@answer_GM_PANNEL_FACTION_RELATIONS", ""};
	array<string@> list = GetList();
	
	uint start = CLAMP( uint( player.ParamBase[ CR_VAL1 ] ), 0, list.length / SHOW_FRACTIONS_LIST_COUNT ) * SHOW_FRACTIONS_LIST_COUNT;
	string@ title = data[1];
	for( uint i = 0; i < SHOW_FRACTIONS_LIST_COUNT; i++ )
	{
		if( start + i >= list.length() )
		{
			title += "\n";
			data.insertLast( "" );
			continue;
		}
			
		IRelations@ rel = faction.GetRelation( "RelationFaction_" + list[start + i] );
		if( rel is null )
			@rel = faction.GetRelation( "RelationDefault" + list[start + i] );
		title += list[start + i] + ": " + colorize_relations( rel.Name ) + "\n";
		data.insertLast( list[start + i] );
	}
	
	data.insertLast( "With player" );
	data.insertLast( ">>>" );
	data.insertLast( "<<<" );
	data.insertLast( "Return" );
	
	DIALOG_MENU( player, data );
}

void answer_GM_PANNEL_FACTION_RELATIONS( Critter& player, uint answerI, string& answerS )
{
	array<string@> list = GetList();
	
	if( answerI == SHOW_FRACTIONS_LIST_COUNT )
	{
		player.ShowScreen( SCREEN_SAY, 0, "gm@answer_GM_PANNEL_FACTION_RELATIONS_PLAYER" );
		player.Say( SAY_SAY_TITLE, "Input login or player Id" );
		return;
	}
	
	if( answerI == SHOW_FRACTIONS_LIST_COUNT + 1 )
	{
		int step = player.ParamBase[ CR_VAL1 ] + 1;
		if( step > int( list.length() / SHOW_FRACTIONS_LIST_COUNT ) )
			step = 0;		

		player.ParamBase[ CR_VAL1 ] = step;
		
		show_faction_list2( player );
		return;
	}
	
	if( answerI == SHOW_FRACTIONS_LIST_COUNT + 2 )
	{
		int step = player.ParamBase[ CR_VAL1 ] - 1;
		if( step < 0 )
			step = list.length() / SHOW_FRACTIONS_LIST_COUNT;		

		player.ParamBase[ CR_VAL1 ] = step;
		
		show_faction_list2( player );
		return;
	}
	
	else if( answerI == SHOW_FRACTIONS_LIST_COUNT + 3 )
	{
		Back( player );
		return;
	}

	uint index = player.ParamBase[ CR_VAL1 ] * SHOW_FRACTIONS_LIST_COUNT + answerI;
	if( index >= list.length() )
	{
		show_faction_list2( player );
		return;
	}
	
	Fraction@ faction = GetMemmoryFraction(player);
	string current = faction.GetRelation( "RelationFaction_" + list[index] ).Name;
	array<string> data = { "gm@answer_GM_PANNEL_FACTION_SET_RELATIONS", "Relations '" + GetFactionNameByIndex( index ) + "'  '" + list[index] + "':\n\t" + colorize_relations( current ), "war","dislike", "neutral", "like","ally", "RETURN" };
	BackParse( player, @answer_GM_PANNEL_FACTION_RELATIONS, answerI, answerS );
	Memmory.set( "faction_" + player.Id + "_relkey", "RelationFaction_" + list[index] );
	Memmory.set( "faction_" + player.Id + "_name", list[index] );
	DIALOG_MENU( player, data );
}

string colorize_relations( string relation )
{
	if( relation == "war" ) 	return COLOR_RELATIONS_WAR + relation + COLOR_NETMSG;
	if( relation == "dislike" ) return COLOR_RELATIONS_DISLIKE + relation + COLOR_NETMSG;
	if( relation == "neutral" ) return COLOR_RELATIONS_NEUTRAL + relation + COLOR_NETMSG;
	if( relation == "like" ) 	return COLOR_RELATIONS_LIKE + relation + COLOR_NETMSG;
	if( relation == "ally" ) 	return COLOR_RELATIONS_ALLY + relation + COLOR_NETMSG;

	return relation;
}

void answer_GM_PANNEL_FACTION_RELATIONS_PLAYER( Critter& player, uint answerI, string& answerS )
{
	int id = 0;
	if( StrToInt( answerS, id ) )
		answerS = GetPlayerName( id );
		
	Fraction@ faction = GetMemmoryFraction(player);
	string current = faction.GetRelation( "RelationCritter_" + answerS ).Name;
	array<string> data = { "gm@answer_GM_PANNEL_FACTION_SET_RELATIONS", "Relations '" + faction.Name + "'  '" + answerS + "':\n\t" + colorize_relations( current ), "war","dislike", "neutral", "like","ally", "RETURN" };
	BackParse( player, @answer_GM_PANNEL_FACTION_RELATIONS, answerI, answerS );
	Memmory.set( "faction_" + player.Id + "_relkey", "RelationCritter_" + answerS );
	DIALOG_MENU( player, data );
}

void answer_GM_PANNEL_FACTION_SET_RELATIONS( Critter& player, uint answerI, string& answerS )
{
	string key;
	Memmory.get( "faction_" + player.Id + "_relkey", key );

	string[] relation = { "war", "dislike", "neutral", "like", "ally" };
	SetFractionRelation( GetMemmoryFraction(player), key, relation[answerI] );

	if( findFirst( key, "RelationFaction_" ) != -1 )
	{
		string name = "";
		Memmory.get( "faction_" + player.Id + "_name", name );
		
		SetFractionRelation( GetFraction( name ), "RelationFaction_" + GetMemmoryFraction(player).Name, relation[answerI] );
	}

	Back( player );
}

void ask_GM_PANNEL_FACTION_INVATE( Critter& player, uint answerI, string& answerS )
{
	int id = 0;
	if( !StrToInt( answerS, id ) )
		id = GetPlayerId( answerS );
	GetMemmoryFraction(player).AddPlayer( id );
}

bool outOfBounds( int value, int min, int max )
{
	return value < min || value > max;
}

void unsafe_GM_PANNEL_CRITTER_PLAYER( Critter& player, int crId, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( isGM( player ) )
		GM_PANNEL_CRITTER_PLAYER( player, crId, param1, param2, param3, param4 );
}

void GM_PANNEL_CRITTER_PLAYER( Critter& player, int crId, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( !isGM( player ) )
	{
		return;
    }
	
	Critter@ cr = GetCritter( crId );
    if( !valid( cr ) )
	{
        return;
	}
	
	player.StatBase[ ST_VAR0 ] = cr.Id;
	player.ShowScreen( SCREEN_DIALOGBOX, 11, "gm@answer_GM_PANNEL_CRITTER_PLAYER" );
	
	Item@ armor = cr.GetItem( 0, SLOT_ARMOR );
	
	string info = "Actions with critter: " + crId + ".\n" + 
		" CRTYPE " + cr.StatBase[ST_BASE_CRTYPE] + ( valid( armor ) ? " [" + ( cr.Stat[ ST_GENDER ] == GENDER_MALE ? armor.Proto.Armor_CrTypeMale : armor.Proto.Armor_CrTypeFemale ) + "]" : "" ) + 
		" W " + cr.StatBase[ST_WALK_TIME] + " R " + cr.StatBase[ST_RUN_TIME] + ( cr.ParamBase[ CR_FIXED_SPEED ] != 0 ? " FIXED " : "" );
	
	if( cr.IsDead() )
	{
		info += "\nKilled by critter #" + cr.StatBase[ ST_KILLER_PERSON ];
		if( cr.StatBase[ ST_KILLER_PERSON ] != 0 )
		{
			Critter@ killer = GetCritter( cr.StatBase[ ST_KILLER_PERSON ] );
			if( !valid( killer ) )
				info += " [N/A]";
			else
			{
				if( killer.IsPlayer() )
					info += " [player]:\n\t'" + GetPlayerName( killer.Id ) + "'";
				else
					info += " [mob]\nDLG " + killer.Stat[ST_DIALOG_ID] + " PID " + killer.GetProtoId() + "\nBODYTYPE " + killer.StatBase[ ST_BODY_TYPE ] + " SKIN " + killer.StatBase[ ST_BASE_CRTYPE ];
			}
		}
	}
	
	player.Say( SAY_DIALOGBOX_TEXT, info );
	if( cr.ParamBase[ QST_GAMEMODE ] == GAME_START )
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_MODE_START );
	else if( cr.ParamBase[ QST_GAMEMODE ] == GAME_ADVENTURE )
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_MODE_ADVENTURE );
	else if( cr.ParamBase[ QST_GAMEMODE ] == GAME_SURVIVAL )
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_MODE_SURVIVAL );
	else if( cr.ParamBase[ QST_GAMEMODE ] == GAME_TEST )
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_MODE_TEST );
	else
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_MODE_ERROR );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 1 ), TEXTMSG_TEXT, STR_GMBTN_PARAMETERS );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 2 ), TEXTMSG_TEXT, STR_GMBTN_MODERATION );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 3 ), TEXTMSG_TEXT, STR_GMBTN_INVENTORY );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 4 ), TEXTMSG_TEXT, STR_GMBTN_BONUSES );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 5 ), TEXTMSG_TEXT, STR_GMBTN_EFFECTS );			
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 6 ), TEXTMSG_TEXT, STR_GMBTN_RAISE_KO );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 7 ), TEXTMSG_TEXT, STR_GMBTN_KO_FOR_AP );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 8 ), TEXTMSG_TEXT, STR_GMBTN_GIVE_ITEM_PID );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 9 ), TEXTMSG_TEXT, STR_GMBTN_PSY_MODES );
	player.SayMsg( SAY_DIALOGBOX_BUTTON( 10 ), TEXTMSG_TEXT, STR_GMBTN_DEAGGRO_NPC );
}

void answer_GM_PANNEL_CRITTER_PLAYER( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 5, "gm@answer_GM_PANNEL_CRITTER_PLAYER_GAMEMODES" );
        player.Say( SAY_DIALOGBOX_TEXT, "Current mode =" + cr.ParamBase[ QST_GAMEMODE ] + " , Select new mode" );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_MODE_START_BTN );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 1 ), TEXTMSG_TEXT, STR_GMBTN_MODE_ADVENTURE_BTN );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 2 ), TEXTMSG_TEXT, STR_GMBTN_MODE_SURVIVAL_BTN );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 3 ), TEXTMSG_TEXT, STR_GMBTN_MODE_TEST_BTN );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 4 ), TEXTMSG_TEXT, STR_RETURN );
    }
    if( answerI == 1 )
    {
        GameVar@ citizenship = GetLocalVar( LVAR_modoc_citizenship, cr.Id );
        GameVar@ faction = GetLocalVar( LVAR_faction, cr.Id );
        player.ShowScreen( SCREEN_DIALOGBOX, 10, "gm@answer_GM_PANNEL_CRITTER_PLAYER_STATS" );
		
		string[] SPECIAL_names = { "S", "P", "E", "C", "I", "A", "L" };
		string description = "";
		for( uint i = 0; i < SPECIAL_names.length(); i++ )
		{
			//, ..     1 .
			//description += SPECIAL_names[i] + cr.Param[ ST_STRENGTH + i ] + ":" + cr.ParamBase[ ST_STRENGTH + i ] + " ";
			description += SPECIAL_names[i] + cr.Param[ ST_STRENGTH + i ] + " ";
		}
		description += "\nLVL " + cr.StatBase[ ST_LEVEL ] + " EXP " + cr.StatBase[ ST_EXPERIENCE ] + " SP " + cr.StatBase[ ST_UNSPENT_SKILL_POINTS ] + " PP " + cr.StatBase[ ST_UNSPENT_PERKS ];
		
        player.Say( SAY_DIALOGBOX_TEXT, description );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_SPECIAL );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 1 ), TEXTMSG_TEXT, STR_GMBTN_SKILLS );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 2 ), TEXTMSG_TEXT, STR_GMBTN_TRAUMAS );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 3 ), TEXTMSG_TEXT, STR_GMBTN_MODES );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 4 ), TEXTMSG_TEXT, STR_GMBTN_TRAITS );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 5 ), TEXTMSG_TEXT, STR_GMBTN_SKIN_BODYTYPE );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 6 ), TEXTMSG_TEXT, STR_GMBTN_FACTION_NAME, "$name" + GetName( cr.ParamBase[ ST_FACTION ] ) );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 7 ), TEXTMSG_TEXT, STR_GMBTN_EXTRA_PARAMS );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 8 ), TEXTMSG_TEXT, STR_GMBTN_LEXEMS );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 9 ), TEXTMSG_TEXT, STR_RETURN );
    }
	
    if( answerI == 2 )
    {
		Moder_Menu( player );
    }
	
    if( answerI == 3 )
    {
        ShowContainer( player, cr, TRANSFER_FAR_CRIT );
    }
	
    if( answerI == 4 )
    {
		ShowScreen_PlayerGift( player, cr );
	}
	
    if( answerI == 5 )
    {
		int t,h,m,s;
        player.ShowScreen( SCREEN_DIALOGBOX, 7, "gm@answer_GM_PANNEL_CRITTER_PLAYER_EFFECTS" );
        player.Say( SAY_DIALOGBOX_TEXT, "Effects" );
        
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_BLACK_SCREEN_30S );
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 1 ), TEXTMSG_TEXT, STR_GMBTN_WHITE_SCREEN_30S );
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 2 ), TEXTMSG_TEXT, STR_GMBTN_RED_SCREEN_30S );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 3 ), TEXTMSG_TEXT, STR_GMBTN_BLACK_SCREEN_25S );
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 4 ), TEXTMSG_TEXT, STR_GMBTN_WHITE_SCREEN_25S );
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 5 ), TEXTMSG_TEXT, STR_GMBTN_RED_SCREEN_25S );
		player.SayMsg( SAY_DIALOGBOX_BUTTON( 6 ), TEXTMSG_TEXT, STR_GMBTN_REFRESH_TIMOUTS );
	}
	
	if( answerI == 6 )
	{
		unsafe_sleep( cr, Random( 0, 1 ), 1, 0, null, null );
		int state = cr.ParamBase[ CR_SLEEPING_STATE ] != 0 ? STR_GMBTN_TARGET_CANT_GETUP : STR_GMBTN_TARGET_WILL_GETUP;
		player.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GMBTN_TARGET_STATE, "$state" + STR_INSERT_TEXT_LINE( state ) );
		GM_PANNEL_CRITTER_PLAYER( player, player.StatBase[ ST_VAR0 ], 0, 0, null, null );
	}
	
	if( answerI == 7 )
	{
        player.Say( SAY_NETMSG, "WIP" );
	}
	
	if( answerI == 8 )
	{
		player.ShowScreen( SCREEN_SAY, 0, "gm@say_GM_GIVE_ITEM" );
        player.SayMsg( SAY_SAY_TITLE, TEXTMSG_TEXT, STR_GMBTN_TARGET_GIVE_ITEM_PID );
		player.ParamBase[ CR_VAL0 ] = 0;
	}
	
    if( answerI == 9 )
	{
        player.ShowScreen( SCREEN_DIALOGBOX, 5, "gm@answer_GM_PANNEL_CRITTER_PLAYER_STATS_MODES_MEDIUM" );
        player.SayMsg( SAY_DIALOGBOX_TEXT, TEXTMSG_TEXT, STR_GMBTN_PSY_STATE_CURRENT, "$value" + cr.ParamBase[ QST_MEDIUM ] );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 0 ), TEXTMSG_TEXT, STR_GMBTN_PSY_STATE_NO);
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 1 ), TEXTMSG_TEXT, STR_GMBTN_PSY_STATE_ANIMAL_MASTER );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 2 ), TEXTMSG_TEXT, STR_GMBTN_PSY_STATE_FACELESS );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 3 ), TEXTMSG_TEXT,STR_GMBTN_PSY_STATE_VOICE );
        player.SayMsg( SAY_DIALOGBOX_BUTTON( 4 ), TEXTMSG_TEXT, STR_GMBTN_PSY_STATE_MIMIC );
	}

	if( answerI == 10 )
	{
		Critter@[] critters;
		Map@ map = player.GetMap();
		Critter@ crit = null;
		if( valid( map ) )
		{
			uint len = map.GetCrittersHex( cr.HexX, cr.HexY, 100, FIND_ALL | FIND_ONLY_NPC, critters );
			for( uint i = 0; i < len; i++ )
			{
				@ crit = critters[i];
				if( valid( crit ) )
				{
					crit.EraseEnemyFromStack( cr.Id );
					EraseAttackPlane( crit, cr );
				}
			}
			player.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GMBTN_DEAGGRO_NPC_RESULT );
		}
	}
}

void say_GM_GIVE_ITEM( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.StatBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}

	int number = 0;
	if( !StrToInt( answerS, number ) || number <= 0 )
	{
		player.Say( SAY_NETMSG, "Wrong number." );
		answer_GM_PANNEL_CRITTER_PLAYER( player, 8, "" );
		return;
	}
	if( player.ParamBase[ CR_VAL0 ] == 0 )
	{
		player.ShowScreen( SCREEN_SAY, 0, "gm@say_GM_GIVE_ITEM" );
		player.Say( SAY_SAY_TITLE, "Amount:" );
		player.ParamBase[ CR_VAL0 ] = number; //pid
	}
	else
	{
		cr.AddItem( player.ParamBase[ CR_VAL0 ], number );
		player.ParamBase[ CR_VAL0 ] = 0;
		GM_PANNEL_CRITTER_PLAYER( player, cr.Id, 0, 0, null, null );
	}
}

void ShowScreen_PlayerGift( Critter& player, Critter& cr )
{
	player.ShowScreen( SCREEN_DIALOGBOX, 13, "gm@answer_GM_PANNEL_CRITTER_PLAYER_GIFT" );
	player.Say( SAY_DIALOGBOX_TEXT, "Moderation" );
	player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "+Experience" );
	player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Give karma" );
	player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Karma perks" );
	player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "+HP" );
	player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "-HP" );
	player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "+Perk" );
	player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "-Perk" );
	player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "Full heal" );
	player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "Medical Check" );
	player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "WALK " +cr.StatBase[ST_WALK_TIME] );
	player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "RUN " + cr.StatBase[ST_RUN_TIME] );
	player.Say( SAY_DIALOGBOX_BUTTON( 11 ), ( cr.ParamBase[ CR_FIXED_SPEED ] != 0 ? "" : "UN" ) + "FIXED SPEED" );
	player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "Return" );
}

void answer_GM_PANNEL_CRITTER_PLAYER_EFFECTS( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
		
    if( answerI == 0 )
    {
		FlushScreen( cr, COLOR_BLACK, 0, 30000 );
    }
    if( answerI == 1 )
    {
		FlushScreen( cr, COLOR_WHITE, 0, 30000 );
    }
    if( answerI == 2 )
    {
		FlushScreen( cr, COLOR_RED, 0, 30000 );
    }
	if( answerI == 3 )
    {
		FlushScreen( cr, COLOR_BLACK, COLOR_BLACK, 25000 );
    }
	if( answerI == 4 )
    {
		FlushScreen( cr, COLOR_WHITE, COLOR_WHITE, 25000 );
    }
	if( answerI == 5 )
    {
		FlushScreen( cr, COLOR_RED, COLOR_RED, 25000 );
    }
	if( answerI == 6 )
	{
        for( uint i = TIMEOUT_BEGIN; i <= TIMEOUT_END; i++ )
			cr.TimeoutBase[ i ] = __FullSecond;		
	}
}	

void ask_setTimingParam( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() < 1 )
	{
		return;
	}
	
	Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}

	int number = 0;
	if( !StrToInt( answerS, number ) || number <= 0 )
	{
		return;
	}
	
	int param = player.ParamBase[CR_VAL0]; player.ParamBase[CR_VAL0] = 0;
	if( param == 0 )
	{
		return;
	}
	
	int t,h,m,s;
	cr.ParamBase[ param ] = number;
	t = cr.ParamBase[ param ]; h = t / 60 / 60; m = ( t / 60 ) % 60; s = t % 60;
	player.Say( SAY_NETMSG, "Input value " + h + ":" + m + ":" + s + "." );
}

void FullHeal( Critter& cr ) //exported
{
	cr.StatBase[ ST_CURRENT_HP ] = cr.Stat[ ST_MAX_LIFE ];
	cr.StatBase[ ST_HUNGER ] = 1000;
	cr.StatBase[ ST_THIRST ] = 1000;
	cr.StatBase[ ST_DYSPNEA ] = 1000;
	cr.StatBase[ ST_DRUNK ] = 0;
    cr.StatBase[ ST_GLOBAL_OVERDOSE ] = 0;
	cr.StatBase[ ST_WETNESS ] = 0;
	cr.StatBase[ ST_POISONING_LEVEL ] = 0;
	cr.StatBase[ ST_RADIATION_LEVEL ] = 0;
	
	cr.ParamBase[ CR_DIRTINESS ] = 0;
	cr.ParamBase[ CR_DEATH_STAGE ] = 0;
	cr.ParamBase[ ST_BLEED ] = 0;
	
	cr.DamageBase[ DAMAGE_EYE ] = 0;
	cr.DamageBase[ DAMAGE_RIGHT_ARM ] = 0;
	cr.DamageBase[ DAMAGE_LEFT_ARM ] = 0;
	cr.DamageBase[ DAMAGE_RIGHT_LEG ] = 0;
	cr.DamageBase[ DAMAGE_LEFT_LEG ] = 0;
	
	ChangeStatus( cr, CR_STATUS_HEAVY_DMG, 0, false );
	ChangeStatus( cr, CR_STATUS_BULLET_OVER, 0, false );
	ChangeStatus( cr, CR_STATUS_BLOOD_TOXIC, 0, false );
}

void answer_GM_PANNEL_CRITTER_PLAYER_GIFT( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
		
    if( answerI == 0 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_EXPERIENCE;
		player.ParamBase[ ST_VAR2 ] = 0;		
		player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_GIFT_ADD" );

        player.Say( SAY_SAY_TITLE, "Experience [ " + cr.Stat[ST_EXPERIENCE] + " ]" );
		cr.ParamBase[CR_EXP_LOCK] = 1;
    }		
    if( answerI == 1 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_KARMA;
		player.ParamBase[ ST_VAR2 ] = 0;		
		player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_GIFT_ADD" );
        player.Say( SAY_SAY_TITLE, "Karma" );
    }
    if( answerI == 2 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_KARMA" );
        player.Say( SAY_DIALOGBOX_TEXT, "WIP" );
    }	
	
    if( answerI == 3 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_CURRENT_HP;
		player.ParamBase[ ST_VAR2 ] = 0;		
		player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_GIFT_ADD" );
        player.Say( SAY_SAY_TITLE, "HP" );
    }
    if( answerI == 4 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_CURRENT_HP;
		player.ParamBase[ ST_VAR2 ] = 1;		
		player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_GIFT_ADD" );
        player.Say( SAY_SAY_TITLE, "HP" );
    }	
	
    if( answerI == 5 )
    {
		player.ParamBase[ ST_VAR1 ] = PERK_BEGIN;
		player.ParamBase[ ST_VAR2 ] = 0;
        player.ShowScreen( SCREEN_DIALOGBOX, 12, "answer_GM_PANNEL_CRITTER_PLAYER_GIFT_PERK" );
        player.Say( SAY_DIALOGBOX_TEXT, "Select Perk" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Return" );
        for(uint i=1; i<11; i++)
        {
		player.SayMsg( SAY_DIALOGBOX_BUTTON( i ), TEXTMSG_GAME, (10000+player.ParamBase[ ST_VAR1 ]+i)*10+1);
        }
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "Next" );
    }
	
    if( answerI == 6 )
    {
		player.ParamBase[ ST_VAR1 ] = PERK_BEGIN;
		player.ParamBase[ ST_VAR2 ] = 1;
        player.ShowScreen( SCREEN_DIALOGBOX, 12, "answer_GM_PANNEL_CRITTER_PLAYER_GIFT_PERK" );
        player.Say( SAY_DIALOGBOX_TEXT, "Select Perk" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Return" );
        for(uint i=1; i<11; i++)
        {
		player.SayMsg( SAY_DIALOGBOX_BUTTON( i ), TEXTMSG_GAME, (10000+player.ParamBase[ ST_VAR1 ]+i)*10+1);
        }
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "Next" );
    }
    if( answerI == 7 )
    {
		FullHeal( cr );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " full heal " + cr.Name + " " + cr.Id, null );
    }
	
	if( answerI == 8 )
	{
		ProccessDoctorSkill( player, cr, true );
	}
	
    if( answerI == 9 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_WALK_TIME;
		player.ShowScreen( SCREEN_SAY, 0, "gm@answer_setVal" );
        player.Say( SAY_SAY_TITLE, "WALK" );
    }

    if( answerI == 10 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_RUN_TIME;
		player.ShowScreen( SCREEN_SAY, 0, "gm@answer_setVal" );
        player.Say( SAY_SAY_TITLE, "RUN" );
    }

    if( answerI == 11 )
    {
		cr.ParamBase[ CR_FIXED_SPEED ] = cr.ParamBase[ CR_FIXED_SPEED ] == 0 ? 1 : 0;
		answer_GM_PANNEL_CRITTER_PLAYER( player, 4, "" );
    }

    if( answerI == 12 )
    {
        GM_PANNEL_CRITTER_PLAYER( player, cr.Id, 0, 0, null, null );
    }
}

void answer_setVal( Critter& player, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    int parameter = player.Stat[ ST_VAR1 ];
    if( !valid( target ) )
	{
        return;
    }
	
	if( answerS.length() > 0 )
    {
        int number = 0;
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has set parameter " + parameter + " from " + target.ParamBase[ parameter ] + " for player " + target.Name + " " + target.Id + " -V- (BEGINNING) ", null );
        StrToInt( answerS, number );
        target.ParamBase[ parameter ] = number;
        player.Say( SAY_NETMSG, "You have changed " + parameter + " to " + number + " for player " + target.Id + "." );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " have changed parameter " + parameter + " to " + number + " -^- (END)", null );
		ChangeCritterSpeed(target);
	}
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_KARMA( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
	cr.KarmaBase[KARMA_BEGIN + answerI] = cr.Karma[KARMA_BEGIN + answerI] == 0 ? 1 : 0;
	answer_GM_PANNEL_CRITTER_PLAYER_GIFT( player, 2, "" );
}


void answer_GM_PANNEL_CRITTER_PLAYER_GIFT_PERK( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( uint( player.Stat[ ST_VAR0 ] ) );
    if( !valid( cr ) )
	{
        return;
	}
		
    if( answerI == 0 && player.ParamBase[ ST_VAR1 ] > int( PERK_BEGIN + 10 ) )
    {
		player.ParamBase[ ST_VAR1 ] -= 11;
        player.ShowScreen( SCREEN_DIALOGBOX, 12, "answer_GM_PANNEL_CRITTER_PLAYER_GIFT_PERK" );
        player.Say( SAY_DIALOGBOX_TEXT, "Choose Perk" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Back" );
        for(uint i=1; i<11; i++)
			player.SayMsg( SAY_DIALOGBOX_BUTTON( i ), TEXTMSG_GAME, uint( ( 10000 + player.ParamBase[ ST_VAR1 ] + i ) * 10 + 1 ) );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "Forward" );		
    }
    if( answerI == 11 && player.ParamBase[ ST_VAR1 ] < int( PERK_END - 10 ) )
    {
		player.ParamBase[ ST_VAR1 ] += 11;
        player.ShowScreen( SCREEN_DIALOGBOX, 12, "answer_GM_PANNEL_CRITTER_PLAYER_GIFT_PERK" );
        player.Say( SAY_DIALOGBOX_TEXT, "Choose Perk" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Back" );
        for(uint i=1; i<11; i++)
			player.SayMsg( SAY_DIALOGBOX_BUTTON( i ), TEXTMSG_GAME, uint( ( 10000 + player.ParamBase[ ST_VAR1 ] + i ) * 10 + 1 ) );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "Forward" );		
    }	
	
	if( player.Stat[ ST_VAR2 ] == 0 )
	{
		cr.ParamBase[ player.ParamBase[ ST_VAR1 ] + answerI] ++;
		int perkId = player.ParamBase[ ST_VAR1 ] + answerI;	
		player.Say( SAY_NETMSG, "You have increased perk by " + perkId + " for 1 player " + cr.Id );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " increased perk " + perkId + " for +1 " + " for player " + cr.Name + " " + cr.Id, null );
	}
	else
	{
		cr.ParamBase[ player.ParamBase[ ST_VAR1 ] + answerI] --;
		int perkId = player.ParamBase[ ST_VAR1 ] + answerI;
		player.Say( SAY_NETMSG, "You have decreased perk " + perkId + " by 1 for player " + cr.Id );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " decreased perk " + perkId + " by -1 " + " for player " + cr.Name + " " + cr.Id, null );
	}	
}

void ask_GM_PANNEL_CRITTER_PLAYER_GIFT_ADD( Critter& player, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    int parameter = player.Stat[ ST_VAR1 ];
    if( !valid( target ) )
	{
        return;
	}
	
    if( answerS.length() > 0 )
    {
        int number = 0;
        StrToInt( answerS, number );
		if( player.Stat[ ST_VAR2 ] == 0 )
		{
			unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " you have added to " + parameter + " that had. " + target.ParamBase[ parameter ] + " for player " + target.Name + " " + target.Id + " -V- (BEGINNING)", null );
			target.ParamBase[ parameter ] += number;
			player.Say( SAY_NETMSG, "you have increased parameter " + parameter + " by " + number + " for player " + target.Id );
			unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " added to parameter " + parameter + "  +" + number + " -^- (END)", null );
		}
        else
		{
			unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " increased parameter " + parameter + " for value. " + target.ParamBase[ parameter ] + " for player " + target.Name + " " + target.Id + " -V- (BEGINNING)", null );
			target.ParamBase[ parameter ] -= number;
			player.Say( SAY_NETMSG, "you have decreased " + parameter + " for " + number + " for player " + target.Id );
			unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " decreased parameter " + parameter + "  -" + number + " -^- (END)", null );
		}
		ChangeCritterSpeed(target);
	}
	GM_PANNEL_CRITTER_PLAYER( player, target.Id, 0, 0, null, null );
}


void answer_GM_PANNEL_CRITTER_PLAYER_GAMEMODES( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    cr.ParamBase[ QST_GAMEMODE ] = answerI;
    Log_factions( player, cr.Id, 0, answerI, null, null );
}

void answer_GM_PANNEL_CRITTER_PLAYER_BANS( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( cr is null )
        return;
    if( answerI == 0 )
    {
        KickId( player, cr.Id, 0, 0 );
    }
    if( answerI == 1 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 10, "answer_GM_PANNEL_CRITTER_PLAYER_BANS_KILL" );
        player.Say( SAY_DIALOGBOX_TEXT, "Kill player" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Simple Death" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Tourn out side" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Bloody burst" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Burst" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "Ash" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "Blown apart" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "Fire" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "Melt" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "Split" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "Return" );
    }
    if( answerI == 2 )
    {
        GM_PANNEL_CRITTER_PLAYER( player, cr.Id, 0, 0, null, null );
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_BANS_KILL( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}

    if( answerI == 9 )
    {
        GM_PANNEL_CRITTER_PLAYER( player, cr.Id, 0, 0, null, null );
		return;
    }	
	
	killbytype( player, player.Stat[ ST_VAR0 ], answerI, 0, null, null );
}

void ask_GM_PANNEL_CRITTER_PLAYER_BANS_UNBAN( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() > 0 )
    {
        Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
        if( cr is null )
            return;
        int number = 0;
        StrToInt( answerS, number );
        if( number <= 0 )
        {
            player.Say( SAY_NETMSG, "Wrong number" );
            return;
        }
        KickBanIdIp( player, cr.Id, number, 0 ); //    0x????????-0xFFFFFFFF,        .
        player.Say( SAY_NETMSG, "character " + GetPlayerName( cr.Id ) + "(" + cr.Id + ")" + " got IP ban for " + number + " hours" );

		Moder_Menu( player );
    }
}

void Moder_Menu( Critter& player )
{
	player.ShowScreen( SCREEN_DIALOGBOX, 3, "answer_GM_PANNEL_CRITTER_PLAYER_BANS" );
	player.Say( SAY_DIALOGBOX_TEXT, "Moderation" );
	player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Kick" );
	player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Kill" );
	player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "RETURN" );
}

void ask_GM_PANNEL_CRITTER_PLAYER_BANS_KICKBANIP( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() > 0 )
    {
        Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
        if( cr is null )
            return;
        int number = 0;
        StrToInt( answerS, number );
        if( number <= 0 )
        {
            player.Say( SAY_NETMSG, "wrong number" );
            return;
        }
        KickBanIdIp( player, cr.Id, number, 0 );
        player.Say( SAY_NETMSG, "character " + GetPlayerName( cr.Id ) + "(" + cr.Id + ")" + " got IP ban for " + number + " hours" );

		Moder_Menu( player );
    }
}

void ask_GM_PANNEL_CRITTER_PLAYER_BANS_KICKBAN( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() > 0 )
    {
        Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
        if( cr is null )
            return;
        int number = 0;
        StrToInt( answerS, number );
        if( number <= 0 )
        {
            player.Say( SAY_NETMSG, "wrong number" );
            return;
        }
        BanId( player, cr.Id, number, 1 );
        player.Say( SAY_NETMSG, "character " + GetPlayerName( cr.Id ) + "(" + cr.Id + ")" + " got IP ban for " + number + " hours" );

		Moder_Menu( player );
    }
}

void ask_GM_PANNEL_CRITTER_PLAYER_BANS_BAN( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() > 0 )
    {
        Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
        if( cr is null )
            return;
        int number = 0;
        StrToInt( answerS, number );
        if( number <= 0 )
        {
            player.Say( SAY_NETMSG, "wrong number" );
            return;
        }
        BanId( player, cr.Id, number, 0 );
        player.Say( SAY_NETMSG, "character " + GetPlayerName( cr.Id ) + "(" + cr.Id + ")" + "got IP ban for " + number + " hours" );

		Moder_Menu( player );
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 7, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_DIALOGBOX_TEXT, "SPECIAL:" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.ParamBase[ ST_STRENGTH ] + " - strength" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.ParamBase[ ST_PERCEPTION ] + " - perception" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.ParamBase[ ST_ENDURANCE ] + " - endurance" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.ParamBase[ ST_CHARISMA ] + " - charisma" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + cr.ParamBase[ ST_INTELLECT ] + " - intellect" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + cr.ParamBase[ ST_AGILITY ] + " - agility" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + cr.ParamBase[ ST_LUCK ] + " - luck" );
    }
    if( answerI == 1 )
    { 
        player.ShowScreen( SCREEN_DIALOGBOX, 19, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKILL" );
        player.Say( SAY_DIALOGBOX_TEXT, "Skills:" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "[RETURN]" );
		player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.SkillBase[ SK_SMALL_GUNS ] + " - small guns" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.SkillBase[ SK_MEDIUM_GUNS ] + " - big guns" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.SkillBase[ SK_BIG_GUNS ] + " - energy" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + cr.SkillBase[ SK_UNARMED ] + " - unarmed" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + cr.SkillBase[ SK_MELEE_WEAPONS ] + " - melee" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + cr.SkillBase[ SK_THROWING ] + " - thrown" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "" + cr.SkillBase[ SK_FIRST_AID ] + " - first aid" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "" + cr.SkillBase[ SK_DOCTOR ] + " - doctor" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "" + cr.SkillBase[ SK_SNEAK ] + " - sneak" );
        player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "" + cr.SkillBase[ SK_LOCKPICK ] + " - lockpick" );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "" + cr.SkillBase[ SK_STEAL ] + " - stealing" );
        player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "" + cr.SkillBase[ SK_TRAPS ] + " - traps" );
        player.Say( SAY_DIALOGBOX_BUTTON( 13 ), "" + cr.SkillBase[ SK_SCIENCE ] + " - science" );
        player.Say( SAY_DIALOGBOX_BUTTON( 14 ), "" + cr.SkillBase[ SK_REPAIR ] + " - repair" );
        player.Say( SAY_DIALOGBOX_BUTTON( 15 ), "" + cr.SkillBase[ SK_SPEECH ] + " - speach" );
        player.Say( SAY_DIALOGBOX_BUTTON( 16 ), "" + cr.SkillBase[ SK_BARTER ] + " - trade" );
        player.Say( SAY_DIALOGBOX_BUTTON( 17 ), "" + cr.SkillBase[ SK_GAMBLING ] + " - gambling" );
        player.Say( SAY_DIALOGBOX_BUTTON( 18 ), "" + cr.SkillBase[ SK_OUTDOORSMAN ] + " - outdorsman" );
    }
    if( answerI == 2 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 10, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_DAMAGES" );
        player.Say( SAY_DIALOGBOX_TEXT, "Traumas" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.DamageBase[ DAMAGE_EYE ] + " - Eyes" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.DamageBase[ DAMAGE_RIGHT_ARM ] + " - left arm" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.DamageBase[ DAMAGE_LEFT_ARM ] + " - right arm" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.DamageBase[ DAMAGE_RIGHT_LEG ] + " - right leg" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + cr.DamageBase[ DAMAGE_LEFT_LEG ] + " - left leg" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + FLAG( cr.StatBase[ ST_CRSTATUS ], CR_STATUS_BULLET_OVER ) + " - bullet wound" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + FLAG( cr.StatBase[ ST_CRSTATUS ], CR_STATUS_HEAVY_DMG ) + " - heavy wound" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "" + cr.StatBase[ ST_BLEED ] + " - bleeding" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "" + cr.ParamBase[ CR_DIRTINESS ] + " - dirt" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "medical check" );
    }
    if( answerI == 3 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 11, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_MODES" );
        player.Say( SAY_DIALOGBOX_TEXT, "Player flags" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.ModeBase[ MODE_NO_PVP ] + " - NO_PVP" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.ModeBase[ MODE_INVULNERABLE ] + " - INVULNERABLE " );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.ModeBase[ MODE_NO_LOOT ] + " - NO_LOOT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.ModeBase[ MODE_NO_STEAL ] + " - NO_STEAL" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + cr.ModeBase[ MODE_NO_PUSH ] + " - NO_PUSH" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + cr.ModeBase[ MODE_NO_WALK ] + " - NO_WALK" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + cr.ModeBase[ MODE_NO_RUN ] + " - NO_RUN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "" + cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] + " - NO_LOOSE_LIMBS" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "" + cr.ModeBase[ MODE_NO_KNOCK ] + " - NO_KNOCK" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "" + cr.ParamBase[ QST_MEDIUM ] + " - PSY_MODE" );
		player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "" + cr.ModeBase[ MODE_UNLIMITED_AMMO ] + " - UNLIMITED_AMMO" );  //  , 
    }
    if( answerI == 4 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 16, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_TRAITS" );
        player.Say( SAY_DIALOGBOX_TEXT, "TRAITS:" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.TraitBase[ TRAIT_FAST_METABOLISM ] + " - FAST_METABOLISM" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.TraitBase[ TRAIT_BRUISER ] + " - BRUISER" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.TraitBase[ TRAIT_SMALL_FRAME ] + " - SMALL_FRAME" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.TraitBase[ TRAIT_SADIST ] + " - SADIST" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + cr.TraitBase[ TRAIT_FINESSE ] + " - FINESSE" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + cr.TraitBase[ TRAIT_KAMIKAZE ] + " - KAMIKAZE" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + cr.TraitBase[ TRAIT_HEAVY_HANDED ] + " - HEAVY_HANDED" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "" + cr.TraitBase[ TRAIT_FAST_SHOT ] + " - FAST_SHOT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "" + cr.TraitBase[ TRAIT_BLOODY_MESS ] + " - PSYCOPATH" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "" + cr.TraitBase[ TRAIT_NERD ] + " - JINXED" );
        player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "" + cr.TraitBase[ TRAIT_SURE_FOOTED ] + " - GOOD_NATURED" );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "" + cr.TraitBase[ TRAIT_CHEM_RELIANT ] + " - CHEM_RELIANT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "" + cr.TraitBase[ TRAIT_CHEM_RESISTANT ] + " - CHEM_RESISTANT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 13 ), "" + cr.TraitBase[ TRAIT_SEX_APPEAL ] + " - SEXUALITY" );
        player.Say( SAY_DIALOGBOX_BUTTON( 14 ), "" + cr.TraitBase[ TRAIT_SKILLED ] + " - SKILLED" );
        player.Say( SAY_DIALOGBOX_BUTTON( 15 ), "" + cr.TraitBase[ TRAIT_NIGHT_PERSON ] + " - NIGHT_PERSON" );
	}
    if( answerI == 5 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 7, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS" );
        player.Say( SAY_DIALOGBOX_TEXT, "BASE_CRTYPE - " + cr.StatBase[ ST_BASE_CRTYPE ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.StatBase[ ST_BODY_TYPE ] + " - BODY_TYPE" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.StatBase[ ST_BASE_CRTYPE ] + " - BASE_CRTYPE" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "standard" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "tribals" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "civils" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "bandits" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "other" );
    }
    if( answerI == 6 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_FACTION;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "ST_FACTION" );
    }
    if( answerI == 7 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 10, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_PARAM" );
        player.Say( SAY_DIALOGBOX_TEXT, "Extra parameters" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.ParamBase[ ST_CURRENT_HP ] + " ST_CURRENT_HP" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.ParamBase[ ST_MAX_LIFE ] + " ST_MAX_LIFE" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.ParamBase[ ST_AGE ] + " ST_AGE" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.ParamBase[ ST_GENDER ] + " ST_GENDER" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + ( 1000 - cr.StatBase[ ST_DYSPNEA ] ) + " ST_DYSPNEA" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + ( 1000 - cr.StatBase[ ST_HUNGER ] ) + " ST_HUNGER" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + ( 1000 - cr.StatBase[ ST_THIRST ] ) + " ST_THIRST" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "" + cr.StatBase[ ST_POISONING_LEVEL ] + " ST_POISONING_LEVEL" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "" + cr.StatBase[ ST_RADIATION_LEVEL ] + " ST_RADIATION_LEVEL" );
		player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "" + ( cr.StatBase[ ST_DRUNK ] ) + " ST_DRUNK" );
    }
    if( answerI == 8 )
    {
        ShowInputBoxScreen( player, "gm@unsafe_Description#Features", 0, INPUTBOX_CLOSE_ON_ENTER );
    }
    if( answerI == 9 )
    {
        GM_PANNEL_CRITTER_PLAYER( player, cr.Id, 0, 0, null, null );
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_PARAM( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        player.ToLife();
        player.ParamBase[ ST_VAR1 ] = ST_CURRENT_HP;
        player.Say( SAY_SAY_TITLE, "ST_CURRENT_HP" );
    }
    if( answerI == 1 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_MAX_LIFE;
        player.Say( SAY_SAY_TITLE, "ST_MAX_LIFE" );
    }
    if( answerI == 2 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_AGE;
        player.Say( SAY_SAY_TITLE, "ST_AGE" );
    }
    if( answerI == 3 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_GENDER;
        player.Say( SAY_SAY_TITLE, "ST_GENDER" );
    }
    if( answerI == 4 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_DYSPNEA;
        player.Say( SAY_SAY_TITLE, "ST_DYSPNEA" );
    }
    if( answerI == 5 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_HUNGER;
        player.Say( SAY_SAY_TITLE, "ST_HUNGER" );
    }
    if( answerI == 6 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_THIRST;
        player.Say( SAY_SAY_TITLE, "ST_THIRST" );
    }
    if( answerI == 7 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_POISONING_LEVEL;
        player.Say( SAY_SAY_TITLE, "ST_POISONING_LEVEL" );
    }
    if( answerI == 8 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_RADIATION_LEVEL;
        player.Say( SAY_SAY_TITLE, "ST_RADIATION_LEVEL" );
    }
	if( answerI == 9 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_DRUNK;
        player.Say( SAY_SAY_TITLE, "ST_DRUNK" );
    }
    player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
}

void unsafe_Description( Critter& player, int p0, int p1, int p2, string@ message, int[] @ p4 )
{
	Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
	if( !valid( cr ) )
	{
		return;
	}
	cr.SetLexems( message.length() > 1 ? message : null );
}

void unsafe_Set_NPC_AFK( Critter& player, int p0, int p1, int p2, string@ message, int[] @ p4 )
{
	Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
	if( !valid( cr ) )
	{
		return;
	}
	
	if( message.length() > 1 )
	{
		player.Say( SAY_NETMSG, "|0xFFFF00 NPC AFK enabled!" );
		string@ lexem = cr.GetLexems() + "_" + message;
		cr.SetLexems( lexem );
		cr.ParamBase[ CR_AFK_MODE ] = 1;
	}
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_DAMAGES( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
    }
	
	if( answerI == 0 )
    {
        if( cr.ParamBase[ DAMAGE_EYE ] == 0 )
            cr.ParamBase[ DAMAGE_EYE ] = 1;
        else
            cr.ParamBase[ DAMAGE_EYE ] = 0;

		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
    }
    else if( answerI == 1 )
    {
        if( cr.ParamBase[ DAMAGE_RIGHT_ARM ] == 0 )
            cr.ParamBase[ DAMAGE_RIGHT_ARM ] = 1;
        else
            cr.ParamBase[ DAMAGE_RIGHT_ARM ] = 0;

		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
    }
    else if( answerI == 2 )
    {
        if( cr.ParamBase[ DAMAGE_LEFT_ARM ] == 0 )
            cr.ParamBase[ DAMAGE_LEFT_ARM ] = 1;
        else
            cr.ParamBase[ DAMAGE_LEFT_ARM ] = 0;

		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
    }
    else if( answerI == 3 )
    {
        if( cr.ParamBase[ DAMAGE_RIGHT_LEG ] == 0 )
            cr.ParamBase[ DAMAGE_RIGHT_LEG ] = 1;
        else
            cr.ParamBase[ DAMAGE_RIGHT_LEG ] = 0;

		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
    }
    else if( answerI == 4 )
    {
        if( cr.ParamBase[ DAMAGE_LEFT_LEG ] == 0 )
            cr.ParamBase[ DAMAGE_LEFT_LEG ] = 1;
        else
            cr.ParamBase[ DAMAGE_LEFT_LEG ] = 0;

		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
    }
	
	if( answerI == 5 )
	{
		ChangeStatus( cr, CR_STATUS_BULLET_OVER, 0, !FLAG( cr.StatBase[ ST_CRSTATUS ], CR_STATUS_BULLET_OVER ) );
		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
	}
	if( answerI == 6 )
	{
		ChangeStatus( cr, CR_STATUS_HEAVY_DMG, 0, !FLAG( cr.StatBase[ ST_CRSTATUS ], CR_STATUS_HEAVY_DMG ) );
		answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		return;
	}
	if( answerI == 7 )
	{
        player.ParamBase[ ST_VAR1 ] = ST_BLEED;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "ST_BLEED:" );
	}
	if( answerI == 8 )
	{
        player.ParamBase[ ST_VAR1 ] = CR_DIRTINESS;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "CR_DIRTINESS:" );
	}
	if( answerI == 9 )
	{
		ProccessDoctorSkill( player, cr, true );
	}
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 27, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_BODY" );
        player.Say( SAY_DIALOGBOX_TEXT, "ST_BODY_TYPE - " + cr.ParamBase[ ST_BODY_TYPE ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "BT_MEN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "BT_WOMEN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "BT_CHILDREN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "BT_SUPER_MUTANT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "BT_GHOUL" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "BT_BRAHMIN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "BT_RADSCORPION" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "BT_RAT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "BT_FLOATER" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "BT_CENTAUR" );
        player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "BT_ROBOT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "BT_DOG" );
        player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "BT_MANTI" );
        player.Say( SAY_DIALOGBOX_BUTTON( 13 ), "BT_DEATHCLAW" );
        player.Say( SAY_DIALOGBOX_BUTTON( 14 ), "BT_PLANT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 15 ), "BT_GECKO" );
        player.Say( SAY_DIALOGBOX_BUTTON( 16 ), "BT_ALIEN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 17 ), "BT_GIANT_ANT" );
		player.Say( SAY_DIALOGBOX_BUTTON( 18 ), "BT_BIG_BAD_BOSS" );
		player.Say( SAY_DIALOGBOX_BUTTON( 19 ), "BT_GIANT_BEETLE" );
		player.Say( SAY_DIALOGBOX_BUTTON( 20 ), "BT_GIANT_WASP" );
		player.Say( SAY_DIALOGBOX_BUTTON( 21 ), "BT_YAO" );
		player.Say( SAY_DIALOGBOX_BUTTON( 22 ), "BT_SWAMP_LURKER" );
		player.Say( SAY_DIALOGBOX_BUTTON( 23 ), "BT_CROCS" );
		player.Say( SAY_DIALOGBOX_BUTTON( 24 ), "BT_MILLEPEDE" );
		player.Say( SAY_DIALOGBOX_BUTTON( 25 ), "BT_LAVASH" );
		player.Say( SAY_DIALOGBOX_BUTTON( 26 ), "BT_SPIDER" );
    }
    if( answerI == 1 )
    {
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS" );
        player.Say( SAY_SAY_TITLE, "Skin number" );
    }
    if( answerI == 2 )
    {
        cr.ChangeCrType( cr.Stat[ ST_GENDER ] == GENDER_MALE ? CRTYPE_DEFAULT_M : CRTYPE_DEFAULT_F );
        cr.StatBase[ ST_BASE_CRTYPE ] = cr.Stat[ ST_GENDER ] == GENDER_MALE ? CRTYPE_DEFAULT_M : CRTYPE_DEFAULT_F;
    }
    if( answerI == 3 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 6, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_BODY" );
        player.Say( SAY_DIALOGBOX_TEXT, "Current skin - " + cr.ParamBase[ ST_BASE_CRTYPE ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "62 Tribal" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "64 Silik" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "110 Long Hair" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "120 Bold" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "61 Tribal fem" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "63 Tribal pony." );
    }
    if( answerI == 4 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 15, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_CIVIL" );
        player.Say( SAY_DIALOGBOX_TEXT, "Current skin - " + cr.ParamBase[ ST_BASE_CRTYPE ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "33 Blond" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "36 Female" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "37 Hooker" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "39 Black sweater" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "40 Sweater" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "41 Shirt" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "42 Dwarf" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "43 Junkie" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "48 Caravaner" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "72 Suit" );
        player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "73 Kitty" );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "77 Bruiser" );
        player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "57 Doctor" );
        player.Say( SAY_DIALOGBOX_BUTTON( 13 ), "89 Scientist" );
        player.Say( SAY_DIALOGBOX_BUTTON( 14 ), "91 Vic" );
    }
    if( answerI == 5 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 9, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_BATTLE" );
        player.Say( SAY_DIALOGBOX_TEXT, "Current skin - " + cr.ParamBase[ ST_BASE_CRTYPE ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "9 Black" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "34 Punk" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "35 Female" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "45 Bandit" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "82 Chinese Farmer" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "92 Chinese red." );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "93 Chinese blue." );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "94 China Farmer fem" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "87 NCR Cop" );
    }
    if( answerI == 6 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 4, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_MISC" );
        player.Say( SAY_DIALOGBOX_TEXT, "Current skin - " + cr.ParamBase[ ST_BASE_CRTYPE ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "16 Dog" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "17 Mr Handy" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "65 Plant" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "66 Robot" );
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_CIVIL( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        cr.ChangeCrType( 33 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 33;
    }
    if( answerI == 1 )
    {
        cr.ChangeCrType( 36 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 36;
    }
    if( answerI == 2 )
    {
        cr.ChangeCrType( 37 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 37;
    }
    if( answerI == 3 )
    {
        cr.ChangeCrType( 39 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 39;
    }
    if( answerI == 4 )
    {
        cr.ChangeCrType( 40 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 40;
    }
    if( answerI == 5 )
    {
        cr.ChangeCrType( 41 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 41;
    }
    if( answerI == 6 )
    {
        cr.ChangeCrType( 42 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 42;
    }
    if( answerI == 7 )
    {
        cr.ChangeCrType( 43 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 43;
    }
    if( answerI == 8 )
    {
        cr.ChangeCrType( 48 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 48;
    }
    if( answerI == 9 )
    {
        cr.ChangeCrType( 72 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 72;
    }
    if( answerI == 10 )
    {
        cr.ChangeCrType( 73 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 73;
    }
    if( answerI == 11 )
    {
        cr.ChangeCrType( 77 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 77;
    }
    if( answerI == 12 )
    {
        cr.ChangeCrType( 57 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 57;
    }
    if( answerI == 13 )
    {
        cr.ChangeCrType( 89 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 89;
    }
    if( answerI == 14 )
    {
        cr.ChangeCrType( 91 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 91;
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_BATTLE( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        cr.ChangeCrType( 9 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 9;
    }
    if( answerI == 1 )
    {
        cr.ChangeCrType( 34 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 34;
    }
    if( answerI == 2 )
    {
        cr.ChangeCrType( 35 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 35;
    }
    if( answerI == 3 )
    {
        cr.ChangeCrType( 45 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 45;
    }
    if( answerI == 4 )
    {
        cr.ChangeCrType( 82 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 82;
    }
    if( answerI == 5 )
    {
        cr.ChangeCrType( 92 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 92;
    }
    if( answerI == 6 )
    {
        cr.ChangeCrType( 93 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 93;
    }
    if( answerI == 7 )
    {
        cr.ChangeCrType( 94 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 94;
    }
    if( answerI == 8 )
    {
        cr.ChangeCrType( 87 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 87;
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_MISC( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}

	if( answerI == 0 )
    {
        cr.ChangeCrType( 16 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 16;
		cr.StatBase[ ST_BODY_TYPE ] = BT_DOG;
    }
    if( answerI == 1 )
    {
        cr.ChangeCrType( 17 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 17;
		cr.StatBase[ ST_BODY_TYPE ] = BT_ROBOT;
    }
    if( answerI == 2 )
    {
        cr.ChangeCrType( 65 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 65;
		cr.StatBase[ ST_BODY_TYPE ] = BT_PLANT;
    }
    if( answerI == 3 )
    {
        cr.ChangeCrType( 66 );
        cr.StatBase[ ST_BASE_CRTYPE ] = 66;
		cr.StatBase[ ST_BODY_TYPE ] = BT_ROBOT;
    }
}

void ask_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() > 0 )
    {
        int      number = 0;
        if( !StrToInt( answerS, number ) || number < 0 || number > 500 )
		{
            player.Say( SAY_NETMSG, "Input number from 1 to 500." );
            return;
		}
        Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
        if( !valid( cr ) )
        {
            player.Say( SAY_NETMSG, "Character " + player.ParamBase[ ST_VAR0 ] + " not online." );
            return;
        }
        cr.ChangeCrType( number );
        cr.StatBase[ ST_BASE_CRTYPE ] = number;
        player.Say( SAY_NETMSG, "Character skin " + player.ParamBase[ ST_VAR0 ] + " was changed to '" + number + "'." );
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKINS_BODY( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    cr.ParamBase[ ST_BODY_TYPE ] = answerI;
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_TRAITS( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
	cr.TraitBase[TRAIT_BEGIN + answerI] = cr.Trait[TRAIT_BEGIN + answerI] == 0 ? 1 : 0;
	answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 4, "" );
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_MODES( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
        if( cr.ModeBase[ MODE_NO_PVP ] == 0 )
            cr.ModeBase[ MODE_NO_PVP ] = 1;
        else
            cr.ModeBase[ MODE_NO_PVP ] = 0;
			/*player.ParamBase[ QST_VISION ] = 0;*/
    }
    if( answerI == 1 )
    {
        if( cr.ModeBase[ MODE_INVULNERABLE ] == 0 )
            cr.ModeBase[ MODE_INVULNERABLE ] = 1;
        else
            cr.ModeBase[ MODE_INVULNERABLE ] = 0;
    }
    if( answerI == 2 )
    {
        if( cr.ModeBase[ MODE_NO_LOOT ] == 0 )
            cr.ModeBase[ MODE_NO_LOOT ] = 1;
        else
            cr.ModeBase[ MODE_NO_LOOT ] = 0;
    }
    if( answerI == 3 )
    {
        if( cr.ModeBase[ MODE_NO_STEAL ] == 0 )
            cr.ModeBase[ MODE_NO_STEAL ] = 1;
        else
            cr.ModeBase[ MODE_NO_STEAL ] = 0;
    }
    if( answerI == 4 )
    {
        if( cr.ModeBase[ MODE_NO_PUSH ] == 0 )
            cr.ModeBase[ MODE_NO_PUSH ] = 1;
        else
            cr.ModeBase[ MODE_NO_PUSH ] = 0;
    }
    if( answerI == 5 )
    {
        if( cr.ModeBase[ MODE_NO_WALK ] == 0 )
            cr.ModeBase[ MODE_NO_WALK ] = 1;
        else
            cr.ModeBase[ MODE_NO_WALK ] = 0;
    }
    if( answerI == 6 )
    {
        if( cr.ModeBase[ MODE_NO_RUN ] == 0 )
            cr.ModeBase[ MODE_NO_RUN ] = 2;
        else
            cr.ModeBase[ MODE_NO_RUN ] = 0;
    }
    if( answerI == 7 )
    {
        if( cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] == 0 )
            cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] = 1;
        else
            cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] = 0;
    }
    if( answerI == 8 )
    {
        if( cr.ModeBase[ MODE_NO_KNOCK ] == 0 )
            cr.ModeBase[ MODE_NO_KNOCK ] = 1;
        else
            cr.ModeBase[ MODE_NO_KNOCK ] = 0;
		
    }
    if( answerI == 9 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 5, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_MODES_MEDIUM" );
        player.Say( SAY_DIALOGBOX_TEXT, "Default - " + cr.ParamBase[ QST_MEDIUM ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "0 - Default" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "1 - Beast Master (disabled)" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "2 - Faceless" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "3 - Voice" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "4 - Mimic" );
    }
	
    if( answerI == 10 )
    {
        if( cr.ModeBase[ MODE_UNLIMITED_AMMO ] > 0 )
            cr.ModeBase[ MODE_UNLIMITED_AMMO ] = 0;
        else
			cr.ModeBase[ MODE_UNLIMITED_AMMO ] = 1;
		
    }
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_MODES_MEDIUM( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 4 )
    {
        player.ParamBase[ ST_VAR1 ] = QST_MEDIUM;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "ID" );
    }
	else 
	{
		cr.ParamBase[ QST_MEDIUM ] = answerI;
		if( answerI == 2 )
		{
			cr.ParamBase[ QST_MEDIUM ] = -2;
		}
		
		Critter@[] source = { cr };
		Critter@[] crits;
		
		cr.GetMap().GetCrittersSeeing( source, true, FIND_ALL | FIND_ONLY_PLAYERS, crits );

		for( int i = 0, j = crits.length(); i < j; i++ )
		{
			Critter@ crit = crits[ i ];
			if( crit.IsPlayer() )
			{
				crit.RunClientScript( "client_names@_updateNick", cr.Id, 0, 0, null, null );
			}
		}
	}
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SKILL( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    if( answerI == 0 )
    {
		answer_GM_PANNEL_CRITTER_PLAYER( player, 1, "" );
		return;
    }
	
	string[] skill_names = {
		"Small guns", "Big guns", "Energy", "Unarmed", "Melee", "Throwing", "First Aid", "Doctor", "Stealth", 
		"Lockpicking", "Theft", "Traps", "Science", "Repair", "Speech", "Barter", "Gambling", "Outdorsman"
	};

	player.ParamBase[ ST_VAR1 ] = 200 + answerI - 1;

	player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
	player.Say( SAY_SAY_TITLE, skill_names[answerI - 1] );
}

void answer_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
	}
	
    player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
	
    if( answerI == 0 )
    {
        player.ParamBase[ ST_VAR1 ] = 0;
        player.Say( SAY_SAY_TITLE, "Strength" );
    }
    if( answerI == 1 )
    {
        player.ParamBase[ ST_VAR1 ] = 1;
        player.Say( SAY_SAY_TITLE, "Perception" );
    }
    if( answerI == 2 )
    {
        player.ParamBase[ ST_VAR1 ] = 2;
        player.Say( SAY_SAY_TITLE, "Endurance" );
    }
    if( answerI == 3 )
    {
        player.ParamBase[ ST_VAR1 ] = 3;
        player.Say( SAY_SAY_TITLE, "Charisma" );
    }
    if( answerI == 4 )
    {
        player.ParamBase[ ST_VAR1 ] = 4;
        player.Say( SAY_SAY_TITLE, "Intellect" );
    }
    if( answerI == 5 )
    {
        player.ParamBase[ ST_VAR1 ] = 5;
        player.Say( SAY_SAY_TITLE, "Agility" );
    }
    if( answerI == 6 )
    {
        player.ParamBase[ ST_VAR1 ] = 6;
        player.Say( SAY_SAY_TITLE, "Luck" );
    }
}

void ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL( Critter& player, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    int      parameter = player.Stat[ ST_VAR1 ];
    if( !valid( target ) )
	{
        return;
    }
	
	if( answerS.length() > 0 )
    {
        int number = 0;
		if( parameter == ST_FACTION )
		{
			if( answerS == "0" || answerS == " " )
				number = 0;
			else
			{
				number = GetStrHash( answerS );
				if( GetName( number ) == "" )
				{
					player.Say( SAY_NETMSG, "Faction does not exist" );
					return;
				}
			}
		}
		
		else
		{
			StrToInt( answerS, number );
		}
		
		int last_value_base = target.ParamBase[ parameter ];
		int last_value = target.Param[ parameter ];
		
		if( parameter == ST_THIRST || parameter == ST_HUNGER )
		{
			target.ParamBase[ parameter ] = 1000 - number;
		}
		else if( parameter == ST_DYSPNEA )
		{
			target.ParamBase[ parameter ] = 1000 - number;
		}
		else
		{
			target.ParamBase[ parameter ] = number;
		}
		
		string text = "param " + parameter 
						+ " from " + last_value_base + "/" + last_value 
						+ " to " + number + " ( " + target.ParamBase[ parameter ] + "/" + target.Param[ parameter ] + " ) " 
						+ " for critter  " + target.Id + ".";
		
        player.Say( SAY_NETMSG, "You have changed " + text );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " changed " + text, null );
		
		if( parameter == ST_BLEED )
		{
			ChangeStatus( target, CR_STATUS_BLEED, 0, number > 0 );
		}
		
		if( parameter == QST_INVIS )
		{
			target.RefreshVisible();
		}
		
		if( parameter == QST_MEDIUM )
		{
			Critter@[] source = { target };
			Critter@[] crits;
			
			target.GetMap().GetCrittersSeeing( source, true, FIND_ALL | FIND_ONLY_PLAYERS, crits );

			for( int i = 0, j = crits.length(); i < j; i++ )
			{
				crits[i].RunClientScript( "client_names@_updateNick", target.Id, 0, 0, null, null );
			}
		}

		ChangeCritterSpeed(target);
        
		if( parameter >= 0 && parameter <= 6 )
        {
			answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 0, "" );
        }
		
        if( parameter >= 200 && parameter <= 217 )
		{
			answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 1, "" );
		}
		
        if( parameter == ST_CURRENT_HP || parameter == ST_MAX_LIFE || parameter == ST_AGE || parameter == ST_GENDER 
		|| parameter == ST_DYSPNEA || parameter == ST_THIRST || parameter == ST_HUNGER || parameter == ST_POISONING_LEVEL || parameter == ST_RADIATION_LEVEL || parameter == ST_DRUNK )
        {
			answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 7, "" );
		}
		
		if( parameter == ST_BLEED || parameter == CR_DIRTINESS )
		{
			answer_GM_PANNEL_CRITTER_PLAYER_STATS( player, 2, "" );
		}
	}
}

void unsafe_GM_PANNEL_CRITTER_NPC( Critter& player, int crId, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		GM_PANNEL_CRITTER_NPC( player, crId, param1, param2, param3, param4 );
	}
}

void GM_PANNEL_CRITTER_NPC( Critter& player, int crId, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@ cr = GetCritter( crId );
    if( !valid( cr ) || !isGM( player ) )
	{
        return;
	}
	
	player.StatBase[ ST_VAR0 ] = crId;
	player.ShowScreen( SCREEN_DIALOGBOX, 14, "answer_GM_PANNEL_CRITTER_NPC" );

	string ai_script = "\n|0x3CF800 AI_Script: |0xFFFF00 "; 
	uint script_id = cr.GetScriptId();
	ai_script += script_id > 0 ? GetScriptName( script_id ) : "none!";

	string info = "NPC, PID #" + cr.GetProtoId() + ", dialog #" + cr.ParamBase[ ST_DIALOG_ID ] + ".\n" +
				  "CRTYPE " + cr.StatBase[ST_BASE_CRTYPE] + " W " + cr.StatBase[ST_WALK_TIME] + " R " + cr.StatBase[ST_RUN_TIME] +
				 ( cr.ParamBase[ CR_FIXED_SPEED ] != 0 ? " FIXED " : "" ) + "\nTeam Id: |0xFFFF00 " + cr.Stat[ ST_TEAM_ID ] + " |0x3CF800 Aggression: |0xFFFF00 " + ( cr.ParamBase[ CR_IS_AGGRESSIVE ] == 0 ? "Passive" : "Active" )
				 + ai_script;

	
	if( cr.IsDead() )
	{
		info += "\nKilled by critter #" + cr.StatBase[ ST_KILLER_PERSON ];
		if( cr.StatBase[ ST_KILLER_PERSON ] != 0 )
		{
			Critter@ killer = GetCritter( cr.StatBase[ ST_KILLER_PERSON ] );
			if( !valid( killer ) )
			{
				info += " [N/A]";
			}
			else
			{
				if( killer.IsPlayer() )
				{
					info += " [player]:\n\t'" + GetPlayerName( killer.Id ) + "'";
				}
				else
				{
					info += " [mob]\nDLG " + killer.Stat[ST_DIALOG_ID] + " PID " + killer.GetProtoId() + "\nBODYTYPE " + killer.StatBase[ ST_BODY_TYPE ] + " SKIN " + killer.StatBase[ ST_BASE_CRTYPE ];
				}
			}
		}
	}

	player.Say( SAY_DIALOGBOX_TEXT, info );
	player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Modes" );
	player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Parameters" );
	player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "NPC Flags" );
	player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Inventory" );
	player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "Prone/Get up" );
	player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "KO for AP" );
	player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "Give item PID" );
	player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "Psy-mode" );
	player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "Full heal" );
	player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "WALK " +cr.StatBase[ST_WALK_TIME] );
	player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "RUN " + cr.StatBase[ST_RUN_TIME] );
	player.Say( SAY_DIALOGBOX_BUTTON( 11 ), ( cr.ParamBase[ CR_FIXED_SPEED ] != 0 ? "" : "UN" ) + "FIXED SPEED" );
	player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "Name NPC");
	player.Say( SAY_DIALOGBOX_BUTTON( 13 ), ( cr.ParamBase[ CR_AFK_MODE ] == 0 ? "Enable " : "Disable " ) + "AFK Mode");
}

void answer_GM_PANNEL_CRITTER_NPC( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.StatBase[ ST_VAR0 ] );
    if( cr is null )
	{
        return;
    }
	if( answerI == 0 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 14, "answer_GM_PANNEL_CRITTER_NPC_MODES" );
        player.Say( SAY_DIALOGBOX_TEXT, "NPC Flags:" );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "" + cr.ModeBase[ MODE_NO_HOME ] + " - MODE_NO_HOME" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "" + cr.ModeBase[ MODE_NO_ENEMY_STACK ] + " - MODE_NO_ENEMY_STACK" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "" + cr.ModeBase[ MODE_NO_LOOT ] + " - MODE_NO_LOOT" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "" + cr.ModeBase[ MODE_NO_STEAL ] + " - MODE_NO_STEAL" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "" + cr.ModeBase[ MODE_NO_PUSH ] + " - MODE_NO_PUSH" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "" + cr.ModeBase[ MODE_NO_WALK ] + " - MODE_NO_WALK" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "" + cr.ModeBase[ MODE_NO_RUN ] + " - MODE_NO_RUN" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "" + cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] + " - MODE_NO_LOOSE_LIMBS" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "" + cr.ModeBase[ MODE_NO_KNOCK ] + " - MODE_NO_KNOCK" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "" + cr.ModeBase[ MODE_NO_BARTER ] + " - MODE_NO_BARTER" );
        player.Say( SAY_DIALOGBOX_BUTTON( 10 ), "" + cr.ModeBase[ MODE_BARTER_ONLY_CASH ] + " - MODE_BARTER_ONLY_CASH" );
        player.Say( SAY_DIALOGBOX_BUTTON( 11 ), "" + cr.ModeBase[ MODE_NO_TALK ] + " - MODE_NO_TALK" );
        player.Say( SAY_DIALOGBOX_BUTTON( 12 ), "" + cr.ModeBase[ MODE_UNLIMITED_AMMO ] + " - MODE_UNLIMITED_AMMO" );
        player.Say( SAY_DIALOGBOX_BUTTON( 13 ), "" + cr.ModeBase[ MODE_INVULNERABLE ] + " - MODE_INVULNERABLE" );
    }
    if( answerI == 1 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 10, "answer_GM_PANNEL_CRITTER_PLAYER_STATS" );
		
		string[] SPECIAL_names = { "S", "P", "E", "C", "I", "A", "L" };
		string description = "param, protoId - " + cr.GetProtoId() + ", dialog - " + cr.ParamBase[ ST_DIALOG_ID ] + "\n";
		for( uint i = 0; i < SPECIAL_names.length(); i++ )
		{
			description += SPECIAL_names[i] + cr.Param[ ST_STRENGTH + i ] + " ";
		}
		description += "\nLVL " + cr.StatBase[ ST_LEVEL ] + " EXP " + cr.StatBase[ ST_EXPERIENCE ] + " SP " + cr.StatBase[ ST_UNSPENT_SKILL_POINTS ] + " PP " + cr.StatBase[ ST_UNSPENT_PERKS ];
		
		player.Say( SAY_DIALOGBOX_TEXT, description );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "SPECIAL" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "SKILLS" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Traumas" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Modes" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "Traits" );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "Skin/bodytype" );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "Faction" );
        player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "Extra Param" );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "Lex" );
        player.Say( SAY_DIALOGBOX_BUTTON( 9 ), "Return" );
    }
    if( answerI == 2 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 8, "answer_GM_PANNEL_CRITTER_NPC_STATS" );
        player.Say( SAY_DIALOGBOX_TEXT, "NPC params, protoId - " + cr.GetProtoId() + ", dialog - " + cr.ParamBase[ ST_DIALOG_ID ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Dialog " + cr.ParamBase[ ST_DIALOG_ID ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "AI_ID "  + cr.ParamBase[ ST_AI_ID ]  );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "NPC ROLE " + cr.ParamBase[ ST_NPC_ROLE ]  );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Master Id " + cr.ParamBase[ MERC_MASTER_ID ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "TEAM_ID " + cr.ParamBase[ ST_TEAM_ID ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "Faction: " + GetName( cr.ParamBase[ ST_FACTION ] ) );
        player.Say( SAY_DIALOGBOX_BUTTON( 6 ), "Rank( disabled ): " + cr.ParamBase[ ST_FR_LEADERSHIP ] );
		player.Say( SAY_DIALOGBOX_BUTTON( 7 ), "Aggression: " + ( cr.ParamBase[ CR_IS_AGGRESSIVE ] == 0 ? "Passive" : "Active" ) );
        player.Say( SAY_DIALOGBOX_BUTTON( 8 ), "Return" );
    }
    if( answerI == 3 )
    {
        ShowContainer( player, cr, TRANSFER_FAR_CRIT );
    }
    else if( answerI == 4 )
    {
		unsafe_sleep( cr, Random( 0, 1 ), 1, 0, null, null );
		player.Say( SAY_NETMSG, "Target " + ( cr.ParamBase[ CR_SLEEPING_STATE ] != 0 ? "can't get up" : "will get up soon" ) + "." );
		GM_PANNEL_CRITTER_NPC( player, player.StatBase[ ST_VAR0 ], 0, 0, null, null );
    }
    else if( answerI == 5 )
    {
        player.Say( SAY_NETMSG, "WIP" );
    }
	else if( answerI == 6 )
	{
		player.ShowScreen( SCREEN_SAY, 0, "gm@say_GM_GIVE_ITEM" );
        player.Say( SAY_SAY_TITLE, "Item PID:" );
		player.ParamBase[ CR_VAL0 ] = 0;
	}
    if( answerI == 7 )
	{
        player.ShowScreen( SCREEN_DIALOGBOX, 5, "answer_GM_PANNEL_CRITTER_PLAYER_STATS_MODES_MEDIUM" );
        player.Say( SAY_DIALOGBOX_TEXT, "Current mode - " + cr.ParamBase[ QST_MEDIUM ] );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "0 - default" );
        player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "1 - beat master (disabled)" );
        player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "2 - faceless" );
        player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "3 - voice" );
        player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "4 - mimic" );
	}
    if( answerI == 8 )
	{
		FullHeal( cr );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " healed NPC " + cr.Name + " " + cr.Id, null );
	}
    if( answerI == 9 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_WALK_TIME;
		player.ShowScreen( SCREEN_SAY, 0, "gm@answer_setVal" );
        player.Say( SAY_SAY_TITLE, "WALK" );
    }

    if( answerI == 10 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_RUN_TIME;
		player.ShowScreen( SCREEN_SAY, 0, "gm@answer_setVal" );
        player.Say( SAY_SAY_TITLE, "RUN" );
    }

    if( answerI == 11 )
    {
		cr.ParamBase[ CR_FIXED_SPEED ] = cr.ParamBase[ CR_FIXED_SPEED ] == 0 ? 1 : 0;
		GM_PANNEL_CRITTER_NPC( player, player.StatBase[ ST_VAR0 ], 0, 0, null, null );
    }
	
	if( answerI == 12 )
	{
		cr.ParamBase[ QST_MEDIUM ] = 3;
		cr.ParamBase[ CR_AFK_MODE ] = 0;
		player.Say( SAY_NETMSG, "|0xFFFF00 NPC psy mode set to voice!" );
		ShowInputBoxScreen( player, "gm@unsafe_Description#Features", 0, INPUTBOX_CLOSE_ON_ENTER );
	}
	
	if( answerI == 13 )
	{
		if( cr.ParamBase[ CR_AFK_MODE ] == 1 )
		{
			player.Say( SAY_NETMSG, "|0xFFFF00 NPC AFK disabled!" );
			string@ lexem = cr.GetLexems();
			uint index = findFirstOf( lexem, "_", 0 );
			string oldLex = substring( lexem, 0, index );
			cr.SetLexems( oldLex );
			cr.ParamBase[ CR_AFK_MODE ] = 0;
		}
		else
		{
			ShowInputBoxScreen( player, "gm@unsafe_Set_NPC_AFK#Set AFK Lexem", 0, INPUTBOX_CLOSE_ON_ENTER );
		}
	}
}

void answer_GM_PANNEL_CRITTER_NPC_STATS( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.Stat[ ST_VAR0 ] );
    if( cr is null )
        return;
    if( answerI == 0 )
    {
        player.ToLife();
        player.ParamBase[ ST_VAR1 ] = ST_DIALOG_ID;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "DIALOG_ID" );
    }
    if( answerI == 1 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_AI_ID;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "AI_ID" );
    }
    if( answerI == 2 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_NPC_ROLE;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "NPC_ROLE" );
    }
    if( answerI == 3 )
    {
        player.ParamBase[ ST_VAR1 ] = MERC_MASTER_ID;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "MERC_MASTER_ID" );
    }
    if( answerI == 4 )
    {
        player.ParamBase[ ST_VAR1 ] = ST_TEAM_ID;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "TEAM_ID" );
    }
	else if( answerI == 5 )
	{
        player.ParamBase[ ST_VAR1 ] = ST_FACTION;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "ST_FACTION" );
	}
	else if( answerI == 6 )
	{
        player.ParamBase[ ST_VAR1 ] = ST_FR_LEADERSHIP;
        player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_CRITTER_PLAYER_STATS_SPECIAL" );
        player.Say( SAY_SAY_TITLE, "ST_FR_LEADERSHIP" );
	}
    if( answerI == 7 )
    {
        cr.ParamBase[CR_IS_AGGRESSIVE] = CLAMP( 1 - cr.ParamBase[CR_IS_AGGRESSIVE], 0, 1 );// == 0 ? "" : ""
		answer_GM_PANNEL_CRITTER_NPC( player, 2, "" );
		return;
    }
    if( answerI == 8 )
    {
        GM_PANNEL_CRITTER_NPC( player, cr.Id, 0, 0, null, null );
    }
}

void answer_GM_PANNEL_CRITTER_NPC_MODES( Critter& player, uint answerI, string& answerS )
{
    Critter@ cr = GetCritter( player.ParamBase[ ST_VAR0 ] );
    if( !valid( cr ) )
	{
        return;
    }
	
	if( answerI == 0 )
    {
        if( cr.ModeBase[ MODE_NO_HOME ] == 0 )
            cr.ModeBase[ MODE_NO_HOME ] = 1;
        else
            cr.ModeBase[ MODE_NO_HOME ] = 0;
    }
    if( answerI == 1 )
    {
        if( cr.ModeBase[ MODE_NO_ENEMY_STACK ] == 0 )
            cr.ModeBase[ MODE_NO_ENEMY_STACK ] = 1;
        else
            cr.ModeBase[ MODE_NO_ENEMY_STACK ] = 0;
    }
    if( answerI == 2 )
    {
        if( cr.ModeBase[ MODE_NO_LOOT ] == 0 )
            cr.ModeBase[ MODE_NO_LOOT ] = 1;
        else
            cr.ModeBase[ MODE_NO_LOOT ] = 0;
    }
    if( answerI == 3 )
    {
        if( cr.ModeBase[ MODE_NO_STEAL ] == 0 )
            cr.ModeBase[ MODE_NO_STEAL ] = 1;
        else
            cr.ModeBase[ MODE_NO_STEAL ] = 0;
    }
    if( answerI == 4 )
    {
        if( cr.ModeBase[ MODE_NO_PUSH ] == 0 )
            cr.ModeBase[ MODE_NO_PUSH ] = 1;
        else
            cr.ModeBase[ MODE_NO_PUSH ] = 0;
    }
    if( answerI == 5 )
    {
        if( cr.ModeBase[ MODE_NO_WALK ] == 0 )
            cr.ModeBase[ MODE_NO_WALK ] = 1;
        else
            cr.ModeBase[ MODE_NO_WALK ] = 0;
    }
    if( answerI == 6 )
    {
        if( cr.ModeBase[ MODE_NO_RUN ] == 0 )
            cr.ModeBase[ MODE_NO_RUN ] = 2;
        else
            cr.ModeBase[ MODE_NO_RUN ] = 0;
    }
    if( answerI == 7 )
    {
        if( cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] == 0 )
            cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] = 1;
        else
            cr.ModeBase[ MODE_NO_LOOSE_LIMBS ] = 0;
    }
    if( answerI == 8 )
    {
        if( cr.ModeBase[ MODE_NO_KNOCK ] == 0 )
            cr.ModeBase[ MODE_NO_KNOCK ] = 1;
        else
            cr.ModeBase[ MODE_NO_KNOCK ] = 0;
    }
    if( answerI == 9 )
    {
        if( cr.ModeBase[ MODE_NO_BARTER ] == 0 )
            cr.ModeBase[ MODE_NO_BARTER ] = 1;
        else
            cr.ModeBase[ MODE_NO_BARTER ] = 0;
    }
    if( answerI == 10 )
    {
        cr.ModeBase[ MODE_BARTER_ONLY_CASH ] = ( cr.ModeBase[ MODE_BARTER_ONLY_CASH ] + 1 ) % 3;
    }
    if( answerI == 11 )
    {
        if( cr.ModeBase[ MODE_NO_TALK ] == 0 )
            cr.ModeBase[ MODE_NO_TALK ] = 1;
        else
            cr.ModeBase[ MODE_NO_TALK ] = 0;
    }
    if( answerI == 12 )
    {
        if( cr.ModeBase[ MODE_UNLIMITED_AMMO ] == 0 )
            cr.ModeBase[ MODE_UNLIMITED_AMMO ] = 1;
        else
            cr.ModeBase[ MODE_UNLIMITED_AMMO ] = 0;
    }
    if( answerI == 13 )
    {
        if( cr.ModeBase[ MODE_INVULNERABLE ] == 0 )
            cr.ModeBase[ MODE_INVULNERABLE ] = 1;
        else
            cr.ModeBase[ MODE_INVULNERABLE ] = 0;
    }
	answer_GM_PANNEL_CRITTER_NPC( player, 0, "" );
}


void unsafe_GM_PANNEL_ITEM( Critter& player, int itemId, int param1, int param2, string@ param3, int[] @ param4 )
{
    if( isGM( player ) )
	{
		GM_PANNEL_ITEM( player, itemId, param1, param2, param3, param4 );
	}
}

void GM_PANNEL_ITEM( Critter& player, int itemId, int param1, int param2, string@ param3, int[] @ param4 )
{ 
	GM_ItemPanel( player, itemId ); 
}
	
void GM_ItemPanel( Critter& player, int itemId )
{
    if( !isGM( player ) )
	{
		return;
    }
	
    Item@ item = GetItem( itemId );
	if( !valid( item ) )
	{
		return;
	}
	
	player.StatBase[ ST_VAR0 ] = itemId;
	
	bool isCont = item.GetType() == ITEM_TYPE_CONTAINER;
	player.ShowScreen( SCREEN_DIALOGBOX, 6, "answer_GM_PANNEL_ITEM" );
	
	player.Say( SAY_DIALOGBOX_TEXT, FullItemInfo(item) );
	player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Variables" );
	player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "enable script" );
	player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Flags #1" );
	player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Flags #2" );
	player.Say( SAY_DIALOGBOX_BUTTON( 4 ), "Lex + Pic" );
	if( isCont )
	{
		player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "Contents" );
	}
	else
	{
		player.Say( SAY_DIALOGBOX_BUTTON( 5 ), "Break for %" );
	}
}

uint[] ItemFlags = 
{
	ITEM_HIDDEN								 ,// 0x00000001 )
	ITEM_FLAT                                ,// 0x00000002 )
	ITEM_NO_BLOCK                            ,// 0x00000004 )
	ITEM_SHOOT_THRU                          ,// 0x00000008 )
	ITEM_LIGHT_THRU                          ,// 0x00000010 )
	ITEM_TWO_HANDS                         ,// 0x00000080 )
	ITEM_BIG_GUN                           ,// 0x00000100 )
	ITEM_ALWAYS_VIEW                         ,// 0x00000200 )
	ITEM_HAS_TIMER                           ,// 0x00000400 )
	ITEM_BAD_ITEM                            ,// 0x00000800 )
	ITEM_NO_HIGHLIGHT                        ,// 0x00001000 )
	ITEM_SHOW_ANIM                           ,// 0x00002000 )
	ITEM_SHOW_ANIM_EXT                       ,// 0x00004000 )
	ITEM_LIGHT                               ,// 0x00008000 )
	ITEM_GECK                                ,// 0x00010000 )
	
	// Group2
	ITEM_TRAP                                ,// 0x00020000 )
	ITEM_NO_LIGHT_INFLUENCE                  ,// 0x00040000 )
	ITEM_NO_LOOT                             ,// 0x00080000 )
	ITEM_NO_STEAL                            ,// 0x00100000 )
	ITEM_GAG                                 ,// 0x00200000 )
	ITEM_COLORIZE                            ,// 0x00400000 )
	ITEM_COLORIZE_INV                        ,// 0x00800000 )
	ITEM_CAN_USE_ON_SMTH                     ,// 0x01000000 )
	ITEM_CAN_LOOK                            ,// 0x02000000 )
	ITEM_CAN_TALK                            ,// 0x04000000 )
	ITEM_CAN_PICKUP                          ,// 0x08000000 )
	ITEM_CAN_USE                             ,// 0x10000000 )
	ITEM_HOLODISK                            ,// 0x20000000 )
	ITEM_RADIO                               // 0x40000000 )
};

string[] ItemFlagsName = 
{
	"ITEM_HIDDEN"							,// 0x00000001 )
	"ITEM_FLAT"								,// 0x00000002 )
	"ITEM_NO_BLOCK"                     	,// 0x00000004 )
	"ITEM_SHOOT_THRU"  	                    ,// 0x00000008 )
	"ITEM_LIGHT_THRU"                       ,// 0x00000010 )
	"ITEM_TWO_HANDS"                      	,// 0x00000080 )
	"ITEM_BIG_GUN"                       	,// 0x00000100 )
	"ITEM_ALWAYS_VIEW"                      ,// 0x00000200 )
	"ITEM_HAS_TIMER"                        ,// 0x00000400 )
	"ITEM_BAD_ITEM"                      	,// 0x00000800 )
	"ITEM_NO_HIGHLIGHT"                     ,// 0x00001000 )
	"ITEM_SHOW_ANIM"                        ,// 0x00002000 )
	"ITEM_SHOW_ANIM_EXT"                    ,// 0x00004000 )
	"ITEM_LIGHT"                     		,// 0x00008000 )
	"ITEM_GECK"                             ,// 0x00010000 )

	// Group2
	"ITEM_TRAP"				                ,// 0x00020000 )
	"ITEM_NO_LIGHT_INFLUENCE" 	            ,// 0x00040000 )
	"ITEM_NO_LOOT"                          ,// 0x00080000 )
	"ITEM_NO_STEAL"                         ,// 0x00100000 )
	"ITEM_GAG"                              ,// 0x00200000 )
	"ITEM_COLORIZE"                         ,// 0x00400000 )
	"ITEM_COLORIZE_INV"                    	,// 0x00800000 )
	"ITEM_CAN_USE_ON_SMTH"                  ,// 0x01000000 )
	"ITEM_CAN_LOOK"                       	,// 0x02000000 )
	"ITEM_CAN_TALK" 		                ,// 0x04000000 )
	"ITEM_CAN_PICKUP" 	                    ,// 0x08000000 )
	"ITEM_CAN_USE"  	                  	,// 0x10000000 )
	"ITEM_HOLODISK"                         ,// 0x20000000 )
	"ITEM_RADIO"                             // 0x40000000 )
};

void show_GM_VAL_PANNEL( Critter& player, Item& item )
{
	player.ShowScreen( SCREEN_DIALOGBOX, 15, "answer_GM_PANNEL_ITEM_VALS" );
	player.Say( SAY_DIALOGBOX_TEXT, "Item, protoID =" + item.GetProtoId() + ", Id =" + item.Id );
	player.Say( SAY_DIALOGBOX_BUTTON( 0 ), ""+item.Val0 +" Val0" );
	player.Say( SAY_DIALOGBOX_BUTTON( 1 ), ""+item.Val1 +" Val1" );
	player.Say( SAY_DIALOGBOX_BUTTON( 2 ), ""+item.Val2 +" Val2" );
	player.Say( SAY_DIALOGBOX_BUTTON( 3 ), ""+item.Val3 +" Val3" );
	player.Say( SAY_DIALOGBOX_BUTTON( 4 ), ""+item.Val4 +" Val4" );
	player.Say( SAY_DIALOGBOX_BUTTON( 5 ), ""+item.Val5 +" Val5" );
	player.Say( SAY_DIALOGBOX_BUTTON( 6 ), ""+item.Val6 +" Val6" );
	player.Say( SAY_DIALOGBOX_BUTTON( 7 ), ""+item.Val7 +" Val7" );
	player.Say( SAY_DIALOGBOX_BUTTON( 8 ), ""+item.Val8 +" Val8" );
	player.Say( SAY_DIALOGBOX_BUTTON( 9 ), ""+item.Val9 +" Val9" );
	player.Say( SAY_DIALOGBOX_BUTTON( 10 ), ""+item.LockerId +" Locker id" );
	player.Say( SAY_DIALOGBOX_BUTTON( 11 ), ""+item.LockerComplexity +" Complexity" );
	player.Say( SAY_DIALOGBOX_BUTTON( 12 ), ""+item.LockerCondition +" Condition" );
	player.Say( SAY_DIALOGBOX_BUTTON( 13 ), ""+item.Info +" Info" );
	player.Say( SAY_DIALOGBOX_BUTTON( 14 ), ""+item.TrapValue +" TrapValue" );
}

void answer_GM_PANNEL_ITEM( Critter& player, uint answerI, string& answerS )
{
    Item@ item = GetItem( player.StatBase[ ST_VAR0 ] );
    if( !valid( item ) )
	{
		return;
    }
	
	if( answerI == 0 )
    {
		show_GM_VAL_PANNEL( player, item );
    }
	
	if( answerI == 1 )
    {
        player.ShowScreen( SCREEN_DIALOGBOX, 4, "answer_GM_PANNEL_ITEM_SCRIPT" );
        player.Say( SAY_DIALOGBOX_TEXT, "Item, protoID =" + item.GetProtoId() + ", Id =" + item.Id );
        player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Workbench" );
		player.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Furniture" );
		player.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Dialog Door" );
		player.Say( SAY_DIALOGBOX_BUTTON( 3 ), "Delete Script" );
    }
	
	if( answerI == 2 )
	{
		player.ShowScreen( SCREEN_DIALOGBOX, 16, "answer_GM_PANNEL_ITEM_Flags0" );
		player.Say( SAY_DIALOGBOX_TEXT, "Item, protoID =" + item.GetProtoId() + ", id =" + item.Id );
		player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "[RETURN]" );
		for( uint i = 0; i < 15; i++ )
		{
			string state = FLAG( item.Flags, ItemFlags[i] ) ? "yes" : "no";
			player.Say( SAY_DIALOGBOX_BUTTON( i+1 ), ItemFlagsName[i] + ": " + state );
		}
	}
	
	if( answerI == 3 )	
	{
		player.ShowScreen( SCREEN_DIALOGBOX, 15, "answer_GM_PANNEL_ITEM_Flags1" );
		player.Say( SAY_DIALOGBOX_BUTTON( 0 ), "[RETURN]" );
		player.Say( SAY_DIALOGBOX_TEXT, "Item, protoID =" + item.GetProtoId() + ", id =" + item.Id );
		for( uint i = 0; i < 14; i++ )
		{
			string state2 = FLAG( item.Flags, ItemFlags[i + 15] ) ? "yes" : "no";
			player.Say( SAY_DIALOGBOX_BUTTON( i+1 ), ItemFlagsName[ i + 15 ] + ": " + state2 );
		}
	}
	
	if( answerI == 4 )
	{
		showFakingMenu( player );
	}

	if( answerI == 5 )
	{
		if( item.GetType() == ITEM_TYPE_CONTAINER )
		{
			ShowContainer( player, item, TRANSFER_FAR_CONT );
		}
		else
		{
			player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_ITEM_BREAK" );
			player.Say( SAY_SAY_TITLE, "Break for %:" );
		}
	}
}

void ask_GM_PANNEL_ITEM_BREAK( Critter& player, uint answerI, string& answerS )
{
    Item@ item = GetItem( player.StatBase[ ST_VAR0 ] );
    if( !valid( item ) )
	{
		return;
	}
	
	int number = 0;
	if( answerS.length() < 1 || !StrToInt( answerS, number ) )
	{
		return;
	}
	
	
	GM_brokeItem( player, item.Id, number * 100, 0, null, null );
}

void setItemFlags( Critter& player, uint n )
{
    Item@ item = GetItem( player.Stat[ ST_VAR0 ] );
    if( !valid( item ) )
	{
		return;
	}
	
	if( FLAG( item.Flags, ItemFlags[n] ) )
	{
		UNSETFLAG( item.Flags, ItemFlags[n] );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has unset flag " + ItemFlags[n] + " for item" + item.Id + " -^- (END)", null );
	}
	else
	{
		SETFLAG( item.Flags, ItemFlags[n] );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has set set flag " + ItemFlags[n] + " for item" + item.Id + " -^- (END)", null );
	}
}

void answer_GM_PANNEL_ITEM_Flags0( Critter& player, uint answerI, string& answerS )
{
    if( answerI == 0 )
	{
		GM_PANNEL_ITEM( player, player.StatBase[ ST_VAR0 ], 0, 0, null, null );
		return;
	}
	
	setItemFlags( player, answerI-1 );
	answer_GM_PANNEL_ITEM( player, 2, "" );
}

void answer_GM_PANNEL_ITEM_Flags1( Critter& player, uint answerI, string& answerS )
{
    if( answerI == 0 )
	{
		int[] vals = {};
		GM_PANNEL_ITEM( player, player.StatBase[ ST_VAR0 ], 0, 0, "", vals );
		return;
	}
	
    setItemFlags( player, (answerI-1) + 15 );
	answer_GM_PANNEL_ITEM( player, 3, "" );
}

//GM pannel item script inits
void answer_GM_PANNEL_ITEM_SCRIPT( Critter& player, uint answerI, string& answerS )
{
	Item@ item = GetItem( player.StatBase[ ST_VAR0 ] );
	if( !valid( item ) )
	{
		return;
	}
	
    if( answerI == 0 )
    {
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has set workbench script for item: " + item.Id + "", null );
		SetWorkbench( player, item.Id, 0, 0 );
    }
	
	if( answerI == 1 ) 
	{
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has set furniture script for item: " + item.Id + "", null );
		_InitFurniture( item, true );
		item.Update();
	}
	
	if( answerI == 2 ) 
	{
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has set security door script for item: " + item.Id + "", null );
		SetSecurityDoor( player, item.Id, 0, 0 );
	}
	
	if( answerI == 3 ) 
	{
		item.SetScript( "_DeleteScript" );
		player.Say( SAY_NETMSG, "|0xFFFF00 Script deleted." );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has deleted all scripts for item: " + item.Id + "", null );
		return;
	}
	player.Say( SAY_NETMSG, "|0xFFFF00 Script set." );
}

void _DeleteScript( Item& item, bool firstTime )
{
	item.SetEvent( ITEM_EVENT_ATTACK, "" );
	item.SetEvent( ITEM_EVENT_USE, "" );
	item.SetEvent( ITEM_EVENT_USE_ON_ME, "" );
	item.SetEvent( ITEM_EVENT_SKILL, "" );
	item.SetEvent( ITEM_EVENT_DROP, "" );
	item.SetEvent( ITEM_EVENT_MOVE, "" );
	item.SetEvent( ITEM_EVENT_WALK, "" );
	item.Update();
}

void answer_GM_PANNEL_ITEM_VALS( Critter& player, uint answerI, string& answerS )
{
	Item@ item = GetItem( player.StatBase[ ST_VAR0 ] );
	if( !valid( item ) )
	{
		return;
	}
	
	player.ParamBase[ ST_VAR1 ] = answerI;
	player.ShowScreen( SCREEN_SAY, 0, "gm@ask_GM_PANNEL_ITEM" );

	string[] data = { "LockerId", "LockerComplexity", "LockerCondition", "Info", "TrapValue" };
	string info = "Val #";
	if( answerI < 10 )
	{
		info += answerI;
	}
	else
	{
		info = data[ answerI - 10 ];
	}
	player.Say( SAY_SAY_TITLE, info );
}

void ask_GM_PANNEL_ITEM( Critter& player, uint answerI, string& answerS )
{
	Item@ item = GetItem( player.StatBase[ ST_VAR0 ] );
	if( !valid( item ) )
	{
		return;
	}
	
    if( answerS.length() > 0 )
    {
        int val_number = player.StatBase[ ST_VAR1 ];
        int number = 0;
        StrToInt( answerS, number );
		switch( val_number )
		{
			case( 0 ):
				item.Val0 = number;
				break;
			case( 1 ):
				item.Val1 = number;
				break;
			case( 2 ):
				item.Val2 = number;
				break;
			case( 3 ):
				item.Val3 = number;
				break;
			case( 4 ):
				item.Val4 = number;
				break;
			case( 5 ):
				item.Val5 = number;
				break;
			case( 6 ):
				item.Val6 = number;
				break;
			case( 7 ):
				item.Val7 = number;
				break;
			case( 8 ):
				item.Val8 = number;
				break;
			case( 9 ):
				item.Val9 = number;
				break;
			case( 10 ):
				item.LockerId = number;
				break;
			case( 11 ):
				item.LockerComplexity = number;
				break;
			case( 12 ):
				item.LockerCondition = number;
				break;
			case( 13 ):
				item.Info = number;
				break;	  
			case( 14 ):
				item.TrapValue = number;
				break;	  
		}
		
		item.Update();
		
        player.Say( SAY_NETMSG, "You have changed item's val" + val_number + " to " + number + " for item: " + item.Id + "." );
		unsafe_log_2( player, 0, 0, 0, player.Name + " " + player.Id + " has changed item's val" + val_number + " to " + number + " for item: " + item.Id + ".", null );
		show_GM_VAL_PANNEL( player, item );
    }
}

//GM HEX SPAWN UPON CTRL+RMB, ALT+RMB
void unsafe_GM_PANNEL_HEX( Critter& gm, int hexX, int hexY, int param2, string@ param3, int[] @ param4 )
{
    if( isGM( gm ) )
	{
		StartMenuGMHex( gm, hexX, hexY );
	}
}

void StartMenuGMHex( Critter& gm, uint16 hexX, uint16 hexY )
{
    Map@ map = gm.GetMap();
    if( map is null )
	{
        return;
    }
	
    iMenuHandler@ handler = MenuGMHex( map, hexX, hexY );
    iDialogBox@ menu = OpenMenu( gm, "Map Hex Options", handler );
}

class MenuGMHex: DefaultMenuHandler
{
    uint map_id;
	uint16 hex_X;
	uint16 hex_Y;
	uint level;
	
    MenuGMHex( Map& map, uint16 hexX, uint16 hexY )
	{
        map_id = map.Id;
		hex_X = hexX;
		hex_Y = hexY;
		level = 0;
   }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
	
        if( map is null )
		{
            return false;
        }

		if( menu.ButtonMsg( STR_GM_HEXMENU_NPC_SPAWN ) )
		{
			MenuGMHexMob@ GM_Hex_Mob_Spawn = MenuGMHexMob( map, hex_X, hex_Y );
			GM_Hex_Mob_Spawn.level = level + 1;
			return menu.OpenChild( "Level " + GM_Hex_Mob_Spawn.level, GM_Hex_Mob_Spawn );
		}		
		
		if( menu.ButtonSayMsg( STR_GM_HEXMENU_ITEM_SPAWN, STR_GM_HEXMENU_ITEM_PID ) )
		{
			string itmPid = menu.GetSayValue();
			if( itmPid !is null && itmPid.length() > 0 )
			{
				int pid = 0;
				StrToInt( itmPid, pid );
				Item@ spawned = map.AddItem( hex_X, hex_Y, pid, 1 );
				if( !valid( spawned ) )
				{
					gm.Say( SAY_NETMSG, "|0xFFFF00 Item Pid Incorrect" );
				}
				unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " spawned Item: " + itmPid + " hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
			}
			return false;
		}
		
		if( menu.ButtonMsg( STR_GM_HEXMENU_COLLECT_ITEMS ) )
		{
			Item@[] items;
			map.GetItems( hex_X, hex_Y, items );
			uint len = items.length();
			if( len > 0 )
			{
				MoveItems( items, gm );
				unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Collected all items at hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
			}
			else
			{
				gm.Say( SAY_NETMSG, "|0xFFFF00 There are no items on the hex!" );
			}
			return true;
		}
		
		if( menu.ButtonMsg( STR_GM_HEXMENU_DELETE_ITEMS ) )
		{
			Item@[] items;
			map.GetItems( hex_X, hex_Y, items );
			uint len = items.length();
			if( len > 0 )
			{
				DeleteItems( items );
				unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Deleted all items at hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
			}
			else
			{
				gm.Say( SAY_NETMSG, "|0xFFFF00 There are no items on the hex!" );
			}
			return true;
		}
		
		if( menu.ButtonMsg( STR_GM_HEXMENU_ADD_RADIATION ) )
		{
			MenuGMHexRad@ GM_Hex_Rad_Spawn = MenuGMHexRad( map, hex_X, hex_Y );
			GM_Hex_Rad_Spawn.level = level + 1;
			return menu.OpenChild( "Level " + GM_Hex_Rad_Spawn.level, GM_Hex_Rad_Spawn );
		}
		
		if( menu.ButtonMsg( STR_GM_HEXMENU_ADD_GAS ) )
		{
			MenuGMHexGas@ GM_Hex_Gas_Spawn = MenuGMHexGas( map, hex_X, hex_Y );
			GM_Hex_Gas_Spawn.level = level + 1;
			return menu.OpenChild( "Level " + GM_Hex_Gas_Spawn.level, GM_Hex_Gas_Spawn );
		}
		
		if( menu.ButtonMsg( STR_GM_HEXMENU_TELEPORT_THERE ) )
		{
			gm.TransitToHex( hex_X, hex_Y, gm.Dir );
			unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Teleported to hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
			return false;
		}
		return true;
    }
	
	int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_HEXMENU_MAIN;
	}
	
    string@ Description( Critter& gm )
	{
		string info = "$X" + hex_X + "$Y" + hex_Y;
		return info;
    }
}

//Menu for mob spawn
class MenuGMHexMob: DefaultMenuHandler
{
    uint map_id;
	uint16 hex_X;
	uint16 hex_Y;
	uint level;
	
    MenuGMHexMob( Map& map, uint16 hexX, uint16 hexY )
	{
        map_id = map.Id;
		hex_X = hexX;
		hex_Y = hexY;
		level = 1;
    }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
		gm.ParamBase[ ST_VAR4 ] = CLAMP( gm.ParamBase[ ST_VAR4 ], 1, 7 );
		
        Map@ map = GetMap( map_id );
		
        if( map is null )
		{
            return true;
        }
		
		if( menu.ButtonMsg( STR_GM_HEXMENU_SPAWN_NPC ) )
		{
			for( int i = 0; i < gm.ParamBase[ ST_VAR4 ]; i++ )
			{
				hex_spawn_NPC( gm, map, hex_X, hex_Y );
				unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Spawned NPC: " + gm.ParamBase[ CR_VAL6 ] + " On map: " + map.Id +" hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
			}
			return true;
		}		
		
		if( menu.ButtonSayMsg( STR_GM_HEXMENU_BUTTON_AMOUNT, "$amount" + gm.ParamBase[ ST_VAR4 ], STR_AMOUNT ) )
		{
			gm.ParamBase[ ST_VAR4 ] = CLAMP( strToInt( checkNull( menu.GetSayValue(), "0" ) ), 1, 7 );
			unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Spawned NPC: " + gm.ParamBase[ CR_VAL6 ] + " On map: " + map.Id +" hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
			return true;
		}		
		
		int aiType = ( gm.ParamBase[CR_VAL2] == 0 ? STR_GM_SPAWNMENU_CONTROL : ( gm.ParamBase[CR_VAL2] == 1 ? STR_GM_SPAWNMENU_ANIMAL : STR_GM_SPAWNMENU_SENTIENT ) );
		if( menu.ButtonMsg( STR_GM_SPAWNMENU_AI_TYPE, "$type" + STR_INSERT_TEXT_LINE( aiType ) ) )
		{
			gm.ParamBase[ CR_VAL2 ] == 0 ? gm.ParamBase[ CR_VAL2 ] = 1 : ( gm.ParamBase [CR_VAL2 ] == 1 ? gm.ParamBase[ CR_VAL2 ] = 2 : gm.ParamBase[ CR_VAL2 ] = 0 );
 			return true;
		}

		string factionName = GetName( gm.ParamBase[CR_VAL3] );
		if( menu.ButtonSayMsg( STR_GM_SPAWNMENU_FACTION_NAME, "$name" + factionName, STR_GM_SPAWNMENU_FACTION_TITLESAY ) )
		{
			string faction = menu.GetSayValue();
			if( faction.length() > 0 )
			{
				int number = 0;
				if( faction == "0" || faction == " " )
				{
					number = 0;
					gm.Say( SAY_NETMSG, "Spawned withoug faction." );
				}
				else
				{
					number = GetStrHash( faction );
					if( GetName( number ) == "" )
					{
						gm.Say( SAY_NETMSG, "Faction does not exist" );
					}
				}
				gm.ParamBase[CR_VAL3] = number;
			}
			else
			{
				gm.Say( SAY_NETMSG, "Input Faction name." );
			}
			return true;
		}
	
		string agression = STR_INSERT_TEXT_LINE( gm.ParamBase[CR_VAL4] == 0 ? STR_GM_SPAWNMENU_AGRESSION_PASSIVE : STR_GM_SPAWNMENU_AGRESSION_ACTIVE );
		if( menu.ButtonMsg( STR_GM_SPAWNMENU_AGRESSION_STATE, "$state" + agression ) )
		{
			gm.ParamBase[CR_VAL4] = CLAMP( 1 - gm.ParamBase[CR_VAL4], 0, 1 );
			return true;
		}
		
		int teamId = gm.ParamBase[CR_VAL5];
		if( menu.ButtonSayMsg( STR_GM_SPAWNMENU_TEAM_ID, "$id" + teamId, STR_GM_SPAWNMENU_TEAM_ID_TITLE ) )
		{
			string team = menu.GetSayValue();
			if( team !is null && team.length() > 0 )
			{
				int teamNum = 0;
				StrToInt( team, teamNum );
				if( teamNum > 0 )
				{
					gm.ParamBase[CR_VAL5] = teamNum;
					gm.Say( SAY_NETMSG, "|0xFFFF00 NPC now spawn with team ID " + team + "." );
				}
				else
				{
					gm.ParamBase[CR_VAL5] = 0;
					gm.Say( SAY_NETMSG, "|0xFFFF00 You have reset the NPC team ID." );
				}
			}
			return true;
		}
		
		int npcPid = gm.ParamBase[CR_VAL6];
		if( menu.ButtonSayMsg( STR_GM_SPAWNMENU_PID, "$value" + npcPid, STR_GM_SPAWNMENU_PID_TITLE ) )
		{
			string type = menu.GetSayValue();
			int	pid = 0;
			StrToInt( type, pid );
			if( pid > 0 )
			{
				gm.ParamBase[ CR_VAL6 ] = pid;
			}
			else
			{
				gm.Say( SAY_NETMSG, "|0xFFFF00 PID not defined." );
			}
			return true;
		}

		string bonusHP = gm.ParamBase[CR_VAL7];
		if( menu.ButtonSayMsg( STR_GM_SPAWNMENU_BONUS_HP, "$value" + bonusHP, STR_GM_SPAWNMENU_BONUS_HP_TITLE ) )
		{
			string bonus = menu.GetSayValue();
			int	bonus_hp = 0;
			StrToInt( bonus, bonus_hp );
			gm.ParamBase[ CR_VAL7 ] = bonus_hp;
			return true;
		}

		string bonusDmg = gm.ParamBase[CR_VAL8];
		if( menu.ButtonSayMsg( STR_GM_SPAWNMENU_BONUS_DAMAGE, "$value" + bonusDmg, STR_GM_SPAWNMENU_BONUS_DAMAGE_TITLE ) )
		{
			string bonus = menu.GetSayValue();
			int	bonus_Dmg = 0;
			StrToInt( bonus, bonus_Dmg );
			gm.ParamBase[ CR_VAL8 ] = bonus_Dmg;
			return true;
		}
			
		string bonusSkill = gm.ParamBase[CR_VAL9];
		if( menu.ButtonSayMsg( STR_GM_SPAWNMENU_BONUS_SKILL, "$value" + bonusSkill, STR_GM_SPAWNMENU_BONUS_SKILL_TITLE ) )
		{
			string bonus = menu.GetSayValue();
			int	bonus_skill = 0;
			StrToInt( bonus, bonus_skill );
			gm.ParamBase[ CR_VAL9 ] = bonus_skill;
			return true;
		}

		if( menu.ButtonMsg( STR_GM_SPAWNMENU_SELECT_MOB ) )
		{
			MenuSelectMobGroup@ menu_select_mob_group = MenuSelectMobGroup( map, hex_X, hex_Y );
			menu_select_mob_group.level = level + 1;
			return menu.OpenChild( "level " + menu_select_mob_group.level, menu_select_mob_group );
		}
		
		if( menu.ButtonMsg( STR_GM_SPAWNMENU_SELECT_HUMANOID_MOB ) )
		{
			MenuSelectHumanoidMobGroup@ menu_select_humanoid_mob_group = MenuSelectHumanoidMobGroup( map, hex_X, hex_Y );
			menu_select_humanoid_mob_group.level = level + 1;
			return menu.OpenChild( "level " + menu_select_humanoid_mob_group.level, menu_select_humanoid_mob_group );
		}
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			level = 0;
			return false;
		}
		return true;
    }
	
    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_SPAWNMENU_MAIN_DESCRIPTION;
	}	

    string@ Description( Critter& gm )
	{	
		return null;
	}
}

//Child menu Mob spawn selection
class MenuSelectMobGroup: DefaultMenuHandler
{
    uint map_id;
	uint level;
	uint16 hex_X;
	uint16 hex_Y;
	uint16 list_begin;
	uint16 list_end;
	
    MenuSelectMobGroup( Map& map, uint16 hexX, uint16 hexY )
	{
        map_id = map.Id;
		level = 2;
		hex_X = hexX;
		hex_Y = hexY;
		list_begin = 0;
		list_end = 0;
    }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
        if( !valid( map ) )
		{ 
			return false; 
		}
		
		for( uint i = STR_GM_MENU_NPC_GROUPS_BEGIN; i < STR_GM_MENU_NPC_GROUPS_END; i ++ )
		{
			string category = i;
			string lex = "$name" + STR_INSERT_TEXT_LINE( category );
			if( menu.ButtonMsg( STR_GM_MOB_MENU_MOBNAME, lex ) )
			{
				switch( i )
				{
					case( STR_GM_MENU_GROUP_RATS ):
						list_begin = RATS_BEGIN;
						list_end = RATS_END;
						break;
					case( STR_GM_MENU_GROUP_MANTIS ):
						list_begin = MANTIS_BEGIN;
						list_end = MANTIS_END;
						break;
					case( STR_GM_MENU_GROUP_ANTS ):
						list_begin = ANTS_BEGIN;
						list_end = ANTS_END;
						break;
					case( STR_GM_MENU_GROUP_PIGMOLERATS ):
						list_begin = H_RATS_BEGIN;
						list_end = H_RATS_END;
						break;
					case( STR_GM_MENU_GROUP_GECKOS ):
						list_begin = GECKOS_BEGIN;
						list_end = GECKOS_END;
						break;
					case( STR_GM_MENU_GROUP_DOGWOLF ):
						list_begin = DOGS_BEGIN;
						list_end = DOGS_END;
						break;
					case( STR_GM_MENU_GROUP_SCORPIONS ):
						list_begin = RADSCORPIONS_BEGIN;
						list_end = RADSCORPIONS_END;
						break;
					case( STR_GM_MENU_GROUP_BRAHMINLAV ):
						list_begin = BRAHMINS_BEGIN;
						list_end = BRAHMINS_END;
						break;
					case( STR_GM_MENU_GROUP_PLANTS ):
						list_begin = PREDATORY_PLANTS_BEGIN;
						list_end = PREDATORY_PLANTS_END;
						break;
					case( STR_GM_MENU_GROUP_YAO ):
						list_begin = YAO_GUAI_BEGIN;
						list_end = YAO_GUAI_END;
						break;
					case( STR_GM_MENU_GROUP_ALIENS ):
						list_begin = ALIENS_BEGIN;
						list_end = ALIENS_END;
						break;
					case( STR_GM_MENU_GROUP_DEATHCLAWS ):
						list_begin = DEATHCLAWS_BEGIN;
						list_end = DEATHCLAWS_END;
						break;
					case( STR_GM_MENU_GROUP_CROCKS ):
						list_begin = CROCKS_BEGIN;
						list_end = CROCKS_END;
						break;
					case( STR_GM_MENU_GROUP_CENTAURS ):
						list_begin = CENTAURS_BEGIN;
						list_end = CENTAURS_END;
						break;
					case( STR_GM_MENU_GROUP_FLOATERS ):
						list_begin = FLOATERS_BEGIN;
						list_end = FLOATERS_END;
						break;
					case( STR_GM_MENU_GROUP_SWAMPLURKERS ):
						list_begin = SWAMPLURKERS_BEGIN;
						list_end = SWAMPLURKERS_END;
						break;
					case( STR_GM_MENU_GROUP_INSECTS ):
						list_begin = OTHER_INSECTS_BEGIN;
						list_end = OTHER_INSECTS_END;
						break;
					default:
						break;
				}

				MenuSelectMob@ menu_select_mob = MenuSelectMob( map, hex_X, hex_Y, list_begin, list_end );
				menu_select_mob.level = level + 1;
				return menu.OpenChild( "level " + menu_select_mob.level, menu_select_mob );
			}
		}
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		return true;
    }

    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_SPAWNMENU_SPAWN_MOB_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

//Child menu humanoid Mob spawn selection
class MenuSelectHumanoidMobGroup: DefaultMenuHandler
{
    uint map_id;
	uint level;
	uint16 hex_X;
	uint16 hex_Y;
	uint16 list_begin;
	uint16 list_end;
	
    MenuSelectHumanoidMobGroup( Map& map, uint16 hexX, uint16 hexY )
	{
        map_id = map.Id;
		level = 2;
		hex_X = hexX;
		hex_Y = hexY;
		list_begin = 0;
		list_end = 0;
    }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
        if( !valid( map ) )
		{ 
			return false; 
		}
		
		for( uint i = STR_GM_MENU_NPC_HUMANOID_GROUPS_BEGIN; i < STR_GM_MENU_NPC_HUMANOID_GROUPS_END; i ++ )
		{
			string category = i;
			string lex = "$name" + STR_INSERT_TEXT_LINE( category );
			if( menu.ButtonMsg( STR_GM_MOB_MENU_MOBNAME, lex ) )
			{
				switch( i )
				{
					case( STR_GM_MENU_GROUP_GHOULS ):
						list_begin = GHOULS_BEGIN;
						list_end = GHOULS_END;
						break;
					case( STR_GM_MENU_GROUP_SMUTANTS ):
						list_begin = SMUTANTS_BEGIN;
						list_end = SMUTANTS_END;
						break;
					case( STR_GM_MENU_GROUP_NCR_SOLDIERS ):
						list_begin = NCR_SOLDIERS_BEGIN;
						list_end = NCR_SOLDIERS_END;
						break;
					case( STR_GM_MENU_GROUP_RANGERS ):
						list_begin = RANGERS_BEGIN;
						list_end = RANGERS_END;
						break;
					case( STR_GM_MENU_GROUP_BOS_SOLDIERS ):
						list_begin = BOS_SOLDIERS_BEGIN;
						list_end = BOS_SOLDIERS_END;
						break;
					case( STR_GM_MENU_GROUP_ENCLAVE_SOLDIERS ):
						list_begin = ENCLAVE_SOLDIERS_BEGIN;
						list_end = ENCLAVE_SOLDIERS_END;
						break;
					case( STR_GM_MENU_GROUP_VCITY_SOLDIERS ):
						list_begin = VCITY_SOLDIERS_BEGIN;
						list_end = VCITY_SOLDIERS_END;
						break;
					case( STR_GM_MENU_GROUP_RENEGADE_SOLDIRES ):
						list_begin = RENEGADE_SOLDIERS_BEGIN;
						list_end = RENEGADE_SOLDIERS_END;
						break;
					case( STR_GM_MENU_GROUP_VAULT_DWELLERS ):
						list_begin = VAULT_DWELLERS_BEGIN;
						list_end = VAULT_DWELLERS_END;
						break;
					case( STR_GM_MENU_GROUP_TOWN_DWELLERS ):
						list_begin = TOWN_DWELLERS_BEGIN;
						list_end = TOWN_DWELLERS_END;
						break;
					case( STR_GM_MENU_GROUP_TRIBALS ):
						list_begin = TRIBALS_BEGIN;
						list_end = TRIBALS_END;
						break;
					case( STR_GM_MENU_GROUP_BANDITS ):
						list_begin = BANDITS_BEGIN;
						list_end = BANDITS_END;
						break;
					default:
						break;
				}

				MenuSelectMob@ menu_select_mob = MenuSelectMob( map, hex_X, hex_Y, list_begin, list_end );
				menu_select_mob.level = level + 1;
				return menu.OpenChild( "level " + menu_select_mob.level, menu_select_mob );
			}
		}
		
		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		return true;
    }

    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_SPAWNMENU_SPAWN_MOB_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

//Child menu Mob spawn selection
class MenuSelectMob: DefaultMenuHandler
{
    uint map_id;
	uint level;
	uint16 hex_X;
	uint16 hex_Y;
	uint16 list_begin;
	uint16 list_end;
	
    MenuSelectMob( Map& map, uint16 hexX, uint16 hexY, uint16 begin, uint16 end )
	{
        map_id = map.Id;
		level = 3;
		hex_X = hexX;
		hex_Y = hexY;
		list_begin = begin;
		list_end = end;
    }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
        if( !valid( map ) )
		{ 
			return false; 
		}

		for( uint i = list_begin, len = list_end; i < len; i ++ )
		{
			string mob = STR_INSERT_MOB_LINE( i * 10 );
			string lex = "$name" + mob;
			if( menu.ButtonMsg( STR_GM_MOB_MENU_MOBNAME, lex ) )
			{
				gm.ParamBase[ CR_VAL6 ] = i;
				
				for( int j = 0; j < gm.ParamBase[ ST_VAR4 ]; j++ )
				{
					hex_spawn_NPC( gm, map, hex_X, hex_Y );
					unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Spawned NPC: " + mob + " On map: " + map.Id +" hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
				}				

				gm.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GM_SPAWNMENU_YOU_HAVE_SPAWNED, "$name" + mob );
				return true;
			}
		}

		if( menu.ButtonMsg( STR_RETURN ) )
		{
			return false;
		}
		
		return true;
    }

    int getDescriptionFile()
    {
    	return TEXTMSG_TEXT;
    }

	int getDescriptionLine()
	{
		return STR_GM_SPAWNMENU_SPAWN_MOB_DESC;
	}

    string@ Description( Critter& gm )
	{
		return null;
    }
}

//Func to spawn NPC based on selections
void hex_spawn_NPC( Critter& gm, Map& map, uint16 hexX, uint16 hexY )
{
    uint16 pid = gm.ParamBase[ CR_VAL6 ];
	if( pid == 0 )
	{
		return;
	}
	
	int iteration = 100;
	int rng = gm.ParamBase[ ST_VAR4 ];
	uint16 tempX = 0, tempY = 0;
	do
	{		
		tempX = Random( hexX - rng, hexX + rng );
		tempY = Random( hexY - rng, hexY + rng );
		iteration--;
	}
	while( !map.IsHexPassed( tempX, tempY ) && iteration > 0 );
	hexX = tempX;
	hexY = tempY;
	
	Critter@ cr = map.AddNpc( pid, hexX, hexY, Random( 0, 5 ), null, null, null );
	if( valid( cr ) )
	{
        cr.ParamBase[ ST_FACTION ] = gm.ParamBase[ CR_VAL3 ];
		cr.ParamBase[ CR_IS_AGGRESSIVE ] = gm.ParamBase[ CR_VAL4 ];
		cr.StatBase[ ST_TEAM_ID ] = gm.ParamBase[ CR_VAL5 ];
		
		int bonus_hp = gm.ParamBase[ CR_VAL7 ];
		int bonus_dmg = gm.ParamBase[ CR_VAL8 ];
		int bonus_skill = gm.ParamBase[ CR_VAL9 ];
		
        cr.StatBase[ ST_AI_ID ] = 207;
        cr.ParamBase[ MERC_TYPE ] = 10;
        cr.ParamBase[ MERC_MASTER_ID ] = int( gm.Id );
        cr.ModeBase[ MODE_NO_HOME ] = 0;

        cr.ParamBase[ ST_MAX_LIFE ] = cr.ParamBase[ ST_MAX_LIFE ] + bonus_hp;
		cr.StatBase[ ST_CURRENT_HP ] = cr.Stat[ ST_MAX_LIFE ];
		 
        cr.ParamBase[ ST_MELEE_DAMAGE ] = cr.ParamBase[ ST_MELEE_DAMAGE ] + bonus_dmg;
		
        cr.ParamBase[ SK_SMALL_GUNS ] = cr.ParamBase[ SK_SMALL_GUNS ] + bonus_skill;
        cr.ParamBase[ SK_MEDIUM_GUNS ] = cr.ParamBase[ SK_MEDIUM_GUNS ] + bonus_skill;
        cr.ParamBase[ SK_BIG_GUNS ] = cr.ParamBase[ SK_BIG_GUNS ] + bonus_skill;
        cr.ParamBase[ SK_UNARMED ] = cr.ParamBase[ SK_UNARMED ] + bonus_skill;
        cr.ParamBase[ SK_MELEE_WEAPONS ] = cr.ParamBase[ SK_MELEE_WEAPONS ] + bonus_skill;
        cr.ParamBase[ SK_THROWING ] = cr.ParamBase[ SK_THROWING ] + bonus_skill;

		gm.ParamBase[ MERC_MASTER_ID ] = int( cr.Id );
		
		int AI_type = gm.ParamBase[CR_VAL2];
		if( AI_type == 0 )
		{
			gmcontrolMob( gm, cr.Id, 0, 0, null, null );
		}
		else if( AI_type == 1 )
		{  
			GM_MobInit( cr );
		}
		else if( AI_type == 2 )
		{
			GM_GuardsInit( cr );
		}
    }
}
//end hex spawning

//Menu for Radiation spawn
class MenuGMHexRad: DefaultMenuHandler
{
    uint map_id;
	uint16 hex_X;
	uint16 hex_Y;
	uint level;
	
    MenuGMHexRad( Map& map, uint16 hexX, uint16 hexY )
	{
        map_id = map.Id;
		hex_X = hexX;
		hex_Y = hexY;
		level = 1;
    }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
        if( !valid( map ) )
		{
            return true;
        }
		
		if( gm.ParamBase[ CR_VAL2 ] > 0 && gm.ParamBase[ CR_VAL3] > 0 && gm.ParamBase[ CR_VAL4 ] > 0 )
		{
			if( menu.Button( "Radiate Hex" ) )
			{
				RadiateHex( gm, map.Id, hex_X, hex_Y, gm.Param[ CR_VAL2 ], gm.Param[ CR_VAL3], gm.Param[ CR_VAL4 ] );
				unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Radiated Hex on map: " + map.Id + " hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
				return true;
			}
		}
		
		string rad_strength = gm.ParamBase[ CR_VAL2 ];
		if( menu.ButtonExtSay( "Strength: ", rad_strength, "Strength:" ) )
		{
			string strength = menu.GetSayValue();
			int val = 0;
			StrToInt( strength, val );
			if( val > 0 )
			{
				gm.ParamBase[ CR_VAL2 ] = val;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Radiation source strength is: " + val + "." );
			}
			else
			{
				gm.ParamBase[ CR_VAL2 ] = 0;
				gm.Say( SAY_NETMSG, "|0xFFFF00 The value must be positive!" );
			}
			return true;
		}
		
		string rad_time = gm.ParamBase[ CR_VAL3 ];
		if( menu.ButtonExtSay( "Tick: ", rad_time, "Set time between 1 and 60 minutes:" ) )
		{
			string tick = menu.GetSayValue();
			int	val = 0;
			StrToInt( tick, val );
			if( val > 0 && val < 61)
			{
				gm.ParamBase[ CR_VAL3 ] = val;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Radiation tick is: " + val + " minutes." );
			}
			else
			{
				gm.Say( SAY_NETMSG, "|0xFFFF00 You must set time between 1 and 60 minutes!" );
			}
			return true;
		}

		string rad_distance = gm.ParamBase[ CR_VAL4 ];
		if( menu.ButtonExtSay( "Radius: ", rad_distance, "Set radiation radius:" ) )
		{
			string radius = menu.GetSayValue();
			int val = 0;
			StrToInt( radius, val );
			if( val > 0 )
			{
				gm.ParamBase[ CR_VAL4 ] = val;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Radiation source radius is: " + val + " hex." );
			}
			else
			{
				gm.ParamBase[ CR_VAL4 ] = 0;
				gm.Say( SAY_NETMSG, "|0xFFFF00 The value must be positive!" );
			}
			return true;
		}
		
		if( menu.Button( "Return" ) )
		{
			return false;
		}
		
		return true;
    }

    string@ Description( Critter& gm )
	{	
		string info = "Radiation spawn menu. \nSelect options and press [ |0xFFFF00 Radiate Hex |0x3CF800 ]. \nStrength: [|0xFFFF00 " + gm.Param[ CR_VAL2 ] + " |0x3CF800 ] rad"
					+ "\nTick: [ |0xFFFF00 " + gm.Param[ CR_VAL3 ] + " |0x3CF800 ] minutes\nRadius: [ |0xFFFF00 " 
					+ gm.Param[ CR_VAL4 ] + " |0x3CF800 ] hex ";
		return info;
	}
		
	string@ ButtonCancel()
	{
        return ButtonDecorator( "Hide menu", null );
    }
}

//Menu for Gas source spawn
class MenuGMHexGas: DefaultMenuHandler
{
    uint map_id;
	uint16 hex_X;
	uint16 hex_Y;
	uint level;
	
    MenuGMHexGas( Map& map, uint16 hexX, uint16 hexY )
	{
        map_id = map.Id;
		hex_X = hexX;
		hex_Y = hexY;
		level = 1;
    }

    bool MenuUpdate( Critter& gm, iDialogBox& menu )
	{
        Map@ map = GetMap( map_id );
		
        if( !valid( map ) )
		{
            return true;
        }
		
		if( gm.ParamBase[ CR_VAL2 ] > 0 && gm.ParamBase[ CR_VAL3 ] > 0 && gm.ParamBase[ CR_VAL4 ] > 0 )
		{
			if( menu.Button( "Gas Hex" ) )
			{
				GasHex( gm, map.Id, hex_X, hex_Y, gm.Param[ CR_VAL2 ], gm.Param[ CR_VAL3], gm.Param[ CR_VAL4 ] );
				unsafe_log_2( gm, 0, 0, 0, gm.Name + " " + gm.Id + " Created Gas source hex on map: " + map.Id + " hex_X: " + hex_X + " hex_Y: " + hex_Y, null );
				return true;
			}
		}
		
		string gas_strength = gm.ParamBase[ CR_VAL2 ];
		if( menu.ButtonExtSay( "Strength: ", gas_strength, "Strength:" ) )
		{
			string strength = menu.GetSayValue();
			int val = 0;
			StrToInt( strength, val );
			if( val > 0 )
			{
				gm.ParamBase[ CR_VAL2 ] = val;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Gas source strength is: " + val + "." );
			}
			else
			{
				gm.ParamBase[ CR_VAL2 ] = 0;
				gm.Say( SAY_NETMSG, "|0xFFFF00 The value must be positive!" );
			}
			return true;
		}
		
		string gas_time = gm.ParamBase[ CR_VAL3 ];
		if( menu.ButtonExtSay( "Tick: ", gas_time, "Set time between 1 and 60 seconds:" ) )
		{
			string tick = menu.GetSayValue();
			int	val = 0;
			StrToInt( tick, val );
			if( val > 0 && val < 61)
			{
				gm.ParamBase[ CR_VAL3 ] = val;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Gas tick is: " + val + " seconds." );
			}
			else
			{
				gm.Say( SAY_NETMSG, "|0xFFFF00 You must set time between 1 and 60 seconds!" );
			}
			return true;
		}

		string gas_distance = gm.ParamBase[ CR_VAL4 ];
		if( menu.ButtonExtSay( "Radius: ", gas_distance, "Set gas radius:" ) )
		{
			string radius = menu.GetSayValue();
			int val = 0;
			StrToInt( radius, val );
			if( val > 0 )
			{
				gm.ParamBase[ CR_VAL4 ] = val;
				gm.Say( SAY_NETMSG, "|0xFFFF00 Gas source radius is: " + val + " hex." );
			}
			else
			{
				gm.ParamBase[ CR_VAL4 ] = 0;
				gm.Say( SAY_NETMSG, "|0xFFFF00 The value must be positive!" );
			}
			return true;
		}
		
		if( menu.Button( "Return" ) )
		{
			return false;
		}
		return true;
    }

    string@ Description( Critter& gm )
	{	
		string info = "Gas hex spawn menu. \nSelect options and press [ |0xFFFF00 Gas Hex |0x3CF800 ]. \nStrength: [|0xFFFF00 " + gm.Param[ CR_VAL2 ] + " |0x3CF800 ] points"
					+ "\nTick: [ |0xFFFF00 " + gm.Param[ CR_VAL3 ] + " |0x3CF800 ] seconds.\nRadius: [ |0xFFFF00 " 
					+ gm.Param[ CR_VAL4 ] + " |0x3CF800 ] hex ";
		return info;
	}
		
	string@ ButtonCancel()
	{
        return ButtonDecorator( "Hide menu", null );
    }
}

string PlayerGameMode( Critter& cr )
{
	string result = "";
	if( isGM( cr ) )
	{
		result += " GM";
	}
	else if( cr.IsNpc() )
	{
		result += " NPC";
	}
	else
	{
		result += " Player";
	}

	return result;
}

void Log_Killings( Critter& player, int targetId, int param1, int param2, string@ param3, int[] @ param4 )
{
	string action = valid( param3 ) ? param3 : "murders";
    string info = player.Id + " " + targetId + " " + param1 + " " + param2 + " '" + action + "'";
	
	file f;
    if( f.open( "logs\\killings.txt", "a" ) == -1 )
	{
		Log( "Did not manage to record the murder in logs. [ " + info + " ]" );
		return;
	}
	
	Critter@ target = GetCritter( targetId );
	if( !valid( target ) )
	{
		Log( "Murder victim not found. [ " + info + " ]" );
	}
	
    Map@ map = player.GetMap();
	if( !valid( map ) )
	{
		Log( "Murder on global. [ " + info + " ]" );
		return;
	}

	Location@ loc = map.GetLocation();
	if( loc.GetProtoId() == LOCATION_TLJ_ARENA )
	{
		return;
	}

	string@ map_name = !valid( map ) ? "Global" : GetMsgStr( 1, TEXTMSG_GM, ( map.GetProtoId() + 1 ) * 10 + 8 );
	if( !valid( map_name ) )
	{
		@map_name = "[ Map #" + map.Id + " PID " + map.GetProtoId() + " ]";
	}
	
	info = map_name + ": " + PlayerGameMode( player ) + " " + crInfo( player ) + " " + action + PlayerGameMode( target ) + " " + crInfo( target );
	f.writeString( TimeToString() + "\t" + info + "\n" );
    f.close();
    
    Critter@[] crs;
    GetAllPlayers( crs );
    string str = "|0xFFFF0000 <|0xFFFFFF00 " + info + ")|0xFFFF0000 > |0xFFBB33CC ";
    for( uint i = 0, j = crs.length(); i < j; i++ )
	{
		if( !valid( crs[i] ) || !isGM( crs[i] ) )
		{
			continue;
		}
		
		crs[i].Say( SAY_NETMSG, str );
	}
	
	DiscordSendMessage( "killings", " ``` " + info + " ``` " );
}

void Log_GM( Critter& player, int crId, int action, int param0, int param1, int param2 )
{
    string   crname;
    Critter@ cr = GetCritter( crId );
    if( valid( cr ) )
	{
        crname = GetPlayerName( crId );
    }
	string date = TimeToString();
}

void Log_Lockpick( Critter& player, int lock, int force, int succes, string@ param3, int[] @ param4 )
{
    string type;
    if( player.Param[ QST_GAMEMODE ] == GAME_START )
	{
        type = "Start";
	}
	else if( player.Param[ QST_GAMEMODE ] == GAME_ADVENTURE )
	{
        type = "Adv.";
	}
    else if( player.Param[ QST_GAMEMODE ] == GAME_SURVIVAL )
	{
        type = "Surv.";
	}
    else if( player.Param[ QST_GAMEMODE ] == GAME_TEST )
	{
        type = "Test";
	}
	
    if( isGM( player ) )
	{
        type += " GM";
	}
    else if( player.GetAccess() > ACCESS_MODER )
	{
        type += " Admin";
	}
    else
	{
        type = "error";
	}
	
    Map@   map = player.GetMap();

    string place = map.GetProtoId();
    string date = TimeToString();

    Item@  locker = GetItem( lock );
    string compl = locker.LockerComplexity;

    if( force == 0 )
    {
        file f;
        if( f.open( "logs\\lockpick.txt", "a" ) >= 0 )
        {
            f.writeString( "" + date + "\t" + player.Id + "\t" + type + "\t" + GetPlayerName( player.Id ) + "\t" + "\t" + " opened lock " + lock + " with lock difficulty of " + compl +" at " + "\t" + place + "\n" );
            f.close();
        }
    }
	
    if( force == 0 && succes == 1 )
    {
        file f;
        if( f.open( "logs\\lockpick.txt", "a" ) >= 0 )
        {
            f.writeString( "" + date + "\t" + player.Id + "\t" + type + "\t" + GetPlayerName( player.Id ) + "\t" + "\t" + " successfully lockpicked the lock: " + lock + " with lock difficulty of " + compl +" at " + "\t" + place + "\n" );
            f.close();
        }
    }
	
    if( force == 1 )
    {
        file f;
        if( f.open( "logs\\lockpick.txt", "a" ) >= 0 )
        {
            f.writeString( "" + date + "\t" + player.Id + "\t" + type + "\t" + GetPlayerName( player.Id ) + "\t" + "\t" + " was breaking the lock " + lock + " with lock difficulty of " + compl +" at " + "\t" + place + "\n" );
            f.close();
        }
    }
}

void Log_Steal( Critter& player, int target, int item, int succes, string@ param3, int[] @ param4 )
{
    string type;
    if( player.Param[ QST_GAMEMODE ] == GAME_START )
	{
        type = "Start";
    }
	else if( player.Param[ QST_GAMEMODE ] == GAME_ADVENTURE )
	{
        type = "Adv.";
    }
	else if( player.Param[ QST_GAMEMODE ] == GAME_SURVIVAL )
	{
        type = "Surv.";
	}
	else if( player.Param[ QST_GAMEMODE ] == GAME_TEST )
	{
        type = "Test";
		
    } 
	
	if( isGM( player ) )
	{
        type += " GM";
    }
	else if( player.GetAccess() > ACCESS_MODER )
	{
        type += " Admin";
	}
	else
	{
        type = "error";
	}
	
	Map@   map = player.GetMap();
    string place = map.GetProtoId();
    string date = TimeToString();

    string targetname = "";
    Critter@ cr = GetCritter( target );
    if( cr.IsPlayer() )
	{
        targetname = GetPlayerName( target );
	}
	
    file f;
    if( f.open( "logs\\steal.txt", "a" ) >= 0 )
	{
        f.writeString( "" + date + "\t" + player.Id + "\t" + type + "\t" + GetPlayerName( player.Id ) + "\t" + "\t" + " stole from " 
		+ "\t" + target + "\t" + targetname + " item " + item + " in " + "\t" + place + "\n" );
        f.close();
    }
}

void Log_factions( Critter& player, int crId, int mode, int level, string@ param3, int[] @ param4 )
{
    string type;
    string date = TimeToString();
	string action = "";
	switch( mode )
	{
		case(0): 
		{
			string[] types = { "Start",  "Adventurer", "Survivor", "Test" };
			if( level >= 0 && level < int(types.length()) )
			{
				type = types[level];
			}
			else
			{
				type = "error";
			}
			action = "game mode";
			break; 
		}
	}
    file f;
	
    if( f.open( "logs\\factions.txt", "a" ) < 0 )
	{
		return;
	}
	
	f.writeString( FixedSize( date, 20 ) + " " + FixedSize( crInfo( player ), 25 ) + " changes " + action + " to '" + type + "' for " + crInfo( crId ) + "\n" );		
	f.close();
}

//BAN
void unsafe_banid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		banid( player, param0, param1, param2, param3, param4 );
	}
}

void banid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    BanId( player, param0, param1, param2 );
}

void unsafe_kickid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		kickid( player, param0, param1, param2, param3, param4 );
	}
}

void kickid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    KickId( player, param0, 0, 0 );
}

void unsafe_kickbanipid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		kickbanipid( player, param0, param1, param2, param3, param4 );
	}
}

void kickbanipid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    KickBanIdIp( player, param0, param1, param2 );
}

void unsafe_unbanid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		unbanid( player, param0, param1, param2, param3, param4 );
	}
}

void unbanid( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    UnbanId( player, param0, 0, 0 );
}

void unsafe_getips( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		getips( player, param0, param1, param2, param3, param4 );
	}
}

void getips( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    GetIps( player, param0, 0, 0 );
}

void unsafe_statcompareradius( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		statcompareradius( player, param0, param1, param2, param3, param4 );
	}
}

void statcompareradius( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@[] crs;

    if( player.GetMap().GetCrittersHex( player.HexX, player.HexY, param1, FIND_ALL | FIND_ONLY_PLAYERS, crs ) > 0 )
	{
        CrittersStatCompare( player, crs, uint16( param0 ) );
    }
}

void unsafe_statcompare( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		statcompare( player, param0, param1, param2, param3, param4 );
	}
}

void statcompare( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@[] crs;
    for( uint8 i = 0, j = param4.length(); i < j; ++i )
	{
        Critter@ cr = GetCritter( param4[ i ] );
        if( !valid( cr ) )
		{
			continue;
		}
        crs.insertLast( cr );
    }
    CrittersStatCompare( player, crs, uint16( param0 ) );
}

void CrittersStatCompare( Critter& player, Critter@[]& crs, uint16 stat )
{
    uint16 minVal = 0, maxVal = 0;
    uint   minId = 0, maxId = 0;

    for( uint16 i = 0, j = crs.length(); i < j; ++i )
	{
        uint16 statVal = crs[ i ].Param[ stat ];
        if( statVal > maxVal )
		{
            minVal = statVal;
            minId = crs[ i ].Id;
        }
		else if( statVal < minVal )
		{
            minVal = statVal;
            minId = crs[ i ].Id;
        }
    }
    player.Say( SAY_NETMSG, "Stat : " + stat + "\nmin value : " + minVal + " id : " + minId + "\nmax value : " + maxVal + " id : " + minId );
}


void unsafe_killbytype( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		killbytype( player, param0, param1, param2, param3, param4 );
	}
}

void killbytype( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@ target = GetCritter( param0 );
    if( target is null )
	{
        player.Say( SAY_NETMSG, "Target not found." );
        return;
    }

    uint16 deadType = 0;
    if( param1 > 0 && param1 < 11 )
	{
        deadType = ANIM2_DEAD_BLOODY_SINGLE - 1 + param1;
	}
	else
	{
        deadType = ( Random( 0, 1 ) > 0 ? ANIM2_DEAD_FRONT : ANIM2_DEAD_BACK );
	}
    target.ToDead( deadType, null );
}

void unsafe_GM_teleport_to_next_player( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( isGM( player ) )
	{
		GM_teleport_to_next_player( player, param0, param1, param2, param3, param4 );
	}
}

void GM_teleport_to_next_player( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    Critter@[] crs;
    GetAllPlayers( crs );
    if( player.StatBase[ ST_VAR0 ] >= int( crs.length() ) )
	{
        player.StatBase[ ST_VAR0 ] = 0;
		player.EraseTimeEvents( 7);
	}
	
    Critter@ daddy = crs[ player.StatBase[ ST_VAR0 ] ];
    if( !valid( daddy ) )
	{
        player.Say( SAY_NETMSG, "Target not found." );
        player.StatBase[ ST_VAR0 ]++;
        return;
    }
	
    player.StatBase[ ST_VAR0 ]++;
    if( daddy.Id == player.Id )
	{
        return;
	}
	
    Map@ map = daddy.GetMap();
    if( !valid( map ) )
	{
        player.Say( SAY_NETMSG, "Player " + GetPlayerName( daddy.Id ) + " on Global." );
        return;
    }
    else if( map.GetProtoId() == MAP_UTILITY_START )
	{
        player.Say( SAY_NETMSG, "Player " + GetPlayerName( daddy.Id ) + " is on startmap." );
        return;
    }
	
	uint[] rates;
	player.GetTimeEvents( 7, null, null, rates );
    for( uint ii = 0; ii < rates.length(); ii++ )
	{
		if( rates[ii] == daddy.Id )
		{
			player.Say( SAY_NETMSG, "Player " + GetPlayerName( daddy.Id ) + " has already been checked." );
			return;
		}
    }	

    uint8 temp_dir = ( daddy.Dir + 3 ) % 6;
	
    for( uint i = 0; i < 6; i++ )
	{
        uint16 hexX = daddy.HexX, hexY = daddy.HexY;
        map.MoveHexByDir( hexX, hexY, ( temp_dir + i ) % 6, Random( 3, 5 ) );
		
        if( not map.IsHexPassed( hexX, hexY ) )
		{
			continue;
		}
		
		Location@ loc = map.GetLocation();
		if( !valid( loc ) )
		{
			return;
		}
		
		player.SetWorldPos(loc.WorldX, loc.WorldY);
        player.TransitToMap( map.Id, hexX, hexY, 0 );
        player.Say( SAY_NETMSG, "You have teleported to player " + GetPlayerName( daddy.Id ) + " " + daddy.Id + "." );
		
		Critter@[] critters;
		map.GetCrittersHex( hexX, hexY, 20, FIND_ALL | FIND_ONLY_PLAYERS, critters );
		for( uint j = 0; j < critters.length(); j++ )
		{
			player.AddTimeEvent( "cte_visited", REAL_SECOND( 30 ), 7, critters[j].Id );
        }
		break;
    }
}

uint cte_visited( Critter& cr, int identifier, uint& rate )
{
	return 0;
}

void gmcontrolMob( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
    player.RunClientScript( "client_gui@_SetControlCritters", param0, 0, 0, null, null );
}

void _OnDeadEvent( Critter& dead, Critter@ killer )
{
    dead.AddTimeEvent( "cte_deleteCorpse", __FullSecond + REAL_HOUR( 2 ), CTE_DELETECORPSE );
}

uint cte_deleteCorpse( Critter& dead, int identifier, uint& rate )
{
    DeleteNpc( dead );
    return 0;
}

void unsafe_show_containments( Critter& cr, int targetId, int itemId, int slot, string@, int[]@ )
{
	if( !isGM( cr ) )
	{
		return;
	}
	ShowContainments( cr, targetId, itemId, slot );
}

void ShowContainments( Critter& cr, int targetId, int itemId, int slot )
{
	Critter@ target = targetId == 0 ? null : GetCritter( targetId );
	Item@ item = itemId == 0 ? null : GetItem( itemId );
	
	if( !valid( target ) && !valid( item ) )
	{
		if( cr.ParamBase[ CR_TARGET_CONTAINER_ID ] == 0 )
		{
			cr.Say( SAY_NETMSG, "Put cursor on target in look mode." );
		}
		else
		{
			itemId = cr.ParamBase[ CR_TARGET_CONTAINER_ID ];
			cr.ParamBase[ CR_TARGET_CONTAINER_ID ] = 0;
			ShowContainments( cr, 0, itemId, slot );
		}
		return;
	}
	
	if( valid( target ) )
	{
		if( slot != SLOT_INV )
		{
			string[] slot_names = { "SLOT_INV", "SLOT_HAND1", "SLOT_HAND2", "SLOT_ARMOR", "SLOT_MISC", "SLOT_HEAD", "SLOT_BACK" };
			if( slot < 0 || uint(slot) >= slot_names.length() )
			{
				cr.Say( SAY_NETMSG, "Slot #" + slot + " is out of range [" + slot_names.length() + "." );
				return;
			}
			
			Item@[] items;
			uint count = target.GetItems( slot, items );
			if( count > 0 )
			{
				GM_ItemPanel( cr, items[0].Id );
			}
			else
			{
				cr.Say( SAY_NETMSG, "There is nothing in " + slot_names[slot] );
			}
			return;
		}
		
		ShowContainer( cr, target, TRANSFER_FAR_CRIT );
		return;
	}
	
	if( !isContainer( item ) )
	{
		GM_ItemPanel( cr, itemId );
		return;
	}
	
	ShowContainer( cr, item, TRANSFER_FAR_CONT );
}

// GM mode hotkey
void unsafe_GMSwitch( Critter& player, int param0, int param1, int param2, string@ param3, int[] @ param4 )
{
	if( player.Param[ ST_ACCESS_LEVEL ] < ACCESS_MODER )
	{
		return;
	}

	if( player.Param[ QST_VISION ] != 0 )
	{
		player.ParamBase[ QST_VISION ] = 0;
		player.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GM_MODE_OFF );
		SayLogGM( player, crInfo( player ) + " : Disables GM mode :" );
	}
	else
	{
		player.ParamBase[ QST_VISION ] = 250;
		player.SayMsg( SAY_NETMSG, TEXTMSG_TEXT, STR_GM_MODE_ON );
		SayLogGM( player, crInfo( player ) + " : Enables GM mode :" );
	}
	
	player.RunClientScript( "client_main@_sinf", isGM( player ) ? player.Param[ CR_SINF_MODE ] : 0, 0, 0, null, null );
}

//~run gm switchDebugMode val 0 0
void switchDebugMode( Critter& cr, int val, int, int )
{
	GameVar@ var = GetGlobalVar( GVAR_DebugInfo );
	if( !valid( var ) )
	{
		return;
	}
	
	string text = "Debug mode ";
	if( val == 0 )
	{
		text += "use_skill & use_item " + ( var.GetValue() == 1 ? "on" : "off" );
		var.opAssign( CLAMP( 1 - var.GetValue(), 0, 1 ) );
	}
	else 
	{
		text += "Level set: " + val;
		var.opAssign( val );
	}
	
	cr.Say( SAY_NETMSG, text );
	Log( text );
}


void unsafe_delete_location( Critter& cr, int locationId, int param1, int param2, string@ param3, int[]@ param4 )
{
	if( !isGM( cr ) )
	{
		return;
	}
	DeleteLocation( cr, locationId );
}

void DeleteLocation( Critter& cr, uint16 locationId )
{
	Location@ loc = GetLocation( locationId );	
	if( !valid( loc ) )
	{
		cr.Say( SAY_NETMSG, "|0xFFFF00 Location does not exist!" );
		return;
	}
	
	DeleteLocation( locationId );
	cr.Say( SAY_NETMSG, "|0xFFFF00 Location deleted" );
}

#endif //__GM_MODULE__