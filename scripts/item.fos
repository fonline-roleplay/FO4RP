// Author: rifleman17
#include "_macros.fos"
#include "_npc_pids.fos"
#include "_colors.fos"

import void ShowInputBoxScreen( Critter& cr, string funcName, uint16 textLength, uint8 flags ) from "main";
import bool isGM( Critter& player ) from "gm";
import void telekineticExplosion (Critter& cr) from "combat";
/* from old lite

   #define STR_SHOVEL_NEEDED	(50)

   void item_geck(Item& item)
   {
        if (item.IsGrouped()) return;
        SETFLAG(item.Flags, ITEM_GECK);
        item.Update();
   }

   void item_hide(Item& item)
   {
        SETFLAG(item.Flags, ITEM_HIDDEN);
        item.Update();
   }

   void item_selector(Item& item)
   {
        int x,y;
        Map@ map = item.GetMapPosition(x,y);
        if(not valid(map)) return;
        //map.GetItems ...
        // ...
   }

   void item_rnd_del(Item& item)
   {
        if(uint(Random(1,100))<=CLAMP(item.Val1,0,100))
                DeleteItem(item);
   }

   void item_spawn(Item& item)
   {

   }

   // ??????? ?????? ???????? ?? ?????????? ????? - ?? ?????????? ?? ???????.
   // ???? ??????????? ?????? ????????? ?? ????????????? ????? (???? ???????? ? ??).
   void _Geck(Item& item, bool firstTime)
   {
        if(firstTime)
                item_geck(item);
   }

   // ??????? ? ??????? ? ScriptName "item_hide" - ? ??????? ?????? ?????????.
   void _Hide(Item& item, bool firstTime)
   {
        if(firstTime)
                item_hide(item);
   }

   // Author: heX
   // Item lib.
   // (?? ????????!!!)
   // ???????? ????? ? ???????????? ????????????.
   // ? Val1 ?? ??????????...
   // ????! Val1 ?? ???????? ??? ?????? ??????.
   void _RndDel(Item& item, bool firstTime)
   {
        if(firstTime)
                item_rnd_del(item);
   }

   // Author: heX
   // Item lib.
   // (?? ????????!!!)
   // ??????? ??? ????? ?????????? ???????? item_selector ????? ??????.
   // ???? ?? ???????? ???????? ????????? ???? (PID_FLOOR_SAFE),
   // ?? ?? ???? ????? ??????
   // ? ??? ?? ??????? ???????(???? ??? ???? ?? ??????)
   // ?? ?????????? ????? ?????????? ?????? ????.
   void _Selector(Item& item, bool firstTime)
   {
        if(firstTime)
                item_selector(item);
   }

   // (?? ????????!!!)
   // ??????? ???? ????? ???????????? ?????????? ???????.
   // ?????? ???? ???? ???????, ?? ????? ????????? ????? ?? ????????? ?????.
   // ???????????? ? ?????????????! - ????? ?????? ???????? ?????????? ??????? ? ???????
   // ??? ??? ????? ?????????????
   // ? ???????????? ?????? ????????? ????? ??? ????????? ????? ????? ???? - ???????? ??? ??????? ??? ??????.
   // ? ????? ????? ?????????? ?????.
   // ? ??????????? ????? ?????????? ?????.
   // ?? ? ??? ?????.
   void _Spawn(Item& item, bool firstTime)
   {
        if(firstTime)
                item_spawn(item);
   }
   //rifleman 17
   // ?????, ??????? ????????? ????? 2 ??????? ?????? ???? ????? ????????? ????? ???????? ?????? , ????????? ? val3
 */

// from new SDK

// Дверь, которая зпкроется через 2 игровые минуты илии через некоторое число реальных секунд , указанное в val3

bool ScriptDoor( Item& door ) { return door.SetScript( "_DoorAutoCloseInit" ); }

void _DoorAutoCloseInit( Item& door, bool firstTime ) { door.SetEvent( ITEM_EVENT_SKILL, "e_UseAutoCloseDoor" ); }

bool e_UseAutoCloseDoor( Item& door, Critter& cr, int skill )
{
	CreateTimeEvent( __FullSecond + REAL_SECOND( door.Val3 == 0 ? 10 : door.Val3 ), "e_AutoCloseDoor", door.Id, true );
	return false;
}

uint e_AutoCloseDoor( uint[] @ val )
{
	Item@ door = GetItem( val[ 0 ] );
	if( not valid( door ) ) { return 0; }
	if( !FLAG( door.LockerCondition, LOCKER_ISOPEN ) ) { return 0; }

	uint16 x = 0;
	uint16 y = 0;
	Map@ map = door.GetMapPosition( x, y );
	if( not valid( map ) ) { return 0; }

	Critter@ cr = map.GetCritter( x, y );
	if( valid( cr ) )
	{
		if( cr.IsLife() ) { return REAL_SECOND( 10 ); } else { cr.TransitToMap( map.Id, x - 1, y, cr.Dir ); }
	}

	if( door.LockerClose() ) { return 0; }

	return REAL_MINUTE( 3 );
}

// Дверь, которая не открывается стандартными способами
void _ClosedDoorInit( Item& door, bool firstTime )
{
    door.SetEvent( ITEM_EVENT_SKILL, "_UseDoor" );
}

bool _UseDoor( Item& door, Critter& cr, int skill )
{
    return true;
}

// Дверь, при использовании которой открывается диалог
void _DialogDoorInit( Item& door, bool firstTime )
{
    door.SetEvent( ITEM_EVENT_SKILL, "_UseDialogDoor" );
}

bool _UseDialogDoor( Item& door, Critter& cr, int skill )
{
    RunDialog( cr, door.Val3, door.HexX, door.HexY, false );
    return true;
}

// Голодиск с номером, присвоенном в Val0
void _HoloInit( Item& item, bool firstTime )
{
    if( item.GetProtoId() != PID_HOLODISK )
        return;
    item.HolodiskNumber = item.Val0;
    item.SetScript( "" );
    item.Update();

}

// from old lite

// powermagic - ????????? ????? ??? ????????
void _RndAnim( Item& item, bool firstTime ) // Sprite& sprite) // ItemCl& itemCl
{
    int rndFrm = Random( 0, item.Val1 );    // itemCl.GetSpriteCount(item.GetProtoId())); // + 1
    // item.Animate(rndFrm, rndFrm);
    item.AnimStayBegin      = rndFrm;
    item.AnimStayEnd        = rndFrm;
    item.AnimShowBegin      = rndFrm;
    item.AnimShowEnd        = rndFrm;
    item.AnimHideBegin      = rndFrm;
    item.AnimHideEnd        = rndFrm;
//	for (int i = 0; i > Sprite.FrmCount; i++)
    return;
}

void _ItemBagInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_ItemBagPick" );
    item.SetEvent( ITEM_EVENT_USE_ON_ME, "e_ItemBagUseItem" );
// item.SetEvent(ITEM_EVENT_USE_ITEM, "e_ItemBagOpen");
}

bool e_ItemBagPick( Item& item, Critter& crit, int skill ) //what is it? deprecated!
{
	if( skill == SKILL_PICK_ON_GROUND && item.Accessory == ACCESSORY_HEX )
    {
        MoveItem( item, item.GetCount(), crit );
        crit.Say( SAY_NETMSG, "pick grnd" );
    }
    return true;
}

import void SwitchState( Item& locker ) from "lockers";

bool e_ItemBagUseItem( Item& item, Critter& crit, Item@ usedItem )
{
    if( valid( usedItem ) && usedItem.GetProtoId() == PID_SHOVEL )
    {
        Map @ map = crit.GetMap();
        if( map.IsHexPassed( item.HexX + 2, item.HexY + 2 ) )
        {
            string logMsg;
            Item @ hole = map.AddItem( item.HexX + 2, item.HexY + 2, ITEM_TREASURE_HOLE, 1 );
            SETFLAG( hole.LockerCondition, LOCKER_ISOPEN );
            logMsg = "Init = " + SETFLAG( hole.LockerCondition, LOCKER_ISOPEN );
            crit.Say( SAY_NETMSG, logMsg );
//       if(FLAG(hole.LockerCondition,LOCKER_ISOPEN)) {SwitchState(hole);}
            hole.Val4 = hole.HexX;
            hole.Val5 = hole.HexY;
            hole.Val7 = crit.WorldX;
            hole.Val8 = crit.WorldY;
            Item @ treasureMap = crit.AddItem( ITEM_TREASURE_MAP, 1 );
            treasureMap.Val7 = crit.WorldX;
            treasureMap.Val8 = crit.WorldY;
            treasureMap.SetLexems( "$hexX" + treasureMap.Val7 + "$hexY" + treasureMap.Val8 );
//       treasureMap.SetLexems("$hexY"+treasureMap.Val8);
            return true;
        }
    }
    else if( item.Accessory == ACCESSORY_HEX )
    {
//     MoveItem(usedItem, usedItem.GetCount(), item, 0);
        crit.ShowScreen( SCREEN_CLOSE, 0, "" );
		crit.ParamBase[ ST_LAST_CONT_ID ] = 0;
        crit.ShowContainer( null, item, item.Proto.GroundLevel ? TRANSFER_HEX_CONT_DOWN : TRANSFER_HEX_CONT_UP );
        return true;
    }
    return false;
}
/*
   void _TreasureInit(Item& item, bool firstTime)
   {
   item.SetEvent(ITEM_EVENT_USE_ON_ME, "e_TreasureOpen");
   item.SetEvent(ITEM_EVENT_SKILL, "e_TreasureUse");
   //   GraveSetFrm(item, 1);
   }

   bool e_TreasureOpen(Item& item, Critter& crit, Item@ usedItem)
   {
   if(valid(usedItem) && usedItem.GetProtoId()==PID_SHOVEL)
        {

                SwitchState(item);
                if(FLAG(item.LockerCondition,LOCKER_ISOPEN))
                {
   //             item.ChangeProto(902);
                  item.Val6 = 1;
                }
                else {item.Val6 = 0;}
                item.Update();
                return true;
        }
   return false;
   }



   bool e_TreasureUse(Item& item, Critter& cr, int skill)
   {
        if(skill==SKILL_PICK_ON_GROUND || skill==SK_LOCKPICK)
        {
                if(FLAG(item.LockerCondition,LOCKER_ISOPEN)) {cr.ShowContainer(null,item,TRANSFER_HEX_CONT_DOWN);}
                else {cr.SayMsg(SAY_NETMSG,TEXTMSG_GAME,STR_SHOVEL_NEEDED);}
                return true;
        }
        return false;
   }
 */
void _ShovelInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_ShovelUse" );
}

bool e_ShovelUse( Item& item, Critter& cr, int skill )
{
    if( skill == SK_TRAPS  && item.Accessory == ACCESSORY_CRITTER ) // && item.GetProtoId() == PID_SHOVEL
    {
        Map @ map = cr.GetMap();
        if( map.IsHexPassed( cr.HexX + 2, cr.HexY + 2 ) )
        {
            string logMsg;
            Item @ hole = map.AddItem( cr.HexX + 2, cr.HexY + 2, ITEM_TREASURE_HOLE, 1 );
            SETFLAG( hole.LockerCondition, LOCKER_ISOPEN );
            hole.Val4 = hole.HexX;
            hole.Val5 = hole.HexY;
            hole.Val7 = cr.WorldX;
            hole.Val8 = cr.WorldY;
            Item @ treasureMap = cr.AddItem( ITEM_TREASURE_MAP, 1 );
            treasureMap.SetLexems( "$hexX" + treasureMap.Val7 + "$hexY" + treasureMap.Val8 );
            return true;
        }
    }
    return false;
}



// powermagic
// key && key brunch script

void _KeyBunchInit( Item& item, bool firstTime )
{
    //item.SetEvent( ITEM_EVENT_USE_ON_ME, "e_KeyBunchAdd" );
    //item.SetEvent( ITEM_EVENT_USE, "e_KeyBunchUse" );
	//item.SetEvent( ITEM_EVENT_SKILL, "e_KeyBunchSkill" );
}

bool e_KeyBunchTest( Item& item, Critter& cr, int skill )
{
    if( skill == SKILL_PUT_CONT )
    {
        cr.Say( SAY_NETMSG, "dude great!" );
        return true;
    }
    return false;
}

bool e_KeyBunchSkill( Item& item, Critter& cr, int skill ) // 143
{
    string msg;
    switch( skill )
    {
		case SK_REPAIR:
		{
			Item@ temp = cr.AddItem( 82, 1 );
			msg = Random( 0, 51 );
			temp.SetLexems( "$KeyLex" + Random( 0, 51 ) );
		}
		case SKILL_PICK_ON_GROUND:
			if( item.Accessory == ACCESSORY_HEX )
			{
				MoveItem( item, item.GetCount(), cr );
				return true;
			}
			if( item.ContainerId == cr.Id )
			{
				cr.Say( SAY_NETMSG, "that's work" );
				key = item.Id;
				cr.ShowScreen( SCREEN_CLOSE, 0, "@"    ); return true;
			}
		case SK_TRAPS:
		{
			Item@[] keys;
			item.GetItems( 0, keys );
			if( keys.length() > 0 )
			{
				cr.Action( ACTION_PICK_CRITTER, 0, null );
				for( uint8 i = 0; i < keys.length(); i++ )
				{
					MoveItem( keys[ i ], keys[ i ].GetCount(), cr );
				}
				cr.Say( SAY_NETMSG, "SUCK MY BALLS BITCH!!! " + item.Accessory );
				return true;
			}
		}
		case SK_SCIENCE:
		{
			Item@[] keys;
			item.GetItems( 0, keys );
			int[] keysId;
			if( keys.length() > 0 )
			{
				for( uint8 i = 0; i < keys.length(); i++ )
				{
					keysId[ i ] = keys[ i ].Id;
				}
				cr.RunClientScript( "_ItemLexRtn", 0, 0, 0, null, keysId );
			}
			return true;
		}
	}
    return false;
}

//     cr.ShowContainer(null, item, TRANSFER_FAR_CONT);

//     cr.SetEvent(CRITTER_EVENT_USE_SKILL, "e_CrUseSkill");

/*if(skill == SKILL_PUT_CONT)

   {

   cr.Say(SAY_NETMSG, "dude great!");

   }

   //     cr.ShowScreen(SCREEN_CLOSE, null, null);



   //     cr.ShowScreen(SCREEN_BAG , 0, "item@TestScreen");





   Item@[] keys;

   item.GetItems(0, keys);*//*

   for(uint8 i = 0; i < keys.length(); i++)

   {

   if(keys[i].GetType() != ITEM_TYPE_KEY)

   {

     MoveItem(keys[i], keys[i].GetCount(), cr);

   }

   cr.Say(SAY_NETMSG, "key "+keys[i].Id);

   uint         GetItems (uint specialId, Item@[]@+ items)

   }*/



bool e_KeyBunchAdd( Item& item, Critter& cr, Item@ usedItem )
{
    if( usedItem.GetType() == ITEM_TYPE_KEY )
    {
        MoveItem( usedItem, usedItem.GetCount(), item, 0 );
        cr.Say( SAY_NETMSG, "You're added some key to brunch" );
        return true;
    }
    return false;
}

uint key;

bool e_KeyBunchUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( valid( onItem ) && onItem.GetType() == ITEM_TYPE_DOOR )
    {
        Item@[] keys;
        item.GetItems( 0, keys );
        if( onItem.LockerCondition == LOCKER_LOCKED )
        {
            for( uint8 i = 0; i < keys.length(); i++ )
            {
                if( keys[ i ].LockerId == onItem.LockerId )
                {
                    onItem.LockerId = 0;
                    onItem.LockerComplexity = 0;
                    cr.Say( SAY_NETMSG, "You're ulock the door" );
                }
            }
        }
    }
    return false;
}



void KeyUseScreen( Critter& player, uint answerI, string& answerS )
{
//   Item@ item = GetItem(answerI);

//   Critter @ cr = GetCritter(item.CritId);

    if( answerS.length() != 0 )
    {
//        uint keyNumber = Random(0, 65534);
//        onDoor.LockerCondition = LOCKER_LOCKED;
//        onDoor.LockerComplexity = lockpick;
//        Log("Locked, LockerCompl = " + onDoor.LockerComplexity);
//        onDoor.LockerId = keyNumber;
//        key.LockerId = keyNumber;
        Item @ key = GetItem( player.StatBase[ ST_VAR0 ] );
        key.SetLexems( "$KeyLex" + answerS );
        key.Update();
//     key.SetEvent(ITEM_EVENT_USE, "");
    }
//   else
//   {
//     key.SetLexems("$KeyLex"+ "noNameKey");
//   }

//     @key = null;
//      @onDoor = null;
//   cr.Say(SAY_NETMSG, keyName);
}

/*

   bool e_CrUseSkill(Critter& cr, int skill, Critter@ onCritter, Item@ onItem, Scenery@ onScenery)

   {

   if(skill == SKILL_PUT_CONT)

   {

    if(onItem.GetType() == ITEM_TYPE_KEY)

    {

      return false;

    }

    cr.Say(SAY_NETMSG, "type = "+onItem.GetType());

    return true;

   //     if(item.GetType() == ITEM_TYPE_KEY) {cr.Say(SAY_NETMSG, "work");} else {cr.Say(SAY_NETMSG, "rok");}

   }

   return false;

   }*/



void _LockerInit( Item& item, bool firstTime )
{
//   if(firstTime)
//   {
//     item.SetLexems("$KeyLex"+"unnamed key");
    item.SetEvent( ITEM_EVENT_USE, "e_LockerKeyUse" );
//   }
}



// Item @ key;
// Item @ onDoor;
// uint16 lockpick = 0;

bool ItemLockedCont( Item& item )
{
    if( item.GetType() == ITEM_TYPE_CONTAINER )
    {
        uint16 proto = item.GetProtoId();
        if( 41 < proto && proto < 46 )
        {
            return true;
        }
        if( 127 < proto && proto < 140 )
        {
            return true;
        }
        if( 180 < proto && proto < 190 )
        {
            return true;
        }
        if( 366 < proto && proto < 371 )
        {
            return true;
        }
        switch( proto )
        {
        case 245:
            return true;
        case 501:
            return true;
        case 502:
            return true;
        case 521:
            return true;
        }
    }
    return false;
}

bool e_LockerKeyUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( valid( onItem ) )
    {
        if( ( onItem.GetType() == ITEM_TYPE_DOOR || onItem.Proto.Container_Changeble || onItem.GetProtoId() == PID_SLOT_MACHINE || onItem.GetProtoId() == PID_SLOT_MACHINE2 ) && onItem.Val1 == 0 && onItem.Val0 == 0 )
        {
            if( _LockerIsClose( onItem ) ) /*onItem.LockerCondition == LOCKER_ISOPEN*/
            {
				if( cr.CountItem( PID_CRAFT_M_BARS ) < 1 )
				{
					cr.Say( SAY_NETMSG, "Вам нужна хотя бы одна железяка для заготовки ключа под устанавливаемый замок." );
					return true;
				}
				
                if( onItem.LockerCondition != LOCKER_LOCKED && onItem.LockerComplexity == 0 )
                {
                    uint key_pid = PID_BLANK_KEY;
					switch( item.GetProtoId() )
                    {
                    case PID_LOCKER_LOW:
                        onItem.Val0 = 1;
						key_pid = PID_TEMPLE_KEY;
                        break;
                    case PID_LOCKER_MED:
                        onItem.Val0 = 2;
						key_pid = PID_JAIL_KEY;
                        break;
                    case PID_LOCKER_HARD:
                        onItem.Val0 = 3;
						key_pid = PID_VAULT_13_SHACK_KEY;
                        break;
                    }

					cr.DeleteItem( PID_CRAFT_M_BARS, 1 );
					
                    Item @ key = cr.AddItem( key_pid, 1 );
                    uint keyNumber = Random( 0, 65534 );
                    key.LockerId = keyNumber;

                    onItem.LockerId = keyNumber;
                    onItem.LockerCondition = LOCKER_LOCKED;
                    onItem.LockerComplexity = cr.Skill[SK_LOCKPICK];

                    Log( "Заперт объект №" + onItem.Id + " на замок сложности " + onItem.LockerComplexity + "." );
                    DeleteItem( item );

                    key.SetLexems( null );
                    key.Update();

					cr.StatBase[ ST_LAST_DOOR_ID ] = key.Id;
					cr.StatBase[ ST_LAST_CONT_ID ] = key.Accessory;
					ShowInputBoxScreen( cr, "main@unsafe_MakeDescLex#Описание:", 0, INPUTBOX_CLOSE_ON_ENTER );
                    return true;
                }
                else
                {
                    cr.Say( SAY_NETMSG, "Дверь уже заперта, сначала взломайте замок." );
                    return true;
                }
            }
            else
            {
                cr.Say( SAY_NETMSG, "Сначала закройте объект." );
                return true;
            }
        }
        else
        {
            cr.Say( SAY_NETMSG, "Этот объект нельзя запереть." );
            return true;
        }
    }
    return false;
}

void _LightEnvInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_LightEnvSkill" );
}

bool e_LightEnvSkill( Item& item, Critter& cr, int skill )
{
//   if(skill == SKILL_LOOT_CRITTER || skill == SKILL_PICK_ON_GROUND || skill == SKILL_PUT_CONT || skill == SKILL_TAKE_ALL_CONT)
//   {
    cr.Say( SAY_NETMSG, "Don't steal the light!" );
    return true;
//   }
//  return false;
}

// Sargonius
// Очистка голодиска
// А ещё вверху кто-то запорол кодировку русских комментов, беда.
void _EmptyDisk( Item& item, bool firstTime )
{
    if( firstTime )
        item.HolodiskNumber = 0;         // Обнуляем номер голодиска
}

bool e_FillRegistrationDocs( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( item.Val1 == 0 )
    {
        cr.Say( SAY_NETMSG, "Вы вписали своё имя в документ, теперь он действительный" );
        string@ name = GetPlayerName( cr.Id );
        item.SetLexems( "$ModocRegistrationName" + name );
        item.Val1 = cr.Id;
        return true;
    }
    else
    {
        string@ name = GetPlayerName( item.Val1 );
        cr.Say( SAY_NETMSG, "Документ заполнен на имя: " + name );
        return true;
    }
}

// flare

#include "_colors.fos"

#define FLARE_BURN_TIME    ( 1000 )

// import bool GetPlayerRadius(Critter@ player, Critter@[]@ crs, uint16 radius) from "main";
import uint GetPlayers( Critter& cr, uint16 radius, bool square, Critter@[]& crs ) from "manager";

string dataName;                 // for anyData;
// uint16 flareLocId = 0;

bool ShowFlare( Critter@[] crs ) // crs[length-1] - critter who run function
{
    uint8 length = crs.length();
    Map @ map = crs[ length - 1 ].GetMap();
    if( !valid( map ) )
        return false;
    Location @ loc = map.GetLocation();
    if( !valid( loc ) || loc.AutoGarbage == false )
    {
        crs[ crs.length() - 1 ].Say( SAY_NETMSG, "Запускать ракету здесь - бессмыслеца. Найдите более подходящее место." );
        return false;
    }
    /*dataName = "flare_"+loc.Id;
       uint16[] playersId;
       if(IsAnyData(dataName)) GetAnyData(dataName, playersId);
       for(uint16 i = 0; i < length; i++)
       {
       //push_back(playersId, crs[i].Id);
       playersId.insertLast(crs[i].Id);
       if(!crs[i].IsKnownLoc(true, loc.Id)) crs[i].SetKnownLoc(true, loc.Id);
       }
       SetAnyData(dataName, playersId);
       MakeLocVisible(loc, true);
       loc.Color != COLOR_RED?loc.Color = COLOR_RED:0;*/
    uint flareLocId = loc.Id;
    CreateTimeEvent( __FullSecond + FLARE_BURN_TIME, "e_ShowFlare", flareLocId, false );
    return true;
}

uint e_ShowFlare( uint[] @ values )
{
    Location @ loc = GetLocation( values[ 0 ] );
    if( !valid( loc ) )
        return 0;
    /*uint16[] playersId;
       MakeLocVisible(loc, false);
       dataName = "flare_"+loc.Id;
       if(IsAnyData(dataName)) GetAnyData(dataName, playersId);
       uint8 length = playersId.length();
       if(length <= 0) return 0;
       Critter @ cr;
       for(uint8 i = 0; i < length; i++)
       {
       @cr = GetCritter(playersId[i]);
       if(cr.IsKnownLoc(true, loc.Id))
       cr.UnsetKnownLoc(true, loc.Id);
       }
       EraseAnyData(dataName);*/
    return 0;
}

/*void MakeLocVisible(Location& loc, bool visible)
   {
   visible?loc.GeckVisible=true:loc.GeckVisible=false;
   visible?loc.GeckCount=1:loc.GeckCount=0;
   visible?loc.AutoGarbage=false:loc.AutoGarbage=true;
   //return false; //fail
   }*/

void _FlareGun( Item& item, bool firstTime )
{
    // if(firstTime)
    // {
    //item.SetEvent( ITEM_EVENT_SKILL, "e_FlareGunSkill" );
    // }
}

bool e_FlareGunSkill( Item& item, Critter& cr, int skill ) // 143
{
    if( skill != SK_TRAPS )
        return false;
    return FlareGunUse( cr, item );
}

bool FlareGunUse( Critter& cr, Item& item ) // export
{
    if( item.AmmoCount > 0 )
    {
        Critter@[] crs;
        GetGlobalMapCritters( cr.WorldX, cr.WorldY, 200, FIND_LIFE | FIND_ONLY_PLAYERS, crs );
        crs.insertLast( cr );
        if( !ShowFlare( crs ) )
            return false;
        item.AmmoCount -= 1;
        item.Update();
        cr.Say( SAY_NETMSG, "Вы запустили сигнальную ракету." );
    }
    return true;
}
/* //старая функция?? ShowFlare(crs) не будет работать с найденным.
   void testflare(Critter& cr, int p0, int p1, int p2)
   {
   Critter@[] crs;
   uint len = GetPlayers(cr, uint16(p0), p1!=0, crs);
   cr.Say(SAY_NETMSG, "вспышку увидят "+len);
   ShowFlare(crs);
   }*/
// end of flare

// gm item / quest reward

uint expBook;

void _ExpBookInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_ExpBookSkill" );
    if( firstTime )
    {

        item.SetEvent( ITEM_EVENT_USE, "e_ExpBookUse" );
    }
}

bool e_ExpBookSkill( Item& item, Critter& cr, int skill )
{
    switch( skill )
    {
    case  SK_TRAPS:
        expBook = item.Id;
        cr.ShowScreen( SCREEN_SAY, 1, "ExpBookScreen" );
        break;
    case SK_REPAIR:
        item.Val1 = ( item.Val1 == 0 ? 1 : 0 );
        break;
    case SK_SCIENCE:
        cr.Say( SAY_NETMSG, "item state = " + item.Val1 );
        break;
    }
    return true;
}

void ExpBookScreen( Critter& cr, uint answerI, string& answerS )
{
    Item@ expBook0 = GetItem( expBook );
    expBook0.SetEvent( ITEM_EVENT_SKILL, "" );
    if( answerS.length() > 0 )
        StrToInt( answerS, expBook0.Val0 );
    cr.Say( SAY_NETMSG, "" + expBook0.Val0 + " " + answerI + " " + answerS );
}

bool e_ExpBookUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    cr.Say( SAY_NETMSG, "" + item.Val0 );
    if( item.Val0 != 0 )
    {
        if( item.Val1 == 0 )
        {
            cr.StatBase[ ST_EXPERIENCE ] += item.Val0;
        }
        else
        {
            cr.StatBase[ ST_UNSPENT_SKILL_POINTS ] += item.Val0;
            cr.Say( SAY_NETMSG, "U recive " + item.Val0 + " skill points" );
        }
        DeleteItem( item );
        return true;
    }
    return false;
}

// master key. unlock and open door
void _InitMasterKey( Item& key, bool firstTime )
{
	// Log( "Инициализируем ключ PID " + key.GetProtoId() + " # " + key.Id + "." );
    // key.SetEvent( ITEM_EVENT_USE, "e_MasterKeyUse" );
}

bool e_MasterKeyUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    // if( valid( onItem ) && ( onItem.GetType() == ITEM_TYPE_DOOR || onItem.GetType() == ITEM_TYPE_CONTAINER ) )
    // {
        // SwitchState( item );
        // item.Update();
    // }
    return true;
}

// ПЕРЕНЕСЕНО В casino.fos
// import bool SlotMachineWork( Critter& cr, Item& onehanded, int skill, Item@ item ) from "casino";

/* void _SlotMachine( Critter& cr, int param0, int param1, int param2 )
{
	if( param0 == 0 || param1 != 0 || param2 != 0 )
	{
		cr.Say( SAY_NETMSG, "Параметры вызова ф-и: номер автомата, 0, 0." );
		return;
	}
	
	Item@ target = GetItem( param0 );
	if(!valid(target) )
	{
		cr.Say( SAY_NETMSG, "Объект не найден." );
		return;
	}
	
	if( target.GetProtoId() != 832 && target.GetProtoId() != 834 )
	{
		cr.Say( SAY_NETMSG, "Данный объект не является слот-машиной! Подходящие прототипы: 832 и 834." );
		return;
	}
	
	cr.Say( SAY_NETMSG, "Слот-машина активирована." );
    target.SetScript( "item@_InitSlotMachine" );
    target.Update();
} */

/*void _InitSlotMachine( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_SlotMachineUse" );
    item.SetEvent( ITEM_EVENT_USE_ON_ME, "e_SlotMachineOnMe" );
}*/

/* bool e_SlotMachineUse( Item& item, Critter& cr, int skill )
{
	Map@ map = cr.GetMap();
	if(!valid(map))return true;
	
    Item@ key1 = cr.GetItem( PID_SLOT_MACHINE_KEY, int( -1 ) );
    switch( skill )
    {
    case SK_REPAIR: {
        if( item.LockerComplexity != 0 )
        {
            cr.Say( SAY_NETMSG, "Замок на автомате впорядке." );
            return true;
        }
		if( valid( key1 ) )
		{
            item.LockerId = key1.LockerId;
            item.LockerComplexity = 400;
            item.Update();
            cr.Say( SAY_NETMSG, "Вы настроили замок на автомате под ваш универсальный ключ." );
            return true;
		}
        else
        {
            Item @ key = cr.AddItem( PID_SLOT_MACHINE_KEY, 1 );
            uint16 rnd = Random( 1, 65534 );
            key.LockerId = rnd;
            item.LockerId = rnd;
            item.LockerComplexity = 400;
            item.Update();
            key.Update();
            cr.Say( SAY_NETMSG, "Вы сделали новый замок на автомате, универсальный ключ в кармане." );
            return true;
        }
	}
    case SK_LOCKPICK: {
		if( isGM( cr ) )
		{
			item.LockerComplexity = 0;
			cr.Say( SAY_NETMSG, "Вы убрали замок с автомата." );
			return true;
		}
		
		cr.Animate( 0, ANIM2_USE, null, false, true );
        cr.Say( SAY_EMOTE_ON_HEAD, "Пытается взломать автомат" );
		map.SetText( item.HexX, item.HexY, COLOR_RED, ":скрежет:" );
		
        if( cr.StatBase[ ST_AGILITY ] * 2 > Random( 15, 25 - ( cr.StatBase[ ST_LUCK ] / 2 ) ) )
        {
			cr.Say( SAY_NETMSG, "Попытка сзлома безуспешна." );
            return true;
        }
        else
        {
			cr.Say( SAY_NETMSG, "Вы взломали.. ложный контейнер для воров. Вот досада! Вы не имеете понятия, где спрятаны настоящие деньги." );
			cr.ParamBase[ ST_LAST_CONT_ID ] = 0;
            cr.ShowContainer( null, item, item.Proto.GroundLevel ? TRANSFER_HEX_CONT_DOWN : TRANSFER_HEX_CONT_UP );
            return true;
        }
	}
    case SKILL_PICK_ON_GROUND: {
        if( item.LockerComplexity == 0 || ( @key1 != null && key1.LockerId == item.LockerId ) ) {
			if( item.LockerComplexity != 0 )
				cr.Say( SAY_EMOTE_ON_HEAD, "Открывает автомат спецключом" );
			cr.ParamBase[ ST_LAST_CONT_ID ] = 0;
            cr.ShowContainer( null, item, item.Proto.GroundLevel ? TRANSFER_HEX_CONT_DOWN : TRANSFER_HEX_CONT_UP );
			return true;
        }
		if( cr.CountItem( PID_BOTTLE_CAPS ) >= 5 )
        {
            SlotMachineWork( cr, item, skill, null );
            return true;
        }
        else
        {
            cr.Say( SAY_NETMSG, "Вам нужно хотя бы 5$ для начала игры." );
            return true;
        }
	}
	case SK_TRAPS: {
		if( item.LockerComplexity == 0 || ( @key1 != null && key1.LockerId == item.LockerId ) ) {
			cr.Say( SAY_EMOTE_ON_HEAD, "Возится с автоматом" );
			if( item.Val6 > 0 )
			{
				map.SetText( item.HexX, item.HexY, COLOR_GRAY, ":звон монет:" );
				item.AddItem( PID_BOTTLE_CAPS, item.Val6, 0 );
				item.Val6 = 0;
			}
			if( item.Val6 < 0 )
			{
				cr.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_fillMoneyInSlotMachine" );
				cr.Say( SAY_DIALOGBOX_TEXT, "В автомате нехватка налички размером в " + item.Val6 + "$." );
				cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Засыпать " + item.Val6 + "$" );
				cr.ParamBase[ ST_LAST_CONT_ID ] = item.Id;
			}
			return true;
		}
		break; }
	}

    return false;
}*/

/*void answer_fillMoneyInSlotMachine( Critter& cr, uint answerI, string& answerS )
{
	Map@ map = cr.GetMap();
	if(!valid(map))return;
	
	if( cr.ParamBase[ ST_LAST_CONT_ID ] == 0 ) return;
	Item@ onehanded = GetItem( cr.ParamBase[ ST_LAST_CONT_ID ] );
	if( !valid( onehanded ) || onehanded.Val6 >= 0 ) return;
	
	int count = CLAMP( -onehanded.Val6, 0, int( cr.CountItem( PID_BOTTLE_CAPS ) ) );
	if( count == 0 ) return;
	
	cr.Say( SAY_EMOTE_ON_HEAD, "Засыпает деньги в автомат" );
	map.SetText( onehanded.HexX, onehanded.HexY, COLOR_GRAY, ":звон монет:" );
	onehanded.Val6 += count;
	_CritDeleteItem( cr, PID_BOTTLE_CAPS, count );
}

bool e_SlotMachineOnMe( Item& item, Critter& cr, Item@ usedItem )
{
    if( @usedItem == null )
        return false;
    SlotMachineWork( cr, item, SKILL_PICK_ON_GROUND, usedItem );
    return true;
}*/ // ПЕРЕНЕСЕНО В casino.fos

#include "_ltp.fos"

#define STR_RUSS_ROULL_LOSE    ( 9000 )
#define STR_RUSS_ROULL_WIN     ( 9001 )
/*
   void russRoulReg(Critter& player, int var, int con, int param2)
   {
        LTPREG(0,process_test)
   }

   void russRoulStart(Critter& cr, int type, int time, int param)
   {
        StartProcess(cr, uint(type), uint(param), uint(time));
   }
 */

bool ltp_roul_inited = false;
void ltp_roul_init()
{
    LTPREG( LTP_RUSSROUL, process_russ_roul )
    ltp_roul_inited = true;
}

uint process_russ_roul( Critter@ cr, int& param0, int& param1, int& param2 )
{
    LTPROCESSD( LTP_RUSSROUL )

    if( param0 == 0 )
    {
        Item@ item = GetItem( uint( param1 ) );
        if( valid( item ) )
        {
            item.AmmoCount--;
            item.Update();
        }
        cr.StatBase[ ST_CURRENT_HP ] = 1;
        cr.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( Random( 0, 1 ) == 0 ? true : false ), Random( 20, 100 ), cr.HexX, cr.HexY );
        cr.SayMsg( SAY_EMOTE_ON_HEAD, TEXTMSG_TEXT, STR_RUSS_ROULL_LOSE );
    }
    else
    {
        cr.SayMsg( SAY_EMOTE_ON_HEAD, TEXTMSG_TEXT, STR_RUSS_ROULL_WIN );
    }

    return 0;
}

void _RevolverInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_RevolverSkill" );
}

bool e_RevolverSkill( Item& item, Critter& cr, int skill )
{
    if( skill == SK_SCIENCE )
    {
        if( item.AmmoCount <= 0 )
            return false;
        if( !ltp_roul_inited )
            ltp_roul_init();
        uint8 russianRoll = Random( 10, 70 ) - ( cr.StatBase[ ST_LUCK ] / 2 );
        uint  rndTime =  Random( 3, 5 ) * 1000;
        bool  roll = ( russianRoll >= 10 ) && ( russianRoll <= 20 );

        StartProcess( cr, LTP_RUSSROUL, roll ? 0 : 1, item.Id, 0, rndTime );

        /*
           else
           {
           StartProcess(cr, LTP_RUSSROUL, 1, rndTime);
           //
           //cr.Say(SAY_EMOTE, "");
           }*/

        cr.Say( SAY_EMOTE_ON_HEAD, "Взводит курок" );
        return true;
    }
    return false;
}



void _InitPoliceStuff( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_PoliceStuffUse" );
    item.SetEvent( ITEM_EVENT_SKILL, "e_PoliceStuffPick" );
    item.SetEvent( ITEM_EVENT_USE_ON_ME, "e_PoliceStuffHammer" );
}

import bool LocIsModoc( uint locPid ) from "globalmap_group";

bool e_PoliceStuffPick( Item& item, Critter& cr, int skill )
{
    if( ( skill == SKILL_PICK_ON_GROUND ) && ( item.Accessory == ACCESSORY_HEX ) )
    {
        Map @ map = cr.GetMap();
        Location @ loc = map.GetLocation();
        if( LocIsModoc(loc.GetProtoId()) )
        {
            if( cr.CountItem( PID_GUARD_BADGE ) >= 1 || item.Val0 == 0 )
            {
                return false;
            }
            cr.Say( SAY_NETMSG, "Вы не уполномочены перенести табличку" );
            return true;
        }
        else if( item.Val1 == 0 )
        {
            return false;
        }
        cr.Say( SAY_NETMSG, "Вы не можете перенести табличку" );
        return true;
    }
    return true;
}

bool e_PoliceStuffHammer( Item& item, Critter& cr, Item@ usedItem )
{
    int HammerTime = ( 11 - cr.Stat[ ST_STRENGTH ] ) * 60 * 10;
    if( item.GetProtoId() == PID_SIGN )
    {
        if( ( cr.Timeout[ TO_SK_REPAIR ] == 0 ) && ( cr.StatBase[ ST_LEVEL ] >= 3 ) )
        {
            if( valid( usedItem ) && ( usedItem.GetProtoId() == PID_SLEDGEHAMMER ) )
            {
                if( cr.CountItem( PID_IRON_PROD ) >= 1 )
                {
                    item.Val1 += 1;
                    cr.DeleteItem( PID_IRON_PROD, 1 );
                    cr.Say( SAY_NETMSG, "Вы забиваете кувалдой крепежные штыри." );
                    cr.TimeoutBase[ TO_SK_REPAIR ] = __FullSecond + HammerTime;
                }
                else
                    cr.Say( SAY_NETMSG, "Нет крепежных штырей (арматур)." );
                return true;
            }
            if( valid( usedItem ) && ( usedItem.GetProtoId() == PID_CROWBAR ) && ( cr.ParamBase[ SK_REPAIR ] >= 100 ) )
            {
                if( item.Val1 >= 1 )
                {
                    item.Val1 -= 1;
                    cr.Say( SAY_NETMSG, "Вы выдергиваете ломиком крепежные штыри." );
                    cr.TimeoutBase[ TO_SK_REPAIR ] = __FullSecond + HammerTime;
                }
                else
                    cr.Say( SAY_NETMSG, "Табличка не закреплена." );
                return true;
            }
        }
        cr.Say( SAY_NETMSG, "У вас недостаточно сил." );
    }
    return false;
}

bool e_PoliceStuffUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( item.GetProtoId() == PID_SIGN )
    {
        if( item.Val0 == 0 )
        {
            cr.ShowScreen( SCREEN_SAY, 0, "item@SignUseScreen" );
            cr.StatBase[ ST_VAR0 ] = item.Id;
        }
        else
            cr.Say( SAY_NETMSG, "табличка уже заполненна" );
    }
    return true;
}

void SignUseScreen( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() != 0 )
    {
        Item @ item = GetItem( player.StatBase[ ST_VAR0 ] );
        item.SetLexems( "" + answerS );
        item.Val0 = 1;
        item.Update();
    }
}


import bool SetTrapOnItem( Critter& cr, Item& trap, Item& onItem ) from "trap"; // Export
import bool UseSkillOnTrappedItem(Item& trappedItem, Critter& cr,  int skill) from "trap"; // Export

void _TestTrapInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_TestTrapUse" );
}

bool e_TestTrapUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
//	return false;

    if( @cr == null || @item == null || @onItem == null )
        return false;
    // if(onItem.LockerCondition == LOCKER_ELECTRO) return false;
    if( SetTrapOnItem( cr, item, onItem ) )
    {
        onItem.SetEvent( ITEM_EVENT_SKILL, "trap@UseSkillOnTrappedItem" );
        return true;
    }
    return false;
}

void _WhistInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_WhistUse" );
}

bool e_WhistUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    Map @ map = cr.GetMap();
    map.PlaySound( "whist.wav", cr.HexX, cr.HexY, cr.Stat[ ST_ENDURANCE ] * 5 );
    cr.Say( SAY_EMOTE_ON_HEAD, "Свестит в свисток." );
    return true;
}

void _InitRpNamer( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_RpNamerUse" );
}

bool e_RpNamerUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( item.GetProtoId() == PID_INFOPAD )
    {
        cr.ShowScreen( SCREEN_SAY, 0, "item@RpNamerUseScreen" );
        cr.StatBase[ ST_VAR0 ] = item.Id;
    }
    return true;
}

void RpNamerUseScreen( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() != 0 )
    {
        Item @ item = GetItem( player.StatBase[ ST_VAR0 ] );
        player.SetLexems( answerS );
        DeleteItem( item );
    }
}

void _music_fleita( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_fleitaUse" );
}

bool e_fleitaUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    Map @ map = cr.GetMap();
    if( Random( 1, 5 ) > 4 )
        map.PlaySound( "flute.wav", cr.HexX, cr.HexY, cr.Stat[ ST_ENDURANCE ] * 5 );
    else if( Random( 1, 5 ) > 3 )
        map.PlaySound( "flute2.wav", cr.HexX, cr.HexY, cr.Stat[ ST_ENDURANCE ] * 5 );
    else if( Random( 1, 5 ) > 2 )
        map.PlaySound( "flute3.wav", cr.HexX, cr.HexY, cr.Stat[ ST_ENDURANCE ] * 5 );
    else if( Random( 1, 5 ) > 1 )
        map.PlaySound( "flute4.wav", cr.HexX, cr.HexY, cr.Stat[ ST_ENDURANCE ] * 5 );
    else if( Random( 1, 5 ) > 0 )
        map.PlaySound( "flute5.ogg", cr.HexX, cr.HexY, cr.Stat[ ST_ENDURANCE ] * 5 );
    cr.Say( SAY_EMOTE_ON_HEAD, "Играет на флейте." );
    Location @ loc = map.GetLocation();
    if( ( loc.WorldX <= 50 ) || ( loc.WorldX >= 150 ) || ( loc.WorldY <= 50 ) || ( loc.WorldY >= 150 ) )
    {
        cr.Say( SAY_NETMSG, "Вы слишком далеко от фермы." );
        return true;
    }
    if( ( loc.WorldX >= item.Val2 - 20 ) && ( loc.WorldX <= item.Val2 + 20 ) && ( loc.WorldY >= item.Val3 - 20 ) && ( loc.WorldY <= item.Val3 + 20 ) )
    {
        cr.Say( SAY_NETMSG, "Тут брамины уже паслись." );
        return true;
    }
    if( loc.Id >= 100 && loc.Id <= 139 )
    {
        cr.Say( SAY_NETMSG, "Начинаете пасти стадо." );
        item.Val1 = map.Id;
        item.Val2 = loc.WorldX;
        item.Val3 = loc.WorldY;
        cr.AddTimeEvent( "cte_BrahminEat", ( 60 * 3 ) * __TimeMultiplier, CTE_WORK, 0 );
    }
    return true;
}

uint cte_BrahminEat( Critter& cr, int identifier, uint& rate )
{
    Critter@[] brahmins;
    Item@ flute = cr.GetItem( PID_FLUTE, SLOT_HAND1 );
    Map @ map = cr.GetMap();
    if( !valid( flute ) || !valid( map ) )
        return 0;
    if( ( map.GetCritters( NPC_PID_Brahmin, FIND_LIFE_AND_KO | FIND_ONLY_NPC, brahmins ) > 0 ) && int( map.Id ) == flute.Val1 )
    {
        for( uint i = 0, ii = brahmins.length(); i < ii; i++ )
            brahmins[ i ].StatBase[ ST_VAR5 ] += 1;

        cr.Say( SAY_NETMSG, "Брамины кажется насытились тут" );
    }
    return 0;
}

void _dosimetr( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_dosimetrUse" );
}

bool e_dosimetrUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    Map @ map = cr.GetMap();
    cr.Say( SAY_EMOTE_ON_HEAD, "Производит замер." );
    Location @ loc = map.GetLocation();
    if( ( loc.WorldX >= item.Val1 - 20 ) && ( loc.WorldX <= item.Val1 + 20 ) && ( loc.WorldY >= item.Val2 - 20 ) && ( loc.WorldY <= item.Val2 + 20 ) )
    {
        cr.Say( SAY_NETMSG, "Кажется место правильное, остается только подождать несколько минут." );
        item.Val3 = map.Id;
        cr.AddTimeEvent( "cte_dosimetrUse", 60 * 3, CTE_WORK, 0 );
    }
    return true;
}

uint cte_dosimetrUse( Critter& cr, int identifier, uint& rate )
{
    Item@ dosimetr = cr.GetItem( PID_DOSIMETR, SLOT_HAND1 );
    Map @ map = cr.GetMap();
    if( !valid( dosimetr ) || !valid( map ) )
        return 0;
    if( int( map.Id ) == dosimetr.Val3 )
    {
        cr.Say( SAY_NETMSG, "Индикатор изменил цвет на желтый, можно возвращаться." );
        DeleteItem( dosimetr );
        cr.AddItem( PID_DOSIMETR_USED, 1 );
    }
    else
        cr.Say( SAY_NETMSG, "Время прошло, но индикатор не сменил цвет, кажется мы сделали что-то неправильно." );
    return 0;
}

void _TraderBadge( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_traderbadgeUse" );
}

bool e_traderbadgeUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    cr.Say( SAY_EMOTE_ON_HEAD, "Показывает значек торговца" );
    return true;
}

void _PochtaBadge( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_PochtaBadgeUse" );
}

bool e_PochtaBadgeUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    cr.Say( SAY_EMOTE_ON_HEAD, "Показывает значек оружейника" );
    return true;
}

void _kosakInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_kosakUse" );
}

bool e_kosakUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
	Item @ respirator = _CritGetItemHandExt( cr );
	if( !(respirator is null) && respirator.GetProtoId() == PID_RESPIRATOR )
	{
		cr.Say( SAY_NETMSG, "Вы не можете курить через респиратор." );
		return true;
	}

	if( ( _CritCountItem( cr, PID_LIGHTER ) < 1 && _CritCountItem( cr, PID_FIREPLACE_TOKEN ) < 1 ) )
	{
		cr.Say( SAY_NETMSG, "Вам нужен источник огня, что бы прикурить." );
		return true;
	}
	
    
    Map @ map = cr.GetMap();
	if( Random( 0, 1 ) > 0 )
        map.PlaySound( "smoking.ogg", cr.HexX, cr.HexY, 1 );
    else
        map.PlaySound( "drugs2.wav", cr.HexX, cr.HexY,  1 );

	if( valid( onCritter ) && onCritter.IsPlayer() )
	{
		onCritter.ParamBase[ CR_VAL0 ] = item.Id;
		
		onCritter.ShowScreen( SCREEN_DIALOGBOX, 1, "answer_SmokingWeed" );
		onCritter.Say( SAY_DIALOGBOX_TEXT, "Вам предлагают дунуть косяк, согласитесь?");
		onCritter.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Да" );
		onCritter.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Нет" );
		
		cr.Say( SAY_NETMSG, "Вы предложили дунуть." );		
		return true;
	}
	
	SmokingWeed( cr, item );
    return true;
}

void SmokingWeed( Critter& cr, Item& item )
{
    cr.Say( SAY_EMOTE_ON_HEAD, "Раскуривает косяк" );
    cr.StatBase[ ST_EXPERIENCE ] += 10 * Random( 1, 5 );
	//cr.StatBase[ ST_RADIATION_LEVEL ] += Random( 0, 2 );
	AffectPoison( cr, Random( 1, 5 ) );
	cr.StatBase[ ST_HUNGER ] -= Random( 2, 4 );
	cr.StatBase[ ST_THRIST ] -= Random( 2, 4 );
    cr.StatBase[ ST_DYSPNEA ] -= Random( 0, 10 );

	int time = cr.Timeout[ TO_TIREDNESS ];
	if( time > 0 )
	{
		//time = CLAMP( time - __FullSecond, 0, time );
		time = CLAMP( time - REAL_SECOND( Random( 60, 120 ) ), 0, time );
		cr.TimeoutBase[ TO_TIREDNESS ] = __FullSecond + time;
	}
	
	if( Random( 0, 2 ) == 0 )
		_SubItem( item, 1 );
}

void answer_SmokingWeed( Critter& targetCr, uint answerI, string& answerS)
{
	Item@ weed = GetItem( targetCr.ParamBase[ CR_VAL0 ] );
	if( valid( weed ) )
		SmokingWeed( targetCr, weed );
}


import void Warn( Critter& admin, int param0, int param1, int param2 )  from "warning"; // ErlKing
import void say( Critter& player, int param0, int param1, int param2 )  from "gm";      // ErlKing

///###################################################  ПСАЙКЕР #############################################################################
//###########################################################################################################################################
void e_PsiUse( Critter& cr )
{	
	uint[] rates;
	uint8 countTimes = cr.GetTimeEvents( CTE_PSI_HEAL, null, null, rates );
	uint8 countTimes2 = cr.GetTimeEvents( CTE_PSI_VISION, null, null, rates );
	uint8 countTimes3 = cr.GetTimeEvents( CTE_PSI_DEGRAD, null, null, rates );
	uint8 countTimes4 = cr.GetTimeEvents( CTE_PSI_SHIELD, null, null, rates );
	if( cr.Stat[ P_PSI_LIMIT ] >= 80 && countTimes3 <= 0 )
	{
		cr.Say( SAY_NETMSG, "Дикая головная боль охватила вас, тело трясется, из носа потекла кровь." );
		if( cr.StatBase[ ST_BODY_TYPE ] != BT_ROBOT ) cr.Say( SAY_EMOTE, "Из носа течет кровь" );
		cr.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( ( Random( 0, 1 ) == 1 ? true : false ) ), Random( 600, 800 ), cr.HexX, cr.HexY );
		cr.AddTimeEvent ("cte_psi_degrad", 0, CTE_PSI_DEGRAD, cr.ParamBase[ P_PSI_LIMIT ] );
	}
    else if(/* cr.Stat[ P_PSY ] >= 11 &&*/ countTimes3 <= 0 )
    {
        cr.ShowScreen( SCREEN_DIALOGBOX, 4, "answer_Psi" );
        cr.Say( SAY_DIALOGBOX_TEXT, "Что требуется?" );
        if( countTimes2 <= 0 ) cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Сверхзрение" );
		else if( countTimes2 >= 1 ) cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "Откл. Сверхзрение" );
        if( countTimes <= 0 ) cr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Лечение" );
		else if( countTimes >= 1 ) cr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "Прерв. лечение" );
        if( countTimes4 <= 0 ) cr.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Пси-щит" );
		else if( countTimes4 >= 1 ) cr.Say( SAY_DIALOGBOX_BUTTON( 2 ), "Остановить пси-щит" );
        cr.Say (SAY_DIALOGBOX_BUTTON (3), "Пси-взрыв");
    }
}

void answer_Psi( Critter& cr, uint answerI, string& answerS )
{
	uint[] rates;
	bool psiHealOn = (cr.GetTimeEvents( CTE_PSI_HEAL, null, null, rates ) > 0);
	bool psiVisionOn = (cr.GetTimeEvents( CTE_PSI_VISION, null, null, rates ) > 0);
	bool psiShieldOn = (cr.GetTimeEvents( CTE_PSI_SHIELD, null, null, rates ) > 0);
	bool psiDegrad = (cr.GetTimeEvents (CTE_PSI_DEGRAD, null, null, rates) > 0);
	
	if( !valid( cr ) || cr.IsKnockout() || cr.IsDead() )
		return;
	if (answerI == 0) {
		if (!psiVisionOn) {
			cr.Say( SAY_NETMSG, "Вы чувствуете живых существ на расстоянии." );
			cr.AddTimeEvent ("cte_psi_vision", 0, CTE_PSI_VISION, cr.ParamBase[ QST_VISION ]);
			cr.ParamBase[ QST_VISION ] = 40;
		} else {
			cr.Say( SAY_NETMSG, "Вы вернулись к нормальному зрению." );
			cr.EraseTimeEvents( CTE_PSI_VISION );
			cr.ParamBase[ QST_VISION ] = 0;
		}
	}
	if( answerI == 1) {
		if (!psiHealOn) {
			cr.StatBase[ ST_CURRENT_HP ] += 40;
			cr.Say( SAY_EMOTE, "Засыпает" );
			cr.Say( SAY_NETMSG, "Вы погружаетесь сон. Раны практически мгновенно зарастают на вашем теле. Следите за вашей силой." );
			cr.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( ( Random( 0, 1 ) == 1 ? true : false ) ), Random( 120, 180 ), cr.HexX, cr.HexY );
			cr.AddTimeEvent ("cte_psi_heal", 0, CTE_PSI_HEAL, cr.Stat[ ST_MAX_LIFE ]);
		} else {
			cr.Say( SAY_NETMSG, "Вы прервали регенерацию." );
			cr.EraseTimeEvents( CTE_PSI_HEAL );
		}
	}
	if( answerI == 2) {
		if (!psiShieldOn) {
			cr.Say( SAY_NETMSG, "Вы окружили себя псионическим полем." );
			cr.AddTimeEvent ("cte_psi_shield", 0, CTE_PSI_SHIELD, cr.Stat[ ST_MAX_LIFE ]);
		} else {
			cr.Say( SAY_NETMSG, "Вы перестали поддерживать псионическое поле." );
			cr.EraseTimeEvents( CTE_PSI_SHIELD );
		}
	}
	if (answerI == 3) {
		if (cr.Stat [P_PSI] > 50) cr.StatBase [P_PSI] -= 50;
		else {
			cr.StatBase [P_PSI_LIMIT] += (50 - cr.Stat [P_PSI]);
			cr.StatBase [P_PSI] = 1;
		}
		if (cr.Stat [P_PSI] < 1) cr.StatBase[P_PSI] = 1;
		telekineticExplosion (cr);
		if (cr.Stat [P_PSI_LIMIT] > 80 && !psiDegrad) {
			cr.AddTimeEvent ("cte_psi_degrad", 0, CTE_PSI_DEGRAD, cr.StatBase [P_PSI_LIMIT]);
		}
	}
	if (cr.Stat [P_PSI] <= 1) { cr.StatBase [P_PSI] = 1;}
}

uint cte_psi_heal (Critter& cr, int identifier, uint& rate) // реген псионика, полный бред, пиздец нахуй
{
	bool psiDegrad = (cr.GetTimeEvents (CTE_PSI_DEGRAD, null, null, null) > 0);
	int heal = 5;
	if( heal > int( rate ) ) heal = rate;
	bool isHealed = true;
	/*
	int i = BP_LIMBS_BEGIN;
	while (i <= BP_LIMBS_END) {
		if (cr.ParamBase [i] > 0) isHealed = false;
		cr.ParamBase [i] -= heal;
		if (cr.ParamBase [i] < 0) cr.ParamBase [i] = 0;
		i ++;
	}
	*/
	if (isHealed) heal = 0;
	cr.StatBase [P_PSI] -= heal;
	cr.ParamBase [ BP_BLOOD_LOSS ] -= 2;
	cr.StatBase [ST_CURRENT_HP] += heal;
	cr.Say (SAY_NETMSG, "Вы регенерируете.");
	int16 aidTime = 13*__TimeMultiplier;
	
	if (cr.Stat [P_PSI] < 1) {
		cr.StatBase [P_PSI_LIMIT] -= cr.ParamBase [P_PSI] - 1;
		cr.StatBase [P_PSI] = 1;
	}
	
	bool psy = true;
	if ( isHealed )
	{
		cr.Say( SAY_NETMSG, "Вы полностью выздоровели." );
		psy = false;
	}
	if (cr.Stat [P_PSI_LIMIT] > 80 && !psiDegrad) {
		cr.AddTimeEvent ("cte_psi_degrad", 0, CTE_PSI_DEGRAD, cr.StatBase [P_PSI_LIMIT]);
		psy = false;
	} else if (psiDegrad) {
		psy = false;
	}
	return psy ? aidTime : 0;
}

uint cte_psi_vision (Critter& cr, int identifier, uint& rate) // сверхзрение псионика
{
	bool psiDegrad = (cr.GetTimeEvents (CTE_PSI_DEGRAD, null, null, null) > 0);
	int16 aidTime = 5*__TimeMultiplier;
	int vis = 1;
	cr.ParamBase [P_PSI] -= vis*2;	
	bool psiRepeat = true;
	
	if ( cr.ParamBase [P_PSI] < 1 ) {
		cr.ParamBase [P_PSI_LIMIT] -= cr.ParamBase [P_PSI]-1;
		cr.ParamBase [P_PSI] = 1;
		if (Random (0, 3) == 0) {
			cr.Say( SAY_NETMSG, "Ваша энергия на исходе. Вы начинаете медленно сходить с ума." ); 
			cr.Say( SAY_EMOTE, "Прерывисто дышит и дрожит" );
		}
	}
	if (cr.Stat [P_PSI_LIMIT] > 80 && !psiDegrad) {
		cr.AddTimeEvent ("cte_psi_degrad", 0, CTE_PSI_DEGRAD, cr.StatBase [P_PSI_LIMIT]);
		psiRepeat = false;
	} else if (psiDegrad) {
		psiRepeat = false;
	}
	return psiRepeat ? aidTime : 0;
}

uint cte_psi_shield (Critter& cr, int identifier, uint& rate) // Psi-shield, obviously
{
	int16 shieldTick = 5*__TimeMultiplier;
	bool psiDegrad = (cr.GetTimeEvents (CTE_PSI_DEGRAD, null, null, null) > 0);
	
	cr.ParamBase [P_PSI] -= 4;
	if ( cr.ParamBase [P_PSI] < 1 ) {
		cr.ParamBase [P_PSI_LIMIT] -= cr.ParamBase [P_PSI]-1;
		cr.ParamBase [P_PSI] = 1;
		if (Random (0, 3) == 0) {
			cr.Say( SAY_NETMSG, "Ваша энергия на исходе. Вы начинаете медленно сходить с ума." ); 
			cr.Say( SAY_EMOTE, "Прерывисто дышит и дрожит" );
		}
	}
	if (cr.Stat [P_PSI_LIMIT] > 80 && !psiDegrad) {
		cr.AddTimeEvent ("cte_psi_degrad", 0, CTE_PSI_DEGRAD, cr.StatBase [P_PSI_LIMIT]);
		shieldTick = 0;
	} else if (psiDegrad) {
		shieldTick = 0;
	}
	
	return shieldTick;
}

uint cte_psi_degrad (Critter& cr, int identifier, uint& rate) // мы едем-едем-едем
{
	uint16 WeaponPid;
	if( cr.ParamBase[ P_PSI_LIMIT ] <= 95 )
	{
		cr.ParamBase[ P_PSI_LIMIT ] += 3;
		cr.ParamBase [QST_VISION] = 20;
		cr.Say( SAY_NETMSG, "Из носа течет кровь, в глазах все двоится, кажется, вы видите сквозь стены.." );
		cr.Say( SAY_EMOTE, "Из носа течет кровь. Существо дрожит" );		
		
	}
	else if( cr.ParamBase[ P_PSI_LIMIT ] <= 98 )
	{
		cr.ParamBase[ P_PSI_LIMIT ] += 4;
		cr.ParamBase [QST_VISION] = 15;
		cr.StatBase [ST_PERCEPTION] -= 2;
		cr.Say( SAY_NETMSG, "Жгучая боль поразила ваши глаза" );
		cr.Say( SAY_EMOTE, "Из носа течет кровь" );		
	}
	else if( cr.ParamBase[ P_PSI_LIMIT ] <= 125 )
	{
		int roll = Random( 1, 3 );
		cr.ParamBase[ P_PSI_LIMIT ] += 3;
		cr.ParamBase [QST_VISION] = 10;
		cr.Say( SAY_NETMSG, "Ваша голова невыносимо болит, из носа хлещет кровь, а тело слабо поддается контролю" );
		if( roll == 1 ) {cr.Say( SAY_EMOTE, "Вгрызается зубами в правую руку" ); cr.DamageBase[ DAMAGE_RIGHT_ARM ] = 1; /*cr.ParamBase[ BP_RIGHT_ARM_HP ] = 60;*/ }		
		if( roll == 2 ) {cr.Say( SAY_EMOTE, "Вгрызается зубами в левую руку," ); cr.DamageBase[ DAMAGE_LEFT_ARM ] = 1; /*cr.ParamBase[ BP_LEFT_ARM_HP ] = 60;*/ }
		if( roll == 3 ) {cr.Say( SAY_EMOTE, "Бьет себя руками по лицу, трясется, глаза широко раскрыты и бешенно бегают, будто бы ища кого-то" ); /*cr.ParamBase[ BP_HEAD_HP ] = 70;*/ }
	}
	else if( cr.ParamBase[ P_PSI_LIMIT ] <= 132 )
	{
		cr.ParamBase[ P_PSI_LIMIT ] += 3;
		cr.StatBase [ST_STRENGTH] -= 2;
		cr.ParamBase [QST_VISION] = 25;
		cr.Say( SAY_NETMSG, "Кости ломит, по всему телу распространяется болезненная слабость. Вам холодно.. За стенами что-то шевелится" );
		cr.Say( SAY_EMOTE, "Застывает в неестественной позе, скалится" );		
	}
	else if( cr.ParamBase[ P_PSI_LIMIT ] <= 150 )
	{
		int roll = Random( 1, 6 );
		cr.StatBase [ST_CURRENT_HP] = 1;
		cr.ParamBase[ P_PSI_LIMIT ] += 5;
		cr.StatBase [ST_MAX_LIFE] -= 2;
		cr.StatBase [ST_STRENGTH] = 1;
		cr.StatBase [ST_ENDURANCE] = 3;
		cr.StatBase [ST_INTELLECT] = 5;
		cr.ParamBase [QST_VISION] = 12;
		if( roll == 1 ){ cr.Say( SAY_NETMSG, "Все тело будто бы скручивается в один маленький комок, вы ощущаете хруст костей, кто-то смеется над вами, некоторые даже позволяют себе бить вас. Голова закипает, вам хочется умереть.." );}
		if( roll == 2 ){cr.Say( SAY_NETMSG, "Вспышка боли расползается по всему телу, рев омерзительных тварей в вашей голове не дает вам покоя. Вы чувствуете, что вас поглощает нечто ужасное, черное и желающее вашей немедленной смерти" );}
		if( roll == 3 ){ cr.Say( SAY_NETMSG, "..Кто здесь?.. Что ты забыл в моем теле?!.." );}
		if( roll == 4 ){ cr.Say( SAY_NETMSG, "..Теперь ты один из нас.." );}
		if( roll == 5 ){ cr.Say( SAY_NETMSG, "..СДОХНИ! СДОХНИ! СДОХНИ!.." );}
		if( roll == 6 ){ cr.Say( SAY_NETMSG, "..ЭТО НЕ ТВОЕ ТЕЛО, БРОСЬ ЕГО. БРОСЬ СЕЙЧАС ЖЕ!.." );}
		cr.Say( SAY_EMOTE, "Держится за голову" );
		cr.Say( SAY_SHOUT, "А-А-а-а-а-а-ааааааааа" );		
	}
	else if( cr.ParamBase[ P_PSI_LIMIT ] <= 160 )
	{
		int roll = Random( 1, 2 );
		int luckRoll = Random (1, 20) + cr.Stat [ST_LUCK];
		if (luckRoll > 19) roll = 3;
		cr.ParamBase[ P_PSI_LIMIT ] += 3;
		cr.ParamBase [QST_VISION] = 0;
		cr.Say( SAY_NETMSG, "Вокруг все плывет, глаза слипаются, вам хочется уснуть.." );
		if( roll == 1 ) {cr.Say( SAY_EMOTE, "Медленно валится вниз" ); cr.DamageBase[ DAMAGE_RIGHT_ARM ] = 1; /*cr.ParamBase[ BP_RIGHT_ARM_HP ] = cr.StatBase[ ST_MAX_LIFE ]*0.2;*/ cr.ToDead( ANIM2_DEAD_BLOODY_SINGLE, cr ); }		
		if( roll == 2 ) {cr.Say( SAY_EMOTE, "Вдавливает пальцами глаза внутрь черепа" ); cr.DamageBase[ DAMAGE_EYE ] = 1; /*cr.ParamBase[ BP_EYES_HP ] = 3000;*/ cr.ToDead( ANIM2_DEAD_BLOODY_SINGLE, cr );}
		if( roll == 3 ) 
		{
			cr.Say( SAY_EMOTE, "Бьет себя руками по лицу, трясется, глаза широко раскрыты и бешенно бегают, будто бы ища кого-то" );
			cr.Say( SAY_NETMSG, "Похоже, вы смогли перебороть свою болезнь. Что-то внутри вас изменилось, а огнестрельное оружие стало жутко ухмыляться при виде вас" );
			/*if (cr.Param [BP_HEAD_HP] < 90) cr.ParamBase[ BP_HEAD_HP ] = 90;*/
			cr.ParamBase[ P_PSI ] = 120;
			cr.ParamBase [P_PSI_LIMIT] = 0;
			
		}
		/*if(cr.CountItem(PID_GM_PISTOL ) > 0) cr.Say(SAY_NORM, "Капибары это круто!");	*/
	}
	return 60 * 60 * __TimeMultiplier;
}
//##################################################################################################################################################################
//########################################################################################################################################################################################################################
void _InitGmPistol( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_GmPistolUse" );
    item.SetEvent( ITEM_EVENT_SKILL, "e_GmPistolPick" );
    item.SetEvent( ITEM_EVENT_ATTACK, "e_GmPistolAttack" );
}

bool e_GmPistolUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( item.GetProtoId() == PID_GM_PISTOL && isGM( cr ) )
    {
        cr.ShowScreen( SCREEN_DIALOGBOX, 3, "answer_GmPistol_GM_menu" );
        cr.Say( SAY_DIALOGBOX_TEXT, "Что желаешь хозяин?" );
        cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "скачать help" );
        cr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "скачать warn" );
        cr.Say( SAY_DIALOGBOX_BUTTON( 2 ), "очистить help" );
        cr.Say( SAY_DIALOGBOX_BUTTON( 3 ), "очистить warn" );
    }
    return true;
}

void answer_GmPistol_GM_menu( Critter& cr, uint answerI, string& answerS )
{
    if( !valid( cr ) )
        return;
    if( answerI == 0 )
    {
        file f;
        if( f.open( "logs\\help_pleads.txt", "r" ) >= 0 )
        {
            string word = "";
            uint   pos = 0;
            f.setPos( 0 );
            while( !f.isEndOfFile() )
            {
                pos = f.getPos();
                if( pos == 0 )
                {
                    f.readLine( word );
                    cr.RunClientScript( "client_main@loger", 0, 0, 0, word, null );
                }
                else
                {
                    f.readLine( word );
                    cr.RunClientScript( "client_main@loger", 1, 0, 0, word, null );
                }
            }
            f.close();
        }
        else
            Log( "can't open!" );
    }
    if( answerI == 1 )
    {
        file f;
        if( f.open( "logs\\warnings.txt", "r" ) >= 0 )
        {
            string word = "";
            uint   pos = 0;
            f.setPos( 0 );
            while( !f.isEndOfFile() )
            {
                pos = f.getPos();
                if( pos == 0 )
                {
                    f.readLine( word );
                    cr.RunClientScript( "client_main@loger", 0, 1, 0, word, null );
                }
                else
                {
                    f.readLine( word );
                    cr.RunClientScript( "client_main@loger", 1, 1, 0, word, null );
                }
            }
            f.close();
        }
        else
            Log( "can't open!" );
    }
    if( answerI == 2 )
    {
        file f;
        if( f.open( "logs\\help_pleads.txt", "w" ) >= 0 )
        {
            // f.writeString("");
            f.close();
        }
        else
            Log( "can't open!" );
    }
    if( answerI == 3 )
    {
        file f;
        if( f.open( "logs\\help_pleads.txt", "w" ) >= 0 )
        {
            // f.writeString("");
            f.close();
        }
        else
            Log( "can't open!" );
    }
}

bool e_GmPistolPick( Item& item, Critter& cr, int skill )
{
    if( ( skill == SKILL_PICK_ON_GROUND ) && ( item.Accessory == ACCESSORY_HEX ) )
    {
        DeleteItem( item );
    }
    return false;
}

bool e_GmPistolAttack( Item& item, Critter& cr, Critter& target )
{
    if( cr.IsPlayer() )
    {
        if( isGM( cr ) )
        {
            cr.StatBase[ ST_VAR0 ] = target.Id;
            cr.ShowScreen( SCREEN_DIALOGBOX, 5, "answer_GmPistolAttack_GM" );
            cr.Say( SAY_DIALOGBOX_TEXT, "Че те надо, карман?" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "предупреждение" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "+ опыт" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 2 ), "+ скиллпоинты" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 3 ), "+ деньги" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 4 ), "+ нокаут" );
            return true;
        }
        else
        {
            cr.StatBase[ ST_VAR0 ] = target.Id;
            cr.ShowScreen( SCREEN_DIALOGBOX, 7, "answer_GmPistolAttack_player" );
            cr.Say( SAY_DIALOGBOX_TEXT, "Сам се тут митолки рисует, а другим, типа, нельзя?" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 0 ), "сленг" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 1 ), "повергейминг" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 2 ), "выход из роли" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 3 ), "мародерство" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 4 ), "клептомания" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 5 ), "метагейм" );
            cr.Say( SAY_DIALOGBOX_BUTTON( 6 ), "мультоводство" );
            return true;
        }
    }
    return true;
}

import uint GetAllPlayers( Critter@[]& crs ) from "manager";

void answer_GmPistolAttack_player( Critter& cr, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( cr.Stat[ ST_VAR0 ] );
    if( target is null or target.IsNpc() )
    {
        cr.Say( SAY_NETMSG, "Игрок не найден." );
        return;
    }
    if( cr.Param[ ST_VAR5 ] > 3 )
        return;
    cr.ParamBase[ ST_VAR5 ] += 1;
    string plead;
    if( answerI == 0 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "НА СЕРВЕРЕ ЗАПЕРЩЕН СЛЕНГ И НЕИГРОВОЕ ОБЩЕНИЕ" );
        plead = " - сленг";
    }
    else if( answerI == 1 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "НЕ СТРОЙТЕ ИЗ СЕБЯ РЕМБО, ПОМНИТЕ ОБ ИНСТИНКТЕ САМОСОХРАНЕНИЯ" );
        plead = " - рембо";
    }
    else if( answerI == 2 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "ПРИДЕРЖИВАЙТЕСЬ СВОЕЙ ИГРОВОЙ РОЛИ" );
        plead = " - несоответствие роли";
    }
    else if( answerI == 3 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "БЕЗСИСТЕМНОЕ ЛУТАНИЕ ТРУПОВ ЭТО МАРОДЕРСТВО, ОСТАНОВИТЕСЬ" );
        plead = " - мародерство";
    }
    else if( answerI == 4 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "НЕ ШАРЬТЕСЬ ГДЕ ПОПАЛО, ПРИСТРЕЛЯТ ЗА ВОРОВСТВО" );
        plead = " - клептомания";
    }
    else if( answerI == 5 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "ИСПОЛЬЗОВАНИЕ ИНФОРМАЦИИ ПОЛУЧЕННОЙ НЕИГРОВЫМ ПУТЕМ ЗАПРЕЩЕНО" );
        plead = " - метагейм";
    }
    else if( answerI == 6 )
    {
        target.ShowScreen( SCREEN_DIALOGBOX, 0, "answer_NULL" );
        target.Say( SAY_DIALOGBOX_TEXT, "ЗАПРЕЩЕНО ВЗАИМОДЕЙСТВИЕ МЕЖДУ СВОИМИ ПЕРСОНАЖАМИ" );
        plead = " - мультоводство";
    }
    if( plead != "" )
    {
        cr.Say( SAY_NETMSG, "предупреждение выдано" );
        Critter@[] crs;
        GetAllPlayers( crs );
        string str = "жалоба от |0xFFFF0000 <|0xFFFFFF00 " + GetPlayerName( cr.Id ) + "(" + cr.Id + ") на " + GetPlayerName( target.Id ) + "(" + target.Id + ")|0xFFFF0000 > |0xFFBB33CC " + plead;
        for( uint i = 0, j = crs.length(); i < j; i++ )
        {
            if( crs[ i ] is null or !isGM( crs[ i ] ) )
                continue;
            crs[ i ].Say( SAY_NETMSG, str );
        }
        file f;
        if( f.open( "logs\\warnings.txt", "a" ) >= 0 )
        {
            f.writeString( "жалоба от " + GetPlayerName( cr.Id ) + "\t " + cr.Id + "\t на " + GetPlayerName( target.Id ) + "\t" + target.Id + "\t" + plead + "\n" );
            f.close();
        }
    }
}

void answer_NULL( Critter& cr, uint answerI, string& answerS )
{
    return;
}

void answer_GmPistolAttack_GM( Critter& cr, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( cr.Stat[ ST_VAR0 ] );
    if( !valid( target ) )
        return;
    if( answerI == 0 ) // предупреждение
    {
        Warn( cr, target.Id, 0, 0 );
    }
    else if( answerI == 1 ) // наградить опытом
    {
        cr.ShowScreen( SCREEN_SAY, 0, "item@GmPistol_exp" );
    }
    else if( answerI == 2 ) // наградить скилами
    {
        cr.ShowScreen( SCREEN_SAY, 0, "item@GmPistol_skill" );
    }
    else if( answerI == 3 ) // наградить скилами
    {
        cr.ShowScreen( SCREEN_SAY, 0, "item@GmPistol_money" );
    }
    else if( answerI == 4 ) // нокаут на
    {
        cr.ShowScreen( SCREEN_SAY, 0, "item@GmPistol_knockdown" );
    }
}

void GmPistol_exp( Critter& player, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( target ) )
        return;
    if( answerS.length() > 0 )
    {
        int number = 0;
        StrToInt( answerS, number );
        target.StatBase[ ST_EXPERIENCE ] += number;
        player.Say( SAY_NETMSG, "вы выдали " + number + " опыта игроку " + target.Id );
    }
}

void GmPistol_skill( Critter& player, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( target ) )
        return;
    if( answerS.length() > 0 )
    {
        int number = 0;
        StrToInt( answerS, number );
        target.StatBase[ ST_UNSPENT_SKILL_POINTS ] += number;
        player.Say( SAY_NETMSG, "вы выдали " + number + " скиллпоинтов игроку " + target.Id );
    }
}

void GmPistol_money( Critter& player, uint answerI, string& answerS )
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( target ) )
        return;
    if( answerS.length() > 0 )
    {
        int number = 0;
        StrToInt( answerS, number );
        target.AddItem( PID_BOTTLE_CAPS, number );
        player.Say( SAY_NETMSG, "вы выдали " + number + " монет, персонажу " + target.Id );
    }
}

//import void GmPistol_knockdown( Critter& player, uint answerI, string& answerS ) from "item";
void GmPistol_knockdown( Critter& player, uint answerI, string& answerS ) //exported
{
    Critter@ target = GetCritter( player.Stat[ ST_VAR0 ] );
    if( !valid( target ) )
        return;
    if( answerS.length() > 0 )
    {
        int number = 0;
        StrToInt( answerS, number );
        target.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( Random( 0, 1 ) == 0 ? true : false ), number, target.HexX, target.HexY );
        player.Say( SAY_NETMSG, "Вы уронили " + target.Id + " на " + number + " ОД." );
    }
}

void _InitRPStuff( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_RPStuffUse" );
}

bool e_RPStuffUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( item.Val0 == 0 )
    {
        cr.ShowScreen( SCREEN_SAY, 0, "item@RPStuffUseScreen" );
        cr.StatBase[ ST_VAR0 ] = item.Id;
    }
    else
        cr.Say( SAY_NETMSG, "уже заполненно" );
    return true;
}

void RPStuffUseScreen( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() != 0 )
    {
        Item @ item = GetItem( player.StatBase[ ST_VAR0 ] );
        uint16 itemPid = item.GetProtoId();

        switch( itemPid )
        {
        case PID_RPSTUFF1:
            item.SetLexems( "" + answerS );
            break;
        case PID_RPSTUFF2:
            item.SetLexems( "" + answerS );
            break;
        case PID_RPSTUFF3:
            item.SetLexems( "" + answerS );
            break;
        case PID_RPSTUFF4:
            item.SetLexems( "" + answerS );
            break;
		case PID_PICTURE:
            item.SetLexems( "" + answerS );
            break;	
        case PID_RPGUN1:
            item.SetLexems( "" + answerS );
            break;
        case PID_RPGUN2:
            item.SetLexems( "" + answerS );
            break;
        case PID_RPGUN3:
            item.SetLexems( "" + answerS );
            break;
        }

        item.Val0 = 1;
        item.Update();
    }
}

void _InitPuti( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_DROP, "e_PutiDrop" );
}

void e_PutiDrop( Item& item, Critter& cr )
{
    if( cr.CountItem( PID_ROPE_USED ) != 0 || cr.CountItem( PID_HANDCUFFS_USED ) != 0 )
    {
        cr.AddItem( PID_PUTI, 1 );
        cr.Say( SAY_NETMSG, "Вы не можете снять путы" );
    }
    DeleteItem( item );
}

// depracated
void _InitCodeDoor( Item& item, bool firstTime )
{
    Log( "Depracated function item@_InitCodeDoor at item.Id " + item.Id );
    // item.SetEvent(ITEM_EVENT_SKILL, "e_CodeDoorSkill");
    // item.LockerCondition = LOCKER_ELECTRO;
}
/*
   bool e_CodeDoorSkill(Item& item, Critter& cr, int skill)
   {
        if(skill == SKILL_PICK_ON_GROUND)
        {
                if(_LockerIsClose(item))
                {

                        cr.RunClientScript("client_screen_codedoor@ShowScreen", item.Id, item.Val1, 0, "Введите код", null);
                        return true;
                }
        }
   return false;
   }*/

void _InitAidKit( Item& item, bool firstTime )
{
    item.SetLexems( "Медикаментов там " + SetupAidLeX( item.Indicator ) + "." );
}

string SetupAidLeX( uint8 aidValue )
{
    string resultTemp = "";

    if( aidValue == 100 )
        resultTemp = "полная сумка";
    else if( aidValue > 80 )
        resultTemp = "достаточно";
    else if( aidValue > 60 )
        resultTemp = "чуть больше половины";
    else if( aidValue > 40 )
        resultTemp = "немного меньше половины";
    else if( aidValue > 20 )
        resultTemp = "совсем не много";
    else if( aidValue > 10 )
        resultTemp = "на дне";
    else if( aidValue > 0 )
        resultTemp = "практически нет";
    else if( aidValue == 0 )
        resultTemp = "нет";

    return resultTemp;
}

void _AutoDoorInit( Item& item, bool firstTime )
{
    if( item.GetProtoId() == PID_AUTODOOR )
        item.SetEvent( ITEM_EVENT_WALK, "e_AutoDoorWalk" );
}

void e_AutoDoorWalk( Item& item, Critter& cr, bool entered, uint8 dir )
{
    Item@ door = GetItem( item.Val1 );
    if( !valid( door ) )
    {
        DeleteItem( item );
        return;
    }
	
	Map @ map = cr.GetMap();
	if( entered )
    {
        if( valid( cr ) && cr.IsPlayer() && cr.StatBase[ ST_BODY_TYPE ] < BT_BRAHMIN && !FLAG( door.LockerCondition, LOCKER_ISOPEN ) && !FLAG( door.LockerCondition, LOCKER_LOCKED ) && !(door.LockerCondition == LOCKER_ELECTRO) && map.GetData(24)>0 )
        {
            door.LockerOpen();
        }
    }
    else
    {
        if( valid( cr ) && cr.IsPlayer() && cr.StatBase[ ST_BODY_TYPE ] < BT_BRAHMIN && map.GetData(24)>0 )
        {
            uint16 x = 0;
            uint16 y = 0;
            @ map = door.GetMapPosition( x, y );
            if( map.GetCrittersHex( x, y, 1, FIND_LIFE, null ) == 0 ) door.LockerClose();
        }
    }
}

void _PillsInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_PillsUse" );
}

bool e_PillsUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    if( item.GetProtoId() == PID_HEART_PILLS )
    {
		cr.Say( SAY_EMOTE_ON_HEAD, "принимает таблетки" );
        cr.StatBase[ ST_POISONING_LEVEL ] += 1;
        return true;
    }
    else if( item.GetProtoId() == PID_PILLS )
    {
        //cr.StatBase[ ST_POISONING_LEVEL ] += 1;
		string info = "";
		if( cr.StatBase[ST_BLOOD_TOXIC] > 0 )
			info += "Есть признаки начала заражения крови. Проведите медобследование у доктора.";
		if( cr.StatBase[ST_BLOOD_TOXIC] > cr.Stat[ ST_ENDURANCE ] * 10 )
			info += " Обнаружены симптомы прогрессирования заражения крови, необходимо принять лекарства!";
		if( info.length() > 0 )
			cr.Say( SAY_NETMSG, info );
		else
			cr.Say( SAY_NETMSG, "Вам кажется, что нет смысла перестраховываться глотая эту гадость - вы не чувствуете симптомов заражения крови." );
        return true;
    }
    return true;
}

void _MercsSignInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_MercsSign" );
}

bool e_MercsSign( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    cr.Say( SAY_EMOTE_ON_HEAD, "показывает плакат с нарисованным копотом" );
    return true;
}

void _MercsSign2Init( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_MercsSign2" );
}

bool e_MercsSign2( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    cr.Say( SAY_EMOTE_ON_HEAD, "показывает нашивку с нарисованным копотом" );
    return true;
}

void _InitEmptyHypo( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_EmptyHypoUse" );
}

bool e_EmptyHypoUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    bool onSelf = ( !valid( onCritter ) && !valid( onItem ) && !valid( onScenery ) );
    if( onSelf )
    {
        Item @ hypo = cr.AddItem( PID_HYPO_BLOOD, 1 );
        hypo.Val1 = cr.Id;
        hypo.Val2 = cr.Stat[ ST_TOXIC ];
        hypo.Val3 = cr.StatBase[ ST_DESEASE ];
        hypo.Val4 = cr.Param[ ST_BODY_TYPE ];
        hypo.Val5 = cr.Stat[ ST_POISONING_LEVEL ];
        hypo.Val6 = cr.Stat[ ST_RADIATION_LEVEL ];
        cr.StatBase[ ST_VAR0 ] = hypo.Id;
        cr.ShowScreen( SCREEN_SAY, 0, "item@HypoUseScreen" );
        hypo.Update();
        cr.DeleteItem( PID_HYPODERMIC_NEEDLE, 1 );
        cr.Say( SAY_NETMSG, "Вы взяли у себя образец крови." );
        cr.Say( SAY_EMOTE_ON_HEAD, "Берет образец крови" );
        return true;
    }
    else if( cr.IsPlayer() && valid( cr ) && valid( onCritter ) )
    {
        if( cr.Timeout[ TO_BATTLE ] > 0 || onCritter.Timeout[ TO_BATTLE ] > 0 )
        {
            cr.Say( SAY_NETMSG, "Это неуместно" );
            return true;
        }
        Item @ hypo = cr.AddItem( PID_HYPO_BLOOD, 1 );
        hypo.Val1 = onCritter.Id;
        hypo.Val2 = onCritter.Stat[ ST_TOXIC ];
        hypo.Val3 = onCritter.StatBase[ ST_DESEASE ];
        hypo.Val4 = onCritter.Param[ ST_BODY_TYPE ];
        hypo.Val5 = onCritter.Stat[ ST_POISONING_LEVEL ];
        hypo.Val6 = onCritter.Stat[ ST_RADIATION_LEVEL ];
        cr.StatBase[ ST_VAR0 ] = hypo.Id;
        cr.ShowScreen( SCREEN_SAY, 0, "item@HypoUseScreen" );
        hypo.Update();
        cr.DeleteItem( PID_HYPODERMIC_NEEDLE, 1 );
        cr.Say( SAY_NETMSG, "Вы взяли образец крови." );
        cr.Say( SAY_EMOTE_ON_HEAD, "Берет образец крови" );
        return true;
    }
    else
        cr.Say( SAY_NETMSG, "Это неуместно" );
    return true;
}

void HypoUseScreen( Critter& player, uint answerI, string& answerS )
{
    if( answerS.length() != 0 )
    {
        Item @ Hypo = GetItem( player.StatBase[ ST_VAR0 ] );
        Hypo.SetLexems( "$HypoLex" + answerS );
        Hypo.Update();
    }
}

void _InitBloodHypo( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_BloodHypoUse" );
    item.SetEvent( ITEM_EVENT_SKILL, "e_BloodHypoSkill" );
}

import void ApplyDesease( Critter& player, int param0, int param1 ) from "morphes";

bool e_BloodHypoUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    bool onSelf = ( !valid( onCritter ) && !valid( onItem ) && !valid( onScenery ) );
    if( onSelf )
    {
        if( item.Val3 != 0 )
        {
            if( item.Val1 == 0 && cr.StatBase[ ST_DESEASE ] <= item.Val3 )
            {
                if( cr.GetTimeEvents( 7, null, null, null ) > 0 && cr.Stat[ ST_TOXIC ] > 0 )
                {
                    cr.EraseTimeEvents( 7 );
                    cr.StatBase[ ST_TOXIC ] = 0;
                }
                cr.StatBase[ ST_DESEASE ] = item.Val3;
            }
            else if( item.Val2 != 0 || Random( 0, 1 ) > 0 )
                ApplyDesease( cr, cr.Id, item.Val3 );
            else if( cr.StatBase[ ST_DESEASE ] < item.Val3 )
                cr.StatBase[ ST_DESEASE ] = item.Val3;
        }
        cr.Say( SAY_NETMSG, "Вы вкололи шприц себе." );
        cr.Say( SAY_EMOTE_ON_HEAD, "Вкалывает шприц" );
        DeleteItem( item );
        return true;
    }
    else if( cr.IsPlayer() && valid( cr ) && valid( onCritter ) )
    {
        if( cr.Timeout[ TO_BATTLE ] > 0 || onCritter.Timeout[ TO_BATTLE ] > 0 )
        {
            cr.Say( SAY_NETMSG, "Это неуместно" );
            return true;
        }
        if( item.Val3 != 0 && onCritter.IsPlayer() )
        {
            if( item.Val1 == 0 && onCritter.StatBase[ ST_DESEASE ] <= item.Val3 )
            {
                if( onCritter.GetTimeEvents( 7, null, null, null ) > 0 && onCritter.Stat[ ST_TOXIC ] > 0 )
                {
                    onCritter.EraseTimeEvents( 7 );
                    onCritter.StatBase[ ST_TOXIC ] = 0;
                }
                onCritter.StatBase[ ST_DESEASE ] = item.Val3;
            }
            else if( item.Val2 != 0 || Random( 0, 1 ) > 0 )
                ApplyDesease( cr, onCritter.Id, item.Val3 );
            else if( onCritter.StatBase[ ST_DESEASE ] < item.Val3 )
                onCritter.StatBase[ ST_DESEASE ] = item.Val3;
        }
        cr.Say( SAY_NETMSG, "Вы вкололи шприц." );
        cr.Say( SAY_EMOTE_ON_HEAD, "Вкалывает шприц" );
        DeleteItem( item );
        return true;
    }
    else
        cr.Say( SAY_NETMSG, "Это неуместно" );
    return true;
}

import void MakeCure( Critter& doctor, Item@ hypo ) from "dialog";

bool e_BloodHypoSkill( Item& item, Critter& cr, int skill )
{
	if( skill != SK_DOCTOR && skill != SK_SCIENCE )
		return false;

	if( _CritCountItem( cr, PID_DOCTORS_BAG ) == 0 )
	{
		cr.Say( SAY_NETMSG, "Вам нужны соответствующие инструменты для анализа крови." );
		return true;
	}

	if( skill == SK_DOCTOR && cr.Skill[ SK_SCIENCE ] > 150 && cr.Skill[ SK_DOCTOR ] > 150 )
	{
		MakeCure( cr, item );
		return true;
	}
	
    if( skill == SK_SCIENCE )
    {
        int body = item.Val4;
        if( cr.Skill[ SK_SCIENCE ] > 50 || cr.Skill[ SK_SCIENCE ] > 50 )
        {
            switch( body )
            {
            case 0:
                cr.Say( SAY_NETMSG, "Это кровь человека." );
                break;
            case 1:
                cr.Say( SAY_NETMSG, "Это кровь человека." );
                break;
            case 2:
                cr.Say( SAY_NETMSG, "Это кровь человека." );
                break;
            case 3:
                cr.Say( SAY_NETMSG, "Это кровь супермутанта." );
                break;
            case 4:
                cr.Say( SAY_NETMSG, "Это кровь гуля." );
                break;
            case 5:
                cr.Say( SAY_NETMSG, "Это кровь брамина." );
                break;
            case 6:
                cr.Say( SAY_NETMSG, "Это кровь скорпиона" );
                break;
            case 7:
                cr.Say( SAY_NETMSG, "Это кровь крысы" );
                break;
            case 8:
                cr.Say( SAY_NETMSG, "Это кровь летуна" );
                break;
            case 9:
                cr.Say( SAY_NETMSG, "Это кровь кентавра" );
                break;
            case 10:
                cr.Say( SAY_NETMSG, "Это гидравлическая жидкость, непонятно как она попала в шприц." );
                break;
            case 11:
                cr.Say( SAY_NETMSG, "Это кровь собаки" );
                break;
            case 12:
                cr.Say( SAY_NETMSG, "Это жидкость мантиса" );
                break;
            case 13:
                cr.Say( SAY_NETMSG, "Это кровь смертокогтя" );
                break;
            case 14:
                cr.Say( SAY_NETMSG, "Это жидкость из растения" );
                break;
            case 15:
                cr.Say( SAY_NETMSG, "Это кровь гекко" );
                break;
            case 16:
                cr.Say( SAY_NETMSG, "Это кровь чужого" );
                break;
            }
            if( cr.Skill[ SK_SCIENCE ] > 100 && body <= 4 )
            {
                if( item.Val2 == 0 )
                    cr.Say( SAY_NETMSG, "Уровень лейкоцитов в норме." );
                else if( item.Val2 <= 50 )
                    cr.Say( SAY_NETMSG, "В крови присутствуют следы воздействия какого-то вируса." );
                else
                    cr.Say( SAY_NETMSG, "Заметны образования в крови, видимо воздействие вируса было довольно продолжительным." );
            }
        }
        return true;
    }
    return false;
}

void _InitPackage( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_DROP, "e_PackageDrop" );
    item.SetEvent( ITEM_EVENT_MOVE, "e_PackageMove" );
    item.SetEvent( ITEM_EVENT_SKILL, "e_PackagePick" );
}

void e_PackageDrop( Item& item, Critter& cr )
{
    cr.ModeBase[ MODE_NO_WALK ] = 0;
    cr.ModeBase[ MODE_NO_RUN ] = 0;
}

void e_PackageMove( Item& item, Critter& crit, uint8 fromSlot )
{
    if( item.CritSlot == SLOT_HAND1 )
    {
        crit.ModeBase[ MODE_NO_WALK ] = 0;
        crit.ModeBase[ MODE_NO_RUN ] = 1;
    }
    if( fromSlot == SLOT_HAND1 )
    {
        crit.ModeBase[ MODE_NO_WALK ] = 1;
        crit.ModeBase[ MODE_NO_RUN ] = 1;
        crit.Say( SAY_NETMSG, "Мешок слишком громоздок для рюкзака, нужно взять в руки, чтобы нести." );
    }
}

bool e_PackagePick( Item& item, Critter& cr, int skill )
{
    if( ( skill == SKILL_PICK_ON_GROUND ) && ( item.Accessory == ACCESSORY_HEX ) )
    {
        if( _CritCountItem( cr, PID_PACKAGE ) == 0 )
        {
            cr.ModeBase[ MODE_NO_WALK ] = 1;
            cr.ModeBase[ MODE_NO_RUN ] = 1;
            cr.Say( SAY_NETMSG, "Мешок слишком громоздок для рюкзака, нужно взять в руки, чтобы нести." );
            return false;
        }
        return true;
    }
    return true;
}

void _InitCompas( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_CompasUse" );
}

bool e_CompasUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
    string output = "";

    Location @ loc = GetLocation( 5 );
    if( loc !is null )
    {
        int x = cr.WorldX * 0.1 - loc.WorldX * 0.1, y = cr.WorldY * 0.1 - loc.WorldY * 0.1;
        if( cr.Skill[ SK_OUTDOORSMAN ] < 100 )
        {
            output += "Модок находиться : ";

            if( y > 0 )
                output += "Северо-";
            else if( y < 0 )
                output += "Юго-";
            if( x > 0 )
                output += "Западней";
            else if( x < 0 )
                output += "Восточней";
            else if( y > 0 )
                output = "Модок находиться : Севернее";
            else if( y < 0 )
                output = "Модок находиться : Южнее";
            else
                output = "Стрелка постоянно крутится";
        }
        if( cr.Skill[ SK_OUTDOORSMAN ] >= 100 )
        {
            output = "Координаты : x=" + x + ", y=" + y;
        }
    }
    else
        output = "Компас заклинило.";

    cr.Say( SAY_NETMSG, output );

    return false;
}

void Item_SetFrame( Item& item, uint8 frame ) // Sprite& sprite) // ItemCl& itemCl
{
    item.AnimStayBegin      = frame;
    item.AnimStayEnd        = frame;
    item.AnimShowBegin      = frame;
    item.AnimShowEnd        = frame;
    item.AnimHideBegin      = frame;
    item.AnimHideEnd        = frame;

    return;
}


import void AffectPoison( Critter& cr, int value ) from "poison";
import void AffectRadiation( Critter& cr, int value ) from "radiation";

void ProccessFood( Critter& cr, Item& item )
{
    uint flag = item.Proto.Food_Flags;
	
	uint pid = item.GetProtoId();
	
	uint[] glassed_drinks = {
		PID_GLASS_BOTTLE_FULL, PID_GLASS_BOTTLE_DIRTY_FULL, PID_CLEAN_WATER2, PID_ANTIDOTE, PID_NUKA_COLA, PID_BEER, PID_BOOZE, PID_GAMMA_GULP_BEER, PID_ROENTGEN_RUM, PID_ROT_GUT, PID_BEER_DARK, 
		PID_SUPER_ENERGY_DRINK, PID_WHISKEY, PID_WHISKEY_PREWAR, PID_ROOTBEER, PID_ATOM_COLA, PID_BLOODMARRY, PID_TURBO_COLA, PID_LIQUER,
		PID_ATOM_COLA_CHERRY, PID_ATOM_COLA_CRAFT, PID_ATOM_COLA_SEA, PID_BEER_LIGHT, PID_ATOMIC_COCTAIL, PID_GROG, PID_HATFIELD_BOOZE
	};
	
	if( glassed_drinks.find( pid ) != -1 )
    cr.AddItem( PID_BOTTLE_GLASS, 1 );
	
	if ( pid == PID_BOTTLE_FULL ) cr.AddItem( PID_BOTTLE_EMPTY, 1 );
	if ( pid == PID_FLASK_FULL ) cr.AddItem( PID_FLASK_EMPTY, 1 );
	if ( pid == PID_PILLS ) cr.AddItem( PID_BOTTLE_EMPTY, 1 );
	//if ( pid == PID_ANTISEPTIC ) cr.AddItem( PID_BOTTLE_EMPTY, 1 );
	//if ( pid == PID_ANESTETIC ) cr.AddItem( PID_BOTTLE_EMPTY, 1 );
	if ( pid == PID_BOTTLE_DIRTY_FULL ) cr.AddItem( PID_BOTTLE_EMPTY, 1 );
	if ( pid == PID_NUKA_COLA ) cr.AddItem( PID_REAL_BOTTLE_CAPS, 1 );
	if ( pid == PID_CANNED_MEAT ) cr.AddItem( PID_BANKA_MEH, 1 );
	if ( pid == PID_lavshtin ) cr.AddItem( PID_BANKA_MEH, 1 );
	if ( pid == PID_DinkiDa ) cr.AddItem( PID_BANKA_MEH, 1 );
	
    if( flag != 0 )
    {
        // if( FLAG( FOOD_KNOCKOUT, flag ) )
        // {
            // cr.ToKnockout( KNOCKOUT_ANIM2_DEFAULT( true ), 100, cr.HexX, cr.HexY ); // Кнок от грибов на 100 од.
        // }
        if( FLAG( FOOD_POISONED, flag ) )
        {
            AffectPoison( cr, Random( 25, 55 ) );
        }
        if( FLAG( FOOD_RADIOACTIVE, flag ) )
        {
            AffectRadiation( cr, Random( 20, 55 ) );
        }
    }

}

void _GasMask( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_GasMaskUse" );
    item.SetEvent( ITEM_EVENT_MOVE, "e_GasMaskMove" );
}

void e_GasMaskMove( Item& item, Critter& crit, uint8 fromSlot )
{
    if(item.CritSlot == SLOT_HAND2 )
    {
	crit.Say( SAY_NETMSG, "Вы одели респиратор." );
    }
    if(fromSlot == SLOT_HAND2 )
    {
	crit.Say( SAY_NETMSG, "Вы сняли респиратор." );
    }
}

bool e_GasMaskUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
	if (cr.GetItems( SLOT_HAND2, null)!=0)
		{
		cr.Say( SAY_NETMSG, "Уберите из рук все лишнее, чтобы нормально одеть респиратор." );
		}
	else
		{
	        cr.MoveItem(item.Id, 1, SLOT_HAND2);
		}
    return true;
}

void _FireFood( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE, "e_FireFoodUse" );
}

bool e_FireFoodUse( Item& item, Critter& cr, Critter@ onCritter, Item@ onItem, Scenery@ onScenery )
{
	cr.Say( SAY_NETMSG, "Пока нет функционала." );
	return false;
}

void _BonesInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_USE_ON_ME, "e_BonesUseItem" );
}

bool e_BonesUseItem( Item& item, Critter& crit, Item@ usedItem )
{
    if( valid( usedItem ) && usedItem.GetProtoId() == PID_SHOVEL )
    {
		DeleteItem( item );
		crit.Say( SAY_NETMSG, "Вы закопали тело." );
        return true;
    }
    return false;
}


void _InitToken( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_TokenPick" );
	item.SetEvent( ITEM_EVENT_DROP, "e_TokenDrop" );
    item.SetEvent( ITEM_EVENT_MOVE, "e_TokenMove" );
	item.SetEvent( ITEM_EVENT_WALK, "e_WorkplaceWalk" );
}

bool e_TokenPick( Item& item, Critter& cr, int skill )
{
    DeleteItem( item );
	return false;
}

void e_TokenDrop( Item& item, Critter& crit )
{
    DeleteItem( item );
}

void e_TokenMove( Item& item, Critter& crit, uint8 fromSlot )
{
    DeleteItem( item );
}

void SetWorkbench( Critter& cr, int p0, int p1, int p2 )
{
	Item@ item = GetItem(p0);
	if( !valid( item ) ) return;
    item.SetScript( "_InitWorkBench" );
    item.Update();
}

void _InitWorkBench( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_WorkBenchPick" );
    item.SetEvent( ITEM_EVENT_USE_ON_ME, "e_WorkBenchCloneKey" );	
}

bool e_WorkBenchCloneKey( Item& item, Critter& cr, Item@ usedItem )
{
    if( valid( usedItem ) && usedItem.GetType() == ITEM_TYPE_KEY )
    {
		if( _CritCountItem( cr, PID_CRAFT_M_BARS ) <= 0 )
		{
			cr.Say( SAY_NETMSG, "Вам нужна железная болванка." );
			return true;
		}
		cr.DeleteItem( PID_CRAFT_M_BARS, 1 );

		uint pid = usedItem.GetProtoId();
		if( pid == PID_BLANK_KEY )
			pid = PID_KEY; //Костыль "перехода" ключей от старого формата (@keylex@) к новому (чистая лексема).
		Item @ newKey = cr.AddItem( pid, 1 );

		newKey.LockerId = usedItem.LockerId;
		newKey.SetLexems( null );
		newKey.Update();

		cr.StatBase[ ST_LAST_DOOR_ID ] = newKey.Id;
		cr.StatBase[ ST_LAST_CONT_ID ] = newKey.Accessory;
		ShowInputBoxScreen( cr, "main@unsafe_MakeDescLex#Описание:", 0, INPUTBOX_CLOSE_ON_ENTER );
		return true;	
	}
    return false;	
}

bool e_WorkBenchPick( Item& item, Critter& cr, int skill )
{
    if( ( skill == SKILL_PICK_ON_GROUND ) && ( item.Accessory == ACCESSORY_HEX ) )
    {
        Item@ Workplace;
        @Workplace = cr.GetMap().GetItem( cr.HexX, cr.HexY, PID_GRAPPLE_HOOK );
        if( !valid( Workplace ) )
		{
			@Workplace = cr.GetMap().AddItem( cr.HexX, cr.HexY, PID_GRAPPLE_HOOK, 1 );
		}
		Workplace.SetScript( "_WorkplaceInit" );
		if( cr.CountItem( PID_WORKBENCH_TOKEN ) == 0 ) cr.AddItem( PID_WORKBENCH_TOKEN, 1 );
		cr.ShowScreen( SCREEN_FIXBOY, 0, "" );
    }
    return true;
}

void _WorkplaceInit( Item& item, bool firstTime )
{
    item.SetEvent( ITEM_EVENT_SKILL, "e_TokenPick" );
	item.SetEvent( ITEM_EVENT_DROP, "e_TokenDrop" );
    item.SetEvent( ITEM_EVENT_MOVE, "e_TokenMove" );
    item.SetEvent( ITEM_EVENT_WALK, "e_WorkplaceWalk" );
}

void e_WorkplaceWalk( Item& item, Critter& cr, bool entered, uint8 dir )
{
	if( !entered )
    {
	    Item@Token = cr.GetItem( PID_WORKBENCH_TOKEN, -1 );
        if( valid( Token )) DeleteItem( Token );
	    Item@Token2 = cr.GetItem( PID_FIREPLACE_TOKEN, -1 );
        if( valid( Token2 )) DeleteItem( Token2 ); 
    }
}



// ####################################################################################################
// #                                             Mio Poll                                             #
// ####################################################################################################

void _Poll( Item& item, bool firstTime )
{
	item.SetEvent( ITEM_EVENT_SKILL, "e_PollInit" );
}
bool e_PollInit( Item& item, Critter& cr, int skill )
{
	cr.ParamBase[ ST_VAR2 ] = item.Id;
	string[] List = { "1", "2", "3", "4", "5", "6" };
	string[] List2 = { "Кол-во пунктов", "Подсчитать", "Очистить урну" };

	if( skill == SK_SCIENCE )
	{
		if( cr.Id == uint ( item.Val0 ) )
		{
			cr.ShowScreen( SCREEN_DIALOGBOX, List2.length(), "Poll" );
			cr.Say( SAY_DIALOGBOX_TEXT, "Опции:" );
			for( uint i = 0, l = List2.length(); i < l; i++ ) { cr.Say( SAY_DIALOGBOX_BUTTON( i ), List2[ i ] ); }
		}
		else { cr.Say( SAY_EMOTE_ON_HEAD, "Пытается перенастроить механизм" ); }
		return true;
	}
	if( skill == SK_REPAIR )
	{
		if( item.Val0 == 0 ) { item.Val0 = cr.Id; cr.Say( SAY_NETMSG, "Урна ваша." ); }
		else if( uint ( item.Val0 ) == cr.Id ) { item.Val0 = 0; cr.Say( SAY_NETMSG, "Урна ничья." ); }
		else { cr.Say( SAY_EMOTE_ON_HEAD, "Пытается взломать механизм" ); }
		return true;
	}
	if( skill == -1 && cr.Id != uint ( item.Val0 ) )
	{
		cr.ShowScreen( SCREEN_DIALOGBOX, item.Val2, "Poll" );
		cr.Say( SAY_DIALOGBOX_TEXT, "Голосовать за номер:" );
		for( uint i = 0, l = item.Val2; i < l; i++ ) { cr.Say( SAY_DIALOGBOX_BUTTON( i ), "Номер "+List[ i ] ); }
		return true;
	}

	return false;
}
void Poll( Critter& player, uint answerI, string& answerS )
{
	Item@ Item0 = GetItem( player.Param[ ST_VAR2 ] );
	if( @ Item0 is null ) { return; }

	if( player.Id != uint ( Item0.Val0 ) )
	{
		if( uint ( Item0.Val1 ) != player.Id )
		{
			if( answerI == 0 ) { Item0.Val3 ++; }
			if( answerI == 1 ) { Item0.Val4 ++; }
			if( answerI == 2 ) { Item0.Val5 ++; }
			if( answerI == 3 ) { Item0.Val6 ++; }
			if( answerI == 4 ) { Item0.Val7 ++; }
			if( answerI == 5 ) { Item0.Val8 ++; }
			Item0.Val1 = player.Id;
			player.Say( SAY_EMOTE_ON_HEAD, "Голосует" );
		} else { player.Say( SAY_EMOTE_ON_HEAD, "Пытается сделать вброс" ); }
	}
	else
	{
		if( answerI == 0 )
		{
			string[] List = { "Один", "Два", "Три", "Четыре", "Пять", "Шесть" };
			player.ShowScreen( SCREEN_DIALOGBOX, List.length(), "Poll_x" );
			player.Say( SAY_DIALOGBOX_TEXT, "Число пунктов:" );
			for( uint i = 0, l = List.length(); i < l; i++ ) { player.Say( SAY_DIALOGBOX_BUTTON( i ), List[ i ] ); }
		}
		if( answerI == 1 )
		{
			string Str;
			for( uint i = 0, l = Item0.Val2; i < l; i++ )
			{
				switch( i )
				{
					case 0: Str +=  "1."+Item0.Val3; break;
					case 1: Str += " 2."+Item0.Val4; break;
					case 2: Str += " 3."+Item0.Val5; break;
					case 3: Str += " 4."+Item0.Val6; break;
					case 4: Str += " 5."+Item0.Val7; break;
					case 5: Str += " 6."+Item0.Val8; break;
				}
			}
			player.Say( SAY_EMOTE, "Считает голоса" );
			player.Say( SAY_NORM, Str );
		}
		if( answerI == 2 ) { Item0.Val1=0; Item0.Val3=0; Item0.Val4=0; Item0.Val5=0; Item0.Val6=0; Item0.Val7=0; Item0.Val8=0; }
	}
}
void Poll_x( Critter& player, uint answerI, string& answerS )
{
	Item@ Item0 = GetItem( player.Param[ ST_VAR2 ] );
	if( @ Item0 is null ) { return; }
	Item0.Val2 = answerI+1;
	player.Say( SAY_NETMSG, "Выбрано число пунктов: "+Item0.Val2 );
}



// Магнитофон.

import void RecorderAdjustment( Critter& cr, Item& targetItem ) from "mio_social";
import void RecorderUse( Critter& cr, Item& item ) from "mio_social";

void _Recorder( Item& item, bool firstTime )
{
	item.SetEvent( ITEM_EVENT_SKILL, "e_RecorderInit" );
}
bool e_RecorderInit( Item& item, Critter& cr, int skill )
{
	if( skill == 213 ) { RecorderAdjustment( cr, item ); return true; }
	else if( skill == -1 )
	{
		if( FLAG( item.Flags, ITEM_CAN_PICKUP ) ) { return false; }
		RecorderUse( cr, item );
		return true;
	}
	return false;
}

// Азартные игры.

import void DiceAdjustment( Critter& cr, Item& targetItem ) from "mio_social";
import void DiceUse( Critter& cr, Item& item ) from "mio_social";

void _Dice( Item& item, bool firstTime )
{
	item.SetEvent( ITEM_EVENT_SKILL, "e_DiceInit" );
}
bool e_DiceInit( Item& item, Critter& cr, int skill )
{
	if( skill == 213 ) { DiceAdjustment( cr, item ); return true; }
	else if( skill == -1 )
	{
		if( FLAG( item.Flags, ITEM_CAN_PICKUP ) ) { return false; }
		DiceUse( cr, item );
		return true;
	}
	return false;
}

import void CardsAdjustment( Critter& cr, Item& targetItem ) from "mio_social";
import void CardsUse( Critter& cr, Item& item ) from "mio_social";

void _Cards( Item& item, bool firstTime )
{
	item.SetEvent( ITEM_EVENT_SKILL, "e_CardsInit" );
}
bool e_CardsInit( Item& item, Critter& cr, int skill )
{
	if( skill == 213 ) { CardsAdjustment( cr, item ); return true; }
	else if( skill == -1 )
	{
		if( FLAG( item.Flags, ITEM_CAN_PICKUP ) ) { return false; }
		CardsUse( cr, item );
		return true;
	}
	return false;
}

