                                                     

string[]__critterHistoryInfo;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

bool LocIsModoc(uint locPid)
{
	return(locPid<=(6));
}

bool LocIsCity(uint locPid)
{
	return(locPid<=(25)||locPid==(40)||locPid==(42)||locPid==26||locPid==27||locPid==29||locPid>=96);
}

bool LocIsMasked(uint locPid)
{
	return(locPid==(41));
}

bool LocIsHidden(uint locPid)
{
	return false;
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                   

class Sprite
{
	Sprite()
	{
		Id=0;
		Hash=0;
		Width=0;
		Height=0;
		FrmCount=0;
		DrawFrame=-1;
	}
	
	void Load(string&name,int path)
	{
		if(name.length()>0)
		Id=LoadSprite(name,path);
		else
		Id=0;
		RefreshData();
	}
	
	void Load(uint nameHash,uint8 dir)
	{
		Id=LoadSprite(nameHash,dir);
		Hash=nameHash;
		RefreshData();
	}
	
	void LoadByIni(string&iniKey,int path)
	{
		string@name=GetIfaceIniStr(iniKey);
		if(@name!=null&&name.length()>0)
		Id=LoadSprite(name,path);
		else
		Id=0;
		RefreshData();
	}
	
	void Draw(int x,int y)
	{
		if(Id!=0)
		DrawSprite(Id,DrawFrame,x,y,0);
	}
	
	void Draw(int x,int y,uint8 sprIndex)
	{
		if(Id!=0)
		DrawSprite(Id,DrawFrame,x,y,0);
	}
	
	uint GetHashName()
	{
		return Hash;
	}
	
	private void RefreshData()
	{
		if(Id!=0)
		{
			Width=GetSpriteWidth(Id,0);
			Height=GetSpriteHeight(Id,0);
			FrmCount=GetSpriteCount(Id);
			DrawFrame=-1;
		}
		else
		{
			Width=0;
			Height=0;
			FrmCount=0;
			DrawFrame=-1;
		}
	}
	
	uint Id;
	uint Hash;
	int Width;
	int Height;
	uint FrmCount;
	int DrawFrame;
}              

uint __GetColor(int r,int g,int b)
{
	r=(((r)>(255))?(255):(((r)<(0))?(0):(r)));
	g=(((g)>(255))?(255):(((g)<(0))?(0):(g)));
	b=(((b)>(255))?(255):(((b)<(0))?(0):(b)));
	return(uint((0xFF<<24)|(((r)&0xFF)<<16)|(((g)&0xFF)<<8)|((b)&0xFF)));
}

uint __GetGradient(uint colorStart,uint colorEnd,uint8 pos)
{
	pos=(((pos)>(100))?(100):(((pos)<(1))?(1):(pos)));
	
	int aS=(colorStart>>24)&0xFF,
	rS=((colorStart>>16)&0xFF),
	gS=((colorStart>>8)&0xFF),
	bS=((colorStart)&0xFF),
	
	aE=(colorEnd>>24)&0xFF,
	rE=((colorEnd>>16)&0xFF),
	gE=((colorEnd>>8)&0xFF),
	bE=((colorEnd)&0xFF); 
	
	rS=(((rE-int(rS*(pos*0.01)))>0)?(rE-int(rS*(pos*0.01))):-(rE-int(rS*(pos*0.01))));
	gS=(((gE-int(gS*(pos*0.01)))>0)?(gE-int(gS*(pos*0.01))):-(gE-int(gS*(pos*0.01))));
	bS=(((bE-int(bS*(pos*0.01)))>0)?(bE-int(bS*(pos*0.01))):-(bE-int(bS*(pos*0.01))));
	
	return __GetColor(rS,gS,bS);
}

uint __GetColor(uint8&a,uint8&r,uint8&g,uint8&b,uint color){
	a=(color>>24)&0xFF;
	r=((color>>16)&0xFF);
	g=((color>>8)&0xFF);
	b=((color)&0xFF);
	
	return 0;
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

import void InitializeGame()from"config";
import void InitTestScreen()from"client_screen_test";
import void InitRadioScreen()from"radio";
import void GUI_Init()from"client_gui";
import void GUI_GetActiveScreens(int[]&result)from"client_gui";
import void GUI_ShowScreen(int screenIndex,int p0,int p1,int p2)from"client_gui";
import void GUI_HideScreen(int screenIndex,int p0,int p1,int p2)from"client_gui";
import void GUI_Render()from"client_gui";
import bool GUI_MouseDown(int click,int x,int y)from"client_gui";
import bool GUI_MouseUp(int click,int x,int y)from"client_gui";
import void GUI_MouseMove(int x,int y)from"client_gui";
import bool GUI_KeyDown(uint8 key)from"client_gui";
import bool GUI_KeyUp(uint8 key)from"client_gui";
import void GUI_InputLost()from"client_gui";
import bool PerkCheck(CritterCl&cr,uint perk)from"perks";
import void CritterGenerate(int[]&data)from"parameters";
import bool CritterGenerateCheck(int[]&data)from"parameters"; 

import void InitChosenTabs()from"chosen_tabs";
import void DrawChosenTabs()from"chosen_tabs";

import void SetHotkeysUse(bool use)from"hotkeys";

import void show_timeouts()from"client_timeouts";

import bool gm_msg(string&message)from"client_gm";     

import void PlayAnimSound(uint crType,int gender,uint anim1,uint anim2)from"animation"; 

import void SaveNames()from"client_names";
import void LoadNames()from"client_names";
import void ClearNameCache()from"client_names";
import string@GetName(uint id)from"client_names";
import bool updateNick(CritterCl&cr)from"client_names";
import bool updateAllNicks()from"client_names";

import void DrawMapTiles()from"qmap_client";
import void qmap_loop()from"qmap_client";  

import void InitContMenuScreen()from"client_screen_contmenu";
import void InitFastPanelScreen()from"client_screen_fastpanel";
import void InitFastPanelSkillbox()from"client_screen_fastpanel";
import void InitFastPanelTextbox()from"client_screen_fastpanel";

import void InitHistoryViewScreen()from"client_screen_history";
import void InitHistoryAllScreen()from"client_screen_history";
import void HidePanel(bool show)from"client_screen_fastpanel";
import void InitCodedoorScreen()from"client_screen_codedoor";
import void InitScreenAddiotional()from"client_screen_additional";
import void SetCrtype(int[]&params)from"client_screen_additional";
import void InitTeachScreen()from"client_screen_teaching";
import void InitScreenDoc()from"client_screen_doc";
import void InitFirstAidScreen()from"client_screen_firstais";
import void InitOptMenuScreen()from"client_screen_options";
import void SetHivePos(int16 x,int16 y,int16 realX,int16 realY,int16 type,uint8 count)from"client_screen_additional";
import void InitScreenInputbox()from"client_screen_inputbox";
import void InitInventoryTnfScreen()from"client_screen_inventory";
import void MoveHand()from"client_screen_copybool";
import void InitClockScreen()from"client_screen_copybool";
import void InitWaypointScreen()from"checkpoints"; 

uint prevId=0;
Sprite[]arrow;  

bool start()
{
	InitializeGame();
	
	if(__ScreenWidth<800||__ScreenWidth>1280||__ScreenHeight<600||__ScreenHeight>1024)
	{
		
		Message(GetMsgStr((3),(1040)));
		
	}       
	
	LoadFont((10),"CourierNewSmall");        
	
	if(!LoadDataFile("tnf.zip"))
	Message("Не найден tnf.zip! Обновите клиент с репозитория http://svn3.xp-dev.com/svn/fo_cl_rp/");
	else if(!AppendIfaceIni("rp_default.ini"))
	Message("Не найден rp_default.ini! Обновите клиент с репозитория http://svn3.xp-dev.com/svn/fo_cl_rp/");
	else
	Message("Файлы из tnf.zip успешно загружены, карта мира и интерфейс изменены для игры на Roleplay сервере.");
	
	GUI_Init();  
	
	InitRadioScreen();
	InitChosenTabs(); 
	
	InitContMenuScreen();
	InitFastPanelScreen();
	InitFastPanelSkillbox();
	InitFastPanelTextbox();
	InitCodedoorScreen();
	InitScreenAddiotional();
	InitTeachScreen();
	InitScreenDoc();
	InitFirstAidScreen();
	InitOptMenuScreen();
	InitInventoryTnfScreen();
	InitScreenInputbox();
	InitClockScreen();
	InitWaypointScreen();
	
	ExpBarSetPos();  
	
	arrow.resize(8);
	arrow[0].Load("arrow0.png",int((4)));
	arrow[1].Load("arrow1.png",int((4)));
	arrow[2].Load("arrow2.png",int((4)));
	arrow[3].Load("arrow3.png",int((4)));
	arrow[4].Load("arrow4.png",int((4)));
	arrow[5].Load("arrow5.png",int((4)));
	arrow[6].Load("arrow6.png",int((4)));
	arrow[7].Load("arrow7.png",int((4)));     
	
	__ShowPlayerNames=true;
	__ShowNpcNames=true;
	
	__global=(0x1)|(0x2);
	
	if(!__FullScr)
	__MouseScroll=false;                                 
	
	return true;
}   

uint loop_turn=0;

uint loop()
{    
	
	if(__isClockActive)
	{
		MoveHand();
	}
	
	if(loop_turn%5==0)
	qmap_loop();
	
	if(loop_turn%100==0)
	{
		int[]result;
		GUI_GetActiveScreens(result);
		
		CritterCl@ch=GetChosen();
		
		if(!(ch is null)&&(prevId==ch.Id)&&((result.length()>0&&result[result.length()-1]==(5))||(result.length()>1&&result[result.length()-2]==(5))))
		{
			SaveNames();
		}
	}
	loop_turn+=1;
	if(loop_turn>100)
	loop_turn=0;
	
	return 100;
}  

void get_active_screens(int[]&result)
{
	GUI_GetActiveScreens(result);
}  

void screen_change(bool show,int screen,int p0,int p1,int p2)
{
	
	if(screen==(1))
	{
		prevId=0;
		ClearNameCache();
	} 
	
	if(screen==(24)||screen==(21)||screen==(29)||screen==(20))
	__IsTextInput=show?true:false;
	
	if(show)
	GUI_ShowScreen(screen,p0,p1,p2);
	else
	GUI_HideScreen(screen,p0,p1,p2);
}

int[]@data_color=null;
int[]@data_number=null;
int[]@data_char=null; 

int[]hive_data;

void SetHiveData(int[]hivedata)
{
	hive_data.resize(0);
	for(uint8 i=0;i<hivedata.length();i++)
	{
		hive_data.insertLast(hivedata[i]);
	}
}

void _dr(int param0,int param1,int param2,string@param3,int[]@param4)
{
	switch(param0)
	{
		case 1:
		@data_color=param4;
		break;
		case 2:
		@data_number=param4;
		break;
		case 3:
		@data_char=param4;
		break;
		default:
		break;
	}
}

uint8 localMapPid=0;                    

void render_iface(uint layer)
{
	if(layer==4)
	{ 
		
		TestDirect3d(0);
	} 
	
	if(layer==3)
	{
		DrawChosenTabs();
		GUI_Render();  
		
		if(GetCurrentCursor()==(1))
		{
			ItemCl@item=GetMonitorItem(__MouseX,__MouseY);
			if(item!is null)
			{ 
				
				if(item.GetProtoId()>=(4053)&&item.GetProtoId()<=(4053)+8)
				{
					CritterCl@choo=GetChosen();
					
					if((((int(choo.HexX-item.HexX))>0)?(int(choo.HexX-item.HexX)):-(int(choo.HexX-item.HexX)))<=16&&(((int(choo.HexY-item.HexY))>0)?(int(choo.HexY-item.HexY)):-(int(choo.HexY-item.HexY)))<=16)
					{
						
						int value=GetScenParam(item.HexX,item.HexY,item.GetProtoId(),0);
						
						int x=0,y=0;
						switch(value)
						{
							case 0:
							x=-100;
							y=-80;
							break;
							case 1:
							x=-120;
							y=-110;
							break;
							case 2:
							x=-120;
							y=-120;
							break;
							case 3:
							x=-120;
							y=-100;
							break;
							case 4:
							x=-90;
							y=-110;
							break;
							case 5:
							x=-100;
							y=-110;
							break;
							case 6:
							x=-60;
							y=-125;
							break;
							case 7:
							x=-120;
							y=-120;
							break;
							default:
							break;
						}
						
						arrow[value].Draw(__MouseX+x,__MouseY+y); 
						
						localMapPid=choo.StatBase[(123)];
						
						if(value!=choo.StatBase[(122)])
						RunServerScriptUnsafe("globalmap_group@unsafe_GetMapPid",item.HexX,item.HexY,item.GetProtoId(),null,null);
						
						string mapName=GetMsgStr((4),(localMapPid+1)*10+8);
						DrawText(localMapPid!=0?mapName:"Пустошь",__MouseX-(localMapPid!=0?mapName.length()*7:45),__MouseY+20,400,20,localMapPid!=0?((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0xFF)&0xFF)<<8)|((0)&0xFF)))):((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),(8),0);
						
					} 
					
				}
			}
			
		}
		
		if(__IsHexAttack)
		{
			int tohit=to_hit_hex();
			if(tohit>0)
			DrawText(tohit+"%",__MouseX+7,__MouseY+8,((tohit/10>=1?2:1)+2)*10,10,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),(5),0);
		}
		if(__ShowTimeouts)
		show_timeouts();
	}
	else if(layer==100&&__GmapActive)
	{           
		
		CritterCl@ch=GetChosen(); 
		
		if(@ch!=null&&ch.Param[(703)]==(3))
		{
			
			for(uint8 i=0;i<hive_data.length();i++)
			{
				int16 x=(hive_data[i])&0x3FF;
				int16 y=(hive_data[i]>>10)&0x3FF;
				int16 type=(hive_data[i]>>20)&0xFFF;
				
				SetHivePos(x/__GmapZoom+__GmapOffsetX,y/__GmapZoom+__GmapOffsetY,x,y,type,i); 
				
			} 
			
		} 
		
		int flags=((0x0001)|(0x0004)|(0x0008)|(0x0200)),
		font=(5);
		
		float size=10/__GmapZoom;
		
		uint16 chx=__GmapGroupCurX/10,chy=__GmapGroupCurY/10;
		
		if(@data_color!=null&&__global&(0x2)!=0)
		{
			uint len=data_color.length();
			
			if(len>0&&len%2==0)
			{ 
				
				int[]drawData(len/2*18);
				
				for(uint i=0,j=0;i<len/2;j++)
				{
					float x=(data_color[j*2]&0xFFFF),
					y=((data_color[j*2]>>16));  
					
					x=x*10/__GmapZoom+__GmapOffsetX;
					y=y*10/__GmapZoom+__GmapOffsetY;
					
					int a=data_color[j*2+1];     
					
					uint k=i*18;
					drawData[k++]=x;
					drawData[k++]=y;
					drawData[k++]=a;
					drawData[k++]=x+size;
					drawData[k++]=y;
					drawData[k++]=a;
					drawData[k++]=x;
					drawData[k++]=y+size;
					drawData[k++]=a;
					drawData[k++]=x;
					drawData[k++]=y+size;
					drawData[k++]=a;
					drawData[k++]=x+size;
					drawData[k++]=y;
					drawData[k++]=a;
					drawData[k++]=x+size;
					drawData[k++]=y+size;
					drawData[k++]=a;       
					
					i++;
				}
				drawData.resize(len/2*18);
				DrawPrimitive((3),drawData);
			}
		}
		
		if(size>10&&__global&(0x1)!=0)
		{
			uint8 alpha=((((size-5)*20)>(0xAA))?(0xAA):((((size-5)*20)<(0))?(0):((size-5)*20)));
			
			int r=0x22,g=0x22,b=0x22; 
			
			r=(((r)>(0xFF))?(0xFF):(((r)<(0))?(0):(r)));
			g=(((g)>(0xFF))?(0xFF):(((g)<(0))?(0):(g)));
			b=(((b)>(0xFF))?(0xFF):(((b)<(0))?(0):(b)));
			int color=((alpha)<<24)|(r<<16)|(g<<8)|(b);
			
			float x0=__GmapOffsetX,
			y0=__GmapOffsetY,
			x=((7)*(50))/__GmapZoom+__GmapOffsetX,
			y=((12)*(50))/__GmapZoom+__GmapOffsetY;
			
			uint w=(7)*(50)/10,
			h=(12)*(50)/10;
			
			int[]drawData((w+h+2)*6);
			
			for(uint i=0;i<=h;i++)
			{
				drawData[i*6]=x0;
				drawData[i*6+1]=y0+size*i;
				drawData[i*6+2]=color;
				drawData[i*6+3]=x;
				drawData[i*6+4]=y0+size*i;
				drawData[i*6+5]=color;
			}
			for(uint j=0;j<=w;j++)
			{
				uint i=h+1+j;
				drawData[i*6]=x0+size*j;
				drawData[i*6+1]=y0;
				drawData[i*6+2]=color;
				drawData[i*6+3]=x0+size*j;
				drawData[i*6+4]=y;
				drawData[i*6+5]=color;
			}
			
			DrawPrimitive((1),drawData);
		}
		
		if(size>=5)
		{
			float x=(chx*10)/__GmapZoom+__GmapOffsetX,
			y=(chy*10)/__GmapZoom+__GmapOffsetY;  
			
			{
				int color=0xAA00FFFF;
				
				int[]drawData={x+1,y+1,color,x+size-1,y+1,color,x+size-1,y+size-1,color,x+1,y+size-1,color,x+1,y+1,color};
				DrawPrimitive((2),drawData);
			}       
			
		}
		
		if(@data_number!=null)
		{
			uint len=data_number.length();
			
			if(len>0&&len%2!=1)
			{
				for(uint i=0;i<len/2;i++)
				{
					float x=(data_number[i*2]&0xFFFF),
					y=((data_number[i*2]>>16));   
					
					x=x*10/__GmapZoom+__GmapOffsetX;
					y=y*10/__GmapZoom+__GmapOffsetY;
					int a=data_number[i*2+1]&0xFFFF,
					b=data_number[i*2+1]>>16;
					;
					
					string str=a;
					if(b>0)
					str+="+"+(b-a);        
					
					{
						uint8 alpha=((((2000.0f/size))<(0x88))?((2000.0f/size)):(0x88));
						int color=0x00FFAA00|((alpha)<<24);
						
						int[]drawData={x+1,y+1,color,x+size-1,y+1,color,x+1,y+size-1,color,x+size-1,y+size-1,color};
						DrawPrimitive((4),drawData);
					}   
					
					int tw=0,th=0,lines=0;
					GetTextInfo(str,0,0,font,flags,tw,th,lines);
					DrawText(str,x-(tw>>1),y-(tw>>1),size+tw,size+tw,0xFF22AAFF,font,flags);
				}
			}
		}
		
		if(@data_char!=null)
		{
			uint len=data_char.length();
			
			if(len>0&&len%2!=1)
			{
				for(uint i=0;i<len/2;i++)
				{
					float x=(data_char[i*2]&0xFFFF),
					y=((data_char[i*2]>>16));   
					
					x=x*10/__GmapZoom+__GmapOffsetX;
					y=y*10/__GmapZoom+__GmapOffsetY;
					uint a=(data_char[i*2+1]&0x00FFFFFF)|0xFF000000,
					b=data_char[i*2+1]>>24;
					
					string str=" ";
					str[0]=b;    
					
					int tw=0,th=0,lines=0;
					GetTextInfo(str,0,0,font,flags,tw,th,lines);
					DrawText(str,x-(tw>>1),y-(tw>>1),size+tw,size+tw,a,font,flags);
				}
			}
		} 
		
		{
			float x=(__MouseX-__GmapOffsetX)*__GmapZoom,
			y=(__MouseY-__GmapOffsetY)*__GmapZoom;
			
			x-=x%10;
			y-=y%10;
			
			string str=floor(x/10)+" : "+floor(y/10);
			
			x=x/__GmapZoom+__GmapOffsetX;
			y=y/__GmapZoom+__GmapOffsetY;
			
			if(size>=5)
			{
				int[]drawData={x+1,y+1,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),x+size-1,y+1,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),x+size-1,y+size-1,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),x+1,y+size-1,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),x+1,y+1,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF))))};
				DrawPrimitive((2),drawData);
			}
			
			int tw=0,th=0,lines=0;  
			
			GetTextInfo(str,0,0,font,(0x0001),tw,th,lines);
			DrawText(str,__MouseX+30,__MouseY+10,tw,th,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0xFF)&0xFF)<<8)|((0)&0xFF)))),font,(0x0001));
		}
	}
	
	if(layer==5)
	{ 
		
	}
}  

void render_map()
{
	DrawMapTiles();
}   

bool mouse_down(int click)
{
	return GUI_MouseDown(click,__MouseX,__MouseY);
}

bool mouse_up(int click)
{
	return GUI_MouseUp(click,__MouseX,__MouseY);
}

void mouse_move(int x,int y)
{ 
	
	GUI_MouseMove(x,y);
}   

bool AltDown=false;
bool key_down(uint8 key)
{
	if(__waiting)
	{
		CritterCl@ch=GetChosen();
		if(@ch!=null)
		{
			if(key==0x01||key==0x39)
			{
				if(ch.Param[(95)]>0)
				{
					Message("Antiflood.");
				}
				else
				RunServerScriptUnsafe("ltp@unsafe_StopProcess",0,0,0,null,null);
			}
			return true;
		}
		else
		__waiting=false;
	} 
	
	if(key==0x38||key==0xB8)
	AltDown=true;
	if(AltDown&&key==0x10)
	SetEffect((0),-1,"2D_Default.fx");
	if(AltDown&&key==0x11)
	SetEffect((0),-1,"2D_BlackWhite.fx");  
	
	if(key==0x1D||key==0x9D)
	__ctrlDown=true;
	
	if(key==0x2C)
	__MapZooming=true;
	
	if(key>=0x3B&&key<=0x58){
		uint16 drugPid=DKPCheckDrugKey(key);
		if(drugPid!=uint16(-1)){
			DKPUnsafeRun(drugPid);
		}
	}
	
	return GUI_KeyDown(key);
}

bool key_up(uint8 key)
{
	if(key==0x38||key==0xB8)
	AltDown=false;
	if(key==0x1D||key==0x9D)
	__ctrlDown=false;
	
	if(__waiting)
	return true;
	
	if(key==0x2C)
	__MapZooming=false;
	
	return GUI_KeyUp(key);
}  

void input_lost()
{
	AltDown=false;
	__MapZooming=false;
	
	GUI_InputLost();
}  

void critter_in(CritterCl&cr)
{
	CritterCl@ch=GetChosen();
	if(!(ch is null)&&(ch.Id==cr.Id)&&(prevId!=cr.Id))
	{
		@data_number=null;
		@data_color=null;
		@data_char=null;
		LoadNames();
		prevId=cr.Id;
	}
	
	updateNick(cr); 
	
	cr.NameColor=((uint((0xFF<<24)|(((0xAD)&0xFF)<<16)|(((0xAD)&0xFF)<<8)|((0xB9)&0xFF))));
	cr.ContourColor=(cr.IsPlayer()?((uint((0xFF<<24)|(((150)&0xFF)<<16)|(((150)&0xFF)<<8)|((0)&0xFF)))):((uint((0xFF<<24)|(((150)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))));
	if(cr.Param[(703)]==(3))
	cr.ContourColor=((uint((0xFF<<24)|(((150)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF))));                          
	
	if(__fastPanel)
	HidePanel(true);
	
}

void critter_out(CritterCl&cr)
{}  

void item_map_in(ItemCl&item)
{}

void item_map_changed(ItemCl&itemNow,ItemCl&itemBefore)
{}

void item_map_out(ItemCl&item)
{}  

void item_inv_in(ItemCl&item)
{         
	
}

void item_inv_out(ItemCl&item)
{         
	
}  

void item_drop(ItemCl&item)
{         
	
}   

bool map_message(string&message,uint16&hexX,uint16&hexY,uint&color,uint&delay)
{
	
	if(color==0xFFFFFFFE)
	message=".."+message+"..";
	
	if(color==((uint((0xFF<<24)|(((0x7F)&0xFF)<<16)|(((0x7F)&0xFF)<<8)|((0x7F)&0xFF)))))
	Message("|0xD3D3D3 "+message);
	return true;
}   

bool in_message(string&message,int&sayType,uint&critterId,uint&delay)
{
	if(sayType>=(10))
	return true;
	
	if((__sinf&(0x8))!=0&&critterId!=0&&sayType<=(8))
	{
		message="["+critterId+"] "+message;
	}
	if((__sinf&(0x40))!=0)
	return true; 
	
	CritterCl@sender=GetCritter(critterId);
	if(sender is null)
	return false;
	
	if(sender.IsNpc())
	return true;
	
	CritterCl@receiver=GetChosen();
	if(!(receiver is null)&&receiver.Param[(700)]==0&&sender.Param[(700)]==0)
	{
		int bs=sender.Stat[(67)];
		int br=receiver.Stat[(67)];
		if(message.length()>1)
		{
			if((bs==br&&bs!=(14))||
			(((bs>=(0)&&bs<(5))||bs==(10)||bs==(18))&&((br>=(0)&&br<(5))||br==(10)||br==(18)))||
			((bs==(12)||bs==(6)||bs==(17)||bs==(19)||bs==(20))&&(br==(12)||br==(6)||br==(17)||br==(19)||br==(20))))
			return true;
		}
		
		if(bs==(29))
		{
			if(sender.IsDead())
			return false;
			string@msg=GenerateZombieSpeech(sayType);
			if(msg!is null&&msg.length()>0)
			message=msg;
		}
		else
		{
			sayType=(5);
			switch(bs)
			{
				case(0):
				message="Говорит";
				break;
				case(1):
				message="Говорит";
				break;
				case(2):
				message="Говорит";
				break;
				case(3):
				message="Говорит";
				break;
				case(4):
				message="Говорит";
				break;
				case(5):
				message="Мычит";
				break;
				case(6):
				message="Щелкает клешнями";
				break;
				case(7):
				message="Пищит";
				break;
				case(8):
				message="Хрипение";
				break;
				case(9):
				message="Хрипение";
				break;
				case(10):
				message="Попикивает";
				break;
				case(11):
				message="Лает";
				break;
				case(12):
				message="Стрекочет";
				break;
				case(13):
				message="Рычит";
				break;
				case(14):
				message="";
				break;
				case(15):
				message="Шипит";
				break;
				case(16):
				message="Хрипит";
				break;
				case(17):
				message="Стрекочет";
				break;
				case(18):
				message="Говорит";
				break;
				case(19):
				message="Стрекочет";
				break;
				case(20):
				message="Жужит";
				break;
				case(30):
				message="";
				break;
			}
		}
	}
	return true;
}

import void DrawHives(uint8 hiveCount)from"client_screen_additional";  

bool out_message(string&message,int&sayType)
{
	if(findFirst(message,"$arcade")==0)
	RunServerScriptUnsafe("arcade_menu@unsafe_arcade",0,0,0,null,null);  
	
	if(__MessagePrefix!="")
	{
		message=__MessagePrefix+" "+message;
		__MessagePrefix="";
	}
	
	if(__IsHotkeysUse)
	__IsTextInput=true;
	
	if(findFirst(message,"~hotkeys")==0)
	{
		string@[]@msg=split(message," ");
		if(msg.length()==1)
		Message("Hotkeys use is now "+(__IsHotkeysUse?"on":"off"));
		else
		{
			if(msg[1]=="on")
			SetHotkeysUse(true);
			else if(msg[1]=="off")
			SetHotkeysUse(false);
			
			if(__IsHotkeysUse)
			__IsTextInput=true;
			;
			
			Message("Hotkeys use is now "+(__IsHotkeysUse?"on":"off"));
		}
		return false;
	}  
	
	if(message[0]==126)
	{             
		
		if(message=="~fastpanel")
		{
			__fastPanel=(__fastPanel?false:true);
			HidePanel(false);
			
			if(__fastPanel)
			RunServerScriptUnsafe("general_unsafe@unsafe_send_fastpanel",1,0,0,"",null);
			Message("fastpanel : "+(__fastPanel?"On":"Off"));
			
			return false;
		}
		
		if(message=="~gmhot")
		{
			__mobhotkeys=(__mobhotkeys?false:true);
			Message("mobhotkeys : "+(__mobhotkeys?"On":"Off"));
			return false;
		}
		
		if(message=="~sf")
		{
			RunServerScriptUnsafe("general_unsafe@unsafe_sleep",1,0,0,"",null);
			return false;
		}
		
		if(message=="~sb")
		{
			RunServerScriptUnsafe("general_unsafe@unsafe_sleep",0,0,0,"",null);
			return false;
		}
		
		if(message=="~mobhot")
		{
			__usermobhotkeys=(__usermobhotkeys?false:true);
			Message("mobhotkeys : "+(__usermobhotkeys?"On":"Off"));
			return false;
		}
		
		if(message=="~teach")
		{
			CritterCl@choo=GetChosen();
			if(@choo==null||choo.Param[(703)]==(3))
			{
				Message("Запрещено аркадным игрокам");
				return false;
			}
			else if(choo.Param[(703)]==(2))
			{
				Message("Запрещено для режима выживания");
				return false;
			}
			else if(choo.Param[(703)]==(0))
			{
				Message("Запрещено до выбора режима игры");
				return false;
			}
			ShowScreen((50),0,0,0);
			return false;
		}
		if(message=="~global")
		{
			ShowScreen((-9),0,0,0);
			Message("test");
			
			return false;
		}
		if(message=="~editway")
		{
			__isEditWaypoint=(__isEditWaypoint?false:true);
			Message("редактирование точек маршрута : "+(__isEditWaypoint?"выключено":"включено"));
			
			return false;
		}
		RunServerScriptUnsafe("general_unsafe@unsafe_log",0,0,0,GetChosen().Name+" "+GetChosen().Id+" - "+message,null);
		if(message=="~gmmenu"){
			uint16 x=__MouseX,y=__MouseY;
			CritterCl@cr=GetMonitorCritter(x,y);
			ItemCl@it=GetMonitorItem(x,y);
			if(@cr!=null)
			{
				if(cr.IsPlayer())
				RunServerScript("gm@GM_PANNEL_CRITTER_PLAYER",cr.Id,0,0,null,null);
				else
				RunServerScript("gm@GM_PANNEL_CRITTER_NPC",cr.Id,0,0,null,null);
				return true;
			}
			else if(@it!=null)
			{
				RunServerScript("gm@GM_PANNEL_ITEM",it.Id,0,0,null,null);
				return true;
			}
			else
			{
				uint16 hexX=0,hexY=0;
				GetMonitorHex(x,y,hexX,hexY);
				RunServerScript("gm@GM_PANNEL_HEX",hexX,hexY,0,null,null);
				return true;
			}
		}
		return true;
	}
	
	if(message[0]==35||message[0]==37||message[0]==36)
	{
		RunServerScriptUnsafe("general_unsafe@unsafe_log",0,0,0,GetChosen().Name+" "+GetChosen().Id+" - "+message,null);
		return gm_msg(message);
	} 
	
	CritterCl@chosen=GetChosen();
	if(chosen!is null and sayType<(11)and chosen.IsDead()and chosen.Anim2Dead>(103))
	{
		Message("Мертвые не разговаривают.");
		return false;
	}
	
	if(sayType==(1))
	{
		if(message.length()>2&&(message[0]==47||message[0]==46))
		{
			int eraseCount=1;
			int8 ch=message[1];
			if(ch==-22||ch==-54||ch==115||ch==83)
			sayType=(3);
			else if(ch==-3||ch==-35||ch==101||ch==69)
			sayType=(5);
			else if(ch==-8||ch==-40||ch==119||ch==87)
			sayType=(7);
			else if(ch==-15||ch==-47||ch==36)
			sayType=(9);
			else if(ch==-16||ch==-48||ch==114||ch==82)
			sayType=(10);
			
			if(sayType!=(1))
			{
				eraseCount++;
				if(message[2]==32)
				eraseCount++;
			}
			
			message=substring(message,eraseCount,message.length()-eraseCount);
		}
		else if(
		message.length()>=4&&message[0]==42&&message[1]!=42&&
		message[message.length()-2]!=42&&message[message.length()-1]==42)
		{
			sayType=(5);
			message=substring(message,1,message.length()-2);
		}
		if(sayType==(1)){RunServerScriptUnsafe("general_unsafe@unsafe_log_1",0,0,0,GetChosen().Name+" "+GetChosen().Id+" - "+message,null);}
		if(sayType==(5)){RunServerScriptUnsafe("general_unsafe@unsafe_log_1",0,0,0,GetChosen().Name+" "+GetChosen().Id+" **"+message+"**",null);}
		if(sayType==(7)){RunServerScriptUnsafe("general_unsafe@unsafe_log_1",0,0,0,GetChosen().Name+" "+GetChosen().Id+" ..."+message+"...",null);}
		if(sayType==(10)){RunServerScriptUnsafe("general_unsafe@unsafe_log_1",0,0,0,GetChosen().Name+" "+GetChosen().Id+" ..."+message+"...",null);}
		if(sayType==(9)){RunServerScriptUnsafe("general_unsafe@unsafe_log_1",0,0,0,GetChosen().Name+" "+GetChosen().Id+" ..."+message+"...",null);}
		if(sayType==(3)){RunServerScriptUnsafe("general_unsafe@unsafe_log_1",0,0,0,GetChosen().Name+" "+GetChosen().Id+" !!!"+message+"!!!",null);}
	}
	
	if(sayType>=(1)&&sayType<=(10))
	{
		for(uint i=0,len=message.length();i<len;i++)
		{
			uint8 chr=message[i];
			if(chr<32||(chr>34&&chr<42)||(chr>42&&chr<44)||chr==47||(chr>57&&chr<63)||chr==64||(chr>90&&chr<97)||(chr>122&&chr<192&&chr!=168&&chr!=184))
			{
				Message("В сообщениии есть запрещенные символы.");
				return false;
			}
		}
	}                  
	
	bool result=false;
	for(uint i=0,j=message.length();i<j;i++)
	{
		if(message[i]!=32)
		{
			result=true;
			break;
		}
	}
	
	return result;
} 

int to_hit_hex()
{
	
	CritterCl@chosen=GetChosen();
	if(!chosen.IsLife())
	return 0;
	CritterCl@target=GetMonitorCritter(__MouseX,__MouseY);
	if((@target!=null))
	return 0;
	
	uint8 mode=0;
	ProtoItem@weapon=chosen.GetSlotProto((1),mode);
	if(weapon is null)
	return 0;
	uint skillNum=((mode)==0?weapon.Weapon_Skill_0:((mode)==1?weapon.Weapon_Skill_1:((mode)==2?weapon.Weapon_Skill_2:0)));
	int dmgType=((mode)==0?weapon.Weapon_DmgType_0:((mode)==1?weapon.Weapon_DmgType_1:((mode)==2?weapon.Weapon_DmgType_2:0)));
	
	ItemCl@realWeapon=chosen.GetItem(0,(1));
	
	bool isFlareGun=(realWeapon.AmmoPid==(1038))&&(((mode)&0xF)==1);
	
	bool isRocket=false;
	if((@realWeapon!=null))
	isRocket=(realWeapon.AmmoPid==(14))||(realWeapon.AmmoPid==(37))||(realWeapon.AmmoPid==(274))||(realWeapon.AmmoPid==(1035));
	
	if(!isFlareGun&&!isRocket&&(skillNum!=(205)||!(dmgType==(4)||dmgType==(6)||dmgType==(7))))
	return 0;
	
	if((@realWeapon!=null)&&skillNum!=(205))
	if(realWeapon.AmmoCount==0)
	return 0;
	
	uint16 tx=0,ty=0;
	GetMonitorHex(__MouseX,__MouseY,tx,ty);
	if(tx==0&&ty==0)
	return 0;
	
	int dist=GetDistantion(chosen.HexX,chosen.HexY,tx,ty);
	
	uint16 toHx=tx,toHy=ty;
	GetHexCoord(chosen.HexX,chosen.HexY,toHx,toHy,0.0f,dist);
	if((tx!=toHx)||(ty!=toHy))
	return 0;  
	
	int wpnMaxDist=((mode)==0?weapon.Weapon_MaxDist_0:((mode)==1?weapon.Weapon_MaxDist_1:((mode)==2?weapon.Weapon_MaxDist_2:0)));
	if(skillNum==(205))
	wpnMaxDist=(((wpnMaxDist)<(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))))?(wpnMaxDist):(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)])))); 
	
	if(dist>wpnMaxDist)
	return 0;
	
	int toHit=int(chosen.Skill[skillNum]);
	int weaponPerk=weapon.Weapon_Perk;
	int blockers=0; 
	
	int distmod1=2;
	int distmod2=0;
	if(weaponPerk==(1))
	distmod1=4;
	else if(weaponPerk==(5))
	{
		distmod1=5;
		distmod2=8;
	}
	
	int perception=chosen.Stat[(1)];
	int acc=dist;
	
	if(dist<distmod2)
	acc+=distmod2;
	else
	{
		if(chosen.IsPlayer())
		acc-=(perception-2)*distmod1;
		else
		acc-=perception*distmod1;
	}
	
	if(-2*perception>acc)
	acc=-2*perception;
	
	acc-=2*chosen.Perk[(315)];
	
	if(acc>=0)
	{
		if(chosen.Damage[(502)]!=0)
		acc*=-12;
		else
		acc*=-4;
	}
	else
	acc*=-4;
	
	toHit+=acc;
	blockers=GetCrittersPath(chosen.HexX,chosen.HexY,tx,ty,0.0f,dist,(0x01),null);
	toHit-=10*blockers; 
	
	if(chosen.Trait[(553)]!=0&&(@realWeapon!=null))
	toHit+=((((weapon.Flags)&((0x00000080)))!=0)?-40:20);
	
	int handlingStrength=chosen.Stat[(0)];
	int reqStrength=weapon.Weapon_MinStrength;
	if(chosen.Perk[(407)]!=0)
	handlingStrength+=3;
	if(handlingStrength<reqStrength)
	toHit-=(reqStrength-handlingStrength)*20;
	if(weaponPerk==(2))
	toHit+=20; 
	
	if(chosen.Damage[(502)]!=0)
	toHit-=25;
	toHit=(((toHit)>(95))?(95):(((toHit)<(5))?(5):(toHit)));
	
	return toHit;
	
} 

int to_hit(CritterCl&chosen,CritterCl&target,ProtoItem&weapon,uint8 weaponMode)
{
	int use=((weaponMode)&0xF);
	int hitLocation=(((weaponMode)>>4)&0xF);
	if(use>2)
	return 0;
	
	if(target.IsDead())
	return 0;
	if(!chosen.IsLife())
	return 0;
	
	ItemCl@realWeapon=chosen.GetItem(0,(1));
	ProtoItem@ammo=null;
	
	if((@realWeapon!=null)&&((use)==0?weapon.Weapon_Round_0:((use)==1?weapon.Weapon_Round_1:((use)==2?weapon.Weapon_Round_2:0)))>0)
	{
		if(realWeapon.AmmoCount==0)
		return 0;
		@ammo=GetProtoItem(realWeapon.AmmoPid);
	}
	
	uint skillNum=((use)==0?weapon.Weapon_Skill_0:((use)==1?weapon.Weapon_Skill_1:((use)==2?weapon.Weapon_Skill_2:0)));
	int skillVal=int(chosen.Skill[skillNum]);
	int wpnMaxDist=((use)==0?weapon.Weapon_MaxDist_0:((use)==1?weapon.Weapon_MaxDist_1:((use)==2?weapon.Weapon_MaxDist_2:0)));
	if(skillNum==(205))
	wpnMaxDist=(((wpnMaxDist)<(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))))?(wpnMaxDist):(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))));
	uint8 weaponSubtype=(skillNum==(200)||skillNum==(201)||skillNum==(202))?(4):((skillNum==(205))?(3):(skillNum==(204))?(2):(1));   
	
	if(weaponSubtype==(4))
	{ 
		
		if(skillNum==(200)&&skillVal<(125))
		{
			
			skillVal+=chosen.Skill[(201)]/3;
			
			skillVal+=chosen.Skill[(202)]/2;
			
			if(skillVal>(125))
			{
				skillVal=(125);
			}
			
		}
		
		if(skillNum==(201)&&skillVal<(125))
		{
			
			skillVal+=chosen.Skill[(200)]/3;
			
			skillVal+=chosen.Skill[(202)]/3;
			
			if(skillVal>(125))
			{
				skillVal=(125);
			}
			
		}
		
		if(skillNum==(202)&&skillVal<(125))
		{
			
			skillVal+=chosen.Skill[(200)]/2;
			
			skillVal+=chosen.Skill[(201)]/3;
			
			if(skillVal>(125))
			{
				skillVal=(125);
			}
			
		}
	}
	else
	{
		
		if(skillNum==(203)&&skillVal<(125))
		{
			skillVal+=chosen.Skill[(205)]/3;
			skillVal+=chosen.Skill[(204)]/2;
			if(skillVal>(125))
			skillVal=(125);
		}
		
		if(skillNum==(204)&&skillVal<(125))
		{
			skillVal+=chosen.Skill[(203)]/2;
			skillVal+=chosen.Skill[(205)]/3;
			if(skillVal>(125))
			skillVal=(125);
		}
		
		if(skillNum==(205)&&skillVal<(125))
		{
			skillVal+=chosen.Skill[(203)]/3;
			skillVal+=chosen.Skill[(204)]/2;
			if(skillVal>(125))
			skillVal=(125);
		}
	} 
	
	int dist=GetCrittersDistantion(chosen,target);
	if(dist>wpnMaxDist)
	return 0;
	
	int toHit=skillVal;
	int weaponPerk=weapon.Weapon_Perk;
	int blockers=0;
	
	if(skillNum!=(203)&&skillNum!=(204))
	{ 
		
		int distmod1=2;
		int distmod2=0;
		if(weaponPerk==(1))
		distmod1=4;
		else if(weaponPerk==(5))
		{
			distmod1=5;
			distmod2=8;
		}
		
		int perception=chosen.Stat[(1)];
		int acc=dist;
		
		if(dist<distmod2)
		acc+=distmod2;
		else
		{
			if(chosen.IsPlayer())
			acc-=(perception-2)*distmod1;
			else
			acc-=perception*distmod1;
		}
		
		if(-2*perception>acc)
		acc=-2*perception;
		
		acc-=2*chosen.Perk[(315)];
		
		if(acc>=0)
		{
			if(chosen.Damage[(502)]!=0)
			acc*=-12;
			else
			acc*=-4;
		}
		else
		acc*=-4;
		
		toHit+=acc; 
		
		blockers=GetCrittersPath(chosen.HexX,chosen.HexY,target.HexX,target.HexY,0.0f,dist,(0x01),null);
		if(!target.IsKnockout())
		blockers--;
		toHit-=10*blockers;
	}
	
	if(!(weapon.Weapon_IsUnarmed)&&chosen.Trait[(553)]!=0&&(@realWeapon!=null))
	toHit+=((((weapon.Flags)&((0x00000080)))!=0)?-40:20);
	
	int handlingStrength=chosen.Stat[(0)];
	int reqStrength=weapon.Weapon_MinStrength;
	if(chosen.Perk[(407)]!=0)
	handlingStrength+=3;
	if(handlingStrength<reqStrength)
	toHit-=(reqStrength-handlingStrength)*20;
	if(weaponPerk==(2))
	toHit+=20;
	
	int acmod=target.Stat[(9)];
	if((@ammo!=null))
	acmod+=ammo.Ammo_ACMod;
	if(acmod>0)
	toHit-=acmod;  
	
	if(chosen.Damage[(502)]!=0)
	toHit-=25;
	if(target.IsKnockout())
	toHit+=40;
	toHit+=target.GetMultihex()*15;
	
	int hitMod=GetHitAim(hitLocation);
	if(skillNum==(204)||skillNum==(203))
	hitMod/=2;
	toHit-=hitMod;
	toHit=(((toHit)>(95))?(95):(((toHit)<(5))?(5):(toHit)));
	
	return toHit;
}

uint GetHitAim(int hitLocation)
{
	switch(hitLocation)
	{
		case(0):
		break;
		case(9):
		break;
		case(4):
		return __HitAimTorso;
		case(7):
		return __HitAimEyes;
		case(1):
		return __HitAimHead;
		case(2):
		case(3):
		return __HitAimArms;
		case(8):
		return __HitAimGroin;
		case(5):
		case(6):
		return __HitAimLegs;
		default:
		break;
	}
	return 0;
}  

void hit_aim(uint8&aim)
{}  

void combat_result(uint[]&data)
{
	uint datalen=data.length();
	if(datalen==0)
	return;
	if(data[0]!=datalen)
	return;
	
	uint current=1;
	
	while(current<datalen)
	{
		int damage=-1;
		uint effect=0;
		uint loc=0;
		int message=-1;
		
		uint mode=data[current++];
		uint who=data[current++];
		uint who2;
		CritterCl@originalTarget;
		
		CritterCl@cr=GetCritter(who);
		CritterCl@chosen=GetChosen();
		CritterCl@trueTarget=null;
		
		bool self=(who==GetChosen().Id);
		
		string name="error0";
		if((@cr!=null))
		{
			if(!self)
			name=cr.Name;
			else
			name=GetMsgStr((5),chosen.Stat[(71)]==(0)?506:556);
		}
		
		uint offset;
		if(self)
		{
			if(cr.Stat[(71)]==(0))
			offset=506;
			else
			offset=556;
		}
		else
		{
			if(cr.Stat[(71)]==(0))
			offset=606;
			else
			offset=706;
		}
		
		string result; 
		
		switch(mode)
		{
			case(2):
			effect=data[current++];
			result=GetMsgStr((5),offset+8);
			result=ReplaceText(result,"%s",name);
			break;
			case(3):
			effect=data[current++];
			damage=data[current++];
			result=GetMsgStr((5),offset+(damage>1?28:27));
			result=ReplaceText(result,"%s",name);
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(4):
			case(8):
			damage=data[current++];
			result=GetMsgStr((5),offset+(damage>1?7:(damage!=0?17:21)));
			result=ReplaceText(result,"%s",name);
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(5):
			case(9):
			loc=data[current++];
			damage=data[current++];
			result=GetMsgStr((5),offset+(damage>1?6:(damage!=0?16:20)));
			result=ReplaceText(result,"%s",name);
			result=ReplaceText(result,"%s",GetMsgStr((5),1000+cr.CrTypeAlias*10+loc-1));
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(6):
			damage=data[current++];
			effect=data[current++];
			message=data[current++];
			result=GetMsgStr((5),offset+(damage>1?14:(damage!=0?18:22)));
			result=ReplaceText(result,"%s",name);
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(7):
			loc=data[current++];
			damage=data[current++];
			effect=data[current++];
			message=data[current++];
			result=GetMsgStr((5),offset+(damage>1?5:(damage!=0?15:19)));
			result=ReplaceText(result,"%s",name);
			result=ReplaceText(result,"%s",GetMsgStr((5),1000+cr.CrTypeAlias*10+loc-1));
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(10):
			damage=data[current++];
			message=data[current++];
			result=GetMsgStr((5),offset+(damage>1?14:(damage!=0?18:22)));
			result=ReplaceText(result,"%s",name);
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(11):
			loc=data[current++];
			damage=data[current++];
			message=data[current++];
			result=GetMsgStr((5),offset+(damage>1?5:(damage!=0?15:19)));
			result=ReplaceText(result,"%s",name);
			result=ReplaceText(result,"%s",GetMsgStr((5),1000+cr.CrTypeAlias*10+loc-1));
			if(damage>1)
			result=ReplaceText(result,"%d",damage);
			break;
			case(12):
			who2=data[current++]; 
			
			@trueTarget=GetCritter(who2);
			if(self)
			{
				
				result=GetMsgStr((5),cr.Stat[(71)]==(0)?608:708);
				string nameTrue="error1";
				if((@trueTarget!=null))
				nameTrue=trueTarget.Name;
				result=ReplaceText(result,"%s",nameTrue);
			}
			else
			{
				
				result=GetMsgStr((5),offset+3);
				if(who2==GetChosen().Id)
				{
					result=ReplaceText(result,"%s",GetMsgStr((5),chosen.Stat[(71)]==(0)?506:556));
				}
				else
				{
					string nameTrue="error1";
					if((@trueTarget!=null))
					nameTrue=trueTarget.Name;
					result=ReplaceText(result,"%s",nameTrue);
				}
				result=ReplaceText(result,"%s",name);
			}
			break;
			case(1):
			result=GetMsgStr((5),offset+9);
			result=ReplaceText(result,"%s",name);
			break;
			case(13):
			result=GetMsgStr((5),offset+9);
			result=ReplaceText(result,"%s",name);
			result+=GetMsgStr((5),108)+GetMsgStr((5),offset-306+20);
			default:
			break;
		}
		
		bool isVerbose=(__CombatMessagesType==0);
		string@[]ext;
		
		if(message!=-1&&isVerbose)
		{
			result+=GetMsgStr((5),message);
		}
		else if(effect!=0)
		{
			offset-=306;
			if(mode>(3))
			{
				if((((effect)&((0x00000001)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+0));
				if((((effect)&((0x00000002)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+1));
				if((((effect)&((0x00000004)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+2));
				if((((effect)&((0x00000008)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+3));
				if((((effect)&((0x00000010)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+4));
				if((((effect)&((0x00000020)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+5));
				if((((effect)&((0x00000040)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+6)); 
				
				if((((effect)&((0x00000800)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+11));
				if((((effect)&((0x00004000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+14));
				if((((effect)&((0x00008000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+15));
				if((((effect)&((0x00200000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+21));
			}
			else
			{
				if((((effect)&((0x00000002)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+1));
				
				if((((effect)&((0x00001000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+12));
				if((((effect)&((0x00002000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+13));
				if((((effect)&((0x00004000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+14));
				if((((effect)&((0x00008000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+15));
				if((((effect)&((0x00010000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+16));
				if((((effect)&((0x00020000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+17));
				if((((effect)&((0x00040000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+18));
				if((((effect)&((0x00080000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+19));
				
				if((((effect)&((0x00200000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+21));
				if((((effect)&((0x10000000)))!=0))
				ext.insertLast(@GetMsgStr((5),offset+7));
			}
			offset+=306;
		}
		
		if(8<=mode&&mode<=11&&(!isVerbose||message==-1))
		ext.insertLast(@GetMsgStr((5),offset+7-306));
		
		for(uint m=0,n=ext.length();m<n;m++)
		{
			if(m==n-1)
			result+=GetMsgStr((5),108);
			else
			result+=", ";
			
			result+=ext[m];
		}
		
		result+=".";
		
		Message(result,int(2));
		
		if(8<=mode&&mode<=11&&isVerbose&&message!=-1)
		Message(name+" "+GetMsgStr((5),offset+7-306)+".",int(2)); 
		
		if(__DamageHitDelay>0&&damage>0)
		MapMessage("-"+damage,cr.HexX,cr.HexY,__DamageHitDelay,0xFFC80000,true,Random(-5,5),-20);
	}
}   

string generic_description(int descType,int&offsX,int&offsY)
{
	CritterCl@chosen=GetChosen();
	if(not(@chosen!=null))
	return"";
	string result;
	
	if(descType==(0))
	{
		result+=chosen.Name+"\n";
		result+="---------------------\n";
		result+=GetMsgStr((3),(400+((0))))+"\n";
		result+=GetMsgStr((3),(400+((1))))+"\n";
		result+=GetMsgStr((3),(400+((2))))+"\n";
		result+=GetMsgStr((3),(400+((3))))+"\n";
		result+=GetMsgStr((3),(400+((4))))+"\n";
		result+=GetMsgStr((3),(400+((5))))+"\n";
		result+=GetMsgStr((3),(400+((6))))+"\n";
		result+="---------------------\n";
		
		ItemCl@weaponMain=chosen.GetItem(0,(1));
		if((@weaponMain!=null))
		{
			int use=((weaponMain.Mode)&0xF);
			if(use>2)
			use=0;
			
			result+=GetMsgStr((2),(weaponMain.GetProtoId()*100+weaponMain.Info))+"\n";
			
			if(weaponMain.GetType()==(3))
			{
				result+=GetMsgStr((3),(415))+" ";
				result+=((use)==0?weaponMain.Proto.Weapon_DmgMin_0:((use)==1?weaponMain.Proto.Weapon_DmgMin_1:((use)==2?weaponMain.Proto.Weapon_DmgMin_2:0)))+"-";
				int wpnMaxDmg=((use)==0?weaponMain.Proto.Weapon_DmgMax_0:((use)==1?weaponMain.Proto.Weapon_DmgMax_1:((use)==2?weaponMain.Proto.Weapon_DmgMax_2:0)));
				if((((use)==0?weaponMain.Proto.Weapon_Skill_0:((use)==1?weaponMain.Proto.Weapon_Skill_1:((use)==2?weaponMain.Proto.Weapon_Skill_2:0)))==(203)||((use)==0?weaponMain.Proto.Weapon_Skill_0:((use)==1?weaponMain.Proto.Weapon_Skill_1:((use)==2?weaponMain.Proto.Weapon_Skill_2:0)))==(204)))
				wpnMaxDmg+=chosen.Stat[(10)];
				result+=wpnMaxDmg;
				
				if(((use)==0?weaponMain.Proto.Weapon_MaxDist_0:((use)==1?weaponMain.Proto.Weapon_MaxDist_1:((use)==2?weaponMain.Proto.Weapon_MaxDist_2:0)))>1)
				{
					result+=" "+GetMsgStr((3),(416))+" ";
					int wpnMaxDist=((use)==0?weaponMain.Proto.Weapon_MaxDist_0:((use)==1?weaponMain.Proto.Weapon_MaxDist_1:((use)==2?weaponMain.Proto.Weapon_MaxDist_2:0)));
					if(((use)==0?weaponMain.Proto.Weapon_Skill_0:((use)==1?weaponMain.Proto.Weapon_Skill_1:((use)==2?weaponMain.Proto.Weapon_Skill_2:0)))==(205))
					wpnMaxDist=(((wpnMaxDist)<(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))))?(wpnMaxDist):(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))));
					result+=wpnMaxDist;
				}
				result+="\n";
				
				if(weaponMain.Proto.Weapon_MaxAmmoCount>0)
				{
					result+=GetMsgStr((3),(417))+" ";
					result+=weaponMain.AmmoCount+"/";
					result+=weaponMain.Proto.Weapon_MaxAmmoCount+" ";
					result+=GetMsgStr((3),(10900+(weaponMain.Proto.Weapon_Caliber)));
				}
				result+="\n";
			}
			else
			{
				result+="\n\n";
			}
		}
		else
		{
			
			uint8 mode=0;
			ProtoItem@unarmed=chosen.GetSlotProto((1),mode);
			result+=GetMsgStr((3),(414))+"\n";
			result+=GetMsgStr((3),(424))+" ";
			result+=((((mode)&0xF))==0?unarmed.Weapon_DmgMin_0:((((mode)&0xF))==1?unarmed.Weapon_DmgMin_1:((((mode)&0xF))==2?unarmed.Weapon_DmgMin_2:0)))+"-";
			result+=(((((mode)&0xF))==0?unarmed.Weapon_DmgMax_0:((((mode)&0xF))==1?unarmed.Weapon_DmgMax_1:((((mode)&0xF))==2?unarmed.Weapon_DmgMax_2:0)))+chosen.Stat[(10)]);
			result+="\n\n";
		}
		result+="---------------------\n";
		
		ItemCl@weaponExt=chosen.GetItem(0,(2));
		if((@weaponExt!=null))
		{
			int use=((weaponExt.Mode)&0xF);
			if(use>2)
			use=0;
			
			result+=GetMsgStr((2),(weaponExt.GetProtoId()*100+weaponExt.Info))+"\n";
			
			if(weaponExt.GetType()==(3))
			{
				result+=GetMsgStr((3),(415))+" ";
				result+=((use)==0?weaponExt.Proto.Weapon_DmgMin_0:((use)==1?weaponExt.Proto.Weapon_DmgMin_1:((use)==2?weaponExt.Proto.Weapon_DmgMin_2:0)))+"-";
				int wpnMaxDmg=((use)==0?weaponExt.Proto.Weapon_DmgMax_0:((use)==1?weaponExt.Proto.Weapon_DmgMax_1:((use)==2?weaponExt.Proto.Weapon_DmgMax_2:0)));
				if((((use)==0?weaponExt.Proto.Weapon_Skill_0:((use)==1?weaponExt.Proto.Weapon_Skill_1:((use)==2?weaponExt.Proto.Weapon_Skill_2:0)))==(203)||((use)==0?weaponExt.Proto.Weapon_Skill_0:((use)==1?weaponExt.Proto.Weapon_Skill_1:((use)==2?weaponExt.Proto.Weapon_Skill_2:0)))==(204)))
				wpnMaxDmg+=chosen.Stat[(10)];
				result+=wpnMaxDmg;
				if(((use)==0?weaponExt.Proto.Weapon_MaxDist_0:((use)==1?weaponExt.Proto.Weapon_MaxDist_1:((use)==2?weaponExt.Proto.Weapon_MaxDist_2:0)))>1)
				{
					result+=" "+GetMsgStr((3),(416))+" ";
					int wpnMaxDist=((use)==0?weaponExt.Proto.Weapon_MaxDist_0:((use)==1?weaponExt.Proto.Weapon_MaxDist_1:((use)==2?weaponExt.Proto.Weapon_MaxDist_2:0)));
					if(((use)==0?weaponExt.Proto.Weapon_Skill_0:((use)==1?weaponExt.Proto.Weapon_Skill_1:((use)==2?weaponExt.Proto.Weapon_Skill_2:0)))==(205))
					wpnMaxDist=(((wpnMaxDist)<(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))))?(wpnMaxDist):(3*(((int(10))<(chosen.Stat[(0)]+2*chosen.Perk[(336)]))?(int(10)):(chosen.Stat[(0)]+2*chosen.Perk[(336)]))));
					result+=wpnMaxDist;
				}
				result+="\n";
				
				if(weaponExt.Proto.Weapon_MaxAmmoCount>0)
				{
					result+=GetMsgStr((3),(417))+" ";
					result+=weaponExt.AmmoCount+"/";
					result+=weaponExt.Proto.Weapon_MaxAmmoCount+" ";
					result+=GetMsgStr((3),(10900+(weaponExt.Proto.Weapon_Caliber)));
				}
				result+="\n";
			}
			else
			{
				result+="\n\n";
			}
		}
		else
		{
			
			uint8 mode=0;
			ProtoItem@unarmed=chosen.GetSlotProto((2),mode);
			result+=GetMsgStr((3),(414))+"\n";
			result+=GetMsgStr((3),(424))+" ";
			result+=((((mode)&0xF))==0?unarmed.Weapon_DmgMin_0:((((mode)&0xF))==1?unarmed.Weapon_DmgMin_1:((((mode)&0xF))==2?unarmed.Weapon_DmgMin_2:0)))+"-";
			result+=(((((mode)&0xF))==0?unarmed.Weapon_DmgMax_0:((((mode)&0xF))==1?unarmed.Weapon_DmgMax_1:((((mode)&0xF))==2?unarmed.Weapon_DmgMax_2:0)))+chosen.Stat[(10)]);
			result+="\n\n";
		}
		
		result+=GetMsgStr((3),(420))+" ";
		result+=(chosen.ItemsWeight()/1000)+"/";
		result+=(chosen.Stat[(11)]/1000)+".";
	}
	else if(descType==(1))
	{
		offsX=23;
		result+="\n\n";
		result+=chosen.Stat[(0)]+"\n";
		result+=chosen.Stat[(1)]+"\n";
		result+=chosen.Stat[(2)]+"\n";
		result+=chosen.Stat[(3)]+"\n";
		result+=chosen.Stat[(4)]+"\n";
		result+=chosen.Stat[(5)]+"\n";
		result+=chosen.Stat[(6)];
	}
	else if(descType==(2))
	{
		offsX=39;
		result+="\n\n";
		result+=GetMsgStr((3),(407))+" ";
		result+=chosen.Stat[(72)]+"/"+chosen.Stat[(7)]+"\n";
		result+=GetMsgStr((3),(408))+" ";
		result+=chosen.Stat[(9)]+"\n";
		result+=GetMsgStr((3),(409))+"\n";
		result+=GetMsgStr((3),(410))+"\n";
		result+=GetMsgStr((3),(411))+"\n";
		result+=GetMsgStr((3),(412))+"\n";
		result+=GetMsgStr((3),(413));
	}
	else if(descType==(3))
	{
		offsX=103;
		result+="\n\n\n\n";
		result+=chosen.Stat[(16)]+"/"+chosen.Stat[(23)]+"%\n";
		result+=chosen.Stat[(17)]+"/"+chosen.Stat[(24)]+"%\n";
		result+=chosen.Stat[(18)]+"/"+chosen.Stat[(25)]+"%\n";
		result+=chosen.Stat[(19)]+"/"+chosen.Stat[(26)]+"%\n";
		result+=chosen.Stat[(22)]+"/"+chosen.Stat[(29)]+"%";
	}
	
	return result;
}  

string item_description(ItemCl&item,int lookType)
{
	
	if(not IsMsgStr((2),(item.GetProtoId()*100+item.Info)+(lookType!=(1)?1:0)))
	return GetMsgStr((3),(10010));
	
	string result; 
	
	if(lookType==(5))
	{
		string fuel=GetMsgStr((3),(561));
		fuel=ReplaceText(fuel,"VALUE",item.Charge/100);
		fuel=ReplaceText(fuel,"MAX_VALUE",item.Proto.Car_TankVolume/100);
		string deterioration=GetMsgStr((3),(562));
		deterioration=ReplaceText(deterioration,"VALUE",item.Deterioration*100/item.Proto.Car_MaxDeterioration);
		result=fuel+"\n"+deterioration;
	}
	
	else if(lookType==(1))
	{
		result+=ReplaceText(GetMsgStr((3),(10000)),"NAME",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
		if(item.Lexems!="")
		{
			string lex=""+item.Lexems;
			for(uint i=0,len=lex.length();i<len;i++)
			{
				uint8 chr=lex[i];
				if(chr==36)
				{
					lex="";
					break;
				}
			}
			if(lex!="")
			result+=" "+lex;
		}
		if(((__sinf&(0x10))!=0)&&item.GetType()>0&&item.GetType()<10)
		{
			result+=" |0xffff0000 id: "+item.Id+" pid: "+item.GetProtoId();
		}
	}
	
	else
	{
		if(lookType==(4))
		result+=GetMsgStr((2),(item.GetProtoId()*100+item.Info))+"\n";
		if(item.Lexems!="")
		{
			string lex=""+item.Lexems;
			for(uint i=0,len=lex.length();i<len;i++)
			{
				uint8 chr=lex[i];
				if(chr==36)
				{
					lex="";
					break;
				}
			}
			if(lex!="")
			result+=""+lex+" ";
		}
		if(item.GetProtoId()==(58)&&item.HolodiskNumber!=0)
		result+=GetMsgStr((7),((item.HolodiskNumber)*10));
		else
		result+=GetMsgStr((2),(item.GetProtoId()*100+item.Info)+1);
		
		if(lookType!=(2))
		{
			uint16 pid=item.GetProtoId();        
			
			if(pid<(940)||pid>(944))
			{
				
				result+="\n"+ReplaceText(GetMsgStr((3),(435)),"VALUE",item.Proto.Weight*item.GetCount());
			}
			else
			{
				result+="\nРазмер: "+item.Val7+" см.";
			} 
			
			if(item.GetType()==(3)&&item.Proto.Weapon_MaxAmmoCount>0)
			{
				result+="\n";
				string str=GetMsgStr((3),(434));
				str=ReplaceText(str,"VALUE",item.AmmoCount);
				str=ReplaceText(str,"MAX_VALUE",item.Proto.Weapon_MaxAmmoCount);
				str=ReplaceText(str,"AMMO",GetMsgStr((3),(10900+(item.Proto.Weapon_Caliber))));
				result+=str;
			} 
			
			if(item.IsDeteriorable())
			{
				uint8 brokenFlags=item.BrokenFlags;
				uint8 brokenCount=item.BrokenCount;
				uint16 deterioration=item.Deterioration; 
				
				result+="\n";
				if((((brokenFlags)&((0x08)))!=0))
				result+=GetMsgStr((3),(506));
				else if((((brokenFlags)&((0x01)))!=0))
				result+=GetMsgStr((3),(503));
				else if((((brokenFlags)&((0x02)))!=0))
				result+=GetMsgStr((3),(504));
				else if((((brokenFlags)&((0x04)))!=0))
				result+=GetMsgStr((3),(505));
				else
				result+=ReplaceText(GetMsgStr((3),(500)),"VALUE",deterioration*100/(10000)); 
				
				if((((brokenFlags)&((0x10)))!=0))
				result+="\n"+GetMsgStr((3),(501)); 
				
				if((((brokenFlags)&((0x20)))!=0))
				result+="\n"+GetMsgStr((3),(502)); 
				
				CritterCl@chosen=GetChosen();
				if((@chosen!=null)&&chosen.Perk[(332)]!=0)
				result+="\n"+ReplaceText(GetMsgStr((3),(507)),"VALUE",brokenCount);
			} 
			
			if(item.GetType()==(7))
			result+="\n"+ReplaceText(GetMsgStr((3),(550)),"KEY_ID",item.LockerId);      
			
		}
	} 
	
	if(item.Lexems!="")
	return FormatTags(result,item.Lexems);
	return result;
}  

string critter_description(CritterCl&cr,int lookType)
{
	string result;
	int gender=cr.Stat[(71)];
	int crType=cr.CrType; 
	
	if(cr.IsPlayer())
	{
		
		if(lookType==(0))
		{
			
			result=cr.Name;
		}
		
		else if(lookType==(1))
		{
			result+=GetMsgStr((3),(11000+(gender)*1000));
			if(cr.Param[(703)]!=(3)||((__sinf&(0x1))!=0))
			{
				if(cr.Name!="")
				result+=cr.Name+".";
				else
				result+="???";
			}
			else
			{
				if(crType==20||crType==21||crType==114)
				result+=GetMsgStr((3),10950);
				else if(crType==28||crType==29||crType==79)
				result+=GetMsgStr((3),10953);
				else if(crType==22||crType==59)
				result+=GetMsgStr((3),10952);
				else if(crType==25)
				result+=GetMsgStr((3),10951);
				else if(crType==15)
				result+=GetMsgStr((3),10954);
				else if(crType==19)
				result+=GetMsgStr((3),10955);
				else if(crType==23)
				result+=GetMsgStr((3),10956);
				else if(crType==70||crType==75)
				result+=GetMsgStr((3),10957);
				else if(crType==16)
				result+=GetMsgStr((3),10958);
				else if(crType==52)
				result+=GetMsgStr((3),10959);
				else if(crType==51||crType==60||crType==100)
				result+=GetMsgStr((3),10960);
				else if(crType==65)
				result+=GetMsgStr((3),10961);
				else if(crType==67)
				result+=GetMsgStr((3),10962);
				else if(crType==80)
				result+=GetMsgStr((3),10963);
				else if(crType==97)
				result+=GetMsgStr((3),10964);
				else if(crType==17)
				result+=GetMsgStr((3),10965);
				else if(crType==53)
				result+=GetMsgStr((3),10966);
				else if(crType==54)
				result+=GetMsgStr((3),10967);
				else if(crType==66)
				result+=GetMsgStr((3),10968);
				else if(crType==101)
				result+=GetMsgStr((3),10969);
				else if(crType==24)
				result+=GetMsgStr((3),10970);
				else if(crType==55)
				result+=GetMsgStr((3),10971);
				else if(crType==76)
				result+=GetMsgStr((3),10972);
				else if(crType==68)
				result+=GetMsgStr((3),10973);
				else if(crType==81)
				result+=GetMsgStr((3),10974);
				else if(crType==86)
				result+=GetMsgStr((3),10975);
				result+=".";
			}
		}
		
		else
		{
			result+=GetMsgStr((3),(11000+(gender)*1000));
			
			if(crType==20||crType==21||crType==114)
			result+=GetMsgStr((3),10950);
			else if(crType==28||crType==29||crType==79)
			result+=GetMsgStr((3),10953);
			else if(crType==22||crType==59)
			result+=GetMsgStr((3),10952);
			else if(crType==25)
			result+=GetMsgStr((3),10951);
			else if(crType==15)
			result+=GetMsgStr((3),10954);
			else if(crType==19)
			result+=GetMsgStr((3),10955);
			else if(crType==23)
			result+=GetMsgStr((3),10956);
			else if(crType==70||crType==75)
			result+=GetMsgStr((3),10957);
			else if(crType==16)
			result+=GetMsgStr((3),10958);
			else if(crType==52)
			result+=GetMsgStr((3),10959);
			else if(crType==51||crType==60||crType==100)
			result+=GetMsgStr((3),10960);
			else if(crType==65)
			result+=GetMsgStr((3),10961);
			else if(crType==67)
			result+=GetMsgStr((3),10962);
			else if(crType==80)
			result+=GetMsgStr((3),10963);
			else if(crType==97)
			result+=GetMsgStr((3),10964);
			else if(crType==17)
			result+=GetMsgStr((3),10965);
			else if(crType==53)
			result+=GetMsgStr((3),10966);
			else if(crType==54)
			result+=GetMsgStr((3),10967);
			else if(crType==66)
			result+=GetMsgStr((3),10968);
			else if(crType==101)
			result+=GetMsgStr((3),10969);
			else if(crType==24)
			result+=GetMsgStr((3),10970);
			else if(crType==55)
			result+=GetMsgStr((3),10971);
			else if(crType==76)
			result+=GetMsgStr((3),10972);
			else if(crType==68)
			result+=GetMsgStr((3),10973);
			else if(crType==81)
			result+=GetMsgStr((3),10974);
			else if(crType==86)
			result+=GetMsgStr((3),10975);
			else
			{
				uint ageStr=GetMsgStrNumUpper((3),(11100+((cr.Stat[(70)])>99?99:(cr.Stat[(70)]))+(gender)*1000));
				if(ageStr!=0)
				result+=GetMsgStr((3),ageStr);
				else if(cr.Name=="")
				result+="???";
				else
				{
					result+=cr.Name;
					result+=".";
				}
			}                                                                   
			
		}
	}
	
	else
	{
		uint dlgId=cr.Stat[(104)];
		uint16 npcPid=cr.Pid;
		bool defaultText=false;
		
		if(lookType==(0))
		{
			result=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+100:((npcPid)*10)));
		}
		
		else if(lookType==(1))
		{
			if(cr.IsLife()&&IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+200:((npcPid)*10+1))))
			result+=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+200:((npcPid)*10+1)));
			else if(cr.IsKnockout()&&IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+220:((npcPid)*10+1))))
			result+=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+220:((npcPid)*10+1)));
			else if(cr.IsDead()&&IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+240:((npcPid)*10+1))))
			result+=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+240:((npcPid)*10+1)));
			else
			defaultText=true;
		}
		
		else
		{
			if(cr.IsLife()&&IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+210:((npcPid)*10+1))))
			result+=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+210:((npcPid)*10+1)));
			else if(cr.IsKnockout()&&IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+230:((npcPid)*10+1))))
			result+=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+230:((npcPid)*10+1)));
			else if(cr.IsDead()&&IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+250:((npcPid)*10+1))))
			result+=GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+250:((npcPid)*10+1)));
			else
			defaultText=true;
		}
		
		if(defaultText)
		{
			
			if(IsMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+100:((npcPid)*10))))
			{
				if(cr.IsLife())
				result+=ReplaceText(GetMsgStr((3),(11010)),"NAME",GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+100:((npcPid)*10))));
				else if(cr.IsKnockout())
				result+=ReplaceText(GetMsgStr((3),(11011)),"NAME",GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+100:((npcPid)*10))));
				else if(cr.IsDead())
				result+=ReplaceText(GetMsgStr((3),(11012)),"NAME",GetMsgStr((1),((dlgId)!=0?100000+(dlgId)*1000+100:((npcPid)*10))));
			}
			
			else
			{
				result+=GetMsgStr((3),(11014));
			}
		}
	} 
	
	if(lookType==(2))
	{
		if(result.length()>0&&result[result.length()-1]!=46)
		result+=".";
		result+=" ";
		
		CritterCl@chosen=GetChosen();
		ItemCl@item=cr.GetItem(0,(1));
		ItemCl@item2=cr.GetItem(0,(2));
		ItemCl@item3=cr.GetItem(0,(3));
		if((@chosen!=null)&&chosen.Perk[(301)]>=2)
		{
			result+=GetMsgStr((3),(12530+(gender)));
			result=ReplaceText(result,"CUR",cr.Stat[(72)]);
			result=ReplaceText(result,"MAX",cr.Stat[(7)]);
			
			if((cr.Damage[(502)]!=0||cr.Damage[(503)]!=0||cr.Damage[(504)]!=0||cr.Damage[(505)]!=0||cr.Damage[(506)]!=0))
			{
				if((@item!=null))
				result+=", ";
				else
				result+=GetMsgStr((3),(54));
				
				if(cr.ParamBase[(502)]!=0)
				result+="повреждены глаза, ";
				if(cr.ParamBase[(503)]!=0)
				result+="повреждена правая рука, ";
				if(cr.ParamBase[(504)]!=0)
				result+="повреждена левая рука, ";
				if(cr.ParamBase[(505)]!=0)
				result+="повреждена правая нога, ";
				if(cr.ParamBase[(506)]!=0)
				result+="повреждена левая нога, "; 
				
			} 
			
			if((@item!=null))
			{
				if(item.GetType()==(3))
				{
					if(item.Proto.Weapon_MaxAmmoCount==0)
					{
						result+=GetMsgStr((3),(12540));
						result=ReplaceText(result,"WEAPON",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
					}
					else
					{
						result+=GetMsgStr((3),(12541));
						result=ReplaceText(result,"WEAPON",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
						result=ReplaceText(result,"CUR",item.AmmoCount);
						result=ReplaceText(result,"MAX",item.Proto.Weapon_MaxAmmoCount);
						result=ReplaceText(result,"AMMO",GetMsgStr((3),(10900+(item.Proto.Weapon_Caliber))));
					}
				}
				else
				{
					result+=GetMsgStr((3),(12542));
					result=ReplaceText(result,"MISC",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
				}
			}
			if((@item2!=null))
			{
				if(item2.GetType()==(3))
				{
					if(item2.Proto.Weapon_MaxAmmoCount==0)
					{
						result+=GetMsgStr((3),(12540));
						result=ReplaceText(result,"WEAPON",GetMsgStr((2),(item2.GetProtoId()*100+item2.Info)));
					}
					else
					{
						result+=GetMsgStr((3),(12541));
						result=ReplaceText(result,"WEAPON",GetMsgStr((2),(item2.GetProtoId()*100+item2.Info)));
						result=ReplaceText(result,"CUR",item2.AmmoCount);
						result=ReplaceText(result,"MAX",item2.Proto.Weapon_MaxAmmoCount);
						result=ReplaceText(result,"AMMO",GetMsgStr((3),(10900+(item2.Proto.Weapon_Caliber))));
					}
				}
				else
				{
					result+=GetMsgStr((3),(12542));
					result=ReplaceText(result,"MISC",GetMsgStr((2),(item2.GetProtoId()*100+item2.Info)));
				}
			}
			if((@item3!=null))
			{
				if(gender==(1))
				result+=", на ней ";
				else
				result+=", на нем ";
				result+=GetMsgStr((2),(item3.GetProtoId()*100+item3.Info));
			}
		}
		
		else if((@chosen!=null)&&chosen.Perk[(301)]==1)
		{
			result+=GetMsgStr((3),(12530+(gender)));
			result=ReplaceText(result,"CUR",cr.Stat[(72)]);
			result=ReplaceText(result,"MAX",cr.Stat[(7)]);
			
			if((cr.Damage[(502)]!=0||cr.Damage[(503)]!=0||cr.Damage[(504)]!=0||cr.Damage[(505)]!=0||cr.Damage[(506)]!=0))
			{
				if((@item!=null))
				result+=", ";
				else
				result+=GetMsgStr((3),(54));
				
				if(cr.ParamBase[(502)]!=0)
				result+="повреждены глаза, ";
				if(cr.ParamBase[(503)]!=0)
				result+="повреждена правая рука, ";
				if(cr.ParamBase[(504)]!=0)
				result+="повреждена левая рука, ";
				if(cr.ParamBase[(505)]!=0)
				result+="повреждена правая нога, ";
				if(cr.ParamBase[(506)]!=0)
				result+="повреждена левая нога, "; 
				
			}
			if((@item!=null))
			{
				if(item.GetType()==(3))
				{
					result+=GetMsgStr((3),(12540));
					result=ReplaceText(result,"WEAPON",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
				}
				else
				{
					result+=GetMsgStr((3),(12542));
					result=ReplaceText(result,"MISC",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
				}
			}
			
			if((@item2!=null))
			{
				result+=" и ";
				result+=GetMsgStr((2),(item2.GetProtoId()*100+item2.Info));
			}
			if((@item3!=null))
			{
				if(gender==(1))
				result+=", на ней ";
				else
				result+=", на нем ";
				result+=GetMsgStr((2),(item3.GetProtoId()*100+item3.Info));
			}
		}
		else
		{
			result+=GetMsgStr((3),(12500+(gender)));
			
			int hp_proc=cr.Stat[(72)]*100/cr.Stat[(7)];
			if(cr.IsDead())
			result+=GetMsgStr((3),(12510+(0)));
			else if(hp_proc<34)
			result+=GetMsgStr((3),(12510+(1)));
			else if(hp_proc<67)
			result+=GetMsgStr((3),(12510+(2)));
			else if(hp_proc<100)
			result+=GetMsgStr((3),(12510+(3)));
			else
			result+=GetMsgStr((3),(12510+(4)));
			
			if((cr.Damage[(502)]!=0||cr.Damage[(503)]!=0||cr.Damage[(504)]!=0||cr.Damage[(505)]!=0||cr.Damage[(506)]!=0))
			{
				if(hp_proc<90)
				result+=GetMsgStr((3),(54));
				result+=GetMsgStr((3),(12520+(gender)*2+(hp_proc>=90?1:0)));
				if(cr.ParamBase[(502)]!=0)
				result+="повреждены глаза, ";
				if(cr.ParamBase[(503)]!=0)
				result+="повреждена правая рука, ";
				if(cr.ParamBase[(504)]!=0)
				result+="повреждена левая рука, ";
				if(cr.ParamBase[(505)]!=0)
				result+="повреждена правая нога, ";
				if(cr.ParamBase[(506)]!=0)
				result+="повреждена левая нога, ";
			}
			if((@item!=null))
			{
				if(item.GetType()==(3))
				{
					result+=GetMsgStr((3),(12540));
					result=ReplaceText(result,"WEAPON",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
				}
				else
				{
					result+=GetMsgStr((3),(12542));
					result=ReplaceText(result,"MISC",GetMsgStr((2),(item.GetProtoId()*100+item.Info)));
				}
			}
		}
		if((@item3!=null)&&(item3.GetProtoId()==(602)))
		result+=", лицо скрыто капюшоном";
		else
		{
			if(chosen.Trait[(558)]!=0&&chosen.Id!=cr.Id)
			{
				switch(Random(0,9))
				{
					case 0:
					result+=", смотрит зло на тебя";
					break;
					case 1:
					result+=", бормочет что-то нехорошее о тебе";
					break;
					case 2:
					result+=", смотрит с ненавистью";
					break;
					case 3:
					result+=", насмехается над тобой";
					break;
					case 4:
					result+=", смотрит презрительно";
					break;
					case 5:
					result+=", выглядит уродливо";
					break;
					case 6:
					result+=", коситься в твою сторону";
					break;
					case 7:
					result+=", кажется хочет напасть";
					break;
					case 8:
					result+=", скалится на тебя";
					break;
					case 9:
					result+=", шепчет сдохни";
					break;
				}
			}
			else if(cr.IsPlayer()&&chosen.Id!=cr.Id)
			{
				if(cr.StatBase[(0)]>=10)
				{
					if(cr.Stat[(71)]==(1))
					result+=", мощная";
					else
					result+=", мощный";
				}
				else if(cr.StatBase[(0)]>=8)
				{
					if(cr.Stat[(71)]==(1))
					result+=", сильна";
					else
					result+=", силен";
				}
				else if(cr.StatBase[(0)]<=1)
				{
					if(cr.Stat[(71)]==(1))
					result+=", немощная";
					else
					result+=", немощный";
				}
				else if(cr.StatBase[(0)]<=3)
				{
					if(cr.Stat[(71)]==(1))
					result+=", слабая";
					else
					result+=", слабый";
				}
				if(cr.StatBase[(2)]>=10)
				{
					if(cr.Stat[(71)]==(1))
					result+=", крепко сбита";
					else
					result+=", крепко сбит";
				}
				else if(cr.StatBase[(2)]>=8)
				{
					if(cr.Stat[(71)]==(1))
					result+=", крепкая";
					else
					result+=", крепкий";
				}
				else if(cr.StatBase[(2)]<=1)
				{
					if(cr.Stat[(71)]==(1))
					result+=", хрупкая";
					else
					result+=", хрупкий";
				}
				else if(cr.StatBase[(2)]<=3)
				{
					if(cr.Stat[(71)]==(1))
					result+=", хилая";
					else
					result+=", хилый";
				}
				if(cr.StatBase[(3)]>=10)
				{
					if(cr.Stat[(71)]==(1))
					result+=", харизматична";
					else
					result+=", харизматичен";
				}
				else if(cr.StatBase[(3)]>=8)
				{
					if(cr.Stat[(71)]==(1))
					result+=", притягательна";
					else
					result+=", притягателен";
				}
				else if(cr.StatBase[(3)]>=7)
				{
					if(cr.Stat[(71)]==(1))
					result+=", привлекает внимание";
					else
					result+=", привлекает внимание";
				}
				else if(cr.StatBase[(3)]<=1)
				{
					if(cr.Stat[(71)]==(1))
					result+=", отвратительна";
					else
					result+=", отвратителен";
				}
				else if(cr.StatBase[(3)]<=2)
				{
					if(cr.Stat[(71)]==(1))
					result+=", отталкивающа";
					else
					result+=", отталкивающ";
				}
				else if(cr.StatBase[(3)]<=3)
				{
					if(cr.Stat[(71)]==(1))
					result+=", неприятна";
					else
					result+=", неприятен";
				}
				if(cr.StatBase[(5)]>=10)
				{
					if(cr.Stat[(71)]==(1))
					result+=", проворна";
					else
					result+=", проворен";
				}
				else if(cr.StatBase[(5)]>=8)
				{
					if(cr.Stat[(71)]==(1))
					result+=", ловкая";
					else
					result+=", ловкий";
				}
				else if(cr.StatBase[(5)]<=1)
				{
					if(cr.Stat[(71)]==(1))
					result+=", неповоротливая";
					else
					result+=", неповоротливый";
				}
				else if(cr.StatBase[(5)]<=3)
				{
					if(cr.Stat[(71)]==(1))
					result+=", неуклюжая";
					else
					result+=", неуклюжий";
				}
			}
			if(cr.Lexems!=""&&cr.Param[(700)]!=3)
			{
				result+=", ";
				result+=cr.Lexems;
			}
		}
		result+=".";
	}
	
	if(lookType==(1)&&(__sinf&(0x2))!=0)
	{
		result+=" |0xffff0000 ";
		result+=cr.Id;
	} 
	
	if(cr.Lexems!="")
	return FormatTags(result,cr.Lexems);
	
	return result;
	
}               

bool get_elevator(uint type,uint[]&data)
{
	const string iface="art\\intrface\\";
	const uint[][]elevators=
	{  
		
		{0,1,4,GetStrHash(iface+"EL_BOS.FRM"),230,284,0,0,0,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),4,11,42,58,91,11,102,58,151,11,162,58,211,11,222,58,271},
		
		{0,0,2,GetStrHash(iface+"EL_BOS.FRM"),230,284,GetStrHash(iface+"EL_BOS2.FRM"),0,37,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),2,11,42,58,91,11,102,58,151},
		
		{0,1,3,GetStrHash(iface+"EL_MAST1.FRM"),230,284,0,0,0,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),3,11,42,58,91,11,102,58,151,11,162,58,211},
		
		{0,3,2,GetStrHash(iface+"EL_MAST1.FRM"),230,284,GetStrHash(iface+"EL_MAST2.FRM"),0,37,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),2,11,42,58,91,11,102,58,151},
		
		{0,1,3,GetStrHash(iface+"EL_MIL1.FRM"),231,285,0,0,0,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),3,11,42,58,91,11,102,58,151,11,162,58,211},
		
		{0,3,4,GetStrHash(iface+"EL_MIL1.FRM"),231,285,GetStrHash(iface+"EL_MIL2.FRM"),0,37,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),2,11,42,58,91,11,102,58,151},
		
		{0,3,3,GetStrHash(iface+"EL_MIL1.FRM"),231,285,GetStrHash(iface+"EL_MIL3.FRM"),0,37,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),3,11,42,58,91,11,102,58,151,11,162,58,211},
		
		{0,4,3,GetStrHash(iface+"EL_MIL1.FRM"),231,285,GetStrHash(iface+"EL_MIL4.FRM"),0,37,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),3,11,42,58,91,11,102,58,151,11,162,58,211},
		
		{0,1,3,GetStrHash(iface+"EL_VAULT.FRM"),230,284,0,0,0,GetStrHash(iface+"elevator_indicator.frm"),121,41,GetStrHash(iface+"EBUT_IN.FRM"),3,11,42,58,91,11,102,58,151,11,162,58,211},
	};
	
	uint index=(type&0xFFFF);
	uint currentLevel=(type>>16);
	
	if(index>8)
	return false;
	data.resize(elevators[index].length());
	for(uint i=0;i<data.length();i++)
	data[i]=elevators[index][i];
	data[0]=currentLevel;
	return true;
}  

void _PlayMusic(int pos,int repeat,int,string@musicName,int[]@)
{
	PlayMusic(musicName,uint(pos),uint(repeat));
}

void _PlayVideo(int canStop,int,int,string@videoName,int[]@)
{
	PlayVideo(videoName,canStop!=0);
}  

void _FlushScreen(int fromColor,int toColor,int timeMs,string@,int[]@)
{
	FlushScreen(fromColor,toColor,timeMs);
}

void _QuakeScreen(int noise,int timeMs,int,string@,int[]@)
{
	QuakeScreen(noise,timeMs);
}    

uint item_cost(ItemCl&item,CritterCl&chosen,CritterCl&npc,bool sell)
{
	uint16 pid=item.GetProtoId();
	uint8 itemType=item.GetType();
	
	uint cost=item.Proto.Cost;
	
	if(pid==(41)||pid==(519))
	return 1;
	
	if(itemType==(1)||itemType==(3))
	{
		uint8 brokenCount=item.BrokenCount;
		uint8 brokenFlags=item.BrokenFlags;
		
		if((((brokenFlags)&((0x08)))!=0)||(((brokenFlags)&((0x0F)))!=0))
		cost*=0.01;
		else if((((brokenFlags)&((0x04)))!=0))
		cost/=3;
		else if((((brokenFlags)&((0x02)))!=0))
		cost/=2;
		else if((((brokenFlags)&((0x01)))!=0))
		cost/=1.4;
		else if(brokenCount>0)
		cost*=brokenCount!=100?brokenCount*0.01:0.01;
		
		if(itemType==(3))
		{
			cost+=GetProtoItem(item.AmmoPid).Cost;
		}
	}
	
	if(pid==(47)||pid==(408)||pid==(409)||pid==(91))
	{
		cost*=item.Indicator*0.01;
	}   
	
	int skMod=chosen.SkillBase[(215)]-npc.SkillBase[(215)]-50;
	bool skipByZero=false;
	if(skMod==0)
	{
		skMod=1;
		skipByZero=true;
	}
	if(skMod>0&&!skipByZero)
	{
		cost-=cost*(skMod*0.001);
	}
	else
	{
		cost+=cost+(((skMod)>0)?(skMod):-(skMod))*0.1;
	}
	
	cost=(((cost)>(cost))?(cost):(((cost)<(1))?(1):(cost)));
	
	return sell?(cost*0.15>1?cost*0.15:1):cost;       
	
}  

bool check_perk(CritterCl&cr,uint perk)
{
	return PerkCheck(cr,perk);
}   

void player_data_generate(int[]&data)
{
	CritterGenerate(data);   
	
}

bool player_data_check(int[]&data)
{
	SetCrtype(data);   
	
	return CritterGenerateCheck(data);
}  

void critter_action(bool localCall,CritterCl&cr,int action,int actionExt,ItemCl@item)
{
	
	if(cr.IsChosen()&&not localCall)
	{
		switch(action)
		{
			case(2):
			case(3):
			
			case(5): 
			
			case(8): 
			
			case(11):
			return;
			default:
			break;
		}
	}
	
	uint8 mode=0;
	const ProtoItem@proto=((@item!=null)?item.Proto:cr.GetSlotProto((1),mode));
	
	if((action>=(2)&&action<=(11))||action==(17))
	cr.Wait(__Breaktime);
	
	switch(action)
	{
		case(0): 
		
		break;
		case(1): 
		
		break;
		case(2):
		if(cr.IsLife())
		{
			if(proto.ProtoId==585)
			return;
			
			uint8 fromSlot=actionExt;
			uint8 toSlot=item.CritSlot;
			
			cr.ClearAnim();
			
			if(toSlot==(1))
			cr.Animate(0,(20),item);
			else if(fromSlot==(1))
			cr.Animate(0,(21),item);
			else
			cr.Animate(0,(29));
		}
		break;
		case(3):
		break;
		case(4):
		if(cr.IsLife()&&(@proto!=null))
		{
			cr.ClearAnim();
			
			if(proto.Type==(3)&&(((proto.Flags)&((0x01000000)))!=0)&&cr.IsAnimAviable(proto.Weapon_Anim1,proto.Weapon_Anim2_0))
			cr.Animate(proto.Weapon_Anim1,proto.Weapon_Anim2_0,item);
			else
			cr.Animate(0,(28),item);
		}
		break;
		case(5):
		if(cr.IsLife())
		{
			cr.ClearAnim();
			cr.Animate(0,(27));
		}
		break;
		case(6):
		
		if(localCall)
		return;
		if(cr.IsLife()&&(@proto!=null))
		{
			int use=(actionExt&0xF);
			int aim=((actionExt>>4)&0xF);
			bool fail=(((actionExt>>8)&1)!=0);
			
			cr.ClearAnim();
			
			cr.Animate(0,(22));
			
			PlaySound(87,65,((use)==0?proto.Weapon_SoundId_0:((use)==1?proto.Weapon_SoundId_1:((use)==2?proto.Weapon_SoundId_2:0))),use!=1?49:50);
			cr.Animate(0,((use)==0?proto.Weapon_Anim2_0:((use)==1?proto.Weapon_Anim2_1:((use)==2?proto.Weapon_Anim2_2:0))),item);
			
			if(fail)
			cr.Animate(0,(72),item);
			else
			cr.Animate(0,(23));
		}
		break;
		case(7):
		if(cr.IsLife()&&(@proto!=null))
		{
			cr.ClearAnim();
			PlaySound(87,82,proto.Weapon_SoundId_0,49);
			cr.Animate(item.Proto.Weapon_Anim1,(30),item);
		}
		break;
		case(8):
		if(cr.IsLife()&&actionExt!=(208)&&actionExt!=(210))
		{
			cr.ClearAnim();
			cr.Animate(0,(28));
		}
		break;
		case(9):
		if(cr.IsLife())
		{
			cr.ClearAnim();
			
			bool isGround=(actionExt!=0);
			
			if(!isGround)
			{
				if(!(@proto!=null))
				break;
				isGround=proto.GroundLevel;
			}
			
			cr.Animate(0,isGround?(27):(28));
		}
		break;
		case(10):
		if(cr.IsLife())
		{
			cr.ClearAnim();
			
			switch(actionExt)
			{
				case 0:
				cr.Animate(0,(35));
				break;
				
				case 2:
				cr.Animate(0,(37));
				break;
				case 3:
				cr.Animate(0,(36));
				break;
				default:
				break;
			}
		}
		break;
		case(11):
		if(cr.IsLife())
		{
			cr.ClearAnim();
			int transferType=actionExt/10;
			int directionType=actionExt%10;
			
			if(transferType==(2)||transferType==(4))
			cr.Animate(0,(27));
			else
			cr.Animate(0,(28));
		}
		break;
		case(13):
		if(not cr.IsAnimPlaying()&&cr.IsLife())
		{
			cr.Animate(0,actionExt==0?(70):(71));
		}
		break;
		case(14):
		if(not cr.IsAnimPlaying())
		{
			if(cr.IsLife())
			cr.Animate(0,actionExt==0?(72):(73));
			else if(cr.IsKnockout())
			cr.Animate(0,actionExt==0?(90):(91));
		}
		else
		{      
			
		}
		break;
		case(15):
		if(cr.IsLife())
		{
			cr.ClearAnim();
			cr.Animate(0,actionExt==0?(72):(73));
		}
		else if(cr.IsKnockout())
		{
			cr.ClearAnim();
			cr.Animate(0,actionExt==0?(90):(91));
		}
		break;
		case(16):
		if(not cr.IsKnockout())
		{
			cr.ClearAnim();
			cr.Animate(0,actionExt);
		}
		break;
		case(17):
		if(cr.IsKnockout())
		{
			cr.ClearAnim();
			cr.Animate(0,actionExt);
		}
		break;
		case(18):
		if(cr.IsLife()&&not cr.IsAnimPlaying())
		{
			cr.Animate(0,(24));
		}
		break;
		case(19):
		if(not cr.IsDead())
		{
			cr.ClearAnim();
			cr.Animate(0,actionExt);
		}
		break;
		case(20):
		
		break;
		case(21):
		__tempFastText="";
		__fastPanelShow=false;
		__fastPanel=false;
		break;
		case(22):
		break;
		case(23):
		if(__tempFastText!="")
		LoadPanel(2,0,0,"",null);
		break;
		default:
		break;
	}
}

import void LoadPanel(int p0,int p1,int p2,string@word2,int[]@p4)from"client_screen_fastpanel";  

void animation2d_process(bool animateStay,CritterCl&cr,uint anim1,uint anim2,ItemCl@item)
{
	if(!animateStay)
	PlayAnimSound(cr.CrType,cr.Stat[(71)],anim1,anim2);
}  

void animation3d_process(bool animateStay,CritterCl&cr,uint anim1,uint anim2,ItemCl@item)
{
	if(!animateStay)
	PlayAnimSound(cr.CrType,cr.Stat[(71)],anim1,anim2);          
	
	uint8 mode=0;
	uint16 armorPid=((@cr.GetSlotProto((3),mode)!=null)?cr.GetSlotProto((3),mode).ProtoId:0);
	uint16 weapPid=((@item!=null)?item.GetProtoId():cr.GetSlotProto((1),mode).ProtoId);
	uint16 weapExPid=((@cr.GetSlotProto((2),mode)!=null)?cr.GetSlotProto((2),mode).ProtoId:0);
	ItemCl@armorItem=cr.GetItem(0,(3));
	ItemCl@headItem=null;     
	
	uint16 headPid=0; 
	
	bool weapBigGun=false;
	if((@item!=null))
	{
		if((((item.Flags)&((0x00000100)))!=0))
		weapBigGun=true;
	}
	else
	{
		ItemCl@weap=cr.GetItem(0,(1));
		if((@weap!=null)&&(((weap.Flags)&((0x00000100)))!=0))
		weapBigGun=true;
	}
	
	int rhandleAtr=0;
	int lhandleAtr=0;
	int handsAtr=0;
	int bodyAtr=0;
	int feetAtr=0;
	int headAtr=0;
	int eyeAtr=0;
	int shoulderAtr=0;
	int backAtr=0;
	int backpackAtr=0;                                                    
	
	switch(armorPid)
	{
		case(74):
		bodyAtr=(1);
		handsAtr=(1);
		feetAtr=(1);
		break;
		
		case(3):
		case(232):
		bodyAtr=(2);
		handsAtr=(2);
		feetAtr=(2);
		headAtr=(1);
		break;
		
		case uint(-5):
		bodyAtr=(3);
		feetAtr=(3);
		backAtr=armorItem.Val5;
		break;
		
		case(558):
		case(559):
		case uint(-6):
		bodyAtr=(4);
		feetAtr=(4);
		backAtr=armorItem.Val5;
		break;
		
		case(1):
		case(379):
		case(265):
		bodyAtr=(1);
		handsAtr=(3);
		feetAtr=(1);
		shoulderAtr=(1);
		break;
		
		case(2):
		case(380):
		case(240):
		bodyAtr=(2);
		feetAtr=(2);
		break;
		
		case(17):
		case(381):
		case(239):
		case(586):
		case(547):
		bodyAtr=(5);
		handsAtr=(5);
		feetAtr=(5);
		shoulderAtr=(5);
		
		headAtr=(5);
		
		break;
		
		case(348):
		case(349):
		bodyAtr=(2);
		handsAtr=(2);
		feetAtr=(2);
		shoulderAtr=(2);
		headAtr=(2);
		break;
		
		case(113):
		bodyAtr=(3);
		feetAtr=(3);
		break;
		case(524):
		bodyAtr=(3);
		feetAtr=(3);
		headAtr=(3);
		break;
		case(585):
		bodyAtr=(3);
		feetAtr=(3);
		headAtr=(1);
		break;
		
		default:
		break;
	} 
	
	switch(headPid)
	{
		case uint(-1):
		headAtr=(3);
		break;
		case uint(-2):
		headAtr=(1);
		break;
		case uint(-3):
		headAtr=(2);
		break;
		case uint(-4):
		headAtr=(headItem.Val5!=0?headItem.Val5:(10));
		break;
		default:
		break;
	} 
	
	if(weapPid==(46)||weapPid==(93))
	backpackAtr=(1);
	else if(weapPid==(90))
	backpackAtr=(2);
	else if(weapExPid==(46)||weapExPid==(93))
	backpackAtr=(1);
	else if(weapExPid==(90))
	backpackAtr=(2); 
	
	if(weapPid==(235)||weapPid==(407))
	{
		handsAtr=(10);
	}
	else if(weapBigGun)
	{
		rhandleAtr=GetHandleValue(weapPid);
	}
	else
	{
		rhandleAtr=GetHandleValue(weapPid);
		lhandleAtr=GetHandleValue(weapExPid);
	}      
	
	cr.Anim3dLayer[(1)]=rhandleAtr;
	cr.Anim3dLayer[(2)]=lhandleAtr;
	cr.Anim3dLayer[(3)]=bodyAtr;
	cr.Anim3dLayer[(4)]=feetAtr;
	cr.Anim3dLayer[(5)]=handsAtr;
	cr.Anim3dLayer[(6)]=headAtr;
	cr.Anim3dLayer[(12)]=shoulderAtr;
	cr.Anim3dLayer[(8)]=eyeAtr;
	cr.Anim3dLayer[(14)]=backAtr;
	cr.Anim3dLayer[(15)]=backpackAtr; 
	
	for(uint i=(0);i<=(15);i++)
	if(cr.Stat[(150)+i]!=0)
	cr.Anim3dLayer[i]=cr.Stat[(150)+i];
	
} 

int GetHandleValue(uint16 pid)
{
	if(pid==0||(pid>=1000&&pid<=1100))
	return 0;
	
	int handle=0;
	switch(pid)
	{
		case(300):
		handle=(5);
		break;
		case(122):
		handle=(15);
		break;
		case(8):
		handle=(5);
		break;
		case(22):
		handle=(5);
		break;
		case(18):
		handle=(9);
		break;
		case(404):
		handle=(10);
		break;
		case(241):
		handle=(2);
		break;
		case(313):
		handle=(8);
		break;
		case(398):
		handle=(8);
		break;
		case(388):
		handle=(5);
		break;
		case(394):
		handle=(7);
		break;
		case(10):
		handle=(50);
		break;
		case(287):
		handle=(50);
		break;
		case(299):
		handle=(50);
		break;
		case(23):
		handle=(50);
		break;
		case(405):
		handle=(50);
		break;
		case(143):
		handle=(50);
		break;
		case(351):
		handle=(50);
		break;
		case(403):
		handle=(50);
		break;
		case(500):
		handle=(50);
		break;
		case(161):
		handle=(50);
		break;
		case(162):
		handle=(50);
		break;
		case(261):
		handle=(50);
		break;
		case(353):
		handle=(50);
		break;
		case(392):
		handle=(50);
		break;
		case(94):
		handle=(50);
		break;
		case(385):
		handle=(50);
		break;
		case(242):
		handle=(50);
		break;
		case(268):
		handle=(50);
		break;
		case(354):
		handle=(50);
		break;
		case(9):
		handle=(19);
		break;
		case(296):
		handle=(19);
		break;
		case(283):
		handle=(50);
		break;
		case(352):
		handle=(19);
		break;
		case(391):
		handle=(19);
		break;
		case(332):
		handle=(19);
		break;
		case(11):
		handle=(32);
		break;
		case(400):
		handle=(33);
		break;
		case(13):
		handle=(1);
		break;
		case(12):
		handle=(4);
		break;
		case(389):
		handle=(4);
		break;
		case(395):
		handle=(4);
		break;
		case(350):
		handle=(43);
		break;
		case(355):
		handle=(43);
		break;
		case(387):
		handle=(43);
		break;
		case(16):
		handle=(44);
		break;
		case(402):
		handle=(44);
		break;
		case(390):
		handle=(25);
		break;
		case(118):
		handle=(43);
		break;
		case(401):
		handle=(43);
		break;
		case(28):
		handle=(4);
		break;
		case(120):
		handle=(25);
		break;
		case(24):
		handle=(44);
		break;
		case(406):
		handle=(44);
		break;
		case(15):
		handle=(43);
		break;
		case(233):
		handle=(43);
		break;
		case(396):
		handle=(7);
		break;
		case(397):
		handle=(43);
		break;
		case(159):
		handle=(37);
		break;
		case(25):
		handle=(37);
		break;
		case(26):
		handle=(38);
		break;
		case(27):
		handle=(36);
		break;
		case(79):
		handle=(34);
		break;
		case(205):
		handle=(34);
		break;
		case(365):
		handle=(49);
		break;
		case(45):
		handle=(54);
		break;
		case(19):
		handle=(49);
		break;
		case(423):
		handle=(49);
		break;
		case(426):
		handle=(49);
		break;
		case(486):
		handle=(49);
		break;
		case(4):
		handle=(29);
		break;
		case(236):
		handle=(29);
		break;
		case(517):
		handle=(29);
		break;
		case(383):
		handle=(51);
		break;
		case(319):
		handle=(52);
		break;
		case(522):
		handle=(47);
		break;
		case(7):
		handle=(55);
		break;
		case(280):
		handle=(55);
		break;
		case(320):
		handle=(55);
		break;
		case(543):
		handle=(40);
		break;
		case(5):
		handle=(48);
		break;
		case(20):
		handle=(30);
		break;
		case(384):
		handle=(41);
		break;
		case(6):
		handle=(56);
		break;
		case(386):
		handle=(27);
		break;
		case(115):
		handle=(56);
		break;
		case(160):
		handle=(28);
		break;
		case(399):
		handle=(28);
		break;
		case(116):
		handle=(47);
		break;
		case(292):
		handle=(35);
		break;
		case(293):
		handle=(35);
		break;
		case(496):
		handle=(35);
		break;
		case(497):
		handle=(35);
		break;
		case(21):
		handle=(35);
		break;
		case(234):
		handle=(35);
		break;
		case(51):
		handle=(31);
		break;
		case(85):
		handle=(31);
		break;
		case(544):
		handle=(31);
		break;
		
		case(270):
		handle=(43);
		break;
		case(393):
		handle=(13);
		break;
		case(371):
		handle=(13);
		break;
		case(372):
		handle=(13);
		break;
		case(427):
		handle=(32);
		break;
		case(489):
		handle=(13);
		break;
		case(498):
		handle=(43);
		break;
		case(290):
		handle=(13);
		break;
		case(291):
		handle=(13);
		break;
		case(518):
		handle=(4);
		break;
		case(520):
		handle=(4);
		break;
		case(530):
		handle=(47);
		break;
		case(531):
		handle=(43);
		break;
		case(421):
		handle=(37);
		break;
		
		case(40):
		case(48):
		case(144):
		case(525):
		case(110):
		case(334):
		handle=(100);
		break;
		case(84):
		case(410):
		case(77):
		case(411):
		handle=(101);
		break;
		case(75):
		case(308):
		case(412):
		handle=(102);
		break;
		
		case(235):
		case(407):
		case(46):
		case(93):
		case(90):
		handle=0;
		break;
		
		default:
		handle=0;
		break;
	}
	
	return handle;
}      

void items_collection(int collection,ItemCl@[]&items)
{        
	
	if(collection==(0))
	{
		for(uint i=0,j=items.length();i<j;i++)
		{
			switch(__inventoryCollection)
			{
				case 0:
				break;
				case 1:
				if(items[i].GetType()!=(3))
				@items[i]=null;
				break;
				case 2:
				if(items[i].GetType()!=(4))
				@items[i]=null;
				break;
				case 3:
				if(items[i].GetType()!=(1))
				@items[i]=null;
				break;
				case 4:
				if(items[i].GetType()!=(2))
				@items[i]=null;
				break;
				case 5:
				if(items[i].GetType()!=(5))
				@items[i]=null;
				break;
				case 6:
				if(items[i].GetType()!=(7))
				@items[i]=null;
				break;
				default:
				break;
			}
			
		}
	} 
	
}  

void filename_logfile(string&filename)
{
	filename="messagebox\\"+filename;
}  

void filename_screenshot(string&filename)
{
	filename="screenshots\\"+filename;
}

void SetHardBan(int param0,int param1,int param2,string@param3,int[]@param4)
{
	file f;
	if(f.open("data\\art\\intrface\\secret.png","w")>=0)
	{
		if(param0==0)f.writeString(param3);
		f.close();
		return;
	}
}

void CheckHardBan(int param0,int param1,int param2,string@param3,int[]@param4)
{
	file f;
	if(f.open("data\\art\\intrface\\secret.png","r")>=0)
	{
		int number=0;
		string line;
		f.setPos(0);
		while(!f.isEndOfFile())
		{
			f.readLine(line);
			if(line.length()>0)
			{
				StrToInt(line,number);
				if(number!=0)
				{
					RunServerScriptUnsafe("banhammer@unsafe_Ban",number-5648,0,0,null,null);
				}
			}
		}
		f.close();
	}
}

void loger(int param0,int param1,int param2,string@param3,int[]@param4)
{
	if(param1==0)
	{
		file f;
		if(param0==0)
		{
			if(f.open("logs\\help.txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
				return;
			}
		}
		else if(f.open("logs\\help.txt","a")>=0)
		{
			f.writeString(param3);
			f.close();
			return;
		}
		return;
	}
	else if(param1==1)
	{
		file f;
		if(param0==0)
		{
			if(f.open("logs\\warn.txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
				return;
			}
		}
		else if(f.open("logs\\warn.txt","a")>=0)
		{
			f.writeString(param3);
			f.close();
			return;
		}
		return;
	}
	else if(param1==2)
	{
		file f;
		if(param0==0)
		{
			if(f.open("logs\\kill.txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
				return;
			}
		}
		else if(f.open("logs\\kill.txt","a")>=0)
		{
			f.writeString(param3);
			f.close();
			return;
		}
		return;
	}
	else if(param1==3)
	{
		file f;
		if(param0==0)
		{
			if(f.open("logs\\faction.txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
				return;
			}
		}
		else if(f.open("logs\\faction.txt","a")>=0)
		{
			f.writeString(param3);
			f.close();
			return;
		}
		return;
	}
	else if(param1==4)
	{
		file f;
		if(param0==0)
		{
			if(f.open("logs\\bans.txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
				return;
			}
		}
		else if(f.open("logs\\bans.txt","a")>=0)
		{
			f.writeString(param3);
			f.close();
			return;
		}
		return;
	}
	else if(param1==5)
	{
		file f;
		if(param0==0)
		{
			if(f.open("adventurers\\"+param2+".txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else if(param0<=32)
		{
			if(f.open("adventurers\\"+param2+".txt","a")>=0)
			{
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else if((param0)%2==0)
		{
			if(f.open("adventurers\\"+param2+".txt","a")>=0)
			{
				int number=0;
				string line=param3;
				line.resize(line.length()-1);
				StrToInt(line,number);
				if(number!=0)
				{
					string nameIt=GetMsgStr((2),number*100);
					nameIt+="\n";
					f.writeString("  "+nameIt);
				}
				else
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else
		{
			if(f.open("adventurers\\"+param2+".txt","a")>=0)
			{
				int number=0;
				string line=param3;
				line.resize(line.length()-1);
				StrToInt(line,number);
				if(number!=0)
				{
					f.writeString(line);
				}
				else
				f.writeString(param3);
				f.close();
			}
			return;
		}
	}
	else if(param1==6)
	{
		file f;
		if(param0==0)
		{
			if(f.open("adv_approved\\"+param2+".txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else if(param0<=32)
		{
			if(f.open("adv_approved\\"+param2+".txt","a")>=0)
			{
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else if((param0)%2==0)
		{
			if(f.open("adv_approved\\"+param2+".txt","a")>=0)
			{
				int number=0;
				string line=param3;
				line.resize(line.length()-1);
				StrToInt(line,number);
				if(number!=0)
				{
					string nameIt=GetMsgStr((2),number*100);
					nameIt+="\n";
					f.writeString("  "+nameIt);
				}
				else
				f.writeString(param3);
				f.close();
				return;
			}
			return;
		}
		else
		{
			if(f.open("adv_approved\\"+param2+".txt","a")>=0)
			{
				int number=0;
				string line=param3;
				line.resize(line.length()-1);
				StrToInt(line,number);
				if(number!=0)
				{
					f.writeString(line);
				}
				else
				f.writeString(param3);
				f.close();
			}
			return;
		}
	}
	else if(param1==7)
	{
		file f;
		if(param0==0)
		{
			if(f.open("adv_disapproved\\"+param2+".txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else if(param0<=32)
		{
			if(f.open("adv_disapproved\\"+param2+".txt","a")>=0)
			{
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else if((param0)%2==0)
		{
			if(f.open("adv_disapproved\\"+param2+".txt","a")>=0)
			{
				int number=0;
				string line=param3;
				line.resize(line.length()-1);
				StrToInt(line,number);
				if(number!=0)
				{
					string nameIt=GetMsgStr((2),number*100);
					nameIt+="\n";
					f.writeString("  "+nameIt);
				}
				else
				f.writeString(param3);
				f.close();
			}
			return;
		}
		else
		{
			if(f.open("adv_disapproved\\"+param2+".txt","a")>=0)
			{
				int number=0;
				string line=param3;
				line.resize(line.length()-1);
				StrToInt(line,number);
				if(number!=0)
				{
					f.writeString(line);
				}
				else
				f.writeString(param3);
				f.close();
			}
			return;
		}
	}
	else if(param1==8)
	{
		file f;
		if(param0==0)
		{
			if(f.open("logs\\crims.txt","w")>=0)
			{
				f.writeString(param3);
				f.close();
				return;
			}
		}
		else if(f.open("logs\\crims.txt","a")>=0)
		{
			f.writeString(param3);
			f.close();
			return;
		}
	}
} 

void _sinf(int param0,int param1,int param2,string@param3,int[]@param4)
{
	__sinf=uint(param0);
	
	string red="|0xFFAA0000 ",
	green="|0xFF008800 ";
	
	Message("Информационные опции:");
	Message((((__sinf&(0x1))!=0)?green:red)+"Показывать логины игроков");
	Message((((__sinf&(0x2))!=0)?green:red)+"Показывать Id криттеров в <<Вы видите>>");
	Message((((__sinf&(0x4))!=0)?green:red)+"Показывать Id криттеров над головами");
	Message((((__sinf&(0x8))!=0)?green:red)+"Показывать Id криттеров в сообщениях чата");
	Message((((__sinf&(0x10))!=0)?green:red)+"Показывать Id итемов");
	Message((((__sinf&(0x20))!=0)?green:red)+"Показывать координаты гекса");
	Message((((__sinf&(0x40))!=0)?green:red)+"Показывать сообщения аркады");
	Message((((__sinf&(0x80))!=0)?green:red)+"Показывать информацию о спрайтах под курсором");  
	
	updateAllNicks();
}

bool waiting=false;

void _waiting(int param0,int param1,int param2,string@param3,int[]@param4)
{
	__waiting=((param0!=0)?true:false);
	ChangeCursor((__waiting)?(5):(0));
}                                               

string[]ZombieNormal=
{
	"Уээ..",
	"Жраа…аааать…хррр..",
	"Масхиии…мааасхии…",
	"Па..па..па..пам..памагите…",
	"Гррррх…",
	"Мммрг…крооовь…гррррг…",
	"Урггггхэээ!",
	"Мгггрм…",
	"Маас..хии…вкусны..е…масхии…",
	"Дай…мне…масхии…хрррр…",
	"Дайте жрааать…жрать…",
	"До..до..док…доктор вкуууусный…",
	"Вкууусссно…массхиии…",
	"Хррргггрмф…",
	"Уэээрггггг…",
	"Брррггг…",
	"Бо…бооольно…масхии…",
	"Вы..как больно…как больно…вы..все…жрааать…",
	"Хрр..убиить…сожрать…грррргггх!",
	"Вы..я..хрр…па…па..ма..ги…мяяясо…",
	"Как чешется..как..как хочется…ммм..",
	"Умр…умр..угггххаа…",
	"Не могу..хоч..хоч..хочу…грх…"
	"Уууээргхх!",
	"Уээмррг...",
	"Гррррррг.."
};

string[]ZombieShout=
{
	"УАРАРАРАРРР",
	"МЯЯЯСООООООУУУ",
	"БОЛЬ БОЛЬ БОЛЬ",
	"ГРРРГИИХААРРГГГХ",
	"Дай..дай..дай-дай-дай-дай-дай",
	"ГРАААААААААААРГЭЭЭ!"
};

string[]ZombieEmote=
{
	"тянет руки со сломанными, скрюченными пальцами",
	"тянет руки к свежему мясу",
	"бредет, спотыкаясь",
	"бредет, подняв руку и верещит",
	"хрипит, стонет и расплескивает вокруг гной",
	"верещит",
	"визжит и молотит руками воздух вокруг себя",
	"щелкает зубами и рычит",
	"грызет свой собственный палец и рычит",
	"хрипя, кашляет кровью и тянет руки в язвах",
	"пытается захватить когтями и вырвать глаз",
	"упал, споткнулся. С визгом поднимается и идет дальше",
	"идет, размахивая руками и дико визжа",
	"бредет, спотыкаясь на каждом шагу и вереща",
	"хрипя, кашляет кровью и тянет руки в язвах",
	"впивается зубами в руку",
	"подняв руки, уныло бредет навстречу смерти",
	"орет нечеловеческим голосом",
	"шумно втягивает воздух искалеченным носом",
	"бежит, подняв одну руку, сжимая второй свой собственный глаз",
	"мотает головой из стороны в сторону, разбрызгивая гной из струпьев",
	"визжит и размахивает руками",
	"визжит и рвет ногтями воздух, в надежде кого-нибудь зацепить",
	"раздирает себе кожу на лице ногтями"
};

string@GenerateZombieSpeech(int&sayType)
{
	if(sayType==(1)||sayType==(7))
	sayType=(2);
	else if(sayType==(3))
	sayType=(4);
	else
	sayType=(6);
	
	string[]@strArr=null;
	
	switch(sayType)
	{
		case(2):
		@strArr=ZombieNormal;
		break;
		case(4):
		@strArr=ZombieShout;
		break;
		case(6):
		@strArr=ZombieEmote;
		break;
	}
	
	if(strArr is null or strArr.length()<1)
	{
		sayType=(6);
		return"Бормочет";
	}
	
	return strArr[Random(0,strArr.length())];
}     

Sprite expbar,
expbar_;

uint16 expbarPosX=0,expbarPosY=0,expbarLineEnd=0;

void ExpBarSetPos()
{
	GetIfaceIniPos("ExpBar",expbarPosX,expbarPosY,expbarLineEnd);
	
	expbar.Load("bar1.png",int((4)));
	expbar_.Load("bar1_e.png",int((4)));
}

void DrawExpBar()
{
	int[]drawData;
	
	CritterCl@choo=GetChosen();
	if(choo is null)
	return;
	
	uint8 level=choo.StatBase[(77)];
	uint levelExp=(((level-1)%2)!=0?(level-1)*((level-1)/2+1):(level-1)*(level-1)/2+(level-1)/2)*1000;
	
	uint16 exp=choo.StatBase[(76)]-levelExp,
	toLevelExp=(((level)%2)!=0?(level)*((level)/2+1):(level)*(level)/2+(level)/2)*1000-levelExp;
	
	float expMod=exp*100/(toLevelExp>100?toLevelExp:100);
	
	uint16 time=choo.StatBase[(125)];
	uint8 allTime=(time)&0xFF,
	elapsedTime=(time>>8)&0xFF;
	
	float timeMod=elapsedTime*100/(allTime>0?allTime:1);
	
	uint16 r0=0x15,
	g0=0x1F,
	b0=0x00,
	
	r1=0x67,
	g1=0x60,
	b1=0x00;                                            
	
	uint16 tempY=(((expbarPosY)-(expbarLineEnd))*(allTime>0?timeMod*0.01:expMod*0.01));
	
	for(uint16 i=0;i<tempY;++i)
	{
		i+=3;
		
		drawData.insertLast((expbarPosX));
		drawData.insertLast((expbarPosY)-i);
		drawData.insertLast((uint((0xFF<<24)|(((r0)&0xFF)<<16)|(((g0)&0xFF)<<8)|((b0)&0xFF))));
		
		drawData.insertLast((expbarPosX)+5);
		drawData.insertLast((expbarPosY)-i);
		drawData.insertLast((uint((0xFF<<24)|(((r1)&0xFF)<<16)|(((g1)&0xFF)<<8)|((b1)&0xFF))));
		
		drawData.insertLast((expbarPosX)+5);
		drawData.insertLast((expbarPosY)-i);
		drawData.insertLast((uint((0xFF<<24)|(((r1)&0xFF)<<16)|(((g1)&0xFF)<<8)|((b1)&0xFF))));
		
		drawData.insertLast((expbarPosX)+8);
		drawData.insertLast((expbarPosY)-i);
		drawData.insertLast((uint((0xFF<<24)|(((r0)&0xFF)<<16)|(((g0)&0xFF)<<8)|((b0)&0xFF)))); 
		
	}
	
	DrawSprite(expbar.Id,-1,(expbarPosX)-42,(expbarPosY)-210,0);
	DrawPrimitive((1),drawData);
	DrawSprite(expbar_.Id,-1,(expbarPosX)-42,(expbarPosY)-210,0);
	DrawText("0"+choo.StatBase[(124)],(expbarPosX)-20,(expbarPosY)+30,70,10,(uint((0xFF<<24)|(((r1)&0xFF)<<16)|(((g1)&0xFF)<<8)|((b1)&0xFF))),(1),0);
}

void GetIfaceIniPos(string iniKey,uint16&posX,uint16&posY,uint16&lineEnd)
{
	string@str=GetIfaceIniStr(iniKey);
	if(@str==null||str=="")
	return;
	
	string@[]@valuesStr=splitEx(str," ");
	if(valuesStr.length()!=3)
	return;
	
	int[]values(3);
	for(int i=0;i<3;i++)
	if(not StrToInt(valuesStr[i],values[i]))
	return;
	
	posX=values[0];
	posY=values[1];
	lineEnd=values[2];
}          

bool isDKPInit=false;
uint16[]dkp_array;

void DKPInit(){          
	
	if(dkp_array.length()%2!=0)Log("dkp_array wring size.");
	else isDKPInit=true;
}

uint16 DKPCheckDrugKey(uint8 key){
	
	if(!isDKPInit)DKPInit();
	
	for(uint8 i=0,j=dkp_array.length();i<j;i++){
		if(dkp_array[i]==key&&i%2==0)return dkp_array[i+1];
	}
	
	return uint16(-1);
}

void DKPUnsafeRun(uint16 drugPid){
	
	if(GetChosen().IsBusy()){Message("choo are busy.");return;}
	if(GetChosen().CountItem(drugPid)<=0){Message("need more drugs.");return;}
	RunServerScriptUnsafe("main@unsafe_DKP",drugPid,0,0,null,null);
}

void __ReInit(int p0,int p1,int p2,string@p3,int[]@p4){
	start();
	screen_change(true,(1),0,0,0);
	screen_change(false,(1),0,0,0);
	render_iface(2);
}
