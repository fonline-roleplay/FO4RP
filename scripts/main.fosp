                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                    

bool LocIsModoc(uint locPid)
{
	return(locPid<=(6));
}

bool LocIsCity(uint locPid)
{
	return(locPid<=(25)||locPid==(40)||locPid==(42)||locPid==26||locPid==27||locPid==29||locPid>=96);
}

bool LocIsMasked(uint locPid)
{
	return(locPid==(41));
}

bool LocIsHidden(uint locPid)
{
	return false;
}                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                        

const int[]TeamsTable=
{  
	
	(5),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(5),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(1),(0),(0),(3),(0),(0),(0),(0),(4),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(3),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(2),(2),(0),(0),(0),(0),(4),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(6),(5),(0),(0),(0),(0),(5),(0),(0),(4),(0),(4),(1),(0),(0),(0),(0),(0),(0),(4),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(4),(4),(3),(1),(1),(1),(1),(0),(0),(5),(0),(0),(0),(0),(1),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(4),(0),(0),(4),(4),(1),(1),(0),(0),(5),(0),(0),(0),(0),(1),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(5),(3),(3),(3),(0),(0),(5),(1),(1),(4),(4),(1),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(4),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(4),(0),(0),(0),(0),(5),(0),(0),(0),(0),(0),(4),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(4),(4),(0),(0),(0),(0),(1),(0),(0),(0),(0),(1),(5),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(4),(0),(0),(0),(0),(5),(1),(0),(0),(0),(1),(4),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(3),(4),(0),(0),(0),(0),(5),(0),(0),(4),(0),(1),(4),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(3),(1),(1),(0),(0),(0),(5),(0),(0),(0),(0),(5),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(1),(1),(1),(0),(0),(0),(1),(1),(1),(1),(1),(1),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(3),(4),(4),(0),(0),(0),(5),(0),(0),(0),(0),(1),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(3),(1),(1),(0),(0),(0),(5),(0),(0),(0),(0),(1),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(3),(3),(3),(0),(0),(0),(5),(0),(0),(0),(0),(0),(4),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(4),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(6),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(1),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),(0),
	
};            

uint __GetColor(int r,int g,int b)
{
	r=(((r)>(255))?(255):(((r)<(0))?(0):(r)));
	g=(((g)>(255))?(255):(((g)<(0))?(0):(g)));
	b=(((b)>(255))?(255):(((b)<(0))?(0):(b)));
	return(uint((0xFF<<24)|(((r)&0xFF)<<16)|(((g)&0xFF)<<8)|((b)&0xFF)));
}

uint __GetGradient(uint colorStart,uint colorEnd,uint8 pos)
{
	pos=(((pos)>(100))?(100):(((pos)<(1))?(1):(pos)));
	
	int aS=(colorStart>>24)&0xFF,
	rS=((colorStart>>16)&0xFF),
	gS=((colorStart>>8)&0xFF),
	bS=((colorStart)&0xFF),
	
	aE=(colorEnd>>24)&0xFF,
	rE=((colorEnd>>16)&0xFF),
	gE=((colorEnd>>8)&0xFF),
	bE=((colorEnd)&0xFF); 
	
	rS=(((rE-int(rS*(pos*0.01)))>0)?(rE-int(rS*(pos*0.01))):-(rE-int(rS*(pos*0.01))));
	gS=(((gE-int(gS*(pos*0.01)))>0)?(gE-int(gS*(pos*0.01))):-(gE-int(gS*(pos*0.01))));
	bS=(((bE-int(bS*(pos*0.01)))>0)?(bE-int(bS*(pos*0.01))):-(bE-int(bS*(pos*0.01))));
	
	return __GetColor(rS,gS,bS);
}

uint __GetColor(uint8&a,uint8&r,uint8&g,uint8&b,uint color){
	a=(color>>24)&0xFF;
	r=((color>>16)&0xFF);
	g=((color>>8)&0xFF);
	b=((color)&0xFF);
	
	return 0;
}                                                                                     

string@GetDateString()
{     
	
	return(__Year+"_"+__Month+"_"+__Day);
}

string@GetDateString(int delta)
{
	uint16 year=0,month=0,day_of_week=0,day=0,hour=0,minute=0,second=0;
	
	GetGameTime(__FullSecond+delta,year,month,day,day_of_week,hour,minute,second);
	
	return(year+"_"+month+"_"+day);
} 

import bool manager_start()from"manager";
import uint manager_loop()from"manager";
import void manager_critter_init(Critter&cr,bool firstTime)from"manager";
import void manager_critter_finish(Critter&cr,bool toDelete)from"manager";
import void manager_critter_idle(Critter&cr)from"manager";
import void manager_critter_dead(Critter&cr,Critter@killer)from"manager";
import void manager_critter_respawn(Critter&cr)from"manager";
import void manager_map_critter_in(Map&map,Critter&cr)from"manager";
import void manager_map_critter_out(Map&map,Critter&cr)from"manager";
import void manager_world_save()from"manager";
import bool manager_player_registration(uint ip,string&name,uint&textMsg,uint&strNum)from"manager";
import bool manager_player_login(uint ip,string&name,uint id,uint&textMsg,uint&strNum)from"manager";                                                                                     

funcdef uint PROCESS(Critter@,int&,int&,int&);                  

import bool RegisterProcess(uint8 type,any func)from"ltp";

import bool StartProcess(Critter&cr,uint8 type,int param0,int param1,int param2,uint time)from"ltp";
import bool StartProcess(Critter&cr,uint8 type,int param0,uint time)from"ltp";
import bool StartProcess(Critter&cr,uint8 type,uint time)from"ltp";

import bool StopProcess(Critter&cr)from"ltp";

import bool checkTDH(Critter&cr)from"ltp";
import bool checkTDH(Critter&cr,uint8 type)from"ltp";          

import void InitializeGame()from"config";
import bool OnUseExplode(Critter&cr,Item&explode,Critter@targetCr,Item@targetItem,Scenery@targetScen,uint timer)from"explode";
import bool IsStill(Item@item)from"manufact_alco";
import bool UseStill(Critter@cr,Item@still,int skill,Item@item)from"manufact_alco";
import bool IsTree(Scenery@scen)from"scenery";
import bool UseAxeOnTree(Critter@cr,Scenery@tree)from"scenery";
import bool UseItemOnCar(Critter&cr,Item&car,Item&item)from"car";
import bool UseSkillOnCar(Critter&cr,Item&car,int skill)from"car";

import void DropPoison(Critter&cr)from"poison";
import void DropParalysis(Critter&cr,int value)from"paralysis";
import void AffectParalysis(Critter&cr,int value)from"paralysis";
import void DropParalysisInstant(Critter&cr)from"paralysis";
import void DropRadiation(Critter&cr)from"radiation";
import void SetHair(Critter&cr)from"hair";
import void RestartHair(Critter&cr)from"hair";
import void HairCut(Critter&cr,Critter&onCr)from"hair";
import void Shave(Critter&cr,Critter&onCr)from"hair";

import void WorldmapInit()from"worldmap";
import void CombatAttack(Critter&cr,Critter@target,ProtoItem&weapon,uint8 weaponMode,ProtoItem@ammo,uint16 hexX,uint16 hexY)from"combat";
import bool TryRepairItem(Critter&cr,Item&item)from"repair";
import bool TryDisassembleItem(Critter&cr,Item&item)from"repair";
import bool WantedSignSet(Item&wantedSign,string&name,uint cost)from"wanted";
import bool IsReadableBook(uint16 pid)from"books";
import void TryReadBook(Critter&cr,Item&book)from"books";
import void UseDrug(Critter&cr,Item&drug)from"drugs";
import void UseDrugOn(Critter&cr,Critter&onCr,Item&drug)from"drugs";
import bool UseGeiger(Critter&cr,Item&geiger)from"geiger";
import bool UseItemOnGeiger(Critter&cr,Item&geiger,Item&item)from"geiger";
import bool UseSkillOnGeiger(Critter&cr,Item&geiger,int skill)from"geiger";

import bool AddAttackPlane(Critter&npc,uint priority,Critter&target)from"npc_planes";
import bool AddAttackPlane(Critter&npc,uint priority,Critter&target,int minHp)from"npc_planes";
import bool UseSkillOnLocker(Critter&cr,Item&locker,int skill)from"lockers";
import bool UseItemOnLocker(Critter&cr,Item&locker,Item&item)from"lockers";
import bool PerkCheck(Critter&cr,uint perk)from"perks";
import void CritterGenerate(Critter&cr)from"parameters";

import int GetDeteriorationProcent(Item&item)from"repair";
import void SetDeterioration(Item&item,int deteriorationProcent)from"repair";
import void NpcProcessLevel(Critter&npc)from"parameters";

import void EditRadioSettings(Critter&player,Item&radio)from"radio";

import void skin(Critter&cr,int crType)from"skins";

import void qmap_critter_in(uint mapId,Critter&cr)from"qmap";
import void qmap_critter_out(uint mapId,Critter&cr)from"qmap";
import void qmap_save_all()from"qmap";
import void qmap_load_all()from"qmap";

import bool UseShovel(Critter&cr,Item&item)from"farm";
import void ApplyMutation(Critter&cr)from"morphes";

import bool unlock(Critter&cr,Critter&targetCr,uint16 pid)from"handcuffs";
import void ChangeCritterSpeed(Critter&cr)from"speed";

import int AddNewCritterHistoryBase(Critter&cr)from"history_menu"; 

import bool e_InitSkinningUse(Item&item,Critter&cr,Critter@onCritter,Item@onItem,Scenery@onScenery)from"mob";

import string SetupAidLeX(uint8 aidValue)from"item";

import void CheckFaction(Critter&cr,bool join)from"factions";

import bool IsHaveBlade(uint16 pid)from"repair";
import void robotRepairSkill(Critter&cr,Critter&targetCr,bool alreadyAllowed)from"repair";

import void ProccessFirstAidSkill(Critter&cr,Critter&targetCr,bool alreadyAllowed)from"heal";
import void ProccessDoctorSkill(Critter&cr,Critter&targetCr,bool alreadyAllowed)from"heal";
import bool ItemStimpackUse(Critter&cr,Item&item)from"heal";
import bool __Bandage(Critter&cr,Critter@targetCr)from"heal";
import void ItemHypoUse(Critter&cr,Item&item)from"heal";
import void ItemSupUse(Critter&cr,Item&item)from"heal";

import void InitCrimsonCaravans()from"crimson_caravans";
import void SaveCaravans()from"crimson_caravans";
import void Log_Steal(Critter&player,int target,int item,int succes,string@param3,int[]@param4)from"gm";

import void ProccessFood(Critter&cr,Item&item)from"item";
import void e_PsiUse(Critter&cr)from"item";

import void InitTiles()from"cimp";

import bool LighterOnFire(Critter&cr,Item&lighter,Scenery&fire)from"cooking";
import bool UseCookingStuff(Scenery&scen,Critter&cr)from"cooking";
import bool CanCook(Scenery@fire)from"cooking";

import bool IsDoorAutomatic(uint pid)from"map_sutter_objects";

import void FlushScreen(Critter&cr,uint fromColor,uint toColor,uint timeMs)from"effects";

import bool AddWalkPlane(Critter&npc,uint priority,uint16 hexX,uint16 hexY,uint8 dir,bool run,uint cut)from"npc_planes";   

void init()
{
	InitializeGame();
}  

bool start()
{   
	
	SetSendParameter((71),true);
	SetSendParameter((70),true);
	SetSendParameter((81),true);
	SetSendParameter((100),true);
	
	SetSendParameter((9),true);
	SetSendParameter((86),true);
	
	SetSendParameter((5),true);
	
	SetSendParameter((7),true);
	SetSendParameter((72),true);        
	
	SetSendParameter((0),true);
	SetSendParameter((380),true);
	
	SetSendParameter((238),true);
	
	SetSendParameter((2),true);
	
	SetSendParameter((3),true);
	
	SetSendParameter((502),true);
	SetSendParameter((503),true);
	SetSendParameter((504),true);
	SetSendParameter((505),true);
	SetSendParameter((506),true);
	
	SetSendParameter(-(1),true,"fonline_tnf.dll@allowSlot_Hand1");
	SetSendParameter(-(3),true);
	
	SetSendParameter((512),true);
	SetSendParameter((511),true);
	SetSendParameter((532),true);
	SetSendParameter((528),true);
	SetSendParameter((541),true);  
	
	uint fromLayer=(150)+(0);
	uint toLayer=(150)+(15);
	for(uint i=fromLayer;i<=toLayer;i++)
	SetSendParameter(i,true); 
	
	SetSendParameter((115),true);
	
	SetSendParameter((104),true);
	
	SetSendParameter((102),true);
	
	SetSendParameter((116),true);
	
	SetSendParameter((117),true);
	SetSendParameter((118),true);
	
	SetSendParameter((215),true);
	
	SetSendParameter((703),true);
	
	SetSendParameter((67),true);
	
	SetSendParameter((700),true);    
	
	int8[]mask0={-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0};
	
	int8[]mask1={0,0,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0};
	
	int8[]mask2={0,0,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0};
	
	int8[]mask3={-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0};
	
	int8[]mask4={-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,-1,0,0};
	SetItemDataMask((0),mask0);
	SetItemDataMask((1),mask1);
	SetItemDataMask((2),mask2);
	SetItemDataMask((3),mask3);
	SetItemDataMask((4),mask4);
	
	SetParameterChangeBehaviour((112),"_giveHair"); 
	
	CallStartCallbacks(); 
	
	qmap_load_all();
	WorldmapInit();
	
	InitCrimsonCaravans();
	InitTiles(); 
	
	if(!manager_start())
	return false;
	
	return true;
}          

void get_start_time(uint16&multiplier,uint16&year,uint16&month,uint16&day,uint16&hour,uint16&minute)
{
	multiplier=4;
	year=2260;
	month=5;
	day=14;
	hour=1;
	minute=0;
}  

void finish()
{}   

uint loop()
{
	return manager_loop();
}  

import void hearshot(Critter&cr,Critter&target,ProtoItem&weapon,uint8 weaponMode)from"rp_combat";
void critter_attack(Critter&cr,Critter&target,ProtoItem&weapon,uint8 weaponMode,ProtoItem@ammo)
{
	
	cr.TimeoutBase[(249)]=__FullSecond+((1)*__TimeMultiplier*60);
	hearshot(cr,target,weapon,weaponMode);
	CombatAttack(cr,target,weapon,weaponMode,ammo,0,0);
} 

void critter_attacked(Critter&cr,Critter&attacker)
{
	attacker.ParamBase[(185)]=cr.Id;
	if(cr.IsPlayer())
	return;
	else
	AddAttackPlane(cr,0,attacker); 
	
	uint helpers=0;
	uint maxHelpers=10-attacker.Stat[(3)];
	maxHelpers=(((maxHelpers)>(8))?(8):(((maxHelpers)<(2))?(2):(maxHelpers)));
	
	Critter@[]critters;
	cr.GetCritters(true,(0x03)|(0x20),critters);
	for(uint i=0,j=critters.length();i<j;i++)
	{
		NpcPlane@plane=critters[i].GetCurPlane();
		if((@plane!=null)&&plane.Type==(1)&&plane.Attack_TargId==attacker.Id)
		{
			helpers++;
			if(helpers>=maxHelpers)
			return;
			@critters[i]=null;
		}
	}
	
	int crHpProc=cr.Stat[(72)]*100/cr.Stat[(7)];
	uint teamId=cr.Stat[(106)];
	uint attackerTeamId=attacker.Stat[(106)];
	for(uint i=0,j=critters.length();i<j;i++)
	{
		Critter@someCr=critters[i];
		if(not(@someCr!=null))
		continue;
		
		uint someCrTeamId=someCr.Stat[(106)];
		if(attackerTeamId==someCrTeamId)
		continue;
		
		int teamParity=(TeamsTable[(((someCrTeamId)<38?(someCrTeamId):0)*38+((teamId)<38?(teamId):0))]);
		switch(teamParity)
		{
			case(0):
			continue;
			case(1):
			break;
			case(2):
			if(someCr.IsCurPlane((1)))
			continue;
			break;
			case(3):
			if(crHpProc>=10)
			continue;
			break;
			case(4):
			if(crHpProc>=30)
			continue;
			break;
			case(5):
			if(crHpProc>=50)
			continue;
			break;
			case(6):
			if(not cr.IsDead())
			continue;
			break;
			case(7):
			if(attacker.IsNpc()||cr.Stat[(3)]<5||cr.Stat[(80)]<0)
			continue;
			break;
			default:
			continue;
		}
		
		AddAttackPlane(someCr,0,attacker);
		helpers++;
		if(helpers>=maxHelpers)
		break;
	}
}  

bool critter_stealing(Critter&cr,Critter&thief,Item&item,uint count)
{
	if(cr.IsKnockout()||cr.Param[(72)]<=0){
		return true;
	}
	
	if(cr.Param[(182)]!=0)
	return true;
	
	thief.TimeoutBase[(249)]=__FullSecond+((1)*__TimeMultiplier*60);
	
	if(cr.IsDead()||cr.Timeout[(238)]>0||thief.Timeout[(238)]>0)
	{
		thief.StatBase[(108)]=0;
		thief.StatBase[(109)]=0;
		return false;
	}
	
	if(cr.Mode[(514)]!=0||thief.Mode[(514)]!=0)
	{
		thief.Say((11),"No PvP.");
		return false;
	}
	
	if(cr.IsKnockout())
	{
		Item@[]items;
		Item@[]items0;
		
		uint itemscount=cr.GetItems((1),items);
		uint itemscount0=cr.GetItems((2),items0);
		
		if(itemscount>0)
		{
			if(items[0].GetProtoId()!=(690)&&items[0].GetProtoId()!=(694)&&items[0].GetProtoId()!=(1537))
			cr.MoveItem(items[0].Id,itemscount,(0));
		}
		if(itemscount0>0)
		{
			if(items0[0].GetProtoId()!=(690)&&items[0].GetProtoId()!=(694)&&items0[0].GetProtoId()!=(1537))
			cr.MoveItem(items0[0].Id,itemscount0,(0));
		}
		
		return true;
	}
	
	int dir1=cr.Dir;
	int dir2=thief.Dir;
	int kDir=(((dir1)>(dir2))?(dir1):(dir2))-(((dir1)<(dir2))?(dir1):(dir2));
	if(kDir>3)
	kDir=6-kDir;
	
	int steal=thief.Skill[(210)];
	if(steal<=0)
	steal=1;
	int size=item.Proto.Volume;
	if(size<=0)
	size=1; 
	
	if(thief.Perk[(338)]!=0)
	{
		kDir=0;
		size=1;
	} 
	
	int kCount=count/steal;
	if(kCount<=0)
	kCount=1; 
	
	uint lastStealCrId=thief.Stat[(108)];
	uint stealCount=thief.Stat[(109)];
	if(lastStealCrId==cr.Id&&thief.Timeout[(248)]>0)
	steal-=steal*stealCount*9/100; 
	
	int k=(steal-kDir*10)/(size*kCount);
	k=(((k)>(95))?(95):(((k)<(5))?(5):(k)));
	bool success=!(Random(1,100)-(cr.Stat[(6)]-5)*5>k); 
	
	if(thief.Perk[(406)]==0&&item.GetProtoId()!=(41)&&item.GetProtoId()!=(41)&&thief.GetMap().GetLocation().GetProtoId()<=6)
	success=false;
	
	if(thief.GetAccess()>=(2))
	success=true;
	
	if(success)
	{
		Log_Steal(thief,cr.Id,item.GetProtoId(),0,null,null);
		
		const int[]stealExp={10,20,30,40,50,60,70,80,90,100,110,120};
		
		if(lastStealCrId==cr.Id&&thief.Timeout[(248)]>0)
		{
			stealCount++;
			if(stealCount>11)
			stealCount=11;
			thief.StatBase[(109)]=stealCount;
		}
		else
		{
			thief.StatBase[(108)]=cr.Id;
			thief.StatBase[(109)]=0;
		}
		
		if(thief.GetAccess()<(2))
		thief.TimeoutBase[(248)]=(__FullSecond);
		if(cr.IsNpc())
		{
			GameVar@stealExpCount=::GetUnicumVar((2011),cr.Id,thief.Id);
			if(stealExpCount<12)
			{
				
				thief.AddScore((13),1);
			}
			stealExpCount=stealExpCount+1;
		}
	}
	else
	{
		thief.Action((10),3,null);
		thief.StatBase[(108)]=0;
		thief.StatBase[(109)]=0;
		
		if(cr.IsNpc())
		{
			int thiefHp=thief.Stat[(72)];
			AddAttackPlane(cr,0,thief,thiefHp<10||Random(1,10)>cr.Stat[(6)]+4||cr.Stat[(3)]<3?__DeadHitPoints:Random(thiefHp/4,thiefHp/2));
		}
	}
	
	return success;
}  

bool critter_use_item(Critter&cr,Item&item,Critter@targetCr,Item@targetItem,Scenery@targetScen,uint param)
{
	bool isPlayer=cr.IsPlayer();
	uint16 pid=item.GetProtoId();
	bool useOnSelf=(not(@targetCr!=null)&&not(@targetItem!=null)&&not(@targetScen!=null)); 
	
	if(!(targetItem is null)&&pid==(572)&&targetItem.GetProtoId()==3321)
	{        
		
		cr.Say((6),"Вытирает кровь тряпкой");
		cr.Say((11),"Вы вытираете кровь");
		cr.Animate(0,(27),null,true,true);
		DeleteItem(targetItem);
		return true;
	}
	if(!(targetItem is null)&&pid==(572)&&targetItem.GetProtoId()==3322)
	{
		cr.Say((6),"Вытирает кровь тряпкой");
		cr.Say((11),"Вы вытираете кровь");
		cr.Animate(0,(27),null,true,true);
		DeleteItem(targetItem);
		return true;
	}
	if(!(targetItem is null)&&pid==(572)&&targetItem.GetProtoId()==3323)
	{
		cr.Say((6),"Вытирает кровь тряпкой");
		cr.Say((11),"Вы вытираете кровь");
		cr.Animate(0,(27),null,true,true);
		DeleteItem(targetItem);
		return true;
	}
	if(!(targetItem is null)&&pid==(572)&&targetItem.GetProtoId()==3324)
	{
		cr.Say((6),"Вытирает кровь тряпкой");
		cr.Say((11),"Вы вытираете кровь");
		cr.Animate(0,(27),null,true,true);
		DeleteItem(targetItem);
		return true;
	}
	if(!(targetItem is null)&&pid==(572)&&targetItem.GetProtoId()==3325)
	{
		cr.Say((6),"Вытирает кровь тряпкой");
		cr.Say((11),"Вы вытираете кровь");
		cr.Animate(0,(27),null,true,true);
		DeleteItem(targetItem);
		return true;
	}
	if(!(targetItem is null)&&pid==(572)&&targetItem.GetProtoId()==3326)
	{
		cr.Say((6),"Вытирает кровь тряпкой");
		cr.Say((11),"Вы вытираете кровь");
		cr.Animate(0,(27),null,true,true);
		DeleteItem(targetItem);
		return true;
	}
	
	if(!(targetItem is null)&&pid==(6)&&targetItem.GetProtoId()==8003||!(targetItem is null)&&pid==(6)&&targetItem.GetProtoId()==8004)
	{
		if(Random(0,100)<=80&&cr.TimeoutBase[(248)]<=__FullSecond+((2)*__TimeMultiplier*60)&&cr.ParamBase[(505)]<=0&&cr.ParamBase[(504)]<=0&&cr.ParamBase[(506)]<=0&&cr.ParamBase[(503)]<=0)
		{
			cr.Say((6),"Добывает руду");
			cr.Animate(6,(51),null,true,true);
			Map@map=cr.GetMap();
			map.SetText(cr.HexX,cr.HexY,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),"УДАР");
		}
		else if(Random(0,80)+cr.StatBase[(6)]*1.5+cr.StatBase[(0)]*2+cr.ParamBase[(213)]*0.2+cr.ParamBase[(217)]*0.2>=20&&cr.ParamBase[(77)]>=6&&cr.TimeoutBase[(248)]<=__FullSecond+((2)*__TimeMultiplier*60)&&
		cr.ParamBase[(505)]<=0&&cr.ParamBase[(504)]<=0&&cr.ParamBase[(506)]<=0&&cr.ParamBase[(503)]<=0)
		{
			cr.Animate(6,(51),null,true,true);
			Map@map=cr.GetMap();
			map.SetText(cr.HexX,cr.HexY,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),"УДАР");
			cr.ParamBase[(192)]=(Random(0,30)+cr.StatBase[(6)]*2+cr.StatBase[(0)]*2+cr.StatBase[(1)]*2+cr.ParamBase[(217)]*0.2)-Random(0,30);
			cr.Say((6),"Добывает руду");
			cr.Say((11),""+cr.ParamBase[(192)]);
			if(cr.ParamBase[(192)]>=0&&cr.ParamBase[(192)]<=40)
			{
				cr.AddItem((19),3);
				cr.Say((11),"Кажется, ничего ценного добыть не удалось");
			}
			if(cr.ParamBase[(192)]>=41&&cr.ParamBase[(192)]<=54)
			{
				cr.AddItem((537),1);
				cr.AddItem((19),4);
				cr.Say((11),"Вы добыли: х1 Минералы; х4 Камень");
			}
			if(cr.ParamBase[(192)]>=55&&cr.ParamBase[(192)]<=65)
			{
				cr.AddItem((536),2);
				cr.AddItem((19),6);
				cr.Say((11),"Вы добыли: х2 Железная руда; х6 Камень");
			}
			if(cr.ParamBase[(192)]>=66&&cr.ParamBase[(192)]<=80)
			{
				cr.AddItem((537),2);
				cr.AddItem((536),3);
				cr.AddItem((19),12);
				cr.Say((11),"Вы добыли: х2 Минералы; х3 Железная руда; х12 Камень");
			}
			if(cr.ParamBase[(192)]>=81&&cr.ParamBase[(192)]<=90)
			{
				cr.AddItem((537),3);
				cr.AddItem((536),3);
				cr.AddItem((19),14);
				cr.Say((11),"Вы добыли: х3 Минералы; х3 Железная руда; х12 Камень");
			}
			if(cr.ParamBase[(192)]>=91)
			{
				cr.AddItem((423),1);
				cr.AddItem((537),3);
				cr.AddItem((536),3);
				cr.AddItem((19),14);
				cr.Say((11),"Вы добыли: х1 Золотая руда; х3 Минералы; х3 Железная руда; х12 Камень");
			}
			if(Random(1,100)-(cr.Stat[(6)]-5)*5>=80)
			{
				cr.ParamBase[(192)]=Random(0,300)-cr.StatBase[(6)]*10-cr.StatBase[(4)]*2-cr.StatBase[(5)]*2;
				if(cr.ParamBase[(192)]>=60&&cr.ParamBase[(192)]<=130)
				{
					cr.Say((11),"Удар, еще удар.. О НЕТ! Кувалда угодила точно в вашу ногу.");
					cr.ParamBase[(505)]=1;
					cr.ParamBase[(72)]-=20;
					cr.Say((5),"Хруст в ноге");
				}
				if(cr.ParamBase[(192)]>=131&&cr.ParamBase[(192)]<=252)
				{
					cr.Say((11),"Вы так увлеклись размахиванием кувалды, что даже не заметили, как вывихнули свою руку");
					cr.ParamBase[(504)]=1;
					cr.ParamBase[(72)]-=20;
					cr.Say((5),"Рука безвольно повисла");
				}
			}
			cr.TimeoutBase[(248)]=__FullSecond+((5)*__TimeMultiplier*60)+((0)*__TimeMultiplier);
			cr.ParamBase[(192)]=0;
		}
		else if(cr.ParamBase[(505)]>=1||cr.ParamBase[(504)]>=1||cr.ParamBase[(506)]>=1||cr.ParamBase[(503)]>=1){cr.Say((11),"Вы травмированы и не в состоянии добывать руду.");}
		else if(cr.ParamBase[(77)]<=5){cr.Say((11),"Вы еще недостаточно опытны. Требования: 6 уровень");}
		else if(cr.TimeoutBase[(248)]>__FullSecond+((2)*__TimeMultiplier*60))
		{
			cr.Say((6),"Отдышка");
			cr.Say((11),"Вы слишком устали, передохните хотя бы три минуты");
		}
		return true;
	}    
	
	if(!(targetItem is null)&&targetItem.GetType()==(9))
	{
		cr.StatBase[(131)]=targetItem.Id;
	}
	
	if(!(targetItem is null)&&targetItem.GetType()==(15)){
		int plantUseItemPID=item.GetProtoId();
		if(plantUseItemPID==(106)||
		plantUseItemPID==(124)||
		plantUseItemPID==(125)||
		plantUseItemPID==(1627)){
			do{if(item.GetCount()>(1))
				item.SetCount(item.GetCount()-(1));else
				DeleteItem(item);}while(false);
			cr.AddItem((542),1);
			return true;
		}else if(plantUseItemPID==(533)){
			do{if(item.GetCount()>(1))
				item.SetCount(item.GetCount()-(1));else
				DeleteItem(item);}while(false);
			cr.AddItem((532),1);
			return true;
		}else if(plantUseItemPID==(1599)){
			do{if(item.GetCount()>(1))
				item.SetCount(item.GetCount()-(1));else
				DeleteItem(item);}while(false);
			return true;
		}else return false;
	}         
	
	if(useOnSelf&&item.GetProtoId()==(1321))
	{
		cr.Say((6),"перебинтовывается");
		cr.StatBase[(149)]/=6;
		cr.DeleteItem((1321),1);
		return true;
	}
	
	if(useOnSelf&&item.GetProtoId()==(572))
	{
		cr.Say((6),"перебинтовывается");
		cr.StatBase[(149)]/=4;
		cr.DeleteItem((572),1);
		return true;
	} 
	
	if(@targetCr!=null&&targetCr.StatBase[(182)]!=0&&(targetCr.Id!=cr.Id))
	{
		if(unlock(cr,targetCr,pid))
		return true;
	}
	
	if(cr.IsPlayer()&&useOnSelf&&item.GetType()==(8))
	{
		cr.ParamBase[(130)]=item.Id;
		cr.ShowContainer(null,item,(3));
		return true;
	}
	
	if((@targetCr!=null)&&targetCr.Param[(703)]==(3)&&item.GetProtoId()==(127)&&(targetCr.IsKnockout()||targetCr.IsDead()))
	{
		Map@map=cr.GetMap();
		uint16 mapPid=map.GetProtoId();
		if(mapPid==18||mapPid==19)
		{
			Map@prison=GetMapByPid(19,0);
			bool noVacancy=true;
			uint8 counter=0;
			uint8 cellIndex=0;
			uint16 X=0,Y=0;
			while(counter<18)
			{
				if(prison.GetData(counter)==0)
				{
					cellIndex=counter;
					noVacancy=false;
					counter=18;
				}
				counter++;
			}
			if(!noVacancy)
			{
				prison.GetEntireCoords(113,cellIndex,X,Y);
				targetCr.TransitToMap(prison.Id,X,Y,Random(0,5));
				prison.SetData(cellIndex,targetCr.Id);
				cr.SayMsg((11),(3),12740);
				targetCr.SayMsg((11),(3),12742);
				if(targetCr.IsKnockout())
				DeleteItem(item);
			}
			else
			{
				cr.SayMsg((11),(3),12741);
			}
			return true;
		}
		return false;
	}
	
	if(pid==(888)&&!(targetItem is null)&&(targetItem.GetType()==(9)||targetItem.GetType()==(8)))
	{
		cr.ShowScreen((4),item.Id,"main@showBunch");
		return true;
	}   
	
	if(useOnSelf&&item.GetProtoId()==(334)&&cr.Param[(67)]!=(10))
	{
		if(cr.StatBase[(67)]!=(10))
		{
			cr.SayMsg((11),(3),12909);
			AffectParalysis(cr,50);
			cr.DeleteItem((334),1);
		}
		return true;
	}
	if((@targetCr!=null)&&item.GetProtoId()==(334)&&targetCr.StatBase[(67)]!=(10))
	{
		targetCr.SayMsg((11),(3),12910);
		AffectParalysis(targetCr,50);
		cr.DeleteItem((334),1);
		return true;
	} 
	
	if(useOnSelf&&item.GetProtoId()==(680))
	{
		if(cr.Param[(180)]!=0||cr.Param[(73)]!=0)
		{
			DropPoison(cr);
			DropParalysis(cr,50);
			cr.DeleteItem((680),1);
			return true;
		}
		else
		{
			cr.DeleteItem((680),1);
			return false;
		}
	}
	
	if((@targetCr!=null)&&item.GetProtoId()==(680))
	{
		if(targetCr.Param[(180)]!=0||targetCr.Param[(73)]!=0)
		{
			DropPoison(targetCr);
			DropParalysis(targetCr,50);
			cr.DeleteItem((680),1);
			return true;
		}
		else
		{
			cr.DeleteItem((680),1);
			return false;
		}
		
	}  
	
	if(item.GetProtoId()==(597))
	{
		if(useOnSelf)
		HairCut(cr,cr);
		else
		HairCut(cr,targetCr);
		return true;
	}
	
	if(item.GetProtoId()==(598))
	{
		if(useOnSelf)
		Shave(cr,cr);
		else
		Shave(cr,targetCr);
		return true;
	}
	
	bool isKnife=(item.GetProtoId()==(236)||item.GetProtoId()==(517)||item.GetProtoId()==(4)||item.GetProtoId()==(319)||item.GetProtoId()==(522)||item.GetProtoId()==(1418)||item.GetProtoId()==(1419));
	
	if(isKnife)
	{
		Map@map=cr.GetMap();
		if(useOnSelf)
		{
			@targetItem=map.GetItem(cr.HexX,cr.HexY,(1524));
			if((@targetItem!=null))
			DeleteItem(targetItem);
		}
		else
		{
			@targetItem=map.GetItem(targetCr.HexX,targetCr.HexY,(1524));
			if((@targetItem!=null))
			DeleteItem(targetItem);
			e_InitSkinningUse(item,cr,targetCr,null,null);
		}
		return true;
	}      
	
	if((((item.Flags)&((0x40000000)))!=0)&&useOnSelf)
	{
		if(isPlayer)
		EditRadioSettings(cr,item);
		return true;
	} 
	
	if(useOnSelf&&IsReadableBook(pid))
	{
		TryReadBook(cr,item);
		return true;
	} 
	
	if(OnUseExplode(cr,item,targetCr,targetItem,targetScen,param))
	return true; 
	
	if((@targetItem!=null)&&targetItem.GetType()==(13)&&UseItemOnCar(cr,targetItem,item))
	return true; 
	
	if(isPlayer&&IsStill(targetItem)&&UseStill(cr,targetItem,-1,item))
	return true; 
	
	if(pid==(543)&&(@targetScen!=null)&&IsTree(targetScen)&&UseAxeOnTree(cr,targetScen))
	return true; 
	
	if(item.GetType()==(2)||item.GetType()==(16))
	{
		if((useOnSelf&&cr.StatBase[(67)]==(10))||(targetCr!=null&&targetCr.StatBase[(67)]==(10)))return false;
		if(pid==40)
		ChangeCritterSpeed(targetCr!=null?targetCr:cr);  
		
		uint8 hungerBonus=item.Proto.Food_Restore;
		uint8 thristBonus=item.Proto.Food_Thrist;
		
		switch(pid)
		{
			case(40):cr.SayMsg((6),(0),10310);break;
			case(48):cr.SayMsg((6),(0),10311);break;
			case(49):cr.SayMsg((6),(0),10312);break;
			case(53):cr.SayMsg((6),(0),10313);break;
			case 71:cr.SayMsg((6),(0),10314);break;
			case 81:cr.SayMsg((6),(0),10315);break;
			case 87:cr.SayMsg((6),(0),10316);break;
			case 103:cr.SayMsg((6),(0),10317);break;
			case 106:cr.SayMsg((6),(0),10318);break;
			case 109:cr.SayMsg((6),(0),10319);break;
			case 110:cr.SayMsg((6),(0),10320);break;
			case 124:cr.SayMsg((6),(0),10311);break;
			case 125:cr.SayMsg((6),(0),10312);break;
			case 144:cr.SayMsg((6),(0),10313);break;
			case 259:cr.SayMsg((6),(0),10314);break;
			case 260:cr.SayMsg((6),(0),10315);break;
			case 273:cr.SayMsg((6),(0),10316);break;
			case 310:cr.SayMsg((6),(0),10317);break;
			case 311:cr.SayMsg((6),(0),10318);break;
			case 378:cr.SayMsg((6),(0),10319);break;
			case 469:cr.SayMsg((6),(0),10330);break;
			case(284):cr.SayMsg((6),(0),10331);break;
			case(539):cr.SayMsg((6),(0),10331);break;
			case(1440):cr.SayMsg((6),(0),10331);break;
			default:break;
		}
		
		if(useOnSelf)
		{
			cr.StatBase[(128)]+=hungerBonus;
			cr.StatBase[(127)]+=thristBonus;
			cr.StatBase[(127)]-=hungerBonus/3;
			ProccessFood(cr,item);
			UseDrug(cr,item);
		}
		else
		{
			targetCr.StatBase[(128)]+=hungerBonus;
			targetCr.StatBase[(127)]+=thristBonus;
			targetCr.StatBase[(127)]-=hungerBonus/3;
			ProccessFood(targetCr,item);
			UseDrugOn(cr,targetCr,item);
		}      
		
		if(pid==(40)&&cr.Param[(67)]!=(10))
		{
			if(useOnSelf)ItemStimpackUse(cr,item);
			else ItemStimpackUse(targetCr,item);
			
		} 
		
		if(pid==(525)&&cr.Param[(67)]!=(10))
		{
			ItemHypoUse(cr,item);
		}
		if(pid==(144)&&cr.StatBase[(67)]!=(10)){
			ItemSupUse(cr,item);
		}
		
		return true;
	}   
	
	if(pid==(325))
	{
		cr.SayMsg((6),(0),(500),"$result"+Random(1,6));
		return true;
	}
	if(pid==(326))
	{
		cr.SayMsg((6),(0),(500),"$result"+uint((item.Id%6)+1));
		return true;
	}
	if(pid==(205))
	{
		cr.DeleteItem((205),1);
		cr.AddItem((79),1);
		return true;
	}
	if(pid==(79))
	{
		cr.DeleteItem((79),1);
		cr.AddItem((205),1);
		return true;
	}
	
	if(pid==(328))
	{
		cr.SayMsg((6),(0),Random(1,2)==1?(510):(511));
		return true;
	} 
	
	if(pid==(317)&&cr.Stat[(71)]==(1))
	{
		cr.SayMsg((6),(0),(520));
		return true;
	} 
	
	if(pid==(541)&&cr.CountItem((101))>0)
	{
		cr.SayMsg((6),(0),(530));
		return true;
	} 
	
	if(pid==(329))
	{
		cr.Say((6),"вкалывает сыворотку");
		ApplyMutation(cr);
		cr.DeleteItem((329),1);
		return true;
	} 
	
	if((pid==(20)||pid==(297))&&!(targetItem is null)&&targetItem.GetType()==(9)&&IsDoorAutomatic(targetItem.GetProtoId()))
	{
		if(targetItem.Val6==0)
		{
			if(cr.Stat[(0)]>=4)
			{
				if(Random(1,100)+(cr.Stat[(6)]-5)*5>45)
				{
					if(!(((targetItem.LockerCondition)&((0x01)))!=0))
					targetItem.LockerOpen();
					else
					cr.Say((11),"Закрыть дверь ломом не выйдет.");
				}
				else
				{
					cr.Say((11),"Дверь не поддалась.");
				}
			}
			else
			{
				cr.Say((11),"У вас недостаточно сил для этого.");
			}
		}
		else
		{
			cr.Say((11),"Сейчас дверь удерживает электромагнитный замок. Попробуйте отключить питание.");
		}
		
		return true;
	}
	
	if((pid==(20)||pid==(75))&&@targetItem!=null)
	{
		uint8 itemType=targetItem.GetType();
		if((itemType==(9)||itemType==(8))&&targetItem.Val0!=0&&((targetItem.LockerCondition&(0x01))!=0))
		{
			
			uint16 pid_locker=0;
			
			switch(targetItem.Val0)
			{
				case 1:
				pid_locker=(1317);
				break;
				case 2:
				pid_locker=(1318);
				break;
				case 3:
				pid_locker=(1319);
				break;
				default:
				break;
			}
			if(pid_locker!=0)
			{
				if(pid==(75))
				{
					
					Item@locker=cr.AddItem(pid_locker,1);
					locker.Val0=targetItem.LockerComplexity-50;
					locker.Update();
					
				}
				
				if(pid==(20))
				{
					switch(pid_locker)
					{
						case(1317):
						pid_locker=3;
						break;
						case(1318):
						pid_locker=6;
						break;
						case(1319):
						pid_locker=10;
						break;
						default:
						pid_locker=1;
						break;
					}
					cr.AddItem((475),Random(1,pid_locker));
				}
			}
			
			targetItem.Val0=0;
			targetItem.Val1=0;
			targetItem.LockerComplexity=0;
			targetItem.LockerId=0;
			targetItem.LockerCondition=(0x01);
			targetItem.Update();
			cr.Say((3),"*Ломает замок*");
			cr.Say((11),"Вы сняли замок.");
			return true;
		}
	} 
	
	if(pid==(52)&&useOnSelf&&UseGeiger(cr,item))
	return true;
	if((@targetItem!=null)&&targetItem.GetProtoId()==(52)&&UseItemOnGeiger(cr,targetItem,item))
	return true; 
	
	if(pid==(289)&&useOnSelf&&UseShovel(cr,item))
	return true; 
	
	if((targetItem.GetType()==(9)||targetItem.GetType()==(8))&&UseItemOnLocker(cr,targetItem,item))
	return true;
	
	return false;
}      

bool critter_use_skill(Critter&cr,int skill,Critter@targetCr,Item@targetItem,Scenery@targetScen)
{
	bool isPlayer=cr.IsPlayer();
	bool onSelf=((!(@targetCr!=null))&&(!(@targetItem!=null))&&(!(@targetScen!=null)));
	
	bool isAidKitScience=(@targetItem!=null&&(targetItem.GetProtoId()==(47)||targetItem.GetProtoId()==(91))&&skill==(212));      
	
	if((@targetItem!=null)&&targetItem.GetType()==(13)&&UseSkillOnCar(cr,targetItem,skill))
	return true; 
	
	if((@targetItem!=null)&&targetItem.GetProtoId()==(52)&&UseSkillOnGeiger(cr,targetItem,skill))
	return true; 
	
	if((@targetItem!=null)&&(targetItem.GetType()==(9)||(targetItem.GetType()==(8)&&!isAidKitScience))&&UseSkillOnLocker(cr,targetItem,skill))
	return true;
	switch(skill)
	{
		case(-1):
		{
			if(!(targetScen is null)&&CanCook(targetScen))
			{
				return UseCookingStuff(targetScen,cr);
			} 
			
			if((@targetScen!=null))
			{
				cr.SayMsg((11),(3),(10202));
				return true;
			} 
			
			if(isPlayer&&IsStill(targetItem)&&UseStill(cr,targetItem,-1,null))
			return true; 
			
			if((@targetItem!=null)&&targetItem.GetProtoId()==(3228)&&WantedSignSet(targetItem,cr.Name,Random(1000,2000)))
			return true;
			
			if((@targetItem!=null)&&targetItem.GetProtoId()==(545)&&OnUseExplode(cr,targetItem,null,null,null,0))
			return true; 
			
			if((@targetItem!=null))
			{
				Item@item=targetItem;
				if(not(((item.Flags)&((0x08000000)))!=0))
				{
					cr.SayMsg((11),(3),(10202));
					break;
				}
				
				int freeWeight=cr.Stat[(11)]-cr.ItemsWeight();
				if(freeWeight>=int(item.Proto.Weight*item.GetCount()))
				{
					
					MoveItem(item,0,cr);
				}
				else
				{
					
					if(item.IsStackable()&&freeWeight>=int(item.Proto.Weight))
					MoveItem(item,freeWeight/item.Proto.Weight,cr);
					
					else
					cr.SayMsg((11),(3),(425));
				}
				ChangeCritterSpeed(cr);
			}
		}
		break;
		case(-2):
		if(cr.ParamBase[(130)]!=0)
		{
			Item@cont=GetItem(cr.ParamBase[(130)]);
			if(@cont!=null&&cont.Accessory==(1)&&cont.CritId==cr.Id)
			{
				uint16 targetPid=targetItem.GetProtoId();
				if(cont.GetProtoId()==(47))
				{
					bool isAidSupply=(targetPid==(40)||
					targetPid==(273)||
					targetPid==(1321)||
					targetPid==(572)||
					targetPid==(1322)||
					targetPid==(125));
					if(!isAidSupply)
					{
						cr.Say((11),"Это нельзя положить в аптечку.");
						return true;
					}
				}
				else if(cont.GetProtoId()==(91))
				{
					bool isDocSupply=(targetPid==(75)||
					targetPid==(1323)||
					targetPid==(297)||
					targetPid==(1324)||
					targetPid==(1322)||
					targetPid==(125)||
					targetPid==(922)||
					targetPid==(1325)||
					targetPid==(1326)||
					targetPid==(1320));
					if(!isDocSupply)
					{
						cr.Say((11),"Это нельзя положить в сумку доктора.");
						return true;
					}
					if(!isDocSupply)
					{
						cr.Say((11),"Это нельзя положить в сумку доктора.");
						return true;
					}
				}
				else if(cont.GetProtoId()==(888))
				{
					if(targetItem.GetType()!=(7))
					{
						cr.Say((11),"Это нельзя прицепить на связку ключей.");
						return true;
					}
				}
				
				cr.ParamBase[(43)]-=int(targetItem.Proto.Weight*cr.GetItemTransferCount());
				ChangeCritterSpeed(cr);
				
			}
		}
		return false;
		
		case(-3):
		if(targetItem.Accessory==(3)&&targetItem.ContainerId!=0)
		{
			Item@cont=GetItem(targetItem.ContainerId);
			if(@cont!=null&&cont.Accessory==(1)&&cont.CritId==cr.Id)
			{
				cr.ParamBase[(43)]+=int(targetItem.Proto.Weight*cr.GetItemTransferCount());
				ChangeCritterSpeed(cr);
			}
		}
		return false;
		case(-4):
		if(targetItem.Accessory==(1)&&targetItem.CritId==cr.Id)
		{
			
			int contWeight=0;
			Item@[]items;
			uint len=targetItem.GetItems(-1,items);
			for(uint i=0;i<len;i++)
			{
				if(items[i]is null)
				continue;
				
				contWeight+=int(items[i].Proto.Weight*items[i].GetCount());
			}
			
			cr.ParamBase[(43)]+=contWeight;
			ChangeCritterSpeed(cr);      
			
		}
		
		return false;
		case(-5):
		cr.Action((10),0,null);
		cr.ShowContainer(targetCr,null,(4));
		return true;
		case(-6):
		cr.Action((10),2,null);
		if((cr.Timeout[(238)]==0&&targetCr.Timeout[(238)]==0)&&
		(targetCr.IsPlayer()||(targetCr.IsNoPlanes()&&targetCr.GetTalkedPlayers(null)==0)))
		targetCr.MoveToDir(cr.Dir);
		return true;
		case(212):
		{
			
			if(isPlayer&&IsStill(targetItem)&&UseStill(cr,targetItem,skill,null))
			return true;
			if(((@targetCr!=null))&&(targetCr.Param[(182)]!=0)||(cr.Param[(182)]!=0))
			{
				if(((@targetCr!=null))&&(targetCr.Param[(182)]!=0))
				{
					uint KeyNumber=(targetCr.Param[(182)]>>16)&0x3FFF;
					cr.SayMsg((11),(3),12954,"$number"+KeyNumber);
				}
				if((cr.Param[(182)]!=0)&&(onSelf))
				{
					uint KeyNumber=(cr.Param[(182)]>>16)&0x3FFF;
					cr.SayMsg((11),(3),12954,"$number"+KeyNumber);
				}
				return true;
			}
			if(onSelf&&cr.Param[(193)]>=1)
			{
				e_PsiUse(cr);
				return true;
			}
			else if(onSelf&&cr.Param[(193)]<=0)
			{
				cr.Say((11),"У вас нет пси-способностей");
				return true;
			}
			else if((@targetCr!=null)&&cr.Param[(193)]>=1&&targetCr.IsPlayer()){
				if(cr.Stat[(193)]>100)cr.StatBase[(193)]-=100;
				else{
					cr.StatBase[(195)]+=101-cr.Stat[(193)];
					cr.StatBase[(193)]=1;
				}
				cr.ParamBase[(761)]=1;
				targetCr.ParamBase[(761)]=1;
				cr.ParamBase[(760)]=cr.Id;
				cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),6000,cr.HexX,cr.HexY);
				cr.AddTimeEvent("cte_bodyswap",5*60*__TimeMultiplier,(60),0);
				SwapCritters(cr,targetCr,true,false);
				cr.Say((11),"Ваш разум отправляется блуждать в астрал");
				targetCr.Say((11),"Ваш разум был изгнан из вашего тела");
				cr.Disconnect();
				targetCr.Disconnect(); 
				
				return true;
			} 
			
			if((@targetItem!=null)&&(((targetItem.Flags)&((0x40000000)))!=0)&&targetItem.Accessory==(1)&&targetItem.CritId==cr.Id)
			{
				if(isPlayer)
				EditRadioSettings(cr,targetItem);
				return true;
			}
			
			if((@targetItem!=null)&&(targetItem.GetProtoId()==(47)||targetItem.GetProtoId()==(91)))
			{
				cr.RunClientScript("client_screen_firstais@ShowScreen",targetItem.Id,targetItem.Val4,targetItem.GetProtoId()==(47)?0:1,"",null);
				return true;
			}
			
			if((@targetItem!=null)&&targetItem.Accessory==(1))
			{
				if(TryDisassembleItem(cr,targetItem))
				return true;
			}
			
			cr.SayMsg((11),(3),(10202));
		}
		break;
		case(213):
		{
			
			if(isPlayer&&IsStill(targetItem)&&UseStill(cr,targetItem,skill,null))
			return true; 
			
			if(onSelf)
			@targetCr=cr;
			string str="Износ - ";
			
			if((@targetCr!=null)&&targetCr.Stat[(67)]==(10))
			{
				if(cr.Timeout[(232)]>0)
				{
					cr.SayMsg((11),(3),3401);
					return true;
				}
				
				robotRepairSkill(cr,targetCr,false);
				ChangeCritterSpeed(targetCr);
				cr.TimeoutBase[(232)]=(__FullSecond+((20)*__TimeMultiplier));
				return true;
			}
			if((@targetItem!=null)&&targetItem.Accessory==(1)&&targetItem.IsDeteriorable())
			{
				if(IsHaveBlade(targetItem.GetProtoId()))
				{
					Item@activeHand=cr.GetItem(0,(1));
					if(@activeHand==null&&activeHand.GetProtoId()!=(278))
					{
						cr.Say((11),"Для заточки лезвия нужен кремень в руке.");
						return true;
					}
					if(!ltp_sharp_inited)
					ltp_sharp_init();
					StartProcess(cr,(36),targetItem.Id,0,0,10);
					return true;
				}
				else if(TryRepairItem(cr,targetItem))
				return true;
			}
			cr.SayMsg((11),(3),(10202));
		}
		break;
		case(208):
		{
			if(cr.Mode[(510)]!=0)
			{
				if(cr.ParamBase[(701)]==1)
				{
					cr.ParamBase[(701)]=0;
					cr.Say((11),"режим суперневидимости выключен");
				}
				cr.ModeBase[(510)]=0;
			}
			else if(not isPlayer)
			cr.ModeBase[(510)]=1;
			else if(cr.GetAccess()>=(2))
			{
				cr.ParamBase[(701)]=1;
				cr.PerkBase[(316)]=1;
				cr.ModeBase[(510)]=1;
				cr.Say((11),"режим суперневидимости включен");
			}
			else
			{
				if(cr.Timeout[(243)]>0)
				{
					if(cr.Param[(67)]<(5))
					{
						cr.Say((6),"блок");
						cr.StatBase[(186)]=1;
					}
					else
					cr.SayMsg((11),(3),(792));
				}
				else if((cr.Timeout[(238)]>10000000))
				cr.SayMsg((11),(3),(791));    
				
				else
				cr.ModeBase[(510)]=1;
			}
		}
		break;
		case(210):
		{
			if((@targetItem!=null))
			{
				cr.SayMsg((11),(3),(10202));
			}
			else if((@targetCr!=null))
			{
				if(targetCr.Param[(182)]!=0)
				{
					cr.ShowContainer(targetCr,null,(5));
				}
				else
				{
					
					if(targetCr.IsDead())
					{
						cr.Action((10),0,null);
						cr.ShowContainer(targetCr,null,(4));
					}
					
					else
					{
						if(isPlayer&&cr.Timeout[(235)]>0)
						cr.SayMsg((11),(3),(3401));
						else
						{
							
							cr.ShowContainer(targetCr,null,(5));
							cr.TimeoutBase[(235)]=(__FullSecond);
							cr.StatBase[(108)]=0;
							cr.StatBase[(109)]=0;
						}
					}
				}
			}
			else
			{
				cr.SayMsg((11),(3),(10202));
			}
		}
		break;
		case(206):
		{
			if((@targetItem!=null)||(@targetScen!=null))
			{
				cr.SayMsg((11),(3),(10202));
				break;
			}
			
			if(not(@targetCr!=null))
			@targetCr=cr;
			bool is_self=(targetCr.Id==cr.Id); 
			
			if(targetCr.Stat[(67)]==(10))
			{
				cr.SayMsg((11),(3),(10202));
				break;
			}
			
			if(targetCr.IsDead())
			{
				cr.SayMsg((11),(3),(3400));
				break;
			}       
			
			if(isPlayer&&cr.Timeout[(230)]>0)
			{
				cr.SayMsg((11),(3),(3401));
				break;
			} 
			
			ProccessFirstAidSkill(cr,targetCr,false);
		}
		break;
		case(207):
		{
			if((@targetItem!=null)||(@targetScen!=null))
			{
				cr.SayMsg((11),(3),(10202));
				break;
			}
			
			if(not(@targetCr!=null))
			@targetCr=cr;
			bool is_self=(targetCr.Id==cr.Id);
			
			if(targetCr.Stat[(67)]==(10))
			{
				cr.SayMsg((11),(3),(10202));
				break;
			}
			
			if(targetCr.IsDead())
			{
				cr.SayMsg((11),(3),(3400));
				break;
			}
			
			if(isPlayer&&cr.Timeout[(231)]>0)
			{
				cr.SayMsg((11),(3),(3401));
				break;
			} 
			
			ProccessDoctorSkill(cr,targetCr,false);                                  
			
		}
		break;
		case(209):
		{
			if((((@targetCr!=null))&&(targetCr.Param[(182)]!=0))||((onSelf)&&(cr.Param[(182)]!=0)))
			{
				if(cr.Timeout[(234)]>0)
				{
					cr.SayMsg((11),(3),3401);
				}
				else
				{
					if((@targetCr!=null)&&((targetCr.Param[(182)]>>29)&0x1)==0)
					{
						cr.TimeoutBase[(234)]=(__FullSecond+((30)*__TimeMultiplier));
						if((cr.Param[(209)]+Random(0,150)+(cr.Stat[(6)]-5)*5)>300-Random(0,50))
						{
							Item@[]items;
							uint8 nohome=(targetCr.Param[(182)]>>30)&0x1;
							int16 xp=(Random(60,400)-cr.Param[(209)]);
							
							if(targetCr.IsNpc())
							{
								targetCr.ParamBase[(517)]=nohome;
							}
							targetCr.GetItems((1),items);
							targetCr.GetItems((2),items);
							DeleteItems(items);
							cr.AddItem((693),1);
							targetCr.ParamBase[(182)]=0;
							cr.SayMsg((11),(3),12953);
							if(xp<0)
							cr.ParamBase[(76)]+=20;
							else
							cr.ParamBase[(76)]+=xp;
						}
						else
						cr.SayMsg((11),(3),12944);
					}
					
					if(onSelf)
					{
						cr.TimeoutBase[(234)]=(__FullSecond+((30)*__TimeMultiplier));
						if((cr.Param[(209)]+Random(0,150)+(cr.Stat[(6)]-5)*5)>300-Random(0,50))
						{
							uint16 xp=(Random(60,400)-cr.Param[(209)]);
							cr.DeleteItem((692),2);
							cr.AddItem((693),1);
							cr.ParamBase[(182)]=0;
							cr.SayMsg((11),(3),12953);
							if(xp>0)
							cr.ParamBase[(76)]+=xp;
						}
						else
						cr.SayMsg((11),(3),12944);
					}
				}   
				
			} 
			
		}
		break;
		case(211):
		{
			
			if((@targetItem!=null))
			{
				uint16 pid=targetItem.GetProtoId();
				if((pid==(206)||pid==(209)||pid==(545))&&
				OnUseExplode(cr,targetItem,null,null,null,0))
				return true;
			}
			
			cr.SayMsg((11),(3),(10202));
		}
		break;
		default:
		{
			cr.SayMsg((11),(3),(10202));
		}
		break;
	}
	
	return true;
}                

bool ltp_reload_inited=false;

void ltp_reload_init()
{
	PROCESS@___pfunc=@process_reload;any ___pany;___pany.store(@___pfunc);RegisterProcess((32),___pany);
	ltp_reload_inited=true;
}

uint process_reload(Critter@cr,int&param0,int&param1,int&param2)
{
	if(param0==-1&&(cr is null)){param0=int((32));return(0xF035BCF3);} 
	
	Item@weapon=GetItem(param0);
	if(@weapon==null)
	return 0;
	
	Item@ammo;
	if(param1!=0)
	@ammo=GetItem(param1); 
	
	if(not(@ammo!=null)||(weapon.AmmoCount>0&&weapon.AmmoPid!=ammo.GetProtoId()))
	{
		if(weapon.AmmoPid!=0)
		{
			Item@existAmmo=cr.GetItem(weapon.AmmoPid,-1);
			if(not(@existAmmo!=null))
			cr.AddItem(weapon.AmmoPid,weapon.AmmoCount);
			else
			existAmmo.SetCount(existAmmo.GetCount()+(weapon.AmmoCount));
		}
		weapon.AmmoCount=0;
	}
	
	if((@ammo!=null))
	{
		uint count=(((ammo.GetCount())<(weapon.Proto.Weapon_MaxAmmoCount-weapon.AmmoCount))?(ammo.GetCount()):(weapon.Proto.Weapon_MaxAmmoCount-weapon.AmmoCount));
		weapon.AmmoCount+=count;
		weapon.AmmoPid=ammo.GetProtoId();
		do{if(ammo.GetCount()>(count))
			ammo.SetCount(ammo.GetCount()-(count));else
			DeleteItem(ammo);}while(false);
	}
	
	weapon.Update();
	
	return 0;
}  

void critter_reload_weapon(Critter&cr,Item&weapon,Item@ammo)
{
	
	if(weapon.Proto.Weapon_Caliber==0)
	{
		if(weapon.GetProtoId()==(390)||weapon.GetProtoId()==(1227)||weapon.GetProtoId()==(1228)||weapon.GetProtoId()==(1229))
		{
			if(((__Hour)>=22||(__Hour)<=6))
			cr.SayMsg((11),(3),(10240));
			else
			{
				weapon.AmmoCount=weapon.Proto.Weapon_MaxAmmoCount;
				weapon.Update();
			}
		}
		else if(weapon.GetProtoId()==(596))
		{
			weapon.AmmoCount=weapon.Proto.Weapon_MaxAmmoCount;
			weapon.Update();      
			
		}
		
		return;
	}      
	
	if(cr.IsPlayer())
	{
		if(cr.GetTimeEvents((10),null,null,null)>0)cr.EraseTimeEvents((10));
		
		uint16 weapPid=weapon.GetProtoId(),skill=1,reloadBaseTime=0;
		
		switch(weapPid)
		{
			case(1040):
			reloadBaseTime=(500);
			skill=cr.ParamBase[(200)];
			break;
			case(313):
			reloadBaseTime=(500);
			skill=cr.ParamBase[(200)];
			break;
			case(1037):
			reloadBaseTime=(500);
			skill=cr.ParamBase[(200)];
			break;
			case(1406):
			reloadBaseTime=(500);
			skill=cr.ParamBase[(200)];
			break;
			case(300):
			reloadBaseTime=(500);
			skill=cr.ParamBase[(200)];
			break;
			case(122):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(8):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(22):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(18):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(404):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(241):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(388):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(1407):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(1412):
			reloadBaseTime=(2000);
			skill=cr.ParamBase[(200)];
			break;
			case(1405):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(385):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(94):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(242):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(1039):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(10):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(287):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(299):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(23):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(405):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(143):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(351):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(161):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(162):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(1408):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(1403):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(200)];
			break;
			case(1409):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(1422):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(9):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(296):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(332):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(1402):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(578):
			reloadBaseTime=(6000);
			skill=cr.ParamBase[(200)];
			break;
			case(11):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(594):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(1401):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(1400):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(1415):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(1416):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(1410):
			reloadBaseTime=(1000);
			skill=cr.ParamBase[(201)];
			break;
			case(1036):
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(201)];
			break;
			case(16):
			reloadBaseTime=(4000);
			skill=cr.ParamBase[(202)];
			break;
			case(402):
			reloadBaseTime=(4000);
			skill=cr.ParamBase[(202)];
			break;
			case(1520):
			reloadBaseTime=(4000);
			skill=cr.ParamBase[(202)];
			break;
			case(1404):
			reloadBaseTime=(8000);
			skill=cr.ParamBase[(202)];
			break;
			case(600):
			reloadBaseTime=(8000);
			skill=cr.ParamBase[(202)];
			break;
			default:
			reloadBaseTime=(10000);
			skill=cr.ParamBase[(200)];
			break;
		}
		
		if(not(@ammo!=null)||(weapon.AmmoCount>0&&weapon.AmmoPid!=ammo.GetProtoId()))
		{
			if(weapon.AmmoPid!=0)
			{
				Item@existAmmo=cr.GetItem(weapon.AmmoPid,-1);
				if(not(@existAmmo!=null))
				cr.AddItem(weapon.AmmoPid,weapon.AmmoCount);
				else
				existAmmo.SetCount(existAmmo.GetCount()+(weapon.AmmoCount));
			}
			weapon.AmmoCount=0;
			weapon.Update();
			return;
		}
		
		int reloadTime=((6000)+reloadBaseTime)-((cr.StatBase[(5)]*200)+(skill*40));
		reloadTime=(((reloadTime)>(10000))?(10000):(((reloadTime)<(1000))?(1000):(reloadTime)));
		if((@ammo!=null))weapon.Val1=ammo.Id;
		else weapon.Val1=0;
		if(reloadBaseTime==(1000)||reloadBaseTime==(500))cr.AddTimeEvent("cte_slowReload_one",reloadTime*__TimeMultiplier*0.001,(10),weapon.Id);
		else cr.AddTimeEvent("cte_slowReload",reloadTime*__TimeMultiplier*0.001,(10),weapon.Id);
		cr.ModeBase[(540)]=2;
		weapon.SetEvent((6),"e_ReloadInterrupt");
	}
	else
	{
		
		if(not(@ammo!=null)||(weapon.AmmoCount>0&&weapon.AmmoPid!=ammo.GetProtoId()))
		{
			if(weapon.AmmoPid!=0)
			{
				Item@existAmmo=cr.GetItem(weapon.AmmoPid,-1);
				if(not(@existAmmo!=null))
				cr.AddItem(weapon.AmmoPid,weapon.AmmoCount);
				else
				existAmmo.SetCount(existAmmo.GetCount()+(weapon.AmmoCount));
			}
			weapon.AmmoCount=0;
		} 
		
		if((@ammo!=null))
		{
			uint count=(((ammo.GetCount())<(weapon.Proto.Weapon_MaxAmmoCount-weapon.AmmoCount))?(ammo.GetCount()):(weapon.Proto.Weapon_MaxAmmoCount-weapon.AmmoCount));
			weapon.AmmoCount+=count;
			weapon.AmmoPid=ammo.GetProtoId();
			do{if(ammo.GetCount()>(count))
				ammo.SetCount(ammo.GetCount()-(count));else
				DeleteItem(ammo);}while(false);
		}
		
		weapon.Update();
		
	}
}

void e_ReloadInterrupt(Item&item,Critter&crit,uint8 fromSlot)
{
	if(fromSlot==(1))
	{
		ChangeCritterSpeed(crit);
		crit.EraseTimeEvents((10));
		item.SetEvent((6),null);
	}
} 

uint cte_slowReload_one(Critter&cr,int identifier,uint&rate)
{
	Item@weapon=cr.GetItemById(rate);
	if(!(@weapon!=null)){ChangeCritterSpeed(cr);return 0;}
	if(weapon.Id!=cr.GetItem(0,(1)).Id){ChangeCritterSpeed(cr);return 0;}
	if(weapon.AmmoCount>=weapon.Proto.Weapon_MaxAmmoCount){ChangeCritterSpeed(cr);return 0;}
	
	Item@ammo;
	if(weapon.Val1>0)@ammo=cr.GetItemById(weapon.Val1);
	
	if((@ammo!=null))
	{
		weapon.AmmoCount++;
		weapon.AmmoPid=ammo.GetProtoId();
		do{if(ammo.GetCount()>(1))
			ammo.SetCount(ammo.GetCount()-(1));else
			DeleteItem(ammo);}while(false);
	}
	weapon.Update();
	
	if(!(@ammo!=null)){ChangeCritterSpeed(cr);return 0;}
	if(weapon.AmmoCount>=weapon.Proto.Weapon_MaxAmmoCount){ChangeCritterSpeed(cr);return 0;}
	return __TimeMultiplier;
}

uint cte_slowReload(Critter&cr,int identifier,uint&rate)
{
	Item@weapon=cr.GetItemById(rate);
	if(!(@weapon!=null)){ChangeCritterSpeed(cr);return 0;}
	if(weapon.Id!=cr.GetItem(0,(1)).Id){ChangeCritterSpeed(cr);return 0;}
	
	Item@ammo;
	if(weapon.Val1>0)@ammo=cr.GetItemById(weapon.Val1);
	
	if((@ammo!=null))
	{
		uint count=(((ammo.GetCount())<(weapon.Proto.Weapon_MaxAmmoCount-weapon.AmmoCount))?(ammo.GetCount()):(weapon.Proto.Weapon_MaxAmmoCount-weapon.AmmoCount));
		weapon.AmmoCount+=count;
		weapon.AmmoPid=ammo.GetProtoId();
		do{if(ammo.GetCount()>(count))
			ammo.SetCount(ammo.GetCount()-(count));else
			DeleteItem(ammo);}while(false);
	}
	weapon.Update();
	ChangeCritterSpeed(cr);
	return 0;
} 

uint cte_limb_management(Critter&cr,int identifier,uint&rate){
	Map@map=cr.GetMap();
	bool emoteSaid=false;
	bool screen=false;
	int maxHP=cr.Stat[(7)];
	int i=(730);
	int currentHP=0;
	int roll=Random(0,1);
	if(cr.ParamBase[(739)]>0)cr.ParamBase[(739)]-=4;
	if(cr.ParamBase[(739)]>0.8*maxHP){
		cr.Say((11),"Вы чувствуете смертельный холод и усталость.");
	}else if(cr.ParamBase[(739)]>0.6*maxHP){
		cr.Say((11),"Вы чувствуете сильную усталость и головокружение");
	}else if(cr.ParamBase[(739)]>0.4*maxHP){
		cr.Say((11),"Вы чувствуете усталость и головокружение");
	}else if(cr.ParamBase[(739)]>0.2*maxHP){
		cr.Say((11),"Вы чувствуете легкое головокружение");
	}
	if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-cr.ParamBase[(739)]&&!cr.IsDead())cr.ParamBase[(72)]=maxHP-__DeadHitPoints-cr.ParamBase[(739)];
	while(i<=(737)){
		currentHP=cr.ParamBase[i];
		if(currentHP>0.8*maxHP&&!cr.IsDead()){
			switch(i){
				case(731):
				if(roll==0){map.PlaySound("head_damage1.ogg",cr.HexX,cr.HexY,1);}
				if(roll==1){map.PlaySound("head_damage2.ogg",cr.HexX,cr.HexY,1);}
				roll=-1;
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваш корпус болит просто невыносимо.");
				if(cr.StatBase[(67)]==(10))cr.Say((5),"Корпус искрит");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###КРИТИЧЕСКИЕ ПОВРЕЖДЕНИЯ КОРПУСА. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				break;
				case(730):
				if(roll==0){map.PlaySound("head_damage1.ogg",cr.HexX,cr.HexY,1);}
				if(roll==1){map.PlaySound("head_damage2.ogg",cr.HexX,cr.HexY,1);}
				roll=-1;
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша голова в ужасном состоянии. В глазах темнеет, вы почти теряете сознание.");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###КРИТИЧЕСКИЕ ПОВРЕЖДЕНИЯ ПРОЦЕССОРА. ТРЕБУЕТСЯ РЕМОНТ.###");
				FlushScreen(cr,0,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),13000);
				if((Random(0,1)==0)&&!cr.IsKnockout()&&!cr.IsDead()){
					cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(18,25),cr.HexX,cr.HexY);
					cr.Say((5),"Шатаясь, падает на землю");
					if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
					if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
					screen==true;
				}
				else if((Random(0,1)==1)&&!cr.IsKnockout()&&!cr.IsDead()){
					cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(10,15),cr.HexX,cr.HexY);
					cr.Say((5),"Шатается");
					if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
					if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
					screen==true;
				}
				if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
				break;
				case(732):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"В глазах все темнеет...");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###КРИТИЧЕСКИЕ ПОВРЕЖДЕНИЯ СЕНСОРОВ. ТРЕБУЕТСЯ РЕМОНТ.###");
				FlushScreen(cr,0,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				FlushScreen(cr,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				if(cr.IsRuning){
					cr.Say((5),"Валится на бегу");
					cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(18,25),cr.HexX,cr.HexY);
					FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
					FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
					
				}
				break;
				case(734):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша правая рука ужасно болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(2,7);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				break;
				case(735):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша левая рука ужасно болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(2,7);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				break;
				case(737):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша левая нога ужасно болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(2,7);
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(12,20),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				break;
				case(736):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша правая нога ужасно болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(2,7);
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(12,20),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				break;
			}
		}
		else if(currentHP>0.6*maxHP&&!cr.IsDead()){
			switch(i){
				case(731):
				if(roll==0){map.PlaySound("head_damage1.ogg",cr.HexX,cr.HexY,1);}
				if(roll==1){map.PlaySound("head_damage2.ogg",cr.HexX,cr.HexY,1);}
				roll=-1;
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Вы чувствуете сильную боль в груди.");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###ЗНАЧИТЕЛЬНЫЕ ПОВРЕЖДЕНИЯ КОРПУСА. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(cr.StatBase[(67)]==(10))cr.Say((5),"Корпус искрит");
				if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(5,12),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),8000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,8000);
				screen==true;
				break;
				case(730):
				if(roll==0){map.PlaySound("head_damage1.ogg",cr.HexX,cr.HexY,1);}
				if(roll==1){map.PlaySound("head_damage2.ogg",cr.HexX,cr.HexY,1);}
				roll=-1;
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"У вас кружится и болит голова.");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###ЗНАЧИТЕЛЬНЫЕ ПОВРЕЖДЕНИЯ ПРОЦЕССОРА. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(!emoteSaid&&!cr.IsKnockout()&&!cr.IsDead())cr.Say((5),"Шатается");
				emoteSaid=true;
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),8000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,8000);
				screen==true;
				if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(10,15),cr.HexX,cr.HexY);
				cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(7,12),cr.HexX,cr.HexY);
				break;
				case(732):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"В глазах все темнеет...");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###ЗНАЧИТЕЛЬНЫЕ ПОВРЕЖДЕНИЯ СЕНСОРОВ. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				break;
				case(734):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша правая рука болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(1,5);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),8000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,8000);
				screen==true;
				break;
				case(735):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша левая рука болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(1,5);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),8000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,8000);
				screen==true;
				break;
				case(737):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша левая нога болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(1,5);
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(3,8),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),8000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,8000);
				screen==true;
				break;
				case(736):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша правая нога болит.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(1,5);
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(3,8),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),8000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,8000);
				screen==true;
				break;
			}
		}
		else if(currentHP>0.4*maxHP&&!cr.IsDead()){
			switch(i){
				case(731):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Вы ощущаете боль в груди.");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###КОРПУС ПОВРЕЖДЕН. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(4,8),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),5000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,5000);
				screen==true;
				break;
				case(730):
				map.PlaySound("head_damage1.ogg",cr.HexX,cr.HexY,1);
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"У вас легкое головокружение");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###ПРОЦЕССОР ПОВРЕЖДЕН. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
				if(!emoteSaid&&!cr.IsKnockout()&&!cr.IsDead())cr.Say((5),"Шатается");
				emoteSaid=true;
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xFF)&0xFF)<<16)|(((0xFF)&0xFF)<<8)|((0xFF)&0xFF)))),5000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xFF)&0xFF)<<16)|(((0xFF)&0xFF)<<8)|((0xFF)&0xFF)))),0,5000);
				screen==true;
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(4,8),cr.HexX,cr.HexY);
				break;
				case(732):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"В глазах все мутнеет...");
				if(cr.StatBase[(67)]==(10))cr.Say((11),"###СЕНСОРЫ ПОВРЕЖДЕНЫ. ТРЕБУЕТСЯ РЕМОНТ.###");
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),10000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,10000);
				screen==true;
				break;
				case(734):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша правая рука побаливает.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(0,1);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),5000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,5000);
				screen==true;
				break;
				case(735):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша левая рука побаливает.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(0,1);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),5000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,5000);
				screen==true;
				break;
				case(737):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша левая нога побаливает.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(0,1);
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(2,4),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),5000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,5000);
				screen==true;
				break;
				case(736):
				if(cr.StatBase[(67)]!=(10))cr.Say((11),"Ваша правая нога побаливает.");
				if(cr.ParamBase[(72)]>=0)cr.ParamBase[(72)]-=Random(0,1);
				if(cr.IsRuning)cr.ToKnockout((((Random(0,1)==1?true:false))?(82):(83)),(((Random(0,1)==1?true:false))?(86):(87)),(((Random(0,1)==1?true:false))?(88):(89)),Random(2,4),cr.HexX,cr.HexY);
				if(screen==false)FlushScreen(cr,0,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),5000);
				if(screen==false)FlushScreen(cr,((uint((0xFF<<24)|(((0xC8)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,5000);
				screen==true;
				break;
			}
		}
		else if(currentHP>0.2*maxHP&&!cr.IsDead()){
			if(cr.ParamBase[(72)]>maxHP-__DeadHitPoints-currentHP&&cr.StatBase[(67)]!=(10))cr.ParamBase[(72)]=maxHP-__DeadHitPoints-currentHP;
		}
		if(cr.StatBase[(67)]!=(10)){
			if((currentHP<0.2*maxHP)&&(currentHP>0))cr.ParamBase[i]-=cr.Stat[(13)];
			else if((currentHP<0.3*maxHP)&&(currentHP>0))cr.ParamBase[i]-=cr.Stat[(13)]*0.8;
			else if((currentHP<0.4*maxHP)&&(currentHP>0))cr.ParamBase[i]-=cr.Stat[(13)]*0.6;
			else if((currentHP<0.5*maxHP)&&(currentHP>0))cr.ParamBase[i]-=cr.Stat[(13)]*0.4;
			else if((currentHP<0.6*maxHP)&&(currentHP>0))cr.ParamBase[i]-=cr.Stat[(13)]*0.2;
			else if((currentHP<0.7*maxHP)&&(currentHP>0))cr.ParamBase[i]-=cr.Stat[(13)]*0.1;
		}
		if(currentHP>maxHP-__DeadHitPoints&&cr.StatBase[(67)]!=(10))cr.ParamBase[i]=maxHP-__DeadHitPoints;
		if(currentHP<0)cr.ParamBase[i]=0;
		i++;
	}
	return(4*60*__TimeMultiplier);
}   

void critter_init(Critter&cr,bool firstTime)
{
	if(firstTime)
	{
		if(cr.IsPlayer())
		{
			AddNewCritterHistoryBase(cr);
			GameVar@TotalPlayers=GetGlobalVar((4));
			if(TotalPlayers.GetValue()<cr.Id)
			TotalPlayers.opAssign(cr.Id);
			
			uint traits=0;
			for(uint i=(__TraitBegin);i<=(__TraitEnd);i++)
			{
				if(cr.TraitBase[i]!=0&&traits<2)
				{
					cr.TraitBase[i]=1;
					traits++;
				}
				else
				cr.TraitBase[i]=0;
			}
			
			if(cr.StatBase[(71)]<0||cr.StatBase[(71)]>1)
			cr.StatBase[(71)]=0;
			if(cr.StatBase[(70)]<14||cr.StatBase[(70)]>80)
			cr.StatBase[(70)]=25;
			for(uint i=(0);i<=(6);i++)
			cr.StatBase[i]=(((cr.StatBase[i])>(10))?(10):(((cr.StatBase[i])<(1))?(1):(cr.StatBase[i])));
			
			if((cr.StatBase[(0)]+cr.StatBase[(1)]+cr.StatBase[(2)]+
			cr.StatBase[(3)]+cr.StatBase[(4)]+cr.StatBase[(5)]+cr.StatBase[(6)])!=__StartSpecialPoints)
			{
				for(uint i=(0);i<=(6);i++)
				cr.StatBase[i]=5;
			}
			
			cr.StatBase[(28)]=500;                           
			
			cr.ChangeCrType(cr.Stat[(71)]==(0)?((106)):((4)));
			cr.StatBase[(112)]=cr.CrType;
			
		}
		
		if(cr.TagSkill[(226)]<int((__SkillBegin))||cr.TagSkill[(226)]>int((__SkillEnd)))
		cr.TagSkillBase[(226)]=0;
		if(cr.TagSkill[(227)]<int((__SkillBegin))||cr.TagSkill[(227)]>int((__SkillEnd)))
		cr.TagSkillBase[(227)]=0;
		if(cr.TagSkill[(228)]<int((__SkillBegin))||cr.TagSkill[(228)]>int((__SkillEnd)))
		cr.TagSkillBase[(228)]=0;
		if(cr.TagSkill[(226)]==cr.TagSkill[(227)])
		cr.TagSkillBase[(226)]=0;
		if(cr.TagSkill[(227)]==cr.TagSkill[(228)])
		cr.TagSkillBase[(227)]=0;
		if(cr.TagSkill[(228)]==cr.TagSkill[(226)])
		cr.TagSkillBase[(228)]=0;
		
		CritterGenerate(cr);
		cr.StatBase[(72)]=cr.Stat[(7)];  
		
		cr.ParamBase[(730)]=0;
		cr.ParamBase[(732)]=0;
		cr.ParamBase[(733)]=0;
		cr.ParamBase[(731)]=0;
		cr.ParamBase[(735)]=0;
		cr.ParamBase[(734)]=0;
		cr.ParamBase[(737)]=0;
		cr.ParamBase[(736)]=0;
		
		cr.ParamBase[(738)]=1;
		cr.AddTimeEvent("cte_limb_management",0,(52));  
		
		if(cr.Stat[(112)]==15)brahminInitSearch(cr);
		
		cr.StatBase[(75)]=cr.Stat[(8)]*100;
		
		for(int i=(__ReputationBegin);i<=599;i++)cr.ParamBase[i]=int(0x80000000);
		
		if(cr.IsPlayer())
		{
			for(uint i=(0);i<=(6);i++)
			cr.StatBase[i]=(((cr.StatBase[i])>(10))?(10):(((cr.StatBase[i])<(1))?(1):(cr.StatBase[i])));
			
			cr.StatBase[(85)]=100;
			cr.StatBase[(82)]=0;
			cr.StatBase[(83)]=0;
			cr.StatBase[(106)]=1;
			cr.StatBase[(69)]=(1); 
			
			skin(cr,cr.StatBase[(67)]);
			cr.StatBase[(67)]=0;
			
		}
		else
		{
			cr.ChangeCrType(cr.StatBase[(112)]);
			if(cr.Stat[(77)]!=0)
			NpcProcessLevel(cr);
		}
	}
	else
	{
		if(cr.IsPlayer()){
			CheckFaction(cr,true);
		}     
		
		Item@armor=cr.GetItem(0,(3));
		if(cr.Stat[(112)]==0)
		cr.StatBase[(112)]=(cr.Stat[(71)]==(0)?((106)):((4)));
		if(not(@armor!=null))
		{
			uint crType=cr.Stat[(112)];
			if(crType==0)
			crType=(cr.Stat[(71)]==(0)?((106)):((4)));
			cr.StatBase[(112)]=crType;
			if(cr.CrType!=crType)
			cr.ChangeCrType(crType);
		}
		
		if(cr.IsPlayer())RestartHair(cr);
		
		if(cr.Stat[(112)]==15)brahminInitSearch(cr);
		cr.EraseTimeEvents((52));
		cr.AddTimeEvent("cte_limb_management",0,(52)); 
		
		if(not(@armor!=null)&&cr.Stat[(114)]!=0)
		{
			switch(cr.Stat[(114)])
			{
				case(1):
				cr.StatBase[(32)]-=3;
				cr.StatBase[(62)]-=30;
				break;
				case(2):
				cr.StatBase[(62)]-=20;
				break;
				case(3):
				cr.StatBase[(32)]-=4;
				cr.StatBase[(62)]-=60;
				break;
				case(4):
				cr.StatBase[(32)]-=4;
				cr.StatBase[(62)]-=75;
				break;
				case(5):
				cr.StatBase[(35)]-=1;
				break;
				default:
				break;
			}
			cr.StatBase[(114)]=0;
		} 
		
		for(uint i=(__TimeoutBegin);i<=(__TimeoutEnd);i++)
		if(i!=(238)&&cr.Timeout[i]>int((((5)*__TimeMultiplier*3600))))
		cr.TimeoutBase[i]=__FullSecond; 
		
		cr.EraseTimeEvents(0);
	}
	
	if(cr.IsPlayer()&&cr.StatBase[(139)]<10000)
	{
		cr.StatBase[(139)]=10000;
	}
	
	ChangeCritterSpeed(cr);
	
	manager_critter_init(cr,firstTime);
}  

void critter_finish(Critter&cr,bool toDelete)
{
	if(cr.IsPlayer())
	{
		CheckFaction(cr,false);
		cr.StatBase[(137)]=0;
	}
	if(toDelete&&cr.Stat[(113)]!=0)
	{
		Item@block=::GetItem(cr.Stat[(113)]);
		if((@block!=null))
		DeleteItem(block);
		cr.StatBase[(113)]=0;
	} 
	
	manager_critter_finish(cr,toDelete);
}  

void critter_idle(Critter&cr)
{
	
	if(cr.Timeout[(244)]==0&&!cr.IsDead())
	{
		if(cr.Mode[(526)]==0&&cr.Timeout[(238)]==0&&cr.StatBase[(72)]<cr.Stat[(7)])
		{
			cr.StatBase[(72)]+=cr.Stat[(13)];
			if(cr.StatBase[(72)]>cr.Stat[(7)])
			cr.StatBase[(72)]=cr.Stat[(7)];
			ChangeCritterSpeed(cr);
		}
		
		cr.TimeoutBase[(244)]=(__FullSecond+((2)*__TimeMultiplier*60));
	} 
	
	if(cr.IsPlayer())
	{
		if(cr.StatBase[(190)]<(cr.StatBase[(72)]+50))cr.StatBase[(190)]++;
		
		GameVar@weariness=GetLocalVar((9960),cr.Id);
		if(weariness>0)
		{
			weariness.opAddAssign(Random(-1,-2));
		}  
		
		if(cr.ParamBase[(95)]>0)
		cr.ParamBase[(95)]-=1;
		
		if(uint(cr.Param[(189)])==0)
		{
			Map@map=cr.GetMap();
			if(!(map is null))
			{
				qmap_critter_in(map.Id,cr);
			}
		}
	}
	manager_critter_idle(cr);
}     

void critter_dead(Critter&cr,Critter@killer)
{
	if(killer!is null&&killer.IsPlayer())
	{
		ExpBarTimer(killer,(60)/killer.StatBase[(124)]); 
		
	}
	
	Map@map=cr.GetMap();
	if(!(@map!=null))
	{
		
	}
	
	if(cr.IsNpc())
	cr.DropPlanes();
	if((@map!=null)&&cr.Mode[(528)]!=0)
	{
		Item@blocker=map.AddItem(cr.HexX,cr.HexY,(820),1);
		if((@blocker!=null))
		cr.StatBase[(113)]=blocker.Id;
	}
	
	if(!(killer is null)&&cr.IsNpc())
	{
		killer.TimeoutBase[(237)]+=((30)*__TimeMultiplier);
	}
	
	manager_critter_dead(cr,killer);
}  

void critter_respawn(Critter&cr)
{
	cr.TimeoutBase[(241)]=0;
	if(cr.CrType==115)
	{
		uint body=cr.Stat[(112)];
		if(body==0)
		body=(cr.Stat[(71)]==(0)?((106)):((4)));
		cr.ChangeCrType(body);
	}
	else if(cr.CrType==81)
	{
		Item@weapon=cr.AddItem((596),1);
		cr.MoveItem(weapon.Id,1,(1));
		weapon.Update();
	}
	else if(cr.CrType==51||cr.CrType==60||cr.CrType==100)
	{
		Item@weapon=cr.AddItem((595),1);
		cr.MoveItem(weapon.Id,1,(1));
		weapon.Update();
	}
	
	if(cr.Param[(180)]!=0)
	DropParalysisInstant(cr);
	if(cr.Param[(73)]!=0)
	DropPoison(cr);
	if(cr.Param[(74)]!=0)
	DropRadiation(cr);
	
	if(cr.Stat[(113)]!=0)
	{
		Item@block=::GetItem(cr.Stat[(113)]);
		if((@block!=null))
		DeleteItem(block);
		cr.StatBase[(113)]=0;
	}
	
	manager_critter_respawn(cr);
}    

void map_critter_in(Map&map,Critter&cr)
{
	if(cr.IsPlayer())
	{
		qmap_critter_in(map.Id,cr);
		
		uint16 locPid=map.GetLocation().GetProtoId();
		if((LocIsCity((locPid))))
		{
			GameVar@lastCityVar=GetLocalVar((3050),cr.Id);
			if(lastCityVar is null)
			return;
			lastCityVar=locPid;
		}
	}  
	
	manager_map_critter_in(map,cr);
}  

void map_critter_out(Map&map,Critter&cr)
{
	if(cr.IsPlayer())
	{
		qmap_critter_out(map.Id,cr);
	}
	
	manager_map_critter_out(map,cr);
}   

void karma_voting(Critter&crFrom,Critter&crTo,bool valUp)
{
	
	crTo.StatBase[(100)]+=(valUp?int(5):-10);
	crFrom.TimeoutBase[(242)]=__FullSecond+((4)*__TimeMultiplier*3600);                                   
	
}     

bool check_look(Map&map,Critter&cr,Critter&opponent)
{
	
	if(map.GetProtoId()==(92)&&opponent.IsPlayer()&&cr.IsPlayer()&&cr.GetAccess()<(2))
	return false;
	
	uint16 hexX=cr.HexX,hexY=cr.HexY,oppHexX=opponent.HexX,oppHexY=opponent.HexY;
	
	uint dist=GetDistantion(hexX,hexY,oppHexX,oppHexY);
	
	if(opponent.Param[(701)]!=0&&(opponent.Param[(701)]-1)<dist&&(!(cr.IsPlayer())||cr.IsPlayer()&&cr.GetAccess()<(2)))
	return false;
	if(opponent.Param[(701)]>dist||cr.Param[(702)]>=dist)
	return true; 
	
	uint maxView=cr.Stat[(1)]*5,
	maxHear=cr.Stat[(1)]*1.5;
	switch(cr.Stat[(1)]){
		case 1:
		maxView=12;
		maxHear=4;
		break;
		case 2:
		maxView=14;
		maxHear=6;
		break;
		case 3:
		maxView=16;
		maxHear=7;
		break;
		case 4:
		maxView=20;
		maxHear=8;
		break;
		case 5:
		maxView=24;
		maxHear=10;
		break;
		case 6:
		maxView=28;
		maxHear=14;
		break;
		case 7:
		maxView=32;
		maxHear=16;
		break;
		case 8:
		maxView=35;
		maxHear=18;
		break;
		case 9:
		maxView=40;
		maxHear=20;
		break;
		case 10:
		maxView=45;
		maxHear=22;
		break;
		default:
		break;
	}
	if(cr.Perk[(315)]>=1)
	{
		maxView+=6;
		maxHear+=4;
	}
	if(cr.IsNpc())
	{
		maxHear+=20;
	}
	
	bool isView=true,isHear=true,isRunOpp=opponent.IsRuning,isRunCr=cr.IsRuning;
	
	int8 startDir=GetDirection(hexX,hexY,oppHexX,oppHexY);
	
	int8 lookDir=abs(startDir-cr.Dir);
	if(lookDir>3)
	lookDir=6-lookDir;
	
	switch(lookDir)
	{
		case 0:
		maxView*=1;
		maxHear*=0.8;
		break;
		case 1:
		maxView*=0.8;
		maxHear*=1;
		break;
		case 2:
		maxView*=0.5;
		maxHear*=0.8;
		break;
		case 3:
		maxView*=0.4;
		maxHear*=0.8;
		break;
		default:
		break;
	}
	
	maxHear*=(isRunOpp?3:1)*(isRunCr?0.8:1);  
	
	uint16 wallHexX=oppHexX,wallHexY=oppHexY;
	
	map.GetHexCoord(hexX,hexY,wallHexX,wallHexY,0.0f,maxView);
	uint walldist=GetDistantion(hexX,hexY,wallHexX,wallHexY);
	
	bool isOutWall=dist>walldist;
	if(isOutWall)
	{
		isView=false;
		switch(cr.Stat[(1)])
		{
			case 1:
			case 2:
			case 3:
			case 4:
			maxHear*=0.1;
			break;
			case 5:
			case 6:
			case 7:
			case 8:
			maxHear*=0.3;
			break;
			case 9:
			case 10:
			maxHear*=0.4;
			break;
			default:
			break;
		}
	}
	
	if(dist>maxView)
	isView=false;
	
	if(dist>maxHear)
	isHear=false;
	
	return(!isView&&!isHear?false:true);
}

void chlook(Critter&player,int p0,int p1,int p2)
{
	Map@map=player.GetMap();
	if(map is null)
	{
		player.Say((11),"map is null");
		return;
	}
	Critter@cr=map.GetCritter(p0);
	if(cr is null)
	{
		player.Say((11),"opponent is null");
		return;
	}
	bool result=check_look(map,player,cr);
	if(result)
	player.Say((11),"I can see it!");
	else
	player.Say((11),"Oh no! Where is it?");
}   

bool check_trap_look(Map&map,Critter&cr,Item&trap)
{
	return true;
}    

uint item_cost(Item&item,Critter&cr,Critter&npc,bool sell)
{
	uint8 itemType=item.GetType();
	uint16 pid=item.GetProtoId();
	uint cost=GetProtoItem(pid).Cost;
	
	if(pid==(41)||pid==(519))
	return 1;
	
	if(itemType==(1)||itemType==(3))
	{
		uint8 brokenCount=item.BrokenCount;
		uint8 brokenFlags=item.BrokenFlags;
		
		if((((brokenFlags)&((0x08)))!=0)||(((brokenFlags)&((0x0F)))!=0))
		cost*=0.01;
		else if((((brokenFlags)&((0x04)))!=0))
		cost/=3;
		else if((((brokenFlags)&((0x02)))!=0))
		cost/=2;
		else if((((brokenFlags)&((0x01)))!=0))
		cost/=1.4;
		else if(brokenCount>0)
		cost*=brokenCount!=100?brokenCount*0.01:0.01;  
		
		if(itemType==(3))
		{
			cost+=GetProtoItem(item.AmmoPid).Cost*item.AmmoCount;
		}
	}   
	
	int skMod=cr.SkillBase[(215)]-npc.SkillBase[(215)]-50;
	bool skipByZero=false;
	if(skMod==0)
	{
		skMod=1;
		skipByZero=true;
	}
	if(skMod>0&&!skipByZero)
	{
		cost-=cost*(skMod*0.001);
	}
	else
	{
		cost+=cost+(((skMod)>0)?(skMod):-(skMod))*0.1;
	}
	
	cost=(((cost)>(cost))?(cost):(((cost)<(1))?(1):(cost)));     
	
	return sell?(cost*0.15>1?cost*0.15:1):cost; 
	
}   

bool items_barter(Item@[]&saleItems,uint[]&saleItemsCount,Item@[]&buyItems,uint[]&buyItemsCount,Critter&player,Critter&npc)
{
	if(npc.Mode[(535)]>0)
	{
		for(uint i=0,j=saleItems.length();i<j;i++)
		{
			Item@item=saleItems[i];
			if((@item!=null)&&(item.GetProtoId()!=(41)&&item.GetProtoId()!=(519)))
			{
				npc.SayMsg((12),(3),(497));
				return false;
			}
		}
	}
	GameVar@loan=GetUnicumVar((6110),player.Id,npc.Id);
	if(loan==1)
	{
		return false;
	}
	
	ChangeCritterSpeed(player);
	ChangeCritterSpeed(npc);
	
	return true;
}    

void items_crafted(Item@[]&items,uint[]&itemsCount,Item@[]&resources,Critter&crafter)
{
	ChangeCritterSpeed(crafter);
	
	int maxDeterioration=0;
	for(uint i=0,j=resources.length();i<j;i++)
	{
		Item@item=resources[i];
		int deterioration=GetDeteriorationProcent(item);
		if(deterioration>maxDeterioration)
		maxDeterioration=deterioration;
	}
	
	for(uint i=0,j=items.length();i<j;i++)
	{
		
		Item@item=items[i];
		if(item.GetType()==(3)&&item.Proto.Weapon_MaxAmmoCount>0)
		{
			item.AmmoCount=0;
			item.Update();
		} 
		
		SetDeterioration(item,maxDeterioration);
	}
	
	uint16 itemsZiroPid=items[0].GetProtoId();
	
	if(itemsZiroPid==(1317)||itemsZiroPid==(1318)||itemsZiroPid==(1319))
	{
		
		items[0].Val0=((((crafter.SkillBase[(213)]/3)+(crafter.SkillBase[(209)]/2))>0)?((crafter.SkillBase[(213)]/3)+(crafter.SkillBase[(209)]/2)):-((crafter.SkillBase[(213)]/3)+(crafter.SkillBase[(209)]/2)));
		return; 
		
	}      
	
	switch(itemsZiroPid)
	{
		case(927):
		{
			items[0].Val6=2;
			items[0].Val5=(3);
			items[0].Val4=crafter.SkillBase[(211)]/5;
			items[0].Val3=crafter.SkillBase[(211)]/15;
			return;
		}
		
		case(925):
		{
			items[0].Val6=4;
			items[0].Val5=(5);
			items[0].Val4=crafter.SkillBase[(211)]/5;
			items[0].Val3=crafter.SkillBase[(211)]/15;
			return;
		}
		
		case(835):
		{
			items[0].Val6=0;
			items[0].Val5=(1);
			items[0].Val4=crafter.SkillBase[(211)]/10;
			items[0].Val3=crafter.SkillBase[(211)]/20;
			return;
		}
		
		case(929):
		{
			items[0].Val6=0;
			items[0].Val5=(1);
			items[0].Val4=2;
			items[0].Val3=1;
			return;
		}
		
		case(932):
		{
			items[0].Val6=4;
			items[0].Val5=(1);
			items[0].Val4=crafter.SkillBase[(211)]/20;
			items[0].Val3=crafter.SkillBase[(211)]/30;
			return;
		}
		
		case(931):
		{
			items[0].Val6=0;
			items[0].Val5=(1);
			items[0].Val4=crafter.SkillBase[(211)]/10;
			items[0].Val3=crafter.SkillBase[(211)]/20;
			return;
		}
		
		case(928):
		{
			items[0].Val6=0;
			items[0].Val5=(1);
			items[0].Val4=crafter.SkillBase[(211)]/20;
			items[0].Val3=crafter.SkillBase[(211)]/30;
			return;
		}
		
		case(926):
		{
			items[0].Val6=0;
			items[0].Val5=(1);
			items[0].Val4=1;
			items[0].Val3=0;
			return;
		}
		
		case(930):
		{
			items[0].Val6=0;
			items[0].Val5=(1);
			items[0].Val4=crafter.SkillBase[(211)]/10;
			items[0].Val3=crafter.SkillBase[(211)]/20;
			return;
		}
		
	}
	
}  

void player_levelup(Critter&player,uint skillIndex,uint skillUp,uint perkIndex)
{
	if(skillIndex>=(__SkillBegin)&&skillIndex<=(__SkillEnd))
	{
		for(;skillUp!=0;skillUp--)
		{
			int skillVal=player.SkillBase[skillIndex];
			if(skillVal>=(__SkillMaxValue))
			break;
			
			int needPoints=1;
			if(skillVal>__SkillModAdd6)
			needPoints=6;
			else if(skillVal>__SkillModAdd5)
			needPoints=5;
			else if(skillVal>__SkillModAdd4)
			needPoints=4;
			else if(skillVal>__SkillModAdd3)
			needPoints=3;
			else if(skillVal>__SkillModAdd2)
			needPoints=2;
			
			if(player.StatBase[(78)]<needPoints)
			break;
			
			skillVal++;
			
			player.SkillBase[skillIndex]=skillVal;
			player.StatBase[(78)]-=needPoints;
		}
	}
	else if(perkIndex>=(__PerkBegin)&&perkIndex<=(__PerkEnd))
	{
		if(PerkCheck(player,perkIndex))
		{
			player.PerkBase[perkIndex]++;
			player.StatBase[(79)]--;
		}
	}
	
	player.StatBase[(85)]=player.Stat[(77)]*100;
}   

void turn_based_begin(Map&map)
{
	
	if(map.TurnBasedRound>0)
	{
		uint[]crittersIds;
		map.GetTurnBasedSequence(crittersIds);
		
		bool continueBattle=false;
		if(crittersIds.length()>=2)
		{
			for(uint i=0,j=crittersIds.length();i<j;i++)
			{
				Critter@cr=::GetCritter(crittersIds[i]);
				if(!(not(@cr!=null)||cr.IsDead()||
				(cr.IsNpc()&&cr.GetPlanes((1),null)==0)||
				(cr.IsPlayer()&&(cr.Mode[(515)]!=0||cr.Stat[(72)]<1))))
				{
					continueBattle=true;
					break;
				}
			}
		}
		
		if(not continueBattle)
		map.EndTurnBased();
	}
} 

void turn_based_end(Map&map)
{
	
} 

void turn_based_process(Map&map,Critter&cr,bool beginTurn)
{
	if(beginTurn)
	{
		cr.StatBase[(88)]=cr.Stat[(87)];
		cr.StatBase[(86)]=0;
	}
	else
	{
		bool hthEvade=false;
		if(cr.Perk[(394)]!=0)
		{
			
			Item@hand1=cr.GetItem(0,(1));
			Item@hand2=cr.GetItem(0,(2));
			if((not(@hand1!=null)||hand1.GetType()!=(3)||not hand1.Weapon_IsHtHAttack(0))&&
			(not(@hand1!=null)||hand1.GetType()!=(3)||not hand1.Weapon_IsHtHAttack(0)))
			{
				hthEvade=true;
			}
		}
		
		cr.StatBase[(86)]=cr.Stat[(75)]*(hthEvade?2:1);
		if(cr.Stat[(86)]<0)
		cr.StatBase[(86)]=0;
		if(hthEvade&&cr.Skill[(203)]>0)
		cr.StatBase[(86)]+=cr.Skill[(203)]/12;
		cr.StatBase[(88)]=0;
	}
} 

void turn_based_sequence(Map&map,Critter@[]&critters,Critter@firstTurnCrit)
{
	
	if((@firstTurnCrit!=null)&&(firstTurnCrit.IsDead()||firstTurnCrit.Stat[(75)]<=0))
	@firstTurnCrit=null; 
	
	SequenceCritter[]sequenceCritters;
	for(uint i=0,j=critters.length();i<j;i++)
	{
		Critter@cr=critters[i];
		if((@firstTurnCrit!=null)&&firstTurnCrit.Id==cr.Id)
		continue;
		if(cr.IsDead())
		continue;
		sequenceCritters.resize(sequenceCritters.length()+1);
		@sequenceCritters.last().critter=cr;
	} 
	
	SequenceCritterRandom=Random(0,1);
	sequenceCritters.sortDesc(); 
	
	critters.resize(0);
	if((@firstTurnCrit!=null))
	critters.insertLast(firstTurnCrit);
	for(uint i=0,j=sequenceCritters.length();i<j;i++)
	critters.insertLast(sequenceCritters[i].critter);
} 

int SequenceCritterRandom=0;
class SequenceCritter
{
	Critter@critter;
	int opCmp(SequenceCritter&in other)
	{
		bool result;
		Critter@cr1=critter;
		Critter@cr2=other.critter;
		int seq1=cr1.Stat[(12)];
		int seq2=cr2.Stat[(12)];
		if(seq1==seq2)
		{
			int ag1=cr1.Stat[(5)];
			int ag2=cr2.Stat[(5)];
			if(ag1==ag2)
			{
				int lk1=cr1.Stat[(6)];
				int lk2=cr2.Stat[(6)];
				if(lk1==lk2)
				{
					if(SequenceCritterRandom==0)
					result=cr1.Id>cr2.Id;
					else
					result=cr1.Id<cr2.Id;
				}
				else
				result=lk1>lk2;
			}
			else
			result=ag1>ag2;
		}
		else
		result=seq1>seq2;
		return result?int(1):int(-1);
	}
}  

void world_save(uint currentIndex,uint[]&deleteIndexes)
{
	
	if(currentIndex==1)
	{
		deleteIndexes.resize(5);
		for(uint i=0;i<5;i++)
		deleteIndexes[i]=9999-i;
	}
	else if(currentIndex>4)
	{
		deleteIndexes.resize(1);
		deleteIndexes[0]=currentIndex-5;
	}
	
	SaveCaravans();
	
	qmap_save_all();
	
	manager_world_save();
}

uint8 NpcCount(Critter@[]&group)
{
	uint8 x=0;
	for(uint i=0,len=group.length();i<len;i++)
	{
		if(group[i]is null or group[i].IsPlayer())
		continue;
		x++;
	}
	return x;
} 

bool player_registration(uint ip,string&name,uint&textMsg,uint&strNum)
{
	return manager_player_registration(ip,name,textMsg,strNum);
}  

bool player_login(uint ip,string&name,uint id,uint&textMsg,uint&strNum)
{
	if(!manager_player_login(ip,name,id,textMsg,strNum))
	return false;
	
	Critter@cr=GetCritter(id);
	
	if(!(cr is null))
	{
		cr.ParamBase[(189)]=0;
		CreateTimeEvent(__FullSecond+((100)*__TimeMultiplier/1000),"e_player_after_login",id,false);    
		
	}
	
	return true;
}

uint e_player_after_login(uint[]@values)
{
	if((values is null)||values.length()<1)
	{
		Log("there isn't id in values");
		return 0;
	}
	
	uint id=values[0];
	
	Critter@cr=GetCritter(id);
	
	if(cr is null)
	{
		Log("can't get player "+id);
		return 0;
	}else{
		FlushScreen(cr,((uint((0xFF<<24)|(((0)&0xFF)<<16)|(((0)&0xFF)<<8)|((0)&0xFF)))),0,20000);
	}
	
	Map@map=cr.GetMap();
	
	if(!(map is null)&&uint(cr.Param[(189)])==0)
	{
		qmap_critter_in(map.Id,cr);
	}
	
	return 0;
}       

void ExpBarTimer(Critter&cr,uint8 time)
{
	uint[]rates; 
	
	int16 tempMultiplier=cr.StatBase[(124)]++;
	cr.StatBase[(124)]=(((cr.StatBase[(124)])>((5)))?((5)):(((cr.StatBase[(124)])<(1))?(1):(cr.StatBase[(124)])));
	
	if(cr.GetTimeEvents((30),null,null,rates)>0)
	{
		
		return;
	} 
	
	cr.StatBase[(125)]=((time)<<8)|(time);
	cr.AddTimeEvent("cte_ExpBar",((100)*__TimeMultiplier/1000),(30),time);
}

void ExpBarSetTime(int&time,uint8 newTime,bool set)
{
	uint8 allTime=(time)&0xFF;   
	
	time=((set?newTime:allTime)<<8)|(newTime); 
	
}

uint cte_ExpBar(Critter&cr,int identifier,uint&rate)
{
	
	int16 tempRate=rate;
	rate=(((tempRate--)>(255))?(255):(((tempRate--)<(0))?(0):(tempRate--)));
	
	uint8 allTime=(cr.StatBase[(125)])&0xFF;
	
	cr.StatBase[(125)]=((rate)<<8)|(allTime);
	
	if(rate<=0)
	{
		cr.StatBase[(124)]=1;
		cr.StatBase[(125)]=0;
		return 0;
	}
	return((1000)*__TimeMultiplier/1000);
}                           

void SetStartCrTimeEvent(Critter&cr,string func,uint time,int identifier,uint rate)
{
	if(cr.GetTimeEvents(identifier,null,null,null)>0)
	{
		cr.Say((11),"erase");
		cr.EraseTimeEvents(identifier);
	}
	
	cr.AddTimeEvent(func,time,identifier,rate);
	
}  

bool player_getaccess(Critter&player,int access,string&password)
{
	Log("Access changed for player "+player.Name+", from "+player.GetAccess()+" to "+access+".");
	player.StatBase[(137)]=access;
	return true;
}

bool player_allowcommand(Critter@player,string@adminPanel,uint8 command)
{
	if((@adminPanel!=null))
	return true;
	
	switch(command)
	{
		
		case(35):
		case(34):
		case(1):
		case(11):
		case(2):
		return true;
		
		case(36):
		case(10):
		case(8):
		if(player.GetAccess()>=(1))
		return true;
		break;
		
		case(12):
		case(14):
		case(16):
		case(15):
		case(33):
		case(30):
		case(4):
		case(7):
		case(3):
		case(6):
		case(5):
		case(9):
		case(31):
		if(player.GetAccess()>=(2))
		return true;
		break;
		
		case(27):
		case(22):
		case(24):
		case(18):
		case(37):
		case(19):
		case(29):
		case(26):
		case(21):
		case(23):
		case(17):
		case(28):
		case(25):
		case(20):
		case(32):
		if(player.GetAccess()==(3))
		return true;
		break;
		
		default:
		player.Say((11),"Unknown command.");
		return false;
	}
	
	player.Say((11),"Access denied.");
	return false;
}

void _giveHair(Critter&cr,uint index,int oldValue)
{
	SetHair(cr);
}

bool ltp_sharp_inited=false;

void ltp_sharp_init()
{
	PROCESS@___pfunc=@process_sharp;any ___pany;___pany.store(@___pfunc);RegisterProcess((36),___pany);
	ltp_sharp_inited=true;
}

uint process_sharp(Critter@cr,int&param0,int&param1,int&param2)
{
	if(param0==-1&&(cr is null)){param0=int((36));return(0xF035BCF3);}
	Item@item=GetItem(param0);
	if(@item==null)
	return 0;
	int8 det=GetDeteriorationProcent(item);
	det-=Random(1,cr.Stat[(0)]);
	det=(((det)>(100))?(100):(((det)<(0))?(0):(det)));
	SetDeterioration(item,det);
	
	cr.Say((11),"Вы точите лезвия.");
	return det>0?3*1000:0;
} 

void ShowInputBoxScreen(Critter&cr,string funcName,uint16 textLength,uint8 flags)
{
	cr.RunClientScript("client_screen_inputbox@ShowInputBox",int(textLength),int(flags),0,funcName,null);
}

void showBunch(Critter&cr,uint answerI,string&answerS)
{
	Item@item=GetItem(answerI);
	Item@locker=GetItem(cr.StatBase[(131)]);
	if(item is null||locker is null)
	return;
	
	UseItemOnLocker(cr,locker,item);
}

void unsafe_DKP(Critter&cr,int drugPid,int,int,string@,int[]@){
	
	Item@drug=cr.GetItem(drugPid,-1);
	if(!(drug is null)){
		if(cr.StatBase[(75)]>=2){
			cr.StatBase[(75)]-=2;
			
			critter_use_item(cr,drug,null,null,null,0);
		}
	}
}

uint cte_bodyswap(Critter&cr,int identifier,uint&rate){
	Critter@targetCr=GetCritter(cr.Param[(760)]);
	if((@targetCr!=null)){
		cr.Say((11),"Вы возвращаетесь в свое тело");
		targetCr.Say((11),"Вы возвращаетесь в свое тело");
		cr.ParamBase[(761)]=0;
		targetCr.ParamBase[(761)]=0;
		SwapCritters(cr,targetCr,true,false);
		cr.Disconnect();
		targetCr.Disconnect();
		return 0;
	}else{
		return 10*__TimeMultiplier;
	}
}

void brahminInitSearch(Critter&cr){
	if(cr.GetTimeEvents((62),null,null,null)>0)return;
	cr.AddTimeEvent("cte_search_partner",0,(62),0);
}

void brahminBirth(Map@map,uint16 hexX,uint16 hexY){
	Critter@baby=map.AddNpc((545),hexX,hexY,Random(0,5),null,null,null);
	if((@baby!=null)){
		baby.StatBase[(71)]=(Random(0,1)==0)?(0):(1);
		baby.AddTimeEvent("cte_brahmin_growth",3*24*60*60*__TimeMultiplier,(63),0);
		baby.StatBase[(105)]=6;
	}
}

uint cte_brahmin_pregnancy(Critter&cr,int identifier,uint&rate){
	if(!cr.IsDead()){
		Map@map=cr.GetMap();
		brahminBirth(map,cr.HexX,cr.HexY);
	}
	return 0;
}

uint cte_search_partner(Critter&cr,int identifier,uint&rate){
	if(cr.Stat[(71)]==(1))return 60*__TimeMultiplier;
	Map@map=cr.GetMap();
	Critter@[]partners;
	rate+=1;
	if(Random(0,99)<rate){
		map.GetCrittersHex(cr.HexX,cr.HexY,15,(0x01),partners);
		int plen=partners.length();
		int i=0;
		int closestIndex=-1;
		int minDistance=15;
		while(i<plen){
			bool isPregnant=(partners[i].GetTimeEvents((61),null,null,null)>0);
			if(partners[i].Stat[(112)]==15&&partners[i].Stat[(71)]==(1)&&!isPregnant){
				if(GetCrittersDistantion(cr,partners[i])<=minDistance){
					minDistance=GetCrittersDistantion(cr,partners[i]);
					closestIndex=i;
				}
			}
			i++;
		}
		if(closestIndex>=0){
			if(GetCrittersDistantion(cr,partners[closestIndex])<=2){
				cr.Say((5),"Браминий секс");
				partners[closestIndex].Say((5),"Браминий секс");
				partners[closestIndex].AddTimeEvent("cte_brahmin_pregnancy",2*24*60*60*__TimeMultiplier,(61),0);
				cr.AddTimeEvent("cte_search_partner",24*60*60*__TimeMultiplier,(62),0);
				return 0;
			}else{
				cr.ModeBase[(517)]=1;
				AddWalkPlane(cr,0,partners[closestIndex].HexX,partners[closestIndex].HexY,6,false,1);
				cr.Say((5),"Возбужденно мычит");
				return 10*__TimeMultiplier;
			}
		}
	}
	return 15*__TimeMultiplier;
}

uint cte_brahmin_growth(Critter&cr,int identifier,uint&rate){
	if(!cr.IsDead()){
		cr.ChangeCrType(15);
	}
	return 0;
}
